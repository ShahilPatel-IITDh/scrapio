/*!
* hgpesb.js
*
* Copyright Â© Healthgrades 2014
* Author: Marc Sexton | msexton@healthgrades.com
* Description: Contains all functionality for the Healthgrades PES Doctor Bug Widget.
* http://www.healthgrades.com
*
*/
window.HGPESB=window.HGPESB||function(){"use strict";function e(){function e(e){var t=window.jQuery.fn.jquery.split("."),s=e.split("."),a;for(a=0;a<t.length;a+=1)t[a]=Number(t[a]);for(a=0;a<s.length;a+=1)s[a]=Number(s[a]);return 2===t.length&&(t[2]=0),t[0]<s[0]||!(t[0]>s[0])&&(t[1]<s[1]||!(t[1]>s[1])&&(t[2]<s[2]||(t[2],s[2],!1)))}function n(){a||(a=!0,s=window.jQuery.noConflict(!0),t())}if(void 0===window.jQuery||e("1.9")){var o=document.createElement("script");o.setAttribute("src","https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"),o.setAttribute("type","text/javascript"),o.onload=n,o.onreadystatechange=function(){"complete"!==this.readyState&&"loaded"!==this.readyState||n()},(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(o)}else s=window.jQuery,t()}function t(){s(document).ready((function($){var e={constants:{base:"https://apps.healthgrades.com/pes/hgpesb/"}};"hg.test"===window.location.hostname&&(e.constants.base="http://hg.test/pes/hgpesb/"),e.settings={token:null,track:!0,debug:!1},e.memory={$container:null},e.init=function(){var t=e;$.extend(t.settings,window.HGPESB.options),t.stylesheet(),$("div[data-healthgrades-id]").each((function(){var e=$(this),s=e.attr("data-healthgrades-id"),a=e.attr("data-healthgrades-template"),n={token:t.settings.token,id:s,template:a,source:t.settings.source,cid:t.settings.cid};$.getJSON(t.constants.base+"server.php?callback=?",$.param(n),(function(a){"Authorized"===a.info.access&&""!==a.response.html.badge?e.html(a.response.html.badge).trigger("hgpesb.badge.loaded",{id:s,template:a.info.badge.template}).on("click",".hgpesb-badge > a",(function(){e.trigger("hgpesb.badge.clicked",{id:s,template:a.info.badge.template})})).on("click",".hgpesb-btn-modal",(function(s){$("body").addClass("hgpesb-modal-open").append(a.response.html.modal),t.initModal(e),s.preventDefault()})):e.trigger("hgpesb.badge.error",{id:s})}))})),t.track()},e.initModal=function(t){var s=e,a=t.attr("data-healthgrades-id");s.floatFooter(),t.trigger("hgpesb.modal.opened",{id:a}),0===$(".hgpesb-modal-page").index(".hgpesb-results")&&t.trigger("hgpesb.results.shown",{id:a}),0===$(".hgpesb-modal-page").index(".hgpesb-survey")&&t.trigger("hgpesb.survey.shown",{id:a}),$(".hgpesb-modal-close, .hgpesb-btn-thanks").click((function(e){$("body").removeClass("hgpesb-modal-open"),$(".hgpesb-modal-container").remove(),$(".hgpesb-modal").scrollTop(0),t.trigger("hgpesb.modal.closed",{id:a}),e.preventDefault()})),$(".hgpesb-btn-take").click((function(e){$(".hgpesb-modal-page").hide(),$(".hgpesb-survey").show(),$(".hgpesb-modal").scrollTop(0),t.trigger("hgpesb.survey.shown",{id:a}),e.preventDefault()})),$(".hgpesb-btn-submit").click((function(e){s.submitSurvey(t),e.preventDefault()})),$(".hgpesb-modal").on("mouseover",".hgpesb-star",(function(){var e=$(this),t=e.closest("ul.hgpesb-stars"),s=t.find("li.hgpesb-star"),a=t.closest(".hgpesb-row").find(".hgpesb-stars-label"),n="hgpesb-stars-rated-"+(s.index(e)+1);t.removeClass("hgpesb-stars-rated-1 hgpesb-stars-rated-2 hgpesb-stars-rated-3 hgpesb-stars-rated-4 hgpesb-stars-rated-5").addClass(n),a.text(e.attr("data-label"))})).on("mouseout",".hgpesb-star",(function(){var e,t=$(this).closest("ul.hgpesb-stars"),s=t.closest(".hgpesb-row").find(".hgpesb-stars-label"),a=Number(t.attr("data-rated"))||!1;t.removeClass("hgpesb-stars-rated-1 hgpesb-stars-rated-2 hgpesb-stars-rated-3 hgpesb-stars-rated-4 hgpesb-stars-rated-5"),s.empty(),a&&(t.addClass("hgpesb-stars-rated-"+a),s.text(t.find("li").eq(a-1).attr("data-label")))})).on("click",".hgpesb-star",(function(e){var t=$(this),s=t.closest("ul.hgpesb-stars"),a=s.find("li.hgpesb-star"),n=s.closest(".hgpesb-row").find(".hgpesb-stars-label"),o=s.closest(".hgpesb-row").find('input[type="hidden"]'),i=a.index(t)+1,d="hgpesb-stars-rated-"+i;s.attr("data-rated",i).removeClass("hgpesb-stars-rated-1 hgpesb-stars-rated-2 hgpesb-stars-rated-3 hgpesb-stars-rated-4 hgpesb-stars-rated-5").addClass(d),n.text(t.attr("data-label")),o.val(t.attr("data-value")),e.preventDefault()})).on("click",".hgpesb-slider button",(function(e){var t=$(this),s=t.closest("ul"),a=s.closest(".hgpesb-row").find('input[type="hidden"]');s.find(".is-active").removeClass("is-active"),t.closest("li").addClass("is-active"),a.val(t.attr("data-answer")),e.preventDefault()})).on("scroll touchmove",(function(){s.floatFooter()})).on("click",".hgpesb-confirm-options input",(function(){var e=$(".hgpesb-modal .hgpesb-confirm-options input").index($(this));$(".hgpesb-confirm-option").removeClass("hgpesb-confirm-active").eq(e).addClass("hgpesb-confirm-active")})),$(window).on("resize",(function(){s.floatFooter()}))},e.debug=function(e){void 0!==window.console&&!0===this.settings.debug&&window.console.log(e)},e.floatFooter=function(){var e=$(".hgpesb-modal"),t=$(".hgpesb-modal-footer"),s="hgpesb-modal-footer-floated";if(t.length>0&&!window.navigator.msPointerEnabled){var a=t.offset(),n;e.height()-a.top+$(window).scrollTop()>t.height()?(t.removeClass(s),$(".hgpesb-sticky").width("auto")):(t.addClass(s),$(".hgpesb-sticky").width($(".hgpesb-modal-body").width()))}},e.track=function(){var e=this,t=e.constants.base+"track/";e.settings.track&&$("div[data-healthgrades-id]").on("hgpesb.badge.error",(function(t,s){e.debug("Badge Error: "+s.id)})).on("hgpesb.badge.loaded",(function(s,a){e.debug("Badge Loaded: "+a.id+", "+a.template),$.post(t,{t:"pageview",dh:"healthgrades.com",dp:window.location.hostname+"/"+a.id,dt:"PES Badges:"+a.id})})).on("hgpesb.badge.clicked",(function(s,a){e.debug("Badge Clicked: "+a.id+", "+a.template),$.post(t,{t:"event",ec:"hgpesb:"+window.location.hostname+":"+a.template+":"+a.id,ea:"click",el:"badge-click"})})).on("hgpesb.modal.opened",(function(t,s){e.debug("Modal Opened: "+s.id)})).on("hgpesb.results.shown",(function(t,s){e.debug("Results Shown: "+s.id)})).on("hgpesb.survey.shown",(function(t,s){e.debug("Survey Shown: "+s.id)})).on("hgpesb.survey.submit",(function(t,s){e.debug("Survey Submit: "+s.id),e.debug(s)})).on("hgpesb.survey.response",(function(t,s){e.debug("Survey Resonse: "+s.id),e.debug(s)})).on("hgpseb.survey.published",(function(t,s){e.debug("Survey Published: "+s.id),e.debug(s)})).on("hgpesb.thanks.shown",(function(t,s){e.debug("Thanks Shown: "+s.id)})).on("hgpesb.modal.closed",(function(t,s){e.debug("Modal Closed: "+s.id)}))},e.stylesheet=function(){var e,t=this.constants.base+"assets/css/hgpesb.css",s=new Date;$("<link>",{rel:"stylesheet",type:"text/css",href:t+"?"+s.getTime()}).appendTo("head")},e.validateSurvey=function(){function e(e){var t=["name@email.com"],s=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return-1===$.inArray(e,t)&&s.test(e)}var t=0;return $('.hgpesb-row[data-required="true"]').each((function(){var s=$(this);s.find("select").length>0&&""===s.find("select").val()||s.find('input[type="radio"]').length>0&&0===s.find('input[type="radio"]:checked').length||s.find('input[type="hidden"]').length>0&&""===s.find('input[type="hidden"]').val()||s.find('input[name="answers[244]"]').length>0&&!e(s.find('input[name="answers[244]"]').val())||s.find('input[value="text"]').length>0&&s.find('input[name="text"]').length>0?(t++,s.addClass("hgpesb-has-error")):s.removeClass("hgpesb-has-error")})),0===t},e.submitSurvey=function(e){var t=this,s=e.attr("data-healthgrades-id"),a=0;t.validateSurvey()?(t.postSurvey(e),t.publishSurvey(e),$(".hgpesb-modal-page").hide(),$(".hgpesb-thanks").show(),$(".hgpesb-modal").scrollTop(0),e.trigger("hgpesb.thanks.shown",{id:s})):(a=$(".hgpesb-has-error:first").position().top,t.debug(a),$(".hgpesb-modal").animate({scrollTop:a},500))},e.postSurvey=function(e){var t=this,s=t.settings,a=e.attr("data-healthgrades-id"),n=t.constants.base+"server.php?",o=["token="+s.token],i=$(".hgpesb-modal form").serialize();e.trigger("hgpesb.survey.submit",{id:a,post:i}),$.post(n+o.join("&"),i,(function(s){t.debug("Healthgrades Widget: Survey Response Code ["+s.response+"]"),e.trigger("hgpesb.survey.response",{id:a,code:s.response})}))},e.publishSurvey=function(e){var t=[],s=e.attr("data-healthgrades-id");$(".hgpesb-modal .hgpesb-row[data-required]").each((function(){var e=$(this),s=e.find(".hgpesb-question").text(),a="";e.find("select").length>0?a=e.find("select option:selected").text().replace("Choose one",""):e.find('input[type="radio"]:checked').length>0?a=e.find("input:checked").parent().text():e.find('input[type="hidden"]').length>0?a=e.find(".hgpesb-stars-label").text():e.find('input[type="text"]').length>0&&(a=e.find('input[type="text"]').val()),""!==a&&t.push([s,a])})),e.trigger("hgpseb.survey.published",{id:s,questions:t})},e.init()}))}var s,a=!1;return{customize:function(e){return window.HGPESB.options=e,this},start:function(){e()}}}();