(function(m,r){typeof exports=="object"&&typeof module<"u"?module.exports=r():typeof define=="function"&&define.amd?define(r):(m=typeof globalThis<"u"?globalThis:m||self,m.Draper=r())})(this,function(){"use strict";const m="";function r({url:e,async:t=!1,defer:n=!1,callback:o=()=>{}}){if(document.querySelector(`script[src="${e}"]`))s(`Script for resource: ${e} already exists.`);else{const i=document.createElement("script");i.type="text/javascript",i.src=e,i.async=t,i.defer=n,document.head.append(i)}o()}function d(e=()=>{}){window.googletag=window.googletag||{cmd:[]},window.googletag.cmd.push(e)}const S=window.innerWidth<700;function L(e=window.location.search){const t=new URLSearchParams(e);return Object.fromEntries(t.entries())}const s=(...e)=>{const t=L(),{debugads:n=!1}=t;if(n){const o=new Date;console.log("[Draper]",...e,o.toLocaleTimeString(),`${o.getMilliseconds()}ms`)}},j=e=>Array.isArray(e)&&e.every(t=>Array.isArray(t)&&t.length===2&&typeof t[0]=="number"&&typeof t[1]=="number"),V=(e,t)=>Array.isArray(e)&&Array.isArray(t)&&e.length<=t.length&&e.every(n=>Array.isArray(n)&&j(n));var g=(e=>(e.AD_BLOCKER="blocked_campaigns",e.NOUN_KEYWORDS="Keyword",e.NOUN_CATEGORIES="category",e.NOUN_ENTITIES="entities",e.NOUN_TAGS="tags",e.LYTICS_SEGMENTS="LyticsSegments",e.REFRESH="refresh",e.REFRESH_KEY="refreshable",e))(g||{}),y=(e=>(e.Desktop="tim.mdp.com",e.Mobile="tim.mdp.mob",e.FacebookInstantArticle="tim.mdp.fbia.com",e))(y||{});const p=Object.freeze({Large:[969,499],Medium:[727,179],Small:[0,0]}),$="https://securepubads.g.doubleclick.net/tag/js/gpt.js";let v=[];function B(e=12,t=5,n=1){window.googletag.pubads().enableLazyLoad({fetchMarginPercent:e,renderMarginPercent:t,mobileScaling:n})}function P(e,t={}){for(const[n,o]of Object.entries(t))e.setTargeting(n,o)}function F(e,t){const n=window.googletag.sizeMapping();e.sort((o,i)=>i[0]-o[0]);for(const[o,i]of[...t].entries())typeof e[o]<"u"&&n.addSize(e[o],i);return n.build()}function k({id:e,adUnitPath:t,sizes:n,viewPortBreakPoints:o=v,slotLevelTargeting:i={},display:a="all",companionAd:l}){if(!e)throw new Error("The 'id' is required.");if(!t)throw new Error(`The 'adUnitPath' for ad slot ${e} is required.`);if(a==="mobile"&&!S||a==="desktop"&&S){s(`The ad slot ${e} will only be defined on ${a}.`);return}const c=V(n,o),w=c?[...n].flat(1):[...n],u=window.googletag.defineSlot(t,w,e);if(u){if(P(u,{...i,[g.REFRESH_KEY]:"true",...c?{breakpoints:o.map(([f,R])=>`${f}x${R}`).join("|")}:{},responsive:String(c),sizes:[...new Set(w.map(([f,R])=>`${f}x${R}`))].join("|")}),c){const f=F(o,n);u.defineSizeMapping(f!=null?f:[])}l&&(u.addService(googletag.companionAds()),googletag.pubads().enableVideoAds()),u.addService(window.googletag.pubads())}}function U(){d(()=>{window.googletag.pubads().refresh()})}function E(){var e;return(e=window.googletag.pubads().getSlots())!=null?e:[]}function C(e){d(()=>{for(const t of e)k(t);K(E()),re(E())})}function q({id:e,adUnitPath:t="",slotLevelTargeting:n={},addElement:o=!1}){d(()=>{if(o){const a=document.createElement("div");a.setAttribute("id",e),a.setAttribute("style","display:none;width:0px;height:0px"),document.body.append(a)}const i=window.googletag.defineOutOfPageSlot(t,e);i&&(P(i,n),i.addService(window.googletag.pubads()))})}function M(e,t){const n=()=>{window.googletag.pubads().addEventListener(e,t)};window.googletag.pubadsReady?n():d(()=>{n()})}function _(e={}){d(()=>{for(const[t,n]of Object.entries(e))window.googletag.pubads().setTargeting(t,n)})}function Y(){d(()=>{const e=E().filter(t=>!t.getSlotElementId().includes("oop-ad"));_({adslots:`${e.length}`})})}function Q(){return window.googletag.pubadsReady?window.googletag.pubads().isInitialLoadDisabled():!1}function z(){const e=googletag.pubads().getTargetingKeys(),t=e.map(n=>googletag.pubads().getTargeting(n));return Object.fromEntries(e.map((n,o)=>[n,t[o].join(",")]))}function G({lazyLoad:e,enableSingleRequestMode:t,disableInitialLoad:n,viewPortBreakPoints:o}={},i={},a=!1){window.googletag=window.googletag||{cmd:[]},a&&r({url:$,async:!0,callback:()=>{s("Appended googletag script to the head tag of the page.")}}),d(()=>{_(i),n&&(window.googletag.pubads().disableInitialLoad(),s("`disableInitialLoad` was called, which means you will need to call the `refresh` method to load the ads.")),e&&B(),t&&window.googletag.pubads().enableSingleRequest(),window.googletag.enableServices()}),typeof o<"u"&&(v=o)}const x="https://pub.doubleverify.com/dvtag/21226187/DV759520/pub.js",O="https://pub.doubleverify.com/signals/ad-refresh.js",D=["ids","bsc","vlp","tvp"];function K(e=[]){d(()=>{window.PQ.cmd.push(()=>{window.PQ.loadSignalsForSlots(e)})})}function H(){d(()=>{Q()?window.PQ.cmd.push(()=>{window.PQ.loadSignals(D)}):s("DoubleVerify: Initial load must be disabled to ensure DV is able to pass the signals to you for targeting.")})}function W(e,t){window.PQ.cmd.push(()=>{window.PQ.getTargeting({signals:D,adUnits:e},(n,o)=>{n?t(n):t(!1,o)})})}function Z({dynamicallyInsertScript:e=!1}={}){e&&r({url:O,async:!0,callback:()=>{document.querySelector(`script[src="${O}"]`).addEventListener("load",()=>{const n={inViewTime:30,inViewPercent:50,maxRefreshes:99,onlyValidTraffic:!0};window.AdRefresh.apply(n)})}})}function J({dynamicallyInsertScript:e=!1}={}){window.PQ=window.PQ||{cmd:[]},e&&r({url:x,async:!0}),H()}const X="https://c.amazon-adsystem.com/aax2/apstag.js";function ee(e=[],t=()=>{}){return new Promise((n,o)=>{e.length>0&&(s("No Amazon(APS) slots to fetch bids for."),o()),window.apstag.fetchBids({slots:e},()=>{window.apstag.setDisplayBids(),t(),n()})})}function te(e,t=!1){window.apstag=window.apstag||{init(){window.apstag._Q.push(["i",arguments,Date.now()])},fetchBids(){window.apstag._Q.push(["f",arguments,Date.now()])},setDisplayBids(){},_Q:[]},t&&r({url:X,async:!0,callback:()=>{s("Dynamically appended the APS script to the head tag of the page. However, it's highly recommended to load the APS library statically.")}}),window.apstag.init(e,()=>{s("APS initialized")})}const ne=(e="")=>`https://micro.rubiconproject.com/prebid/dynamic/${e}.js`;function I(e){window.pbjs.que.push(e)}function oe(e,t=()=>{}){return new Promise(n=>{I(()=>{window.pbjs.rp.requestBids({callback(){t(),n()},gptSlotObjects:e})})})}function ie({magniteId:e},t=!1){window.pbjs=window.pbjs||{},window.pbjs.que=window.pbjs.que||[],t&&r({url:ne(e),async:!0,callback:()=>{s("Dynamically appended the Prebid script to the head tag of the page. However, it's highly recommended to load the Prebid library statically.")}}),I(()=>{s("Prebid initialized")})}const ae=[[728,90],[970,250],[320,50],[320,480],[300,250],[300,50],[300,600],[100,1]];function se(e=[]){const t=[];for(const n of e){const[o]=n.getSizes();typeof o<"u"&&o!=="fluid"&&ae.some(([i,a])=>i===o.width&&a===o.height)&&t.push(n)}return t}function re(e){window.draperBiddingReady||s("Bidding services are not ready.");const t=se(e),n=2e3,o={adServerRequestSent:!1,aps:!1,prebid:!1};function i(){o.adServerRequestSent||(o.adServerRequestSent=!0,U())}function a(){o.aps&&o.prebid&&i()}Promise.allSettled([ee(t,()=>{o.aps=!0,a()}),oe(t,()=>{o.prebid=!0,a()})]).then(()=>s("Fetched all bids!")).catch(l=>{s(l)}),window.setTimeout(i,n)}function de(e){const{enabled:t,amazon:n={enabled:!1,config:{}},prebid:o={enabled:!1,config:{}}}=e;if(!t){s("Header bidding disabled for all bidding services.");return}window.draperBiddingReady=!1,n.enabled&&te(n.config),o.enabled&&ie(o.config),window.draperBiddingReady=!0}const b="https://ai.time.com";async function le(e){try{const t=await fetch(`${b}/noun/extract/${e}`),{keywords:n}=await t.json();return n.join(",")}catch(t){throw new Error(t)}}async function ce(e){try{const t=await fetch(`${b}/noun/entities/get_entities/${e}`),{entities:n=[]}=(await t.json()).data;return n.join(",")}catch(t){throw new Error(t)}}async function ge(e,t=[]){try{const n=await fetch(`${b}/noun/tags/get_tags/${e}`),{tags:o=[]}=(await n.json()).data;return[...new Set([...o,...t])].join(",")}catch(n){throw new Error(n)}}async function ue(e){try{const t=await fetch(`${b}/noun/topics/get_topics/${e}`),{data:n}=await t.json();return n.b2b_content.join(",")}catch(t){throw new Error(t)}}async function fe(e=""){try{const t=await fetch(`${b}/adblocker/match/${e}`),{block_status:n}=await t.json();return n.filter(o=>o.to_block).map(o=>o.ab_campaign_id).join(",")}catch(t){throw new Error(t)}}function pe({contentType:e="",contentId:t="",tags:n}){["article","gallery","collection-article","single-column-article","longform","video-article"].includes(e)&&t&&Promise.all([fe(t),le(t),ue(t),ce(t),ge(t,n)]).then(([i="",a="",l="",c="",w=""])=>_({[g.AD_BLOCKER]:i,[g.NOUN_KEYWORDS]:a,[g.NOUN_CATEGORIES]:l,[g.NOUN_ENTITIES]:c,[g.NOUN_TAGS]:w})).catch(i=>{s(i)})}const A={gamNetworkCode:"21801468956",dynamicallyInsertScripts:!1,googlePublisherTags:{adRefreshInterval:3e4,lazyLoad:!0,enableSingleRequestMode:!0,disableInitialLoad:!0,sizeMap:[[p.Large,[[970,250]]],[p.Medium,[[160,600],[728,90]]],[p.Small,[[1,1],[300,50],[300,250],[300,600],[320,50],[336,280]]]],viewPortBreakPoints:[p.Large,p.Medium,p.Small]},bidding:{enabled:!0,amazon:{enabled:!0,deals:!0,config:{pubID:"3928",adServer:"googletag",videoAdServer:"DFP",simplerGPT:!0,bidTimeout:2e3,cmpTimeout:2e3,deals:!0}},prebid:{enabled:!0,config:{magniteId:"20996"}}}};let N,h;function T(){const{section:e="",contentType:t=""}=h;return`/${N}/${S?y.Mobile:y.Desktop}/${e}/${t}`}return{init(e={}){const{gamNetworkCode:t=A.gamNetworkCode,pageLevelTargeting:n={},googlePublisherTags:o=A.googlePublisherTags,bidding:i=A.bidding}=e,a=L(),{testads:l}=a;N=t,h={...n,...l&&{test:l}},de(i),G(o,h),J(),Z({dynamicallyInsertScript:!0});const{cid:c,contentType:w,tags:u}=h;pe({contentId:c,contentType:w,tags:u})},defineAd({id:e,sizes:t,adUnitPath:n=T(),slotLevelTargeting:o={}}){this.defineAds([{adUnitPath:n,id:e,sizes:t,slotLevelTargeting:o}])},defineAds(e){const t=e.map(n=>{var o;return{...n,adUnitPath:(o=n.adUnitPath)!=null?o:T()}});C(t),Y()},defineOutOfPageAd({id:e,adUnitPath:t=T(),slotLevelTargeting:n={},addElement:o=!0}){q({id:e,slotLevelTargeting:n,addElement:o,adUnitPath:t})},getPageLevelAdTargetingKeyVals(){return z()},getQualityTargeting(e,t){W(e,t)},addEventListener:(e,t)=>{M(e,t)}}});
