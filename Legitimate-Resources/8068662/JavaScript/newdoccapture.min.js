var LPQDocCapture=function(){return function(n){function h(n,i){var u=null,f,r,e;t.docTitleOptions!=null&&t.docTitleOptions.length>0&&(f=_.uniqBy(t.docTitleOptions,"Title"),u=$("<div />",{"class":"col-xs-12 divFooterImageRight "+(t.docTitleOptions.length==1?"hidden ":""),style:"padding:0px;10px;"}).append($("<div />",{"class":"divFooterImageRight-left"}).append($("<div />",{style:"float: left;width: 90%;"}).append($("<select />",{"data-role":"none",id:t.prefix+"ddlUploadDoc"+i,"class":"ddlUploadDoc-style",style:"width: 90%"}).append($.map(f,function(n){return $("<option />",{value:/PLEASE\s+SELECT/i.test(n.Title)?"":n.Title}).text(n.Title)}))),$("<span />",{style:"float: right;width: 10 %;","class":t.requireDocTitle?"RequiredIcon":""}))));r="col-lg-3 col-md-4 col-sm-6 ";$("#"+t.prefix+"hdOneColumnLayout").val().toUpperCase()==="Y"&&(r="");e=$("<div />",{"class":r+"col-xs-12 text-center",style:"height:330px; margin-top:20px;",id:t.prefix+"divImage_"+i}).append($("<div />",{style:"height:230px;width:100%;","class":"img-thumbnail"}).append(/\.pdf$/i.test(n)?$("<label />",{style:"-moz-word-break: break-all;-o-word-break: break-all;word-break: break-all;margin:0;max-height:220px;",id:t.prefix+"image_"+i,"class":"img-responsive fileupload-new divImage"}).text(n):$("<img />",{id:t.prefix+"image_"+i,"class":"img-responsive fileupload-new divImage",style:"max-height:220px;",src:n})),$("<div />",{"class":"divFooterImage row"}).append($("<div />",{"class":"col-xs-12 divFooterImageLeft Button",id:t.prefix+"divButton_"+i}).append($("<button />",{"data-role":"none","class":"btn btn-sm btn-primary footer-theme btnRemove UploadDocBtn-style",type:"button",id:t.prefix+"btnRemove_"+i}).text("Remove")),u),"<br />");$("#"+t.prefix+"divImage").append(e);$("#"+t.prefix+"ddlUploadDoc"+i).observer({validators:[function(){return t.requireDocTitle==!0&&Common.ValidateText($(this).val())===!1?"Please select title":""}],validateOnBlur:!0,group:t.prefix+"ValidateUploadDocs"});$.lpqValidate.hideValidation("#"+t.prefix+"divDocCaptureMessage")}function l(n,t){var i=new window.FileReader;i.readAsText(n);i.onload=function(n){var i=n.target.result,r=0,u;i=i.substr(0,15);/PDF-([0-9].[0-9]*)/.test(i)==!0&&(u=/PDF-([0-9].[0-9]*)/.exec(i)[1],r=parseFloat(u));$.isFunction(t)&&t(r)}}function a(n){var e=n.replace(/^\w+_/g,""),o=t.prefix+"btnRemove_"+e,f,s,i;if(n==o){for(f=n.replace("btnRemove","image"),s=n.replace("btnRemove","divImage"),i=0;i<r.length;i++)f==r[i].imageID&&(r.splice(i,1),$("#"+f).remove(),$("#"+o).remove(),$("#"+s).remove());$.lpqValidate.removeValidationItem(t.prefix+"ValidateUploadDocs",t.prefix+"ddlUploadDoc"+e);u.validateUploadDocument()}}function o(n,t,i,r){this.base64data=n;this.imageID=t;this.fileName=i;this.fileSize=r}function c(){var n=navigator.userAgent;return!((n.indexOf("MSIE")>0||n.indexOf("Trident")>0||n.indexOf("Edge")>0)&&parseFloat($.browser.version)<10)}function v(n,i,r,u){var s=document.getElementById(t.prefix+"image_"+n),e=document.createElement("canvas"),h=e.getContext("2d"),f=new Image;f.src=i;f.onload=function(){var i=f.width,c=f.height,g=i*c,y=2097152,nt=i/c,p=0,d=0,w,a,l,v,b,k;for(g>y&&(p=Math.sqrt(y*nt),d=y/p,i=Math.floor(p),c=Math.floor(d)),e.width=i,e.height=c,h.drawImage(f,0,0,i,c),w=1,v=null,b=0;b<100;b++){if(k=parseFloat(w.toFixed(2)),l=e.toDataURL("image/jpeg",k),a=(l.length-23)*3/4096,a<800){s.src=l;v=new o(l,t.prefix+"image_"+n,r,a);break}else if(k<.4){v=new o(l,t.prefix+"image_"+n,r,a);break}w-=.02}u(v)}}function s(n){if(n!="")if($("#divErrorPopup").length>0)$("#errorTitle").text("Document Upload"),$("#txtErrorPopupMessage").html(n),$("#divErrorPopup").popup("open",{positionTo:"window"});else{$("#errorTitle").text("Document Upload");var t=$("#divErrorDialog");$("#txtErrorMessage").html(n);t.length>0&&$.mobile.changePage(t,{transition:"slide",reverse:!1,changeHash:!0})}}var u=this,r=[],i=0,t=$.extend({},{prefix:"",requireDocTitle:!0,docTitleOptions:[],oneColumnLayout:!1,requireDocUpload:!1},n),e=!0,f=!1;$("#"+t.prefix+"imagePlaceHolder").on("click",function(){c()?e?f||$("#"+t.prefix+"image-thumbnail").trigger("click"):(f&&(f=!1,$("#"+t.prefix+"image-thumbnail").trigger("click")),e=!0):s("Please update this IE browser to a newer version. Picture upload feature is not available for IE browser version < 10.")});$("#"+t.prefix+"imagePlaceHolder").parent().on("keydown",function(n){n.which==13&&$("#"+t.prefix+"imagePlaceHolder").trigger("click")});$("#"+t.prefix+"DocUploadSrcSelector").on("pagehide",function(){$("html, body").stop().animate({scrollTop:$("#"+t.prefix+"divDocCaptureMessage").offset().top-100},"500","swing")});if(qDATA.camera=="true"&&"mediaDevices"in navigator&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.enumerateDevices&&!isMobile.any())navigator.mediaDevices.enumerateDevices().then(function(n){var s="",u;n!=null&&n.length>0&&_.forEach(n,function(n){if(n.kind=="videoinput"&&!/\s(IR)\s/i.test(n.label)&&/\s(Rear|Back)/i.test(n.label))return s=n.deviceId,!1});u=$("#"+t.prefix+"DocUploadSrcSelector");$("div[data-command='upload']",u).on("click",function(){$.mobile.back();setTimeout(function(){$("#"+t.prefix+"btnFileCamera").trigger("click")},100)});$("div[data-command='capture']",u).on("click",function(){navigator.mediaDevices.getUserMedia({video:{deviceId:s}}).then(function(n){$("div.capture-stream video",u)[0].srcObject=n}).catch(function(){navigator.mediaDevices.getUserMedia({video:!0}).then(function(n){$("div.capture-stream video",u)[0].srcObject=n}).catch(function(){$("div.capture-stream",u).removeClass("active")})});$("div.capture-stream",u).addClass("active")});$("div.capture-stream .close-btn",u).on("click",function(){var n=$("div.capture-stream video",u)[0];$.each(n.srcObject.getVideoTracks(),function(n,t){t.stop()});$("div.capture-stream",u).removeClass("captured active")});$("div.capture-stream .control-btns .capture-btn",u).on("click",function(){var n=$("div.capture-stream canvas",u)[0],t=$("div.capture-stream video",u)[0];n.width=t.videoWidth;n.height=t.videoHeight;n.getContext("2d").drawImage(t,0,0);$("div.capture-stream img",u)[0].src=n.toDataURL();$("div.capture-stream",u).addClass("captured")});$("div.capture-stream .control-btns .cancel-btn",u).on("click",function(){$("div.capture-stream",u).removeClass("captured")});$("div.capture-stream .control-btns .continue-btn",u).on("click",function(){setTimeout(function(){var s,n,c,l;i++;s=$("div.capture-stream canvas",u)[0];n=s.toDataURL();h(n,i);c="data:image/png;base64,";l=Math.round((n.length-c.length)*3/4);r.push(new o(n,t.prefix+"image_"+i,"camera"+i,l));$.mobile.loading("hide");f=!0;e=!1;$("div.capture-stream",u).removeClass("captured active");$.mobile.back()},100);$.mobile.loading("show",{theme:"a",text:"Scanning ... please wait",textonly:!0,textVisible:!0});var n=$("div.capture-stream video",u)[0];$.each(n.srcObject.getVideoTracks(),function(n,t){t.stop()})});$("#"+t.prefix+"image-thumbnail").on("click",function(){goToNextPage("#"+t.prefix+"DocUploadSrcSelector")})}).catch(function(){$("#"+t.prefix+"image-thumbnail").on("click",function(){$("#"+t.prefix+"btnFileCamera").trigger("click")})});else $("#"+t.prefix+"image-thumbnail").on("click",function(){$("#"+t.prefix+"btnFileCamera").trigger("click")});$("#"+t.prefix+"divImage").on("click",function(n){a(n.target.id)});$("#"+t.prefix+"btnFileCamera").change(function(n){var a;if($(this).val()!=undefined&&$(this).val()!="")if(c)if(a=$(this).val(),a=a.substring(a.lastIndexOf("\\")+1,a.length),/\.(pdf|jpeg|jpg|gif|png)$/i.test($(this).val())){i++;$.mobile.loading("show",{theme:"a",text:"Uploading ... please wait",textonly:!0,textVisible:!0});var y=n.target.files[0],p=URL.createObjectURL(y),w=parseInt(y.size,10)/1024,b=function(n){r.push(n);$.mobile.loading("hide");f=!0;e=!1},k=new Image;k.src=p;/\.pdf$/i.test(a)?l(y,function(n){if(n>=1.4){h(a,i);var r=new window.FileReader;r.readAsDataURL(y);r.onloadend=function(){var n=r.result;b(new o(n,t.prefix+"image_"+i,a,w))}}else $.mobile.loading("hide"),s("We don't support PDF version below 1.4. Please convert your file to version 1.4 or above and try again.")}):setTimeout(function(){if(k.naturalHeight!=0&&k.naturalWidth!=0)if(h(p,i),w>800)v(i,p,a,b);else{var n=new window.FileReader;n.readAsDataURL(y);n.onloadend=function(){var r=n.result;b(new o(r,t.prefix+"image_"+i,a,w))}}else s("The file '"+a+"' content is invalid. Please check the input file."),u.validateUploadDocument()},100);$.mobile.loading("hide")}else s("The file '"+a+"' is invalid. Please check the input file.");else s("Please update this IE browser to a newer version.  Picture upload feature is not available for IE browser version < 10.");$("#"+t.prefix+"fileupload-container").fileupload("clear")});u.validateUploadDocument=function(){var u=!0,o,n,i,f,e,s;if(r.length>0){if(o=0,n=$.map(Object.keys(window),function(n){var t="docUploadObj";if(n.indexOf(t,n.length-t.length)!==-1)return n}),n!=null)for(i=0;i<n.length;i++){if(window[n[i]]!=null&&(f=window[n[i]].getDocArray(),f!=null&&f.length>0))for(e=0;e<f.length;e++)o+=f[e].fileSize;if(t.prefix==null||t.prefix==""||n[i].startsWith(t.prefix))break}$.lpqValidate(t.prefix+"ValidateUploadDocs")==!1&&(u=!1);o>12e3?($.lpqValidate.showValidation("#"+t.prefix+"divDocCaptureMessage","Please reduce total file size to less than 12MB."),u=!1):$.lpqValidate.hideValidation("#"+t.prefix+"divDocCaptureMessage")}else t.requireDocUpload==!0?(s=$("#"+t.prefix+"hdnPrevUploadeddocLength").val(),!!getParaByName("loanid")==!1&&($.lpqValidate.showValidation("#"+t.prefix+"divDocCaptureMessage","Please upload your document(s)."),u=!1),!!getParaByName("loanid")==!0&&s=="N"&&($.lpqValidate.showValidation("#"+t.prefix+"divDocCaptureMessage","Please upload your document(s)."),u=!1)):$.lpqValidate.hideValidation("#"+t.prefix+"divDocCaptureMessage");return u};u.updateSettings=function(n){n.title.length>0&&$("#"+t.prefix+"divDocCaptureWrapper").find("div.sub_section_header:first-child div.section-title").html(htmlDecode(n.title));t=$.extend({},t,n,{prefix:t.prefix});r=[];i=0;e=!0;f=!1;$("#"+t.prefix+"divImage").html("");$.lpqValidate.removeValidationGroup(t.prefix+"ValidateUploadDocs")};u.setUploadDocument=function(n){if(r.length==0)return n;n==null&&(n={});n.hasOwnProperty("sDocArray")||(n.sDocArray=[],n.sDocInfoArray=[]);var i=n.sDocArray.length;$.each(r,function(r,u){var f=u.fileName,o,e;f.length>20&&(f=".."+f.substring(f.length-20));f="("+(i+r+1)+")"+f;n.sDocArray.push({title:f,base64data:u.base64data});t.docTitleOptions!=null&&t.docTitleOptions.length>0?(o=$("#"+t.prefix+u.imageID.replace(/^\w+_/g,"ddlUploadDoc")).val(),e=_.filter(t.docTitleOptions,{Title:o}),(typeof e=="undefined"||e.length==0)&&(e=[{Title:"",Group:"",Code:"",LoanType:""}]),e.forEach(function(t){n.sDocInfoArray.push({docTitle:t.Title,docGroup:t.Group,docCode:t.Code,docLoanType:t.LoanType,docFileName:f})})):n.sDocInfoArray.push({docTitle:"",docGroup:"",docCode:"",docLoanType:"",docFileName:f})})};u.getDocArray=function(){return r}}}();