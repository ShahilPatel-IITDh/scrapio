"use strict";var dla=window.dla||{};const MAX_DISPLAYED_MESSAGES=25,MATCH_VARIABLES_REGEXP=/\[\[(.*?)\]\]/g,DELETE_TIMEOUT_SECONDS=7;dla.richInboxStore=function(){let e,t={};const s={_cache:[],_prevCache:[],backup(){this._prevCache=this._cache.slice()},restoreBackup(){this._cache=this._prevCache.slice()},update(e){this._cache=e},markMessageAsRead(e){this._cache.forEach(t=>{t.id===e&&(t.read=1)})},deleteMessage(e){this._cache=this._cache.filter(t=>t.id!==e)},getMessageCount(){return{unread:this._cache.reduce((e,t)=>t.read?e:e+1,0),total:this._cache.length}}};function r(e,t){window.dispatchEvent(new CustomEvent(e,{detail:t}))}function a(e){return Promise.all(Array.from(e).map(e=>function(e){return Promise.all([n(e.sline),n(e.content)]).then(t=>{const s=Object.assign({},e);return s.sline=t[0],s.content=t[1],s})}(e)))}function n(e){let s=e||"";const r=function(e){return(e.match(MATCH_VARIABLES_REGEXP)||[]).map(e=>e.replace("[[","").replace("]]","").trim())}(s);return Promise.all(r.map(e=>{return s=e,new Promise(e=>{if(t.hasOwnProperty(s))e(t[s]);else if("firstname"===s){const r=window.dla.resources.firstname||ll&&ll.webComponentConfig&&ll.webComponentConfig.dlaResources.firstName||"";e(r),t[s]=r}else s.startsWith("jackpot_")?function(e){const t=dla.resources.requestPrefix||"";return new Promise((s,r)=>{$.ajax({type:"GET",url:t+"/api/drawings/"+e+"?currency="+dla.resources.currency,dataType:"json"}).done((function(e){if(e&&e.next){const t=e.next.specialMarketingJackpot||e.next.marketingJackpot||e.next.jackpot;s(t)}else r()})).fail((function(){r()}))})}(s.replace("jackpot_","")).then(r=>{const a=dla.helper.formatJackpot(r);e(a),t[s]=a}).catch(()=>e(dla.helper.formatJackpot(0))):e("{{"+s+"}}")});var s})).then(e=>(r.forEach((t,r)=>{s=s.replace("[["+t+"]]",e[r])}),s))}function o(){return new Promise(e=>{new Promise(e=>{window._ol("rims.getNewMessages",{limit:25},t=>{e(t)})}).then(()=>{window._ol("rims.getMessages",t=>{a(function(e){return e.reduce((e,t)=>(e.some(e=>e.id===t.id)||e.push(t),e),[])}(t).slice(0,25)).then(t=>{s.update(t),r("ll-rich-inbox-store-getMessages",t),e(t)})})})})}return{getMessages:o,setPollingInterval:function e(s){const r=1e3*s;void 0===window._ol.q&&dla.resources.playerNr?(dla.resources.playerNr?o():$(window).on("otherLevelsTrackingIdSet",()=>{t={},o()}),setInterval(o,r)):setTimeout(()=>{e(r)},1e3)},getMessageCount:()=>s.getMessageCount(),markMessageAsRead(e){s.markMessageAsRead(e),window._ol("rims.markAsRead",e),r("ll-rich-inbox-store-markAsRead",e)},deleteMessage(e){s.deleteMessage(e),window._ol("rims.markAsDeleted",e),r("ll-rich-inbox-store-markAsDeleted",e)},trackOpenMessage(e){_ol("setPhash",e,()=>{_ol("registerEvent","msgOpen","userAction")})},trackCta(){_ol("registerEvent","ctaClick","userAction")},getVarsCache:()=>Object.assign({},t),clearVarsCache(){t={}},markMessagesAsRead(e){e.forEach(e=>{s.markMessageAsRead(e),window._ol("rims.markAsRead",e)}),r("ll-rich-inbox-store-markAsReadMultiple",e)},deleteMessages(t){s.backup(),t.forEach(e=>{s.deleteMessage(e)}),e=setTimeout(()=>{t.forEach(e=>{window._ol("rims.markAsDeleted",e)}),r("ll-rich-inbox-store-confirmedDeletedMultiple",t)},7e3),r("ll-rich-inbox-store-markAsDeletedMultiple",t)},undoDeleteMessages(){clearTimeout(e),s.restoreBackup(),r("ll-rich-inbox-store-restoreBackup")}}}(),$(window).trigger("available","richInboxStore");