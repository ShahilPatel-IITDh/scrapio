// Deep Link Component

$(document)
.ready(function() {
	//window.addEventListener("load", function() {
		if($('.deeplinkonload').length==1){
			$('html, body').animate({
		        scrollTop: $('.deeplinkonload').offset().top - $(".site-header").height()
		    }, 'slow');	
		}
		if($('.deeplinkonload').length>1){
			console.log("Deep Link : Multiple onLoad scroll in same page.");
		}
		
		if(($('.deeplinkonload').length==0) && ($('.url-deeplink-class').length>0)){
			var target = window.location.hash;
			target = target.replace('#', '');		
			if(target && $('[name="'+target+'"]').length>0){
				$('html, body').animate({
					scrollTop: $('[name="'+target+'"]').offset().top - $(".site-header").height()
				}, 'slow');
			}
		}
		$('[href^="#"]').not('.skip-links').click(function(e) {
		    e.preventDefault();
		    var deepValue = $(this).attr('href');
			deepValue = deepValue.replace('#', '');
			 if($('[name="'+deepValue+'"]').length >0) {
				$('html, body').animate({
					scrollTop: $('[name="'+deepValue+'"]').offset().top - $(".site-header").height()
				}, 'slow');
			 }
					
		});
	//});

})

.on("click", ".ctaHashtagClass", function(e){
	
	var targetUrlhash = $(this).attr('data-cta-link');
	if (typeof targetUrlhash === 'undefined') {
		var targetUrlhash = $(this).attr('href');
	}
	
    var targethash = targetUrlhash.replace('#', ''),
        goTarget = targetUrlhash.split('#')[1],
        goTargetVar = $('[name="'+goTarget+'"]');
    if(targethash){
      if (goTargetVar.length) {
        $('html, body').animate({
            scrollTop: $('[name="'+goTarget+'"]').offset().top - $(".site-header").height()
        }, 'slow');
        checkMobileClk()
      }
    }
});

function checkMobileClk() {
  setTimeout(function(){
    if ($(".mobile-nav-hamburger.close").length)
      $(".mobile-nav-hamburger.close").click();
  }, 200);
}

//ACCESS DEEPLINK COMPONENT EXTERNALLY
$(window).bind("load", function () {

  if(window.location.hash){
   if ($(window.location.hash).length)

    $('html, body').animate({
      scrollTop: $(window.location.hash).offset().top - $(".site-header").height()
    }, 'slow');

  }

})
var cardAnimate = document.createElement("style");
//cardAnimate.innerHTML = "[data-animation] {-webkit-animation-duration: 1s; animation-duration: 1s; -webkit-animation-fill-mode: both; animation-fill-mode: both;opacity: .30;-webkit-transition:all .6s ease-in-out; transition:all .6s ease-in-out;}"
//    + "@keyframes cardFadeIn{0%{opacity:.30;} to{opacity:1}} .cardFadeIn{ -webkit-animation-name:cardFadeIn;animation-name:cardFadeIn;}"
//   + "@keyframes cardFadeInBottomRight {0% {opacity:0; -webkit-transform: translate3d(20px, 40px, 0); transform: translate3d(20px, 40px, 0);} to {opacity: 1; -webkit-transform: translateZ(0); transform: translateZ(0);}}"
//  + "img[data-animation]{opacity:0}"
//  + ".cardFadeInBottomRight {-webkit-animation-name: cardFadeInBottomRight; animation-name: cardFadeInBottomRight;}"
cardAnimate.innerHTML = "a>span>.svg-hover-push {margin-left:10px; transition: all .3s ease;} a:hover .svg-hover-push {margin-left:15px}"
                      + ".card-footer .btn {white-space: normal;text-align: center;}";
document.getElementsByTagName("head")[0].appendChild(cardAnimate);

//IOS CSS
if (navigator.userAgent.match(/(iPad|iPhone)/g)) {
  var iosCss = document.createElement("style");
    iosCss.innerHTML = ".card button.btn {display:-webkit-box;}"
      + "@media (max-width:767px) {.card:not(.full-bleed) .card-img>img {object-fit: cover; transform: scale(.88); transform-origin: 100% 100%;} }"
      + ".cmp-column--image > img {align-self: center;}";
    document.getElementsByTagName("head")[0].appendChild(iosCss);
}

//IS SAFARI
if (navigator.userAgent.indexOf("Safari") != -1) {
 var safariCss = document.createElement("style");
     safariCss.innerHTML = ".card .card-img {flex-direction: row;}"
                         + ".card .card-img>img {height: auto;width: auto;}"
                         + ".card-footer .btn:not(.link) {min-height: 60px}";
     document.getElementsByTagName("head")[0].appendChild(safariCss);
}

//IE11 WRAPPING DIV BUG
if (/MSIE \d|Trident.*rv:/.test(navigator.userAgent)) {
  var ieCRDcss = document.createElement("style");
      ieCRDcss.innerHTML = ".xf-content-height {width: 100%;}"
                         + ".card:not(.card-inset) .card-title {white-space: normal;}"
                         + ".card:not(.card-inset) .card-title > a {width:100%}";
      document.getElementsByTagName("head")[0].appendChild(ieCRDcss);
}

//IE EDGE
if(/MSIE \d|Trident.*rv:/.test(navigator.userAgent) || navigator.userAgent.indexOf("Edge/15.15063") > -1) {

  // IE 11 FIX - FOREACH
  if (typeof Array.prototype.forEach != 'function') {
    Array.prototype.forEach = function (callback) {
      for (var i = 0; i < this.length; i++) {
        callback.apply(this, [this[i], i, this]);
      }
    };
  }
  if (window.NodeList && !NodeList.prototype.forEach) {
    NodeList.prototype.forEach = Array.prototype.forEach;
  }

}

//PRIMARY CARD IMAGE
//INIT ANIMATION ON SCROLL
function primaryImage() {
  if (document.querySelectorAll('.card-primary-grow')[0]) {

    document.querySelectorAll('.card-primary-grow').forEach(function(item) {
      item.setAttribute("style", "background-image: url("+item.getAttribute('data-img')+")")
    })

  }
}
document.addEventListener('DOMContentLoaded', primaryImage);

/*
//INIT ANIMATION ON SCROLL
function sectionScroll() {

	try
	{
		document.querySelectorAll('.card[data-module-id]').forEach(function(item) {
	        var itemPosition = item.getBoundingClientRect().top,
	            itemPositionPercent = (itemPosition / window.innerHeight) * 100;

              item.querySelectorAll('.card-img>img').forEach(function(itmImg) {
                itmImg.setAttribute("data-animation", "cardFadeInBottomRight")
              })

	        if (itemPositionPercent <= 60) {

	            item.querySelectorAll('[data-animation]').forEach(function(itm) {
	                itm.classList.add(itm.getAttribute("data-animation"))
	            })

	        }
	    })
	}catch(e)
	{
		console.log("card-animation- sectionScroll"+e);
	}

}
window.addEventListener("scroll", sectionScroll);
document.addEventListener('DOMContentLoaded', sectionScroll);
*/

//MEDIA QUERY
var cardResize = function() {

  function cardLink() {
    $(".card-inset-mobile").each(function() {
      var link = $(this).find(".card-title span > a").attr("href");

     	if(typeof link !== 'undefined'){
          var aUrl = link.split('/'),
          aLabel = aUrl.pop() || aUrl.pop(),
          aRiLabel = aLabel.replace(/-/g, ' ');

          if (!$(this).find("header > p .js-disclaimer-link").length) {
            $(this).wrap("<a class='inset-card-link full-width' href='"+ link +"' aria-label='"+aRiLabel+"'></a>");
          }
    	}
    });
  }

  //DESKTOP MAX-WIDTH: 767PX
  if (window.matchMedia("(max-width: 767px)").matches) {

    $(".card-inset").addClass("card-inset-mobile");
    if (!$(".inset-card-link>.card-inset").length)
      cardLink()

  } else {

    $(".card-inset").removeClass("card-inset-mobile")

    $(".card-inset").each(function() {
      //if ($(".inset-card-link>.card-inset").length)
      if ($(this).parent().hasClass("inset-card-link")) {
        $(this).unwrap()
      }

    });

  }

}
cardResize()
window.addEventListener("resize", cardResize);

//REMOVE CONTENT FRAGMENT &nbsp; FROM ALL CARDS
$(window).bind("load",function() {

  setTimeout(function(){
    $('.card footer .product-price').each(function(){
      if ($(".product-price del").length)
        $(this).html($(this).html().replace(/&nbsp;/gi,''));
    });
  }, 350);

  //MAKE ARROW PART OF LAST WORD
  $('.card:not(.card-inset) .card-title a').each(function() {
    var $this = $(this);
    $this.html($this.html().replace(/(\S+)\s*$/, '<span class="flex-center inline-flex">$1<svg class="svg-hover-push" width="6" height="10" viewBox="0 0 6 10" fill="none" xmlns="http://www.w3.org/2000/svg" style="min-width: 10px;" aria-hidden="true" focusable="false">'
    +'<path class="icon-stroke" d="M0.999999 1L5 5L1 9" stroke="#262626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>'
    +'</svg></span>'));
  });

  //REMOVE AEM SPACING
  $(".card-title a").each(function(){
    $(this).html($(this).html().replace(/^\s+|\r\n|\n|\r|(>)\s+(<)|\s+$/gm, '$1$2'));
  });

});
$(function () {
    var showLocationFlagArr = $('.showLocationFlag').map(function(){
        return $(this).val()
    }).get();
    var showLocationFlag = showLocationFlagArr.includes('true');
    if (showLocationFlag && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            if (position && position.coords.latitude && position.coords.longitude) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;  
                //console.log("latitude="+lat+" longitude="+lng);
                const latlng = {
                    lat: parseFloat(lat),
                    lng: parseFloat(lng),
                };
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'latLng': latlng }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        if (results[0]) {
                            const geoLocation = results[0].formatted_address;
                            //console.log("Location: " + geoLocation);
                            $('.intro-text-location-address').text(geoLocation);
                            $('.intro-text-geo-location').removeClass('hide');
                        }else {
                      		console.log("No results found");
                    	}
                    }else {
                    	console.log("Geocoder failed due to: " + status);
                  	}
           		});
            }
        });
    }
});
$(function () {
  var ctaTarget;
  $("[data-globalmodal]")
    .off("click")
    .on("click", function (e) {
      var $targetPop = $("#modal-" + this.dataset.globalmodal);

      ctaTarget = e.target;

      var _jsModalId = "modal-" + this.dataset.globalmodal;
      _jsModalId = _jsModalId.replace(/-/g, "");
      var jsModalId = _jsModalId.valueOf();

      var jsModalId = window[_jsModalId];

      // ADA UPDATE to trap focus inside modal -- start
      focusModalElements($targetPop, false);
      // ADA UPDATE to trap focus inside modal -- end

      $(this).attr("aria-expanded", "true");
      $targetPop.addClass("popup");
      $("html").addClass("scroll");
      setTimeout(function () {
        $targetPop.find(".modal-close").focus();
      }, 100);
      setTimeout(function () {
        try {
          if (jsModalId) {
            modalAnalytics(jsModalId);
          }
        } catch (e) {
          console.log("Analytics for modal failed : " + e);
        }
      }, 500);
    });
  $("[data-globalmodalclose]")
    .off("click")
    .on("click", function () {
      try {
        var $target = $("#modal-" + this.dataset.globalmodalclose);
        $target.removeClass("popup");
        $("html").removeClass("scroll");
        $(ctaTarget).focus();
        $("[data-globalmodal=" + "'" + this.dataset.globalmodalclose + "']").attr("aria-expanded", "false");
        $("html,body").animate(
          {
            // scrollTop: $("[data-globalmodal=" + "'" + this.dataset.globalmodalclose + "']").offset().top - 350,
            scrollTop: $(ctaTarget).offset().top - 350,
          },
          {
            complete: function () {
              ctaTarget = null;
            },
          }
        );
      } catch (e) {}

      try {
        if (jsModalId) {
          modalAnalyticsReset();
        }
      } catch (e) {
        console.log("Default page load failed : " + e);
      }
    });

  $(".modal-overlay .modal-tool-open").on("click", function () {
    setTimeout(function () {
      $(".modal-close").click();
    }, 0);
  });

	// ADA UPDATE to trap focus inside page load modal -- start
	var pageloadModal = $('.pageload-modal');
	if(pageloadModal.length > 0){
		focusModalElements(pageloadModal, true);
	}
	// ADA UPDATE to trap focus inside page load modal -- end

  if (navigator.userAgent.match(/(iPad|iPhone)/g)) {
    var iosCss = document.createElement("style");
    iosCss.innerHTML =
      "@media (max-width:767px) {div.modal-overlay.modal-upsell .modal#upsell-modal .container .content .content-image {width:100%;} .content-image>img {object-fit: cover; transform: scale(.68); transform-origin: 100% 100%;} }";
    document.getElementsByTagName("head")[0].appendChild(iosCss);
  }
});
var focusModalElements = function focusModalElements(targetModal, isPageLoadModal){
      var focusableElements =
        'button, input:not([type="hidden"]), a[href], select, textarea, [tabindex]:not([tabindex="-1"])';
      var modal = targetModal[0]; // select the modal by it's id

      var firstFocusableElement = modal.querySelectorAll(focusableElements)[0]; // get first element to be focused inside modal
      var focusableContent = modal.querySelectorAll(focusableElements);
      var lastFocusableElement = focusableContent[focusableContent.length - 1]; // get last element to be focused inside modal

      document.addEventListener("keydown", function (e) {
        let isTabPressed = e.key === "Tab" || e.keyCode === 9;

        if (!isTabPressed) {
          return;
        }

        if (e.shiftKey) {
          if (document.activeElement === firstFocusableElement) {
            lastFocusableElement.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastFocusableElement) {
            firstFocusableElement.focus();
            e.preventDefault();
          }
        }
      });

    if(isPageLoadModal){
        lastFocusableElement.focus();
    } else {
        firstFocusableElement.focus();
    }
}

var modalAnalytics = function modalAnalytics(jsModalId) {
  if (jsModalId) {
    /*HRBData.digital_data.page_section = jsModalId.page_section;
    HRBData.digital_data.page_sub_section = jsModalId.page_sub_section;
    HRBData.digital_data.page_title = jsModalId.page_title;
    HRB.analytics.callRule("page_load");*/
	var contextData = {
			'page_section': jsModalId.page_section,
			'page_sub_section': jsModalId.page_sub_section,
			'page_title': jsModalId.page_title
		};
		callAnalytics('page_load', contextData);


  }
};

/*if (HRBData && HRBData.digital_data) {
  this.defaultPageSection = HRBData.digital_data.page_section;
  this.defaultSubSection = HRBData.digital_data.page_sub_section;
  this.defaultPageTitle = HRBData.digital_data.page_title;
}

var modalAnalyticsReset = function modalAnalyticsReset() {
  if (HRBData && HRBData.digital_data) {
    HRBData.digital_data.page_section = this.defaultPageSection;
    HRBData.digital_data.page_sub_section = this.defaultSubSection;
    HRBData.digital_data.page_title = this.defaultPageTitle;
  }
};*/

