var Un=Object.create;var Ho=Object.defineProperty;var Zn=Object.getOwnPropertyDescriptor;var Xn=Object.getOwnPropertyNames;var Jn=Object.getPrototypeOf,Yn=Object.prototype.hasOwnProperty;var Qn=(e,t)=>()=>(e&&(t=e(e=0)),t);var ei=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ti=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Xn(t))!Yn.call(e,n)&&n!==o&&Ho(e,n,{get:()=>t[n],enumerable:!(r=Zn(t,n))||r.enumerable});return e};var oi=(e,t,o)=>(o=e!=null?Un(Jn(e)):{},ti(t||!e||!e.__esModule?Ho(o,"default",{value:e,enumerable:!0}):o,e));var s=Qn(()=>{});var an=ei((op,sn)=>{"use strict";s();sn.exports=function(t){var o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=void 0,i=void 0,l=void 0,c=[];return function(){var g=As(o),h=new Date().getTime(),C=!n||h-n>g;n=h;for(var L=arguments.length,p=Array(L),m=0;m<L;m++)p[m]=arguments[m];if(C&&r.leading)return r.accumulate?Promise.resolve(t.call(this,[p])).then(function(b){return b[0]}):Promise.resolve(t.call.apply(t,[this].concat(p)));if(i?clearTimeout(l):i=_s(),c.push(p),l=setTimeout(u.bind(this),g),r.accumulate){var y=c.length-1;return i.promise.then(function(b){return b[y]})}return i.promise};function u(){var d=i;clearTimeout(l),Promise.resolve(r.accumulate?t.call(this,c):t.apply(this,c[c.length-1])).then(d.resolve,d.reject),c=[],i=null}};function As(e){return typeof e=="function"?e():e}function _s(){var e={};return e.promise=new Promise(function(t,o){e.resolve=t,e.reject=o}),e}});s();s();s();var he=e=>e!==void 0;var Ye=(e,t)=>{let o=e;return r=>(he(r)&&(o=r,t(r)),o)};var Io=e=>{let t;return()=>(t===void 0&&(t=e()),t)};var ri={Accept:"application/vnd.lichess.v5+json"},No={cache:"no-cache",credentials:"same-origin"},Fo={"X-Requested-With":"XMLHttpRequest"},Ro=e=>{if(e.ok)return e;throw e.status==429?new Error("Too many requests"):e.status==413?new Error("The uploaded file is too large"):new Error(`Error ${e.status}`)};var Me=(e,t={})=>ni(e,t).then(o=>Ro(o).json()),ni=(e,t={})=>fetch(e,{...No,headers:{...ri,...Fo},...t}),W=(e,t={})=>Dt(e,t).then(o=>Ro(o).text()),Dt=(e,t={})=>fetch(e,{...No,headers:{...Fo},...t});var ee=e=>{let t=new FormData;for(let o of Object.keys(e))he(e[o])&&t.append(o,e[o]);return t},Te=(e,t)=>{let o=new URLSearchParams;for(let n of Object.keys(t))he(t[n])&&o.append(n,t[n]);let r=o.toString();return r?`${e}?${r}`:e};s();s();s();s();s();function ii(e,t){return document.createElement(e,t)}function si(e,t,o){return document.createElementNS(e,t,o)}function ai(){return le(document.createDocumentFragment())}function li(e){return document.createTextNode(e)}function ci(e){return document.createComment(e)}function di(e,t,o){if(te(e)){let r=e;for(;r&&te(r);)r=le(r).parent;e=r!=null?r:e}te(t)&&(t=le(t,e)),o&&te(o)&&(o=le(o).firstChildNode),e.insertBefore(t,o)}function pi(e,t){e.removeChild(t)}function ui(e,t){te(t)&&(t=le(t,e)),e.appendChild(t)}function Vo(e){if(te(e)){for(;e&&te(e);)e=le(e).parent;return e!=null?e:null}return e.parentNode}function mi(e){var t;if(te(e)){let o=le(e),r=Vo(o);if(r&&o.lastChildNode){let n=Array.from(r.childNodes),i=n.indexOf(o.lastChildNode);return(t=n[i+1])!==null&&t!==void 0?t:null}return null}return e.nextSibling}function fi(e){return e.tagName}function hi(e,t){e.textContent=t}function gi(e){return e.textContent}function bi(e){return e.nodeType===1}function vi(e){return e.nodeType===3}function yi(e){return e.nodeType===8}function te(e){return e.nodeType===11}function le(e,t){var o,r,n;let i=e;return(o=i.parent)!==null&&o!==void 0||(i.parent=t!=null?t:null),(r=i.firstChildNode)!==null&&r!==void 0||(i.firstChildNode=e.firstChild),(n=i.lastChildNode)!==null&&n!==void 0||(i.lastChildNode=e.lastChild),i}var $o={createElement:ii,createElementNS:si,createTextNode:li,createDocumentFragment:ai,createComment:ci,insertBefore:di,removeChild:pi,appendChild:ui,parentNode:Vo,nextSibling:mi,tagName:fi,setTextContent:hi,getTextContent:gi,isElement:bi,isText:vi,isComment:yi,isDocumentFragment:te};s();s();function ce(e,t,o,r,n){let i=t===void 0?void 0:t.key;return{sel:e,data:t,children:o,text:r,elm:n,key:i}}s();var Se=Array.isArray;function ge(e){return typeof e=="string"||typeof e=="number"||e instanceof String||e instanceof Number}function Bt(e){return e===void 0}function D(e){return e!==void 0}var Ot=ce("",{},[],void 0,void 0);function Ce(e,t){var o,r;let n=e.key===t.key,i=((o=e.data)===null||o===void 0?void 0:o.is)===((r=t.data)===null||r===void 0?void 0:r.is),l=e.sel===t.sel,c=!e.sel&&e.sel===t.sel?typeof e.text==typeof t.text:!0;return l&&n&&i&&c}function xi(){throw new Error("The document fragment is not supported on this platform.")}function ki(e,t){return e.isElement(t)}function wi(e,t){return e.isDocumentFragment(t)}function Mi(e,t,o){var r;let n={};for(let i=t;i<=o;++i){let l=(r=e[i])===null||r===void 0?void 0:r.key;l!==void 0&&(n[l]=i)}return n}var Ti=["create","update","remove","destroy","pre","post"];function Pe(e,t,o){let r={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},n=t!==void 0?t:$o;for(let p of Ti)for(let m of e){let y=m[p];y!==void 0&&r[p].push(y)}function i(p){let m=p.id?"#"+p.id:"",y=p.getAttribute("class"),b=y?"."+y.split(" ").join("."):"";return ce(n.tagName(p).toLowerCase()+m+b,{},[],void 0,p)}function l(p){return ce(void 0,{},[],void 0,p)}function c(p,m){return function(){if(--m===0){let b=n.parentNode(p);n.removeChild(b,p)}}}function u(p,m){var y,b,k,T;let x,w=p.data;if(w!==void 0){let v=(y=w.hook)===null||y===void 0?void 0:y.init;D(v)&&(v(p),w=p.data)}let M=p.children,S=p.sel;if(S==="!")Bt(p.text)&&(p.text=""),p.elm=n.createComment(p.text);else if(S!==void 0){let v=S.indexOf("#"),A=S.indexOf(".",v),E=v>0?v:S.length,P=A>0?A:S.length,N=v!==-1||A!==-1?S.slice(0,Math.min(E,P)):S,z=p.elm=D(w)&&D(x=w.ns)?n.createElementNS(x,N,w):n.createElement(N,w);for(E<P&&z.setAttribute("id",S.slice(E+1,P)),A>0&&z.setAttribute("class",S.slice(P+1).replace(/\./g," ")),x=0;x<r.create.length;++x)r.create[x](Ot,p);if(Se(M))for(x=0;x<M.length;++x){let Eo=M[x];Eo!=null&&n.appendChild(z,u(Eo,m))}else ge(p.text)&&n.appendChild(z,n.createTextNode(p.text));let Je=p.data.hook;D(Je)&&((b=Je.create)===null||b===void 0||b.call(Je,Ot,p),Je.insert&&m.push(p))}else if(!((k=o==null?void 0:o.experimental)===null||k===void 0)&&k.fragments&&p.children){for(p.elm=((T=n.createDocumentFragment)!==null&&T!==void 0?T:xi)(),x=0;x<r.create.length;++x)r.create[x](Ot,p);for(x=0;x<p.children.length;++x){let v=p.children[x];v!=null&&n.appendChild(p.elm,u(v,m))}}else p.elm=n.createTextNode(p.text);return p.elm}function d(p,m,y,b,k,T){for(;b<=k;++b){let x=y[b];x!=null&&n.insertBefore(p,u(x,T),m)}}function g(p){var m,y;let b=p.data;if(b!==void 0){(y=(m=b==null?void 0:b.hook)===null||m===void 0?void 0:m.destroy)===null||y===void 0||y.call(m,p);for(let k=0;k<r.destroy.length;++k)r.destroy[k](p);if(p.children!==void 0)for(let k=0;k<p.children.length;++k){let T=p.children[k];T!=null&&typeof T!="string"&&g(T)}}}function h(p,m,y,b){for(var k,T;y<=b;++y){let x,w,M=m[y];if(M!=null)if(D(M.sel)){g(M),x=r.remove.length+1,w=c(M.elm,x);for(let v=0;v<r.remove.length;++v)r.remove[v](M,w);let S=(T=(k=M==null?void 0:M.data)===null||k===void 0?void 0:k.hook)===null||T===void 0?void 0:T.remove;D(S)?S(M,w):w()}else M.children?(g(M),h(p,M.children,0,M.children.length-1)):n.removeChild(p,M.elm)}}function C(p,m,y,b){let k=0,T=0,x=m.length-1,w=m[0],M=m[x],S=y.length-1,v=y[0],A=y[S],E,P,N,z;for(;k<=x&&T<=S;)w==null?w=m[++k]:M==null?M=m[--x]:v==null?v=y[++T]:A==null?A=y[--S]:Ce(w,v)?(L(w,v,b),w=m[++k],v=y[++T]):Ce(M,A)?(L(M,A,b),M=m[--x],A=y[--S]):Ce(w,A)?(L(w,A,b),n.insertBefore(p,w.elm,n.nextSibling(M.elm)),w=m[++k],A=y[--S]):Ce(M,v)?(L(M,v,b),n.insertBefore(p,M.elm,w.elm),M=m[--x],v=y[++T]):(E===void 0&&(E=Mi(m,k,x)),P=E[v.key],Bt(P)?n.insertBefore(p,u(v,b),w.elm):(N=m[P],N.sel!==v.sel?n.insertBefore(p,u(v,b),w.elm):(L(N,v,b),m[P]=void 0,n.insertBefore(p,N.elm,w.elm))),v=y[++T]);T<=S&&(z=y[S+1]==null?null:y[S+1].elm,d(p,z,y,T,S,b)),k<=x&&h(p,m,k,x)}function L(p,m,y){var b,k,T,x,w,M,S,v;let A=(b=m.data)===null||b===void 0?void 0:b.hook;(k=A==null?void 0:A.prepatch)===null||k===void 0||k.call(A,p,m);let E=m.elm=p.elm;if(p===m)return;if(m.data!==void 0||D(m.text)&&m.text!==p.text){(T=m.data)!==null&&T!==void 0||(m.data={}),(x=p.data)!==null&&x!==void 0||(p.data={});for(let z=0;z<r.update.length;++z)r.update[z](p,m);(S=(M=(w=m.data)===null||w===void 0?void 0:w.hook)===null||M===void 0?void 0:M.update)===null||S===void 0||S.call(M,p,m)}let P=p.children,N=m.children;Bt(m.text)?D(P)&&D(N)?P!==N&&C(E,P,N,y):D(N)?(D(p.text)&&n.setTextContent(E,""),d(E,null,N,0,N.length-1,y)):D(P)?h(E,P,0,P.length-1):D(p.text)&&n.setTextContent(E,""):p.text!==m.text&&(D(P)&&h(E,P,0,P.length-1),n.setTextContent(E,m.text)),(v=A==null?void 0:A.postpatch)===null||v===void 0||v.call(A,p,m)}return function(m,y){let b,k,T,x=[];for(b=0;b<r.pre.length;++b)r.pre[b]();for(ki(n,m)?m=i(m):wi(n,m)&&(m=l(m)),Ce(m,y)?L(m,y,x):(k=m.elm,T=n.parentNode(k),u(y,x),T!==null&&(n.insertBefore(T,y.elm,n.nextSibling(k)),h(T,[m],0,0))),b=0;b<x.length;++b)x[b].data.hook.insert(x[b]);for(b=0;b<r.post.length;++b)r.post[b]();return y}}s();s();function Qe(e,t,o){if(e.ns="http://www.w3.org/2000/svg",o!=="foreignObject"&&t!==void 0)for(let r=0;r<t.length;++r){let n=t[r];if(typeof n=="string")continue;let i=n.data;i!==void 0&&Qe(i,n.children,n.sel)}}function a(e,t,o){let r={},n,i,l;if(o!==void 0?(t!==null&&(r=t),Se(o)?n=o:ge(o)?i=o.toString():o&&o.sel&&(n=[o])):t!=null&&(Se(t)?n=t:ge(t)?i=t.toString():t&&t.sel?n=[t]:r=t),n!==void 0)for(l=0;l<n.length;++l)ge(n[l])&&(n[l]=ce(void 0,void 0,void 0,n[l],void 0));return e[0]==="s"&&e[1]==="v"&&e[2]==="g"&&(e.length===3||e[3]==="."||e[3]==="#")&&Qe(r,n,e),ce(e,r,n,i,void 0)}function et(e,t){var o;let r=(o=t.data)===null||o===void 0?void 0:o.ns;e.data.fn=t.data.fn,e.data.args=t.data.args,t.data=e.data,t.children=e.children,t.text=e.text,t.elm=e.elm,r&&Qe(t.data,t.children,t.sel)}function Si(e){let t=e.data,o=t.fn(...t.args);et(o,e)}function Ci(e,t){let o,r=e.data,n=t.data,i=r.args,l=n.args;if(r.fn!==n.fn||i.length!==l.length){et(n.fn(...l),t);return}for(o=0;o<l.length;++o)if(i[o]!==l[o]){et(n.fn(...l),t);return}et(e,t)}var Wt=function(t,o,r,n){return n===void 0&&(n=r,r=o,o=void 0),a(t,{key:o,hook:{init:Si,prepatch:Ci},fn:r,args:n})};s();var Pi="http://www.w3.org/1999/xlink",Li="http://www.w3.org/XML/1998/namespace";function Bo(e,t){let o,r=t.elm,n=e.data.attrs,i=t.data.attrs;if(!(!n&&!i)&&n!==i){n=n||{},i=i||{};for(o in i){let l=i[o];n[o]!==l&&(l===!0?r.setAttribute(o,""):l===!1?r.removeAttribute(o):o.charCodeAt(0)!==120?r.setAttribute(o,l):o.charCodeAt(3)===58?r.setAttributeNS(Li,o,l):o.charCodeAt(5)===58?r.setAttributeNS(Pi,o,l):r.setAttribute(o,l))}for(o in n)o in i||r.removeAttribute(o)}}var Le={create:Bo,update:Bo};s();function Oo(e,t){let o,r,n=t.elm,i=e.data.class,l=t.data.class;if(!(!i&&!l)&&i!==l){i=i||{},l=l||{};for(r in i)i[r]&&!Object.prototype.hasOwnProperty.call(l,r)&&n.classList.remove(r);for(r in l)o=l[r],o!==i[r]&&n.classList[o?"add":"remove"](r)}}var Ae={create:Oo,update:Oo};s();function Wo(e,t,o){if(typeof e=="function")e.call(t,o,t);else if(typeof e=="object")for(let r=0;r<e.length;r++)Wo(e[r],t,o)}function Ai(e,t){let o=e.type,r=t.data.on;r&&r[o]&&Wo(r[o],t,e)}function _i(){return function e(t){Ai(t,e.vnode)}}function Kt(e,t){let o=e.data.on,r=e.listener,n=e.elm,i=t&&t.data.on,l=t&&t.elm,c;if(o!==i){if(o&&r)if(i)for(c in o)i[c]||n.removeEventListener(c,r,!1);else for(c in o)n.removeEventListener(c,r,!1);if(i){let u=t.listener=e.listener||_i();if(u.vnode=t,o)for(c in i)o[c]||l.addEventListener(c,u,!1);else for(c in i)l.addEventListener(c,u,!1)}}}var jt={create:Kt,update:Kt,destroy:Kt};s();s();var tt="\uE00A",ot="\uE00B";var rt="\uE017";var zt="\uE019",nt="\uE01B",it="\uE01C",st="\uE01D";var at="\uE01F";var lt="\uE022";var Gt="\uE02B",Ko="\uE02C";var ct="\uE02E";var dt="\uE031",jo="\uE032",pt="\uE033";var _e="\uE03F";var ut="\uE047";var mt="\uE052";var zo="\uE060";var ft="\uE06E";s();s();s();s();s();function Ie(e,t,o=!1){let r,n=0;return function(...i){let l=this;r&&clearTimeout(r),r=void 0;let c=performance.now()-n;n=performance.now(),o&&c>t?e.apply(l,i):r=setTimeout(()=>{r=void 0,e.apply(l,i)},t)}}s();function J(e){return{insert:t=>e(t.elm)}}function H(e,t,o,r=!0){return J(n=>n.addEventListener(e,i=>{let l=t(i);return l===!1&&i.preventDefault(),o==null||o(),l},{passive:r}))}s();var Hi=Io(()=>{let e=document.createElement("div");e.style.position="absolute",e.style.overflow="scroll",e.style.visibility="hidden",document.body.appendChild(e);let t=e.offsetWidth-e.clientWidth;return document.body.removeChild(e),t});s();s();s();s();s();s();var Ii=[{"stroke-width":3.779,d:"m21.78 12.64c-1.284 8.436 8.943 12.7 14.54 17.61 3 2.632 4.412 4.442 5.684 7.93"},{"stroke-width":4.157,d:"m43.19 36.32c2.817-1.203 6.659-5.482 5.441-7.623-2.251-3.957-8.883-14.69-11.89-19.73-0.4217-0.7079-0.2431-1.835 0.5931-3.3 1.358-2.38 1.956-5.628 1.956-5.628"},{"stroke-width":4.535,d:"m37.45 2.178s-3.946 0.6463-6.237 2.234c-0.5998 0.4156-2.696 0.7984-3.896 0.6388-17.64-2.345-29.61 14.08-25.23 27.34 4.377 13.26 22.54 25.36 39.74 8.666"}],de=(e="-2 -2 54 54")=>a("div.spinner",{"aria-label":"loading"},[a("svg",{attrs:{viewBox:e}},[a("g",{attrs:{mask:"url(#mask)",fill:"none"}},Ii.map(t=>a("path",{attrs:t})))])]);s();var Fc=Pe([Ae,Le]);function qo(){return lichess.loadEsm("dasher")}s();s();s();s();s();s();var Uo=["white","black"],be=["a","b","c","d","e","f","g","h"],Ne=["1","2","3","4","5","6","7","8"];var Xo=[...Ne].reverse(),ht=Array.prototype.concat(...be.map(e=>Ne.map(t=>e+t))),F=e=>ht[8*e[0]+e[1]],_=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49];var gt=ht.map(_);function Jo(e){let t,o=()=>(t===void 0&&(t=e()),t);return o.clear=()=>{t=void 0},o}var Yo=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;let t=performance.now()-e;return e=void 0,t}}},bt=e=>e==="white"?"black":"white",ie=(e,t)=>{let o=e[0]-t[0],r=e[1]-t[1];return o*o+r*r},Fe=(e,t)=>e.role===t.role&&e.color===t.color,se=e=>(t,o)=>[(o?t[0]:7-t[0])*e.width/8,(o?7-t[1]:t[1])*e.height/8],K=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},qt=(e,t,o=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${o})`},Re=(e,t)=>{e.style.visibility=t?"visible":"hidden"},Y=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},vt=e=>e.buttons===2||e.button===2,j=(e,t)=>{let o=document.createElement(e);return t&&(o.className=t),o};function yt(e,t,o){let r=_(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[o.left+o.width*r[0]/8+o.width/16,o.top+o.height*(7-r[1])/8+o.height/16]}s();var pe=(e,t)=>Math.abs(e-t),Ni=e=>(t,o,r,n)=>pe(t,r)<2&&(e==="white"?n===o+1||o<=1&&n===o+2&&t===r:n===o-1||o>=6&&n===o-2&&t===r),Ut=(e,t,o,r)=>{let n=pe(e,o),i=pe(t,r);return n===1&&i===2||n===2&&i===1},Qo=(e,t,o,r)=>pe(e,o)===pe(t,r),er=(e,t,o,r)=>e===o||t===r,Zt=(e,t,o,r)=>Qo(e,t,o,r)||er(e,t,o,r),Fi=(e,t,o)=>(r,n,i,l)=>pe(r,i)<2&&pe(n,l)<2||o&&n===l&&n===(e==="white"?0:7)&&(r===4&&(i===2&&t.includes(0)||i===6&&t.includes(7))||t.includes(i));function Ri(e,t){let o=t==="white"?"1":"8",r=[];for(let[n,i]of e)n[1]===o&&i.color===t&&i.role==="rook"&&r.push(_(n)[0]);return r}function Xt(e,t,o){let r=e.get(t);if(!r)return[];let n=_(t),i=r.role,l=i==="pawn"?Ni(r.color):i==="knight"?Ut:i==="bishop"?Qo:i==="rook"?er:i==="queen"?Zt:Fi(r.color,Ri(e,r.color),o);return gt.filter(c=>(n[0]!==c[0]||n[1]!==c[1])&&l(n[0],n[1],c[0],c[1])).map(F)}function V(e,...t){e&&setTimeout(()=>e(...t),1)}function tr(e){e.orientation=bt(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function or(e,t){for(let[o,r]of t)r?e.pieces.set(o,r):e.pieces.delete(o)}function rr(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(let[o,r]of e.pieces)r.role==="king"&&r.color===t&&(e.check=o)}function Vi(e,t,o,r){q(e),e.premovable.current=[t,o],V(e.premovable.events.set,t,o,r)}function G(e){e.premovable.current&&(e.premovable.current=void 0,V(e.premovable.events.unset))}function $i(e,t,o){G(e),e.predroppable.current={role:t,key:o},V(e.predroppable.events.set,t,o)}function q(e){let t=e.predroppable;t.current&&(t.current=void 0,V(t.events.unset))}function Di(e,t,o){if(!e.autoCastle)return!1;let r=e.pieces.get(t);if(!r||r.role!=="king")return!1;let n=_(t),i=_(o);if(n[1]!==0&&n[1]!==7||n[1]!==i[1])return!1;n[0]===4&&!e.pieces.has(o)&&(i[0]===6?o=F([7,i[1]]):i[0]===2&&(o=F([0,i[1]])));let l=e.pieces.get(o);return!l||l.color!==r.color||l.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(o),n[0]<i[0]?(e.pieces.set(F([6,i[1]]),r),e.pieces.set(F([5,i[1]]),l)):(e.pieces.set(F([2,i[1]]),r),e.pieces.set(F([3,i[1]]),l)),!0)}function Jt(e,t,o){let r=e.pieces.get(t),n=e.pieces.get(o);if(t===o||!r)return!1;let i=n&&n.color!==r.color?n:void 0;return o===e.selected&&R(e),V(e.events.move,t,o,i),Di(e,t,o)||(e.pieces.set(o,r),e.pieces.delete(t)),e.lastMove=[t,o],e.check=void 0,V(e.events.change),i||!0}function xt(e,t,o,r){if(e.pieces.has(o))if(r)e.pieces.delete(o);else return!1;return V(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,V(e.events.change),e.movable.dests=void 0,e.turnColor=bt(e.turnColor),!0}function nr(e,t,o){let r=Jt(e,t,o);return r&&(e.movable.dests=void 0,e.turnColor=bt(e.turnColor),e.animation.current=void 0),r}function Yt(e,t,o){if(wt(e,t,o)){let r=nr(e,t,o);if(r){let n=e.hold.stop();R(e);let i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:n};return r!==!0&&(i.captured=r),V(e.movable.events.after,t,o,i),!0}}else if(Oi(e,t,o))return Vi(e,t,o,{ctrlKey:e.stats.ctrlKey}),R(e),!0;return R(e),!1}function kt(e,t,o,r){let n=e.pieces.get(t);n&&(Bi(e,t,o)||r)?(e.pieces.delete(t),xt(e,n,o,r),V(e.movable.events.afterNewPiece,n.role,o,{premove:!1,predrop:!1})):n&&Wi(e,t,o)?$i(e,n.role,o):(G(e),q(e)),e.pieces.delete(t),R(e)}function $e(e,t,o){if(V(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){R(e),e.hold.cancel();return}else if((e.selectable.enabled||o)&&e.selected!==t&&Yt(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(ir(e,t)||eo(e,t))&&(Qt(e,t),e.hold.start())}function Qt(e,t){e.selected=t,eo(e,t)?e.premovable.dests=Xt(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function R(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function ir(e,t){let o=e.pieces.get(t);return!!o&&(e.movable.color==="both"||e.movable.color===o.color&&e.turnColor===o.color)}var wt=(e,t,o)=>{var r,n;return t!==o&&ir(e,t)&&(e.movable.free||!!(!((n=(r=e.movable.dests)===null||r===void 0?void 0:r.get(t))===null||n===void 0)&&n.includes(o)))};function Bi(e,t,o){let r=e.pieces.get(t);return!!r&&(t===o||!e.pieces.has(o))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function eo(e,t){let o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}var Oi=(e,t,o)=>t!==o&&eo(e,t)&&Xt(e.pieces,t,e.premovable.castle).includes(o);function Wi(e,t,o){let r=e.pieces.get(t),n=e.pieces.get(o);return!!r&&(!n||n.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||o[1]!=="1"&&o[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function sr(e,t){let o=e.pieces.get(t);return!!o&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function ar(e){let t=e.premovable.current;if(!t)return!1;let o=t[0],r=t[1],n=!1;if(wt(e,o,r)){let i=nr(e,o,r);if(i){let l={premove:!0};i!==!0&&(l.captured=i),V(e.movable.events.after,o,r,l),n=!0}}return G(e),n}function lr(e,t){let o=e.predroppable.current,r=!1;if(!o)return!1;if(t(o)){let n={role:o.role,color:e.movable.color};xt(e,n,o.key)&&(V(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),r=!0)}return q(e),r}function De(e){G(e),q(e),R(e)}function to(e){e.movable.color=e.movable.dests=e.animation.current=void 0,De(e)}function U(e,t,o){let r=Math.floor(8*(e[0]-o.left)/o.width);t||(r=7-r);let n=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(n=7-n),r>=0&&r<8&&n>=0&&n<8?F([r,n]):void 0}function cr(e,t,o,r){let n=_(e),i=gt.filter(d=>Zt(n[0],n[1],d[0],d[1])||Ut(n[0],n[1],d[0],d[1])),c=i.map(d=>yt(F(d),o,r)).map(d=>ie(t,d)),[,u]=c.reduce((d,g,h)=>d[0]<g?d:[g,h],[c[0],0]);return F(i[u])}var I=e=>e.orientation==="white";s();var ro="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Ki={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},ji={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Mt(e){e==="start"&&(e=ro);let t=new Map,o=7,r=0;for(let n of e)switch(n){case" ":case"[":return t;case"/":if(--o,o<0)return t;r=0;break;case"~":{let i=t.get(F([r-1,o]));i&&(i.promoted=!0);break}default:{let i=n.charCodeAt(0);if(i<57)r+=i-48;else{let l=n.toLowerCase();t.set(F([r,o]),{role:Ki[l],color:n===l?"black":"white"}),++r}}}return t}function dr(e){return Xo.map(t=>be.map(o=>{let r=e.get(o+t);if(r){let n=ji[r.role];return r.color==="white"&&(n=n.toUpperCase()),r.promoted&&(n+="~"),n}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}s();function no(e,t){t.animation&&(io(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Tt(e,t){var o,r,n;if(!((o=t.movable)===null||o===void 0)&&o.dests&&(e.movable.dests=void 0),!((r=t.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),io(e,t),t.fen&&(e.pieces=Mt(t.fen),e.drawable.shapes=((n=t.drawable)===null||n===void 0?void 0:n.shapes)||[]),"check"in t&&rr(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Qt(e,e.selected),no(e,t),!e.movable.rookCastle&&e.movable.dests){let i=e.movable.color==="white"?"1":"8",l="e"+i,c=e.movable.dests.get(l),u=e.pieces.get(l);if(!c||!u||u.role!=="king")return;e.movable.dests.set(l,c.filter(d=>!(d==="a"+i&&c.includes("c"+i))&&!(d==="h"+i&&c.includes("g"+i))))}}function io(e,t){for(let o in t)Object.prototype.hasOwnProperty.call(t,o)&&(Object.prototype.hasOwnProperty.call(e,o)&&pr(e[o])&&pr(t[o])?io(e[o],t[o]):e[o]=t[o])}function pr(e){if(typeof e!="object"||e===null)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}s();var oe=(e,t)=>t.animation.enabled?Ui(e,t):re(e,t);function re(e,t){let o=e(t);return t.dom.redraw(),o}var so=(e,t)=>({key:e,pos:_(e),piece:t}),Gi=(e,t)=>t.sort((o,r)=>ie(e.pos,o.pos)-ie(e.pos,r.pos))[0];function qi(e,t){let o=new Map,r=[],n=new Map,i=[],l=[],c=new Map,u,d,g;for(let[h,C]of e)c.set(h,so(h,C));for(let h of ht)u=t.pieces.get(h),d=c.get(h),u?d?Fe(u,d.piece)||(i.push(d),l.push(so(h,u))):l.push(so(h,u)):d&&i.push(d);for(let h of l)d=Gi(h,i.filter(C=>Fe(h.piece,C.piece))),d&&(g=[d.pos[0]-h.pos[0],d.pos[1]-h.pos[1]],o.set(h.key,g.concat(g)),r.push(d.key));for(let h of i)r.includes(h.key)||n.set(h.key,h.piece);return{anims:o,fadings:n}}function ur(e,t){let o=e.animation.current;if(o===void 0){e.dom.destroyed||e.dom.redrawNow();return}let r=1-(t-o.start)*o.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{let n=Zi(r);for(let i of o.plan.anims.values())i[2]=i[0]*n,i[3]=i[1]*n;e.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>ur(e,i))}}function Ui(e,t){let o=new Map(t.pieces),r=e(t),n=qi(o,t);if(n.anims.size||n.fadings.size){let i=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:n},i||ur(t,performance.now())}else t.dom.redraw();return r}var Zi=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;s();s();var Xi=["green","red","blue","yellow"];function mr(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?R(e):De(e);let o=Y(t),r=U(o,I(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:o,brush:Ji(t),snapToValidMove:e.drawable.defaultSnapToValidMove},fr(e))}function fr(e){requestAnimationFrame(()=>{let t=e.drawable.current;if(t){let o=U(t.pos,I(e),e.dom.bounds());o||(t.snapToValidMove=!1);let r=t.snapToValidMove?cr(t.orig,t.pos,I(e),e.dom.bounds()):o;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),fr(e)}})}function hr(e,t){e.drawable.current&&(e.drawable.current.pos=Y(t))}function gr(e){let t=e.drawable.current;t&&(t.mouseSq&&Yi(e.drawable,t),ao(e))}function ao(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function br(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),vr(e.drawable))}function Ji(e){var t;let o=(e.shiftKey||e.ctrlKey)&&vt(e),r=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return Xi[(o?1:0)+(r?2:0)]}function Yi(e,t){let o=n=>n.orig===t.orig&&n.dest===t.dest,r=e.shapes.find(o);r&&(e.shapes=e.shapes.filter(n=>!o(n))),(!r||r.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),vr(e)}function vr(e){e.onChange&&e.onChange(e.shapes)}function yr(e,t){if(!t.isTrusted||t.button!==void 0&&t.button!==0||t.touches&&t.touches.length>1)return;let o=e.dom.bounds(),r=Y(t),n=U(r,I(e),o);if(!n)return;let i=e.pieces.get(n),l=e.selected;if(!l&&e.drawable.enabled&&(e.drawable.eraseOnClick||!i||i.color!==e.turnColor)&&br(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||i||l||es(e,r)))t.preventDefault();else if(t.touches)return;let c=!!e.premovable.current,u=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&wt(e,e.selected,n)?oe(h=>$e(h,n),e):$e(e,n);let d=e.selected===n,g=Tr(e,n);if(i&&g&&d&&sr(e,n)){e.draggable.current={orig:n,piece:i,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:g,previouslySelected:l,originTarget:t.target,keyHasChanged:!1},g.cgDragging=!0,g.classList.add("dragging");let h=e.dom.elements.ghost;h&&(h.className=`ghost ${i.color} ${i.role}`,K(h,se(o)(_(n),I(e))),Re(h,!0)),lo(e)}else c&&G(e),u&&q(e);e.dom.redraw()}function es(e,t){let o=I(e),r=e.dom.bounds(),n=Math.pow(r.width/8,2);for(let i of e.pieces.keys()){let l=yt(i,o,r);if(ie(l,t)<=n)return!0}return!1}function xr(e,t,o,r){let n="a0";e.pieces.set(n,t),e.dom.redraw();let i=Y(o);e.draggable.current={orig:n,piece:t,origPos:i,pos:i,started:!0,element:()=>Tr(e,n),originTarget:o.target,newPiece:!0,force:!!r,keyHasChanged:!1},lo(e)}function lo(e){requestAnimationFrame(()=>{var t;let o=e.draggable.current;if(!o)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(o.orig)&&(e.animation.current=void 0);let r=e.pieces.get(o.orig);if(!r||!Fe(r,o.piece))ue(e);else if(!o.started&&ie(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){let i=o.element();if(!i)return;i.cgDragging=!0,i.classList.add("dragging"),o.element=i}let n=e.dom.bounds();K(o.element,[o.pos[0]-n.left-n.width/16,o.pos[1]-n.top-n.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==U(o.pos,I(e),n))}lo(e)})}function kr(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=Y(t))}function wr(e,t){let o=e.draggable.current;if(!o)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&o.originTarget!==t.target&&!o.newPiece){e.draggable.current=void 0;return}G(e),q(e);let r=Y(t)||o.pos,n=U(r,I(e),e.dom.bounds());n&&o.started&&o.orig!==n?o.newPiece?kt(e,o.orig,n,o.force):(e.stats.ctrlKey=t.ctrlKey,Yt(e,o.orig,n)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!n&&(e.pieces.delete(o.orig),V(e.events.change)),(o.orig===o.previouslySelected||o.keyHasChanged)&&(o.orig===n||!n)?R(e):e.selectable.enabled||R(e),Mr(e),e.draggable.current=void 0,e.dom.redraw()}function ue(e){let t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,R(e),Mr(e),e.dom.redraw())}function Mr(e){let t=e.dom.elements;t.ghost&&Re(t.ghost,!1)}function Tr(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&o.tagName==="PIECE")return o;o=o.nextSibling}}s();function Cr(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Sr(e,2),setTimeout(()=>Sr(e,void 0),120)},120)}function Sr(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Pr(e,t){function o(){tr(e),t()}return{set(r){r.orientation&&r.orientation!==e.orientation&&o(),no(e,r),(r.fen?oe:re)(n=>Tt(n,r),e)},state:e,getFen:()=>dr(e.pieces),toggleOrientation:o,setPieces(r){oe(n=>or(n,r),e)},selectSquare(r,n){r?oe(i=>$e(i,r,n),e):e.selected&&(R(e),e.dom.redraw())},move(r,n){oe(i=>Jt(i,r,n),e)},newPiece(r,n){oe(i=>xt(i,r,n),e)},playPremove(){if(e.premovable.current){if(oe(ar,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){let n=lr(e,r);return e.dom.redraw(),n}return!1},cancelPremove(){re(G,e)},cancelPredrop(){re(q,e)},cancelMove(){re(r=>{De(r),ue(r)},e)},stop(){re(r=>{to(r),ue(r)},e)},explode(r){Cr(e,r)},setAutoShapes(r){re(n=>n.drawable.autoShapes=r,e)},setShapes(r){re(n=>n.drawable.shapes=r,e)},getKeyAtDomPos(r){return U(r,I(e),e.dom.bounds())},redrawAll:t,dragNewPiece(r,n,i){xr(e,r,n,i)},destroy(){to(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}s();function Lr(){return{pieces:Mt(ro),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:Yo()}}s();s();s();function Be(e,t,o){let r=new Map,n=[];for(let c of e)r.set(c.hash,!1);let i=t.firstChild,l;for(;i;)l=i.getAttribute("cgHash"),r.has(l)?r.set(l,!0):n.push(i),i=i.nextSibling;for(let c of n)t.removeChild(c);for(let c of e)r.get(c.hash)||t.appendChild(o(c))}function O(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Hr(e,t,o){let r=e.drawable,n=r.current,i=n&&n.mouseSq?n:void 0,l=new Map,c=e.dom.bounds(),u=r.autoShapes.filter(p=>!p.piece);for(let p of r.shapes.concat(u).concat(i?[i]:[]))p.dest&&l.set(p.dest,(l.get(p.dest)||0)+1);let d=r.shapes.concat(u).map(p=>({shape:p,current:!1,hash:Ar(p,l,!1,c)}));i&&d.push({shape:i,current:!0,hash:Ar(i,l,!0,c)});let g=d.map(p=>p.hash).join(";");if(g===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=g;let h=t.querySelector("defs"),C=t.querySelector("g"),L=o.querySelector("g");os(r,d,h),Be(d.filter(p=>!p.shape.customSvg),C,p=>_r(e,p,r.brushes,l,c)),Be(d.filter(p=>p.shape.customSvg),L,p=>_r(e,p,r.brushes,l,c))}function os(e,t,o){var r;let n=new Map,i;for(let u of t)u.shape.dest&&(i=e.brushes[u.shape.brush],u.shape.modifiers&&(i=Ir(i,u.shape.modifiers)),!((r=u.shape.modifiers)===null||r===void 0)&&r.hilite&&n.set("hilite",{key:"hilite",color:"white",opacity:1,lineWidth:1}),n.set(i.key,i));let l=new Set,c=o.firstChild;for(;c;)l.add(c.getAttribute("cgKey")),c=c.nextSibling;for(let[u,d]of n.entries())l.has(u)||o.appendChild(cs(d))}function Ar({orig:e,dest:t,brush:o,piece:r,modifiers:n,customSvg:i},l,c,u){return[u.width,u.height,c,e,t,o,t&&(l.get(t)||0)>1,r&&rs(r),n&&ns(n),i&&is(i)].filter(d=>d).join(",")}function rs(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function ns(e){return[e.lineWidth,e.hilite].filter(t=>t).join(",")}function is(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return"custom-"+t.toString()}function _r(e,{shape:t,current:o,hash:r},n,i,l){var c;let u,d=Er(_(t.orig),e.orientation);if(t.customSvg)u=ss(t.customSvg,d,l);else if(t.dest&&t.dest!==t.orig){let g=n[t.brush];t.modifiers&&(g=Ir(g,t.modifiers)),u=ls(g,d,Er(_(t.dest),e.orientation),o,(i.get(t.dest)||0)>1,l,(c=t.modifiers)===null||c===void 0?void 0:c.hilite)}else u=as(n[t.brush],d,o,l);return u.setAttribute("cgHash",r),u}function ss(e,t,o){let[r,n]=St(t,o),i=ne(O("g"),{transform:`translate(${r},${n})`}),l=ne(O("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return i.appendChild(l),l.innerHTML=e,i}function as(e,t,o,r){let n=St(t,r),i=ds(),l=(r.width+r.height)/(4*Math.max(r.width,r.height));return ne(O("circle"),{stroke:e.color,"stroke-width":i[o?0:1],fill:"none",opacity:Nr(e,o),cx:n[0],cy:n[1],r:l-i[1]/2})}function ls(e,t,o,r,n,i,l=!1){function c(d){let g=us(n&&!r),h=St(t,i),C=St(o,i),L=C[0]-h[0],p=C[1]-h[1],m=Math.atan2(p,L),y=Math.cos(m)*g,b=Math.sin(m)*g;return ne(O("line"),{stroke:d?"white":e.color,"stroke-width":ps(e,r)+(d?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${d?"hilite":e.key})`,opacity:d?1:Nr(e,r),x1:h[0],y1:h[1],x2:C[0]-y,y2:C[1]-b})}let u=l?O("g"):c(!1);return l&&[!0,!1].map(d=>u.appendChild(c(d))),u}function cs(e){let t=ne(O("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:e.key==="hilite"?1.86:2.05,refY:2});return t.appendChild(ne(O("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function ne(e,t){for(let o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.setAttribute(o,t[o]);return e}function Er(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function Ir(e,t){return{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(o=>o).join("")}}function ds(){return[3/64,4/64]}function ps(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function Nr(e,t){return(e.opacity||1)*(t?.9:1)}function us(e){return(e?20:10)/64}function St(e,t){let o=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*o,(3.5-e[1])*r]}function Rr(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(let u of Uo)e.classList.toggle("orientation-"+u,t.orientation===u);e.classList.toggle("manipulable",!t.viewOnly);let o=j("cg-container");e.appendChild(o);let r=j("cg-board");o.appendChild(r);let n,i,l;if(t.drawable.visible&&(n=ne(O("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),n.appendChild(O("defs")),n.appendChild(O("g")),i=ne(O("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(O("g")),l=j("cg-auto-pieces"),o.appendChild(n),o.appendChild(i),o.appendChild(l)),t.coordinates){let u=t.orientation==="black"?" black":"",d=t.ranksPosition==="left"?" left":"";o.appendChild(Fr(Ne,"ranks"+u+d)),o.appendChild(Fr(be,"files"+u))}let c;return t.draggable.enabled&&t.draggable.showGhost&&(c=j("piece","ghost"),Re(c,!1),o.appendChild(c)),{board:r,container:o,wrap:e,ghost:c,svg:n,customSvg:i,autoPieces:l}}function Fr(e,t){let o=j("coords",t),r;for(let n of e)r=j("coord"),r.textContent=n,o.appendChild(r);return o}s();s();function Vr(e,t){if(!e.dropmode.active)return;G(e),q(e);let o=e.dropmode.piece;if(o){e.pieces.set("a0",o);let r=Y(t),n=r&&U(r,I(e),e.dom.bounds());n&&kt(e,"a0",n)}e.dom.redraw()}function Dr(e,t){let o=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",n=>n.preventDefault()),e.viewOnly)return;let r=fs(e);o.addEventListener("touchstart",r,{passive:!1}),o.addEventListener("mousedown",r,{passive:!1})}function Br(e,t){let o=[];if("ResizeObserver"in window||o.push(Oe(document.body,"chessground.resize",t)),!e.viewOnly){let r=$r(e,kr,hr),n=$r(e,wr,gr);for(let l of["touchmove","mousemove"])o.push(Oe(document,l,r));for(let l of["touchend","mouseup"])o.push(Oe(document,l,n));let i=()=>e.dom.bounds.clear();o.push(Oe(document,"scroll",i,{capture:!0,passive:!0})),o.push(Oe(window,"resize",i,{passive:!0}))}return()=>o.forEach(r=>r())}function Oe(e,t,o,r){return e.addEventListener(t,o,r),()=>e.removeEventListener(t,o,r)}var fs=e=>t=>{e.draggable.current?ue(e):e.drawable.current?ao(e):t.shiftKey||vt(t)?e.drawable.enabled&&mr(e,t):e.viewOnly||(e.dropmode.active?Vr(e,t):yr(e,t))},$r=(e,t,o)=>r=>{e.drawable.current?e.drawable.enabled&&o(e,r):e.viewOnly||t(e,r)};s();function Wr(e){let t=I(e),o=se(e.dom.bounds()),r=e.dom.elements.board,n=e.pieces,i=e.animation.current,l=i?i.plan.anims:new Map,c=i?i.plan.fadings:new Map,u=e.draggable.current,d=gs(e),g=new Set,h=new Set,C=new Map,L=new Map,p,m,y,b,k,T,x,w,M,S;for(m=r.firstChild;m;){if(p=m.cgKey,jr(m))if(y=n.get(p),k=l.get(p),T=c.get(p),b=m.cgPiece,m.cgDragging&&(!u||u.orig!==p)&&(m.classList.remove("dragging"),K(m,o(_(p),t)),m.cgDragging=!1),!T&&m.cgFading&&(m.cgFading=!1,m.classList.remove("fading")),y){if(k&&m.cgAnimating&&b===We(y)){let v=_(p);v[0]+=k[2],v[1]+=k[3],m.classList.add("anim"),K(m,o(v,t))}else m.cgAnimating&&(m.cgAnimating=!1,m.classList.remove("anim"),K(m,o(_(p),t)),e.addPieceZIndex&&(m.style.zIndex=co(_(p),t)));b===We(y)&&(!T||!m.cgFading)?g.add(p):T&&b===We(T)?(m.classList.add("fading"),m.cgFading=!0):po(C,b,m)}else po(C,b,m);else if(zr(m)){let v=m.className;d.get(p)===v?h.add(p):po(L,v,m)}m=m.nextSibling}for(let[v,A]of d)if(!h.has(v)){M=L.get(A),S=M&&M.pop();let E=o(_(v),t);if(S)S.cgKey=v,K(S,E);else{let P=j("square",A);P.cgKey=v,K(P,E),r.insertBefore(P,r.firstChild)}}for(let[v,A]of n)if(k=l.get(v),!g.has(v))if(x=C.get(We(A)),w=x&&x.pop(),w){w.cgKey=v,w.cgFading&&(w.classList.remove("fading"),w.cgFading=!1);let E=_(v);e.addPieceZIndex&&(w.style.zIndex=co(E,t)),k&&(w.cgAnimating=!0,w.classList.add("anim"),E[0]+=k[2],E[1]+=k[3]),K(w,o(E,t))}else{let E=We(A),P=j("piece",E),N=_(v);P.cgPiece=E,P.cgKey=v,k&&(P.cgAnimating=!0,N[0]+=k[2],N[1]+=k[3]),K(P,o(N,t)),e.addPieceZIndex&&(P.style.zIndex=co(N,t)),r.appendChild(P)}for(let v of C.values())Or(e,v);for(let v of L.values())Or(e,v)}function Kr(e){let t=I(e),o=se(e.dom.bounds()),r=e.dom.elements.board.firstChild;for(;r;)(jr(r)&&!r.cgAnimating||zr(r))&&K(r,o(_(r.cgKey),t)),r=r.nextSibling}function uo(e){var t,o;let r=e.dom.elements.wrap.getBoundingClientRect(),n=e.dom.elements.container,i=r.height/r.width,l=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,c=l*i;n.style.width=l+"px",n.style.height=c+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",l+"px"),(o=e.addDimensionsCssVarsTo)===null||o===void 0||o.style.setProperty("--cg-height",c+"px")}var jr=e=>e.tagName==="PIECE",zr=e=>e.tagName==="SQUARE";function Or(e,t){for(let o of t)e.dom.elements.board.removeChild(o)}function co(e,t){let r=e[1];return`${t?3+7-r:3+r}`}var We=e=>`${e.color} ${e.role}`;function gs(e){var t;let o=new Map;if(e.lastMove&&e.highlight.lastMove)for(let i of e.lastMove)ae(o,i,"last-move");if(e.check&&e.highlight.check&&ae(o,e.check,"check"),e.selected&&(ae(o,e.selected,"selected"),e.movable.showDests)){let i=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(i)for(let c of i)ae(o,c,"move-dest"+(e.pieces.has(c)?" oc":""));let l=e.premovable.dests;if(l)for(let c of l)ae(o,c,"premove-dest"+(e.pieces.has(c)?" oc":""))}let r=e.premovable.current;if(r)for(let i of r)ae(o,i,"current-premove");else e.predroppable.current&&ae(o,e.predroppable.current.key,"current-premove");let n=e.exploding;if(n)for(let i of n.keys)ae(o,i,"exploding"+n.stage);return o}function ae(e,t,o){let r=e.get(t);r?e.set(t,`${r} ${o}`):e.set(t,o)}function po(e,t,o){let r=e.get(t);r?r.push(o):e.set(t,[o])}s();function Gr(e,t){let r=e.drawable.autoShapes.filter(n=>n.piece).map(n=>({shape:n,hash:vs(n),current:!1}));Be(r,t,n=>bs(e,n,e.dom.bounds()))}function qr(e){var t;let o=I(e),r=se(e.dom.bounds()),n=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;n;)qt(n,r(_(n.cgKey),o),n.cgScale),n=n.nextSibling}function bs(e,{shape:t,hash:o},r){var n,i,l;let c=t.orig,u=(n=t.piece)===null||n===void 0?void 0:n.role,d=(i=t.piece)===null||i===void 0?void 0:i.color,g=(l=t.piece)===null||l===void 0?void 0:l.scale,h=j("piece",`${u} ${d}`);return h.setAttribute("cgHash",o),h.cgKey=c,h.cgScale=g,qt(h,se(r)(_(c),I(e)),g),h}var vs=e=>{var t,o,r;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(o=e.piece)===null||o===void 0?void 0:o.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function Ur(e,t){let o=Lr();Tt(o,t||{});function r(){let n="dom"in o?o.dom.unbind:void 0,i=Rr(e,o),l=Jo(()=>i.board.getBoundingClientRect()),c=g=>{Wr(d),i.autoPieces&&Gr(d,i.autoPieces),!g&&i.svg&&Hr(d,i.svg,i.customSvg)},u=()=>{uo(d),Kr(d),i.autoPieces&&qr(d)},d=o;return d.dom={elements:i,bounds:l,redraw:xs(c),redrawNow:c,unbind:n},d.drawable.prevSvgHash="",uo(d),c(!1),Dr(d,u),n||(d.dom.unbind=Br(d,u)),d.events.insert&&d.events.insert(i),d}return Pr(r(),r)}function xs(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}s();s();var Ct=!1,Ke=e=>(Ct===!1&&(Ct=window.Intl&&Intl.NumberFormat?new Intl.NumberFormat:null),Ct===null?""+e:Ct.format(e));s();var Zr={chess960:`This is a Chess960 game!

The starting position of the pieces on the players' home ranks is randomized.`,kingOfTheHill:`This is a King of the Hill game!

The game can be won by bringing the king to the center.`,threeCheck:`This is a Three-check game!

The game can be won by checking the opponent three times.`,antichess:`This is an Antichess game!

If you can take a piece, you must. The game can be won by losing all your pieces, or by being stalemated.`,atomic:`This is an Atomic chess game!

Capturing a piece causes an explosion, taking out your piece and surrounding non-pawns. Win by mating or exploding your opponent's king.`,horde:`This is a Horde chess game!
Black must take all White pawns to win. White must checkmate the Black king.`,racingKings:`This is a Racing Kings game!

Players must race their kings to the eighth rank. Checks are not allowed.`,crazyhouse:`This is a Crazyhouse game!

Every time a piece is captured, the capturing player gets a piece of the same type and of their color in their pocket.`},Xr=e=>"lobby.variant."+e;function mo(e){return!e||Object.keys(Zr).every(function(t){if(e===t&&!lichess.storage.get(Xr(t))){let o=confirm(Zr[t]);return o&&lichess.storage.set(Xr(t),"1"),o}else return!0})}s();function ks(e,t){return(e.rating||0)>(t.rating||0)?-1:1}function ws(e,t){return e.t<t.t?-1:1}function fo(e,t){t.sort(e.sort==="time"?ws:ks)}function Jr(e){e.action=e.sri===lichess.sri?"cancel":"join",e.variant=e.variant||"standard"}function ho(e){e.data.hooks.forEach(Jr)}function Yr(e,t){Jr(t),e.data.hooks.push(t)}function Qr(e,t){e.data.hooks=t,ho(e)}function en(e,t){e.data.hooks=e.data.hooks.filter(o=>o.id!==t),e.stepHooks.forEach(o=>{o.id===t&&(o.disabled=!0)})}function tn(e,t){e.data.hooks=e.data.hooks.filter(o=>t.includes(o.id))}function on(e,t){return e.data.hooks.find(o=>o.id===t)}s();function Ms(e,t){return e.rating>t.rating?-1:1}function Ts(e){e.data.seeks.sort(Ms)}function bo(e){e.data.seeks.forEach(function(t){t.action=e.me&&t.username===e.me.username?"cancelSeek":"joinSeek"}),Ts(e)}function rn(e,t){return e.data.seeks.find(o=>o.id===t)}s();var Cs={key:"lobby.tab",fix(e){return e||"pools"}},Ps={key:"lobby.mode",fix(e){return e||"list"}},Ls={key:"lobby.sort",fix(e){return e||"rating"}};function vo(e,t){let o=e.key+":"+(t||"-");return{set(r){let n=e.fix(r);return lichess.storage.set(o,""+n),n},get(){return e.fix(lichess.storage.get(o))}}}function nn(e){return{tab:vo(Cs,e),mode:vo(Ps,e),sort:vo(Ls,e)}}s();var ln=oi(an(),1),je=(0,ln.default)(()=>Me("/lobby/seeks"),2e3),cn=()=>Me("/account/now-playing").then(e=>e.nowPlaying),dn=e=>Me("/setup/hook/"+lichess.sri,{method:"POST",body:ee({variant:1,timeMode:1,time:e.lim,increment:e.inc,days:1,color:"random"})});s();var un=(e,t)=>`lobby-pool-range.${(e==null?void 0:e.username)||"anon"}.${t}`,mn=(e,t)=>{let o=un(e,t.id);t.range?lichess.storage.set(o,t.range):lichess.storage.remove(o)},fn=(e,t)=>lichess.storage.get(un(e,t));s();var ze=class{constructor(t,o){this.send=t;this.receive=(t,o)=>this.handlers[t]?(this.handlers[t](o),!0):!1;this.handlers={had(r){Yr(o,r),r.action==="cancel"&&o.flushHooks(!0),o.redraw()},hrm(r){r.match(/.{8}/g).forEach(function(n){en(o,n)}),o.redraw()},hooks(r){Qr(o,r),o.flushHooks(!0),o.redraw()},hli(r){tn(o,r.match(/.{8}/g)||[]),o.redraw()},reload_seeks(){o.tab==="seeks"&&je().then(o.setSeeks)}},lichess.idleTimer(3*60*1e3,()=>t("idle",!0),()=>{t("idle",!1),o.awake()})}realTimeIn(){this.send("hookIn")}realTimeOut(){this.send("hookOut")}poolIn(t){this.send("poolIn",t,{},!0)}poolOut(t){this.send("poolOut",t.id)}};s();s();var hn=e=>Array.from(new FormData(e).entries()).filter(([t,o])=>!t.includes("_range")).reduce((t,[o,r])=>({...t,[o]:r}),{}),gn=e=>Object.keys(e).reduce((t,o)=>{let r=o.indexOf("["),n=r>0?o.slice(0,r):o;return r>0?{...t,[n]:[...t[n]||[],e[o]]}:{...t,[n]:e[o]}},{}),bn=e=>({get:()=>JSON.parse(e.get()||"null"),set:t=>e.set(JSON.stringify(t)),remove:()=>e.remove()});var Ge=class{constructor(t,o){this.root=o;this.open=!1;this.toggle=()=>{this.open=!this.open};this.set=t=>{this.data=t&&{form:t,filter:gn(t)}};this.save=t=>{let o=t&&hn(t);o?this.store.set(o):this.store.remove(),this.set(o),this.root.onSetFilter()};this.filter=t=>{if(!this.data)return{visible:t,hidden:0};let o=this.data.filter,r=o.ratingRange&&o.ratingRange.split("-").map(u=>parseInt(u,10)),n=[],i=[],l,c=0;return t.forEach(u=>{var d,g,h,C;if(l=u.variant,u.action==="cancel")i.push(u);else if(!((d=o.variant)!=null&&d.includes(l))||!((g=o.speed)!=null&&g.includes((u.s||1).toString()))||((h=o.mode)==null?void 0:h.length)==1&&o.mode[0]!=(u.ra||0).toString()||((C=o.increment)==null?void 0:C.length)==1&&o.increment[0]!=u.i.toString()||r&&(!u.rating||u.rating<r[0]||u.rating>r[1]))c++;else{let L=u.ra+l+u.t+u.rating;n.includes(L)||i.push(u),n.push(L)}}),{visible:i,hidden:c}};this.store=bn(t),this.set(this.store.get())}};s();s();var vn=(e,t)=>o=>{if(he(o))return lichess.storage.set(e,JSON.stringify(o)),o;let r=JSON.parse(lichess.storage.get(e));return r!==null?r:t()};s();var me=[{id:1,icon:Gt,key:"standard",name:"Standard"},{id:10,icon:ot,key:"crazyhouse",name:"Crazyhouse"},{id:2,icon:nt,key:"chess960",name:"Chess960"},{id:4,icon:it,key:"kingOfTheHill",name:"King of the Hill"},{id:5,icon:lt,key:"threeCheck",name:"Three-check"},{id:6,icon:pt,key:"antichess",name:"Antichess"},{id:7,icon:dt,key:"atomic",name:"Atomic"},{id:8,icon:mt,key:"horde",name:"Horde"},{id:9,icon:tt,key:"racingKings",name:"Racing Kings"},{id:3,icon:Gt,key:"fromPosition",name:"From Position"}],yn=me.filter(({key:e})=>["standard","chess960","kingOfTheHill","threeCheck","fromPosition","antichess","atomic","racingKings","horde"].includes(e)),xn=(e,t)=>t==="hook"?e.filter(({key:o})=>o!=="fromPosition"):e,kn=["antichess","atomic","horde","racingKings","threeCheck"],wn=[{icon:ft,key:"ultraBullet",name:"UltraBullet"},{icon:ut,key:"bullet",name:"Bullet"},{icon:st,key:"blitz",name:"Blitz"},{icon:rt,key:"rapid",name:"Rapid"},{icon:at,key:"classical",name:"Classical"},{icon:ct,key:"correspondence",name:"Correspondence"}],Lt=e=>[{id:1,key:"realTime",name:e("realTime")},{id:2,key:"correspondence",name:e("correspondence")},{id:0,key:"unlimited",name:e("unlimited")}],yo=(e,t)=>t.find(o=>o.key===e).id,Pt=[0,1/4,1/2,3/4,1,3/2,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,25,30,35,40,45,60,75,90,105,120,135,150,165,180],xo=e=>e<Pt.length?Pt[e]:180,qe=e=>{if(e<=20)return e;switch(e){case 21:return 25;case 22:return 30;case 23:return 35;case 24:return 40;case 25:return 45;case 26:return 60;case 27:return 90;case 28:return 120;case 29:return 150;default:return 180}},Ue=e=>{if(e<=3)return e;switch(e){case 4:return 5;case 5:return 7;case 6:return 10;default:return 14}},At=(e,t,o)=>{for(let r=0;r<o;r++)if(t(r)===e)return r},Mn=e=>[{key:"casual",name:e("casual")},{key:"rated",name:e("rated")}],ko=e=>[{key:"black",name:e("black")},{key:"random",name:e("randomColor")},{key:"white",name:e("white")}];var Hs=(e,t,o,r)=>{if(!["standard","fromPosition"].includes(e))return e;if(t!=="realTime")return"correspondence";let n=o*60+r*40;return n<30?"ultraBullet":n<180?"bullet":n<480?"blitz":n<1500?"rapid":"classical"},Ze=class{constructor(t){this.gameType=null;this.lastValidFen="";this.fenError=!1;this.friendUser="";this.loading=!1;this.time=()=>xo(this.timeV());this.increment=()=>qe(this.incrementV());this.days=()=>Ue(this.daysV());this.storeKey=t=>{var o;return`lobby.setup.${((o=this.root.me)==null?void 0:o.username)||"anon"}.${t}`};this.makeSetupStore=t=>vn(this.storeKey(t),()=>({variant:"standard",fen:"",timeMode:t==="hook"?"realTime":"unlimited",time:5,increment:3,days:2,gameMode:t==="ai"||!this.root.me?"casual":"rated",ratingMin:-500,ratingMax:500,aiLevel:1}));this.loadPropsFromStore=t=>{let o=this.store[this.gameType]();this.variant=Ye((t==null?void 0:t.variant)||o.variant,this.onVariantChange),this.fen=this.propWithApply((t==null?void 0:t.fen)||o.fen),this.timeMode=this.propWithApply((t==null?void 0:t.timeMode)||o.timeMode),this.timeV=this.propWithApply(At(o.time,xo,100)),this.incrementV=this.propWithApply(At(o.increment,qe,100)),this.daysV=this.propWithApply(At(o.days,Ue,20)),this.gameMode=this.propWithApply(o.gameMode),this.ratingMin=this.propWithApply(o.ratingMin),this.ratingMax=this.propWithApply(o.ratingMax),this.aiLevel=this.propWithApply(o.aiLevel),this.enforcePropRules(),this.savePropsToStore()};this.enforcePropRules=()=>{this.variant()==="fromPosition"&&(this.fen=this.propWithApply(this.fen().replace(/_/g," "))),this.gameMode()==="rated"&&this.ratedModeDisabled()&&(this.gameMode=this.propWithApply("casual")),this.ratingMin=this.propWithApply(Math.min(0,this.ratingMin())),this.ratingMax=this.propWithApply(Math.max(0,this.ratingMax())),this.ratingMin()===0&&this.ratingMax()===0&&(this.ratingMax=this.propWithApply(50))};this.savePropsToStore=(t={})=>this.gameType&&this.store[this.gameType]({variant:this.variant(),fen:this.fen(),timeMode:this.timeMode(),time:this.time(),increment:this.increment(),days:this.days(),gameMode:this.gameMode(),ratingMin:this.ratingMin(),ratingMax:this.ratingMax(),aiLevel:this.aiLevel(),...t});this.savePropsToStoreExceptRating=()=>this.gameType&&this.savePropsToStore({ratingMin:this.store[this.gameType]().ratingMin,ratingMax:this.store[this.gameType]().ratingMax});this.isProvisional=()=>{let t=this.root.data.ratingMap&&this.root.data.ratingMap[this.selectedPerf()];return t?!!t.prov:!0};this.onPropChange=()=>{this.isProvisional()?this.savePropsToStoreExceptRating():this.savePropsToStore(),this.root.redraw()};this.onVariantChange=()=>{this.enforcePropRules(),this.isProvisional()?(this.ratingMin(-500),this.ratingMax(500),this.savePropsToStoreExceptRating()):(this.gameType&&(this.ratingMin(this.store[this.gameType]().ratingMin),this.ratingMax(this.store[this.gameType]().ratingMax)),this.savePropsToStore()),this.root.redraw()};this.propWithApply=t=>Ye(t,this.onPropChange);this.openModal=(t,o,r)=>{this.root.leavePool(),this.gameType=t,this.loading=!1,this.fenError=!1,this.lastValidFen="",this.friendUser=r||"",this.loadPropsFromStore(o)};this.closeModal=()=>{this.gameType=null,this.root.redraw()};this.validateFen=Ie(()=>{let t=this.fen();t&&W(Te("/setup/validate-fen",{fen:t,strict:this.gameType==="ai"?1:void 0})).then(()=>{this.fenError=!1,this.lastValidFen=t,this.root.redraw()},()=>{this.fenError=!0,this.root.redraw()})},300);this.ratedModeDisabled=()=>!this.root.me||this.gameType==="hook"&&this.timeMode()==="unlimited"||this.variant()!=="standard"&&(this.timeMode()!=="realTime"||this.time()<.5&&this.increment()==0||this.time()==0&&this.increment()<2);this.selectedPerf=()=>Hs(this.variant(),this.timeMode(),this.time(),this.increment());this.ratingRange=()=>{if(!this.root.data.ratingMap)return"";let t=this.root.data.ratingMap[this.selectedPerf()].rating;return`${Math.max(100,t+this.ratingMin())}-${t+this.ratingMax()}`};this.hookToPoolMember=t=>{let o=t=="random"&&this.gameType==="hook"&&this.variant()=="standard"&&this.gameMode()=="rated"&&this.timeMode()=="realTime",r=`${this.time()}+${this.increment()}`;return o&&this.root.pools.find(n=>n.id===r)?{id:r,range:this.ratingRange()}:null};this.propsToFormData=t=>ee({variant:yo(this.variant(),me).toString(),fen:this.fen(),timeMode:yo(this.timeMode(),Lt(this.root.trans)).toString(),time:this.time().toString(),time_range:this.timeV().toString(),increment:this.increment().toString(),increment_range:this.incrementV().toString(),days:this.days().toString(),days_range:this.daysV().toString(),mode:this.gameMode()==="casual"?"0":"1",ratingRange:this.ratingRange(),ratingRange_range_min:this.ratingMin().toString(),ratingRange_range_max:this.ratingMax().toString(),level:this.aiLevel().toString(),color:t});this.validFen=()=>this.variant()!=="fromPosition"||!this.fenError;this.validTime=()=>this.timeMode()!=="realTime"||this.time()>0||this.increment()>0;this.validAiTime=()=>this.gameType!=="ai"||this.timeMode()!=="realTime"||this.variant()!=="fromPosition"||this.time()>=1;this.valid=()=>this.validFen()&&this.validTime()&&this.validAiTime();this.submit=async t=>{let o=this.hookToPoolMember(t);if(o){this.root.enterPool(o),this.closeModal();return}this.gameType==="hook"&&this.root.setTab(this.timeMode()==="realTime"?"real_time":"seeks"),this.loading=!0,this.root.redraw();let r=`/setup/${this.gameType}`;this.gameType==="hook"&&(r+=`/${lichess.sri}`);let n={user:this.friendUser||void 0},i;try{i=await Dt(Te(r,n),{method:"post",body:this.propsToFormData(t)})}catch(d){this.loading=!1,this.root.redraw(),alert("Sorry, we encountered an error while creating your game. Please try again.");return}let{ok:l,redirected:c,url:u}=i;if(l)c?location.href=u:(this.loading=!1,this.closeModal());else{let d=await i.json();alert(d?Object.keys(d).map(g=>`${g}: ${d[g]}`).join(`
`):"Invalid setup"),i.status==403&&this.closeModal()}};this.root=t,this.blindModeColor=Ye("random",this.onPropChange),this.store={hook:this.makeSetupStore("hook"),friend:this.makeSetupStore("friend"),ai:this.makeSetupStore("ai")}}};var Xe=class{constructor(t,o){this.opts=t;this.redraw=o;this.stepHooks=[];this.stepping=!1;this.redirecting=!1;this.alreadyWatching=[];this.initNumberSpreader=(t,o,r)=>{let n=r,i=[],l=(c,u,d)=>{t.textContent=Ke(Math.round((c*(o-1-d)+u*(d+1))/o))};return c=>{if(!c&&c!==0)return;i.forEach(clearTimeout),i=[];let u=Math.abs(lichess.socket.pingInterval()/o),d=n||c;n=c;for(let g=0;g<o;g++)i.push(setTimeout(()=>l(d,c,g),Math.round(g*u)))}};this.flushHooks=t=>{this.flushHooksTimeout&&clearTimeout(this.flushHooksTimeout),t?this.doFlushHooks():(this.stepping=!0,this.tab==="real_time"&&this.redraw(),setTimeout(()=>{this.stepping=!1,this.doFlushHooks()},500)),this.flushHooksTimeout=this.flushHooksSchedule()};this.flushHooksSchedule=()=>setTimeout(this.flushHooks,8e3);this.setTab=t=>{t!==this.tab&&(t==="seeks"?je().then(this.setSeeks):t==="real_time"?this.socket.realTimeIn():this.tab==="real_time"&&(this.socket.realTimeOut(),this.data.hooks=[]),this.tab=this.stores.tab.set(t)),this.filter.open=!1};this.setMode=t=>{this.mode=this.stores.mode.set(t),this.filter.open=!1};this.setSort=t=>{this.sort=this.stores.sort.set(t)};this.onSetFilter=()=>{this.flushHooks(!0),this.tab!=="real_time"&&this.redraw()};this.clickHook=t=>{let o=on(this,t);!o||o.disabled||this.stepping||this.redirecting||(o.action==="cancel"||mo(o.variant))&&this.socket.send(o.action,o.id)};this.clickSeek=t=>{let o=rn(this,t);!o||this.redirecting||(o.action==="cancelSeek"||mo(o.variant))&&this.socket.send(o.action,o.id)};this.setSeeks=t=>{this.data.seeks=t,bo(this),this.redraw()};this.clickPool=t=>{this.me?this.poolMember&&this.poolMember.id===t?this.leavePool():this.enterPool({id:t}):(dn(this.pools.find(o=>o.id==t)),this.setTab("real_time")),this.redraw()};this.enterPool=t=>{mn(this.me,t),this.setTab("pools"),this.poolMember=t,this.poolIn()};this.leavePool=()=>{this.poolMember&&(this.socket.poolOut(this.poolMember),this.poolMember=void 0)};this.poolIn=()=>{this.poolMember&&(this.poolInStorage.fire(),this.socket.poolIn(this.poolMember))};this.hasOngoingRealTimeGame=()=>!!this.data.nowPlaying.find(t=>t.isMyTurn&&t.speed!=="correspondence");this.gameActivity=t=>{this.data.nowPlaying.find(o=>o.gameId===t)&&cn().then(o=>{this.data.nowPlaying=o,this.startWatching(),this.redraw()})};this.setRedirecting=()=>{this.redirecting=!0,setTimeout(()=>{this.redirecting=!1,this.redraw()},4e3),this.redraw()};this.awake=()=>{switch(this.tab){case"real_time":this.data.hooks=[],this.socket.realTimeIn();break;case"seeks":je().then(this.setSeeks);break}};this.joinPoolFromLocationHash=()=>{if(location.hash.startsWith("#pool/")){let t=/^#pool\/(\d+\+\d+)(?:\/(.+))?$/,o=t.exec(location.hash),r={id:o[1],blocking:o[2]},n=fn(this.me,r.id);n&&(r.range=n),o&&(this.setTab("pools"),this.me?this.enterPool(r):setTimeout(()=>this.clickPool(r.id),1500),history.replaceState(null,"","/"))}};var n,i;this.data=t.data,this.data.hooks=[],this.me=t.data.me,this.pools=t.pools,this.playban=t.playban,this.filter=new Ge(lichess.storage.make("lobby.filter"),this),this.setupCtrl=new Ze(this),ho(this),bo(this),this.socket=new ze(t.socketSend,this),this.stores=nn((n=this.me)==null?void 0:n.username.toLowerCase()),this.tab=(i=this.me)!=null&&i.isBot?"now_playing":this.stores.tab.get(),this.mode=this.stores.mode.get(),this.sort=this.stores.sort.get(),this.trans=t.trans;let r=location.hash.replace("#","");if(["ai","friend","hook"].includes(r)){let l,c={},u=new URLSearchParams(location.search);r==="hook"?u.get("time")==="realTime"?(this.tab="real_time",c.timeMode="realTime"):u.get("time")==="correspondence"&&(this.tab="seeks",c.timeMode="correspondence"):u.get("fen")?(c.fen=u.get("fen"),c.variant="fromPosition"):l=u.get("user"),this.setupCtrl.openModal(r,c,l),history.replaceState(null,"","/")}this.poolInStorage=lichess.storage.make("lobby.pool-in"),this.poolInStorage.listen(l=>{this.leavePool(),o()}),this.flushHooksSchedule(),this.startWatching(),this.playban?this.playban.remainingSeconds<86400&&setTimeout(lichess.reload,this.playban.remainingSeconds*1e3):(setInterval(()=>{this.poolMember?this.poolIn():this.tab==="real_time"&&!this.data.hooks.length&&this.socket.realTimeIn()},10*1e3),this.joinPoolFromLocationHash()),lichess.pubsub.on("socket.open",()=>{this.tab==="real_time"?(this.data.hooks=[],this.socket.realTimeIn()):this.tab==="pools"&&this.poolMember&&this.poolIn()}),window.addEventListener("beforeunload",()=>this.leavePool())}doFlushHooks(){this.stepHooks=this.data.hooks.slice(0),this.tab==="real_time"&&this.redraw()}startWatching(){let t=this.data.nowPlaying.map(o=>o.gameId).filter(o=>!this.alreadyWatching.includes(o));t.length&&(setTimeout(()=>this.socket.send("startWatching",t.join(" ")),2e3),t.forEach(o=>this.alreadyWatching.push(o)))}};s();s();function _t(e,t,o,r){return a("span",{attrs:{role:"tab"},class:{active:t===o,glowing:t!==o&&t==="pools"&&!!e.poolMember},hook:H("mousedown",n=>e.setTab(t),e.redraw)},r)}function Tn(e){var i;let t=e.data.nbNowPlaying,o=e.data.nowPlaying.filter(l=>l.isMyTurn).length,r=e.tab,n=(i=e.me)==null?void 0:i.isBot;return[n?void 0:_t(e,"pools",r,[e.trans.noarg("quickPairing")]),n?void 0:_t(e,"real_time",r,[e.trans.noarg("lobby")]),n?void 0:_t(e,"seeks",r,[e.trans.noarg("correspondence")]),r==="now_playing"||t||n?_t(e,"now_playing",r,[...e.trans.vdomPlural("nbGamesInPlay",t,t>=100?"100+":t.toString()),o>0?a("i.unread",o>=9?"9+":o):null]):null]}s();function Sn(e){return H("click",t=>{let o=t.target.getAttribute("data-id")||t.target.parentNode.getAttribute("data-id");o==="custom"?e.setupCtrl.openModal("hook"):o&&e.clickPool(o)},e.redraw)}function Cn(e){let t=e.poolMember;return e.pools.map(o=>{let r=!!t&&t.id===o.id;return a("div",{class:{active:r,transp:!r&&(!!t&&!r)},attrs:{"data-id":o.id}},[a("div.clock",`${o.lim}+${o.inc}`),r&&t.range&&!e.opts.hideRatings?a("div.range",t.range.replace("-","\u2013")):a("div.perf",o.perf),r?de():null])}).concat(a("div.custom",{class:{transp:!!t},attrs:{"data-id":"custom"}},e.trans.noarg("custom")))}s();s();s();function Et(e){return e.map(function(t){return a("td",[t])})}var Ht={ultraBullet:"UltraBullet",bullet:"Bullet",blitz:"Blitz",rapid:"Rapid",classical:"Classical",correspondence:"Correspondence",racingKings:"Racing Kings",threeCheck:"Three-check",antichess:"Antichess",horde:"Horde",atomic:"Atomic",crazyhouse:"Crazyhouse",chess960:"Chess960",kingOfTheHill:"King of the Hill"};s();var Ns={ultraBullet:ft,bullet:ut,blitz:st,rapid:rt,classical:at,correspondence:ct,chess960:nt,kingOfTheHill:it,antichess:pt,atomic:dt,threeCheck:lt,horde:mt,racingKings:tt,crazyhouse:ot},fe=Ns;function Fs(e,t){let o=e.trans.noarg;return a("tr.hook."+t.action,{key:t.id,class:{disabled:!!t.disabled},attrs:{title:t.disabled?"":t.action==="join"?o("joinTheGame")+" | "+Ht[t.perf]:o("cancel"),"data-id":t.id}},Et([a("span.is.color-icon."+(t.c||"random")),t.rating?a("span.ulink.ulpt",{attrs:{"data-href":"/@/"+t.u}},t.u):o("anonymous"),t.rating&&!e.opts.hideRatings?t.rating+(t.prov?"?":""):"",t.clock,a("span",{attrs:{"data-icon":fe[t.perf]}},o(t.ra?"rated":"casual"))]))}var Pn=e=>t=>t.variant==="standard"===e,An=e=>e.action==="cancel",Ln=e=>!An(e),_n=e=>a("i.toggle",{key:"set-mode-chart",attrs:{title:e.trans.noarg("graph"),"data-icon":Ko},hook:H("mousedown",t=>e.setMode("chart"),e.redraw)}),En=(e,t)=>{let o=t.find(An),r=o?13:14,n=t.slice(0,r),i=d=>Fs(e,d),l=n.filter(Ln).filter(Pn(!0));fo(e,l);let c=n.filter(Ln).filter(Pn(!1)).slice(0,Math.max(0,r-l.length-1));fo(e,c);let u=[...l.map(i),c.length?a("tr.variants",{key:"variants"},[a("td",{attrs:{colspan:5}},"\u2014 "+e.trans("variant")+" \u2014")]):null,...c.map(i)];return o&&u.unshift(i(o)),a("table.hooks__list",[a("thead",a("tr",[a("th"),a("th",e.trans("player")),a("th",{class:{sortable:!0,sort:e.sort==="rating"},hook:H("click",d=>e.setSort("rating"),e.redraw)},[a("i.is"),e.trans("rating")]),a("th",{class:{sortable:!0,sort:e.sort==="time"},hook:H("click",d=>e.setSort("time"),e.redraw)},[a("i.is"),e.trans("time")]),a("th",e.trans("mode"))])),a("tbody",{class:{stepping:e.stepping},hook:H("click",d=>{let g=d.target;do if(g=g.parentNode,g.nodeName==="TR")return e.clickHook(g.getAttribute("data-id"));while(g.nodeName!=="TABLE")},e.redraw)},u)])};s();var ve=e=>e+"%",It=e=>Math.log(e/150+1);function Hn(e){let t=Math.max(1e3,Math.min(2200,e||1500)),o,r=2/5;return t==1500?o=r:t>1500?o=r+It(t-1500)/It(1300)*2*r:o=r-It(1500-t)/It(500)*r,Math.round(o*94)}var wo=2e3,In=e=>{let t=o=>Math.log((o-30)/200+1);return Math.round(t(Math.min(wo,e||wo))/t(wo)*100)};function Vs(e,t){let o=Math.max(0,Hn(t.rating)-2),r=Math.max(0,In(t.t)-2),n=[t.id,"plot.new",t.ra?"rated":"casual",t.action==="cancel"?"cancel":""].join(".");return a("span#"+n,{key:t.id,attrs:{"data-icon":fe[t.perf],style:`bottom:${ve(o)};left:${ve(r)}`},hook:{insert(i){$(i.elm).powerTip({placement:t.rating&&t.rating>1800?"se":"ne",closeDelay:200,popupId:"hook",preRender(){$("#hook").html($s(e,t)).find(".inner-clickable").on("click",()=>e.clickHook(t.id))}}),setTimeout(function(){i.elm.classList.remove("new")},20)},destroy(i){$.powerTip.hide(i.elm,!0),$.powerTip.destroy(i.elm)}}})}function $s(e,t){let o=t.c||"random",r='<div class="inner">';return t.rating?(r+='<a class="opponent ulpt is color-icon '+o+'" href="/@/'+t.u+'">',r+=" "+t.u,e.opts.hideRatings||(r+=" ("+t.rating+(t.prov?"?":"")+")"),r+="</a>"):r+='<span class="opponent anon '+o+'">'+e.trans("anonymous")+"</span>",r+='<div class="inner-clickable">',r+=`<div>${t.clock}</div>`,r+='<i data-icon="'+fe[t.perf]+'"> '+e.trans(t.ra?"rated":"casual")+"</i>",r+="</div></div>",r}var Ds=[1,2,3,5,7,10,15,20,30];function Bs(){let e=[];return Ds.forEach(t=>{let o=In(t*60);e.push(a("span.x.label",{attrs:{style:"left:"+ve(o-1.5)}},""+t)),e.push(a("div.grid.vert",{attrs:{style:"width:"+ve(o)}}))}),e}var Os=[1e3,1200,1400,1500,1600,1800,2e3];function Ws(){let e=[];return Os.forEach(function(t){let o=Hn(t);e.push(a("span.y.label",{attrs:{style:"bottom:"+ve(o+1)}},""+t)),e.push(a("div.grid.horiz",{attrs:{style:"height:"+ve(o+.8)}}))}),e}function Nn(e){return a("i.toggle",{key:"set-mode-list",attrs:{title:e.trans.noarg("list"),"data-icon":jo},hook:H("mousedown",t=>e.setMode("list"),e.redraw)})}function Fn(e,t){return a("div.hooks__chart",[a("div.canvas",{hook:H("click",o=>{o.target.classList.contains("plot")&&e.clickHook(o.target.id)},e.redraw)},t.map(o=>Vs(e,o))),...Ws(),...Bs()])}s();function js(e,t){var h;let o=(h=e.filter.data)==null?void 0:h.form,r=$(t),n=r.find(".rating-range"),i=n.find('input[name="ratingRange"]'),l=n.find(".rating-range__min"),c=n.find(".rating-range__max");o?Object.keys(o).forEach(C=>{let L=r.find(`input[name="${C}"]`)[0];L&&(L.type=="checkbox"?L.checked=!0:L.value=o[C])}):r.find("input").prop("checked",!0);let u=()=>e.filter.save(r.find("form")[0]);r.find("input").on("change",u),r.find("form").on("reset",C=>{C.preventDefault(),e.filter.save(null),e.filter.open=!1,e.redraw()}).on("submit",C=>{C.preventDefault(),e.filter.open=!1,e.redraw()});function d(C){l.attr("max",c.val()),c.attr("min",l.val());let L=l.val()+"-"+c.val();i.val(L),n.siblings(".range").text(L),C&&u()}let g=i.val()?i.val().split("-"):[];l.attr({step:"50",value:g[0]||l.attr("min")}).on("input",d),c.attr({step:"50",value:g[1]||c.attr("max")}).on("input",d),d()}function Rn(e,t){let o=e.filter;return a("i.toggle.toggle-filter",{class:{gamesFiltered:t>0,active:o.open},hook:H("mousedown",o.toggle,e.redraw),attrs:{"data-icon":o.open?_e:zt,title:e.trans.noarg("filterGames")}})}var Vn=e=>a("div.hook__filters",{hook:{insert(t){let o=t.elm;o.filterLoaded||(lichess.loadCssPath("lobby.setup"),W("/setup/filter").then(r=>{o.innerHTML=r,o.filterLoaded=!0,js(e,o)}))}}});function $n(e){let t,o,r,n,i;switch(e.filter.open&&(t=Vn(e)),e.mode){case"chart":i=e.filter.filter(e.data.hooks),r=i.hidden,o=t||Fn(e,i.visible),n=e.filter.open?null:Nn(e);break;default:i=e.filter.filter(e.stepHooks),r=i.hidden,o=t||En(e,i.visible),n=e.filter.open?null:_n(e)}return[Rn(e,r),n,o]}s();function Gs(e,t){let o=t.action==="joinSeek"?"join":"cancel",r=e.trans.noarg;return a("tr.seek."+o,{key:t.id,attrs:{title:t.action==="joinSeek"?r("joinTheGame")+" - "+Ht[t.perf.key]:r("cancel"),"data-id":t.id}},Et([a("span.is.color-icon."+(t.color||"random")),t.rating?a("span.ulpt",{attrs:{"data-href":"/@/"+t.username}},t.username):"Anonymous",t.rating&&!e.opts.hideRatings?t.rating+(t.provisional?"?":""):"",t.days?e.trans.pluralSame("nbDays",t.days):"\u221E",a("span",[a("span.varicon",{attrs:{"data-icon":fe[t.perf.key]}}),r(t.mode===1?"rated":"casual")])]))}function qs(e){if(e.me&&e.data.seeks.length<8)return a("div.create",[a("a.button",{hook:H("click",()=>e.setupCtrl.openModal("hook",{variant:"standard",timeMode:"correspondence"}),e.redraw)},e.trans("createAGame"))])}function Dn(e){return[a("table.hooks__list",[a("thead",[a("tr",["","player","rating","time","mode"].map(t=>a("th",e.trans(t))))]),a("tbody",{hook:H("click",t=>{let o=t.target;do if(o=o.parentNode,o.nodeName==="TR"){if(!e.me){confirm(e.trans("youNeedAnAccountToDoThat"))&&(location.href="/signup");return}return e.clickSeek(o.getAttribute("data-id"))}while(o.nodeName!=="TABLE")})},e.data.seeks.map(t=>Gs(e,t)))]),qs(e)]}s();function Us(e){let t=Date.now()+e.secondsLeft*1e3;return a("time.timeago",{hook:{insert(o){o.elm.setAttribute("datetime",""+t)}}},lichess.timeago(t))}function Bn(e){return a("div.now-playing",e.data.nowPlaying.map(t=>a("a."+t.variant.key,{key:`${t.gameId}${t.lastMove}`,attrs:{href:"/"+t.fullId}},[a("span.mini-board.cg-wrap.is2d",{attrs:{"data-state":`${t.fen},${t.orientation||t.color},${t.lastMove}`},hook:{insert(o){lichess.miniBoard.init(o.elm)}}}),a("span.meta",[t.opponent.ai?e.trans("aiNameLevelAiLevel","Stockfish",t.opponent.ai):t.opponent.username,a("span.indicator",t.isMyTurn?t.secondsLeft&&t.hasMoved?Us(t):[e.trans.noarg("yourTurn")]:a("span","\xA0"))])])))}function Mo(e){let t,o={};if(e.redirecting)t=de();else switch(e.tab){case"pools":t=Cn(e),o={hook:Sn(e)};break;case"real_time":t=$n(e);break;case"seeks":t=Dn(e);break;case"now_playing":t=Bn(e);break}return a("div.lobby__app.lobby__app-"+e.tab,[a("div.tabs-horiz",{attrs:{role:"tablist"}},Tn(e)),a("div.lobby__app__content.l"+(e.redirecting?"redir":e.tab),o,t)])}s();s();s();var Nt="modal-overlay";function Q(e){Q.close();let t=$(`<div id="modal-wrap"><span class="close" role="button" aria-label="Close" data-icon="${_e}" tabindex="0"></span></div>`),o=$(`<div id="${Nt}" class="${e.class}">`);return e.noClickAway||o.on("click",Q.close),$('<a href="#"></a>').appendTo(o),t.appendTo(o),$('<a href="#"></a>').appendTo(o),e.content.clone().removeClass("none").appendTo(t),e.onInsert&&e.onInsert(t),Q.onClose=e.onClose,t.find(".close,.cancel").each(function(){Wn(this,Q.close)}),$("body").addClass("overlayed").prepend(o),Kn(t),t}Q.close=()=>{$("body").removeClass("overlayed"),$(`#${Nt}`).each(function(){Q.onClose&&Q.onClose(),$(this).remove()}),delete Q.onClose};Q.onClose=void 0;function On(e){let t=e.onClose;return a(`div#${Nt}`,e.noClickAway?{}:{hook:H("mousedown",o=>{o.target.id==Nt&&t()})},[a("div#modal-wrap."+e.class,{hook:J(o=>{Kn($(o)),e.onInsert&&e.onInsert($(o))})},[a("span.close",{attrs:{"data-icon":_e,role:"button","aria-label":"Close",tabindex:"0"},hook:J(o=>Wn(o,t))}),a("div",e.content)])])}var Wn=(e,t)=>{e.addEventListener("click",t),e.addEventListener("keydown",o=>o.code==="Enter"||o.code==="Space"?t():!0)},Kn=e=>{e.on("click",t=>t.stopPropagation()),Xs(e)},Zs='button:not(:disabled), [href], input:not(:disabled):not([type="hidden"]), select:not(:disabled), textarea:not(:disabled), [tabindex="0"]';var Xs=e=>{let t=e.find(Zs);setTimeout(()=>{var o,r;return(r=(o=t[1])!==null&&o!==void 0?o:t[0])===null||r===void 0?void 0:r.focus()})};s();s();s();var Z=({key:e,name:t},o)=>a("option",{attrs:{value:e,selected:e===o}},t);var ye=e=>{let{trans:t,setupCtrl:o}=e,r=lichess.blindMode?yn:me;return a("div.variant.label-select",[a("label",{attrs:{for:"sf_variant"}},t("variant")),a("select#sf_variant",{on:{change:n=>o.variant(n.target.value)},hook:J(n=>n.focus())},xn(r,o.gameType).map(n=>Z(n,o.variant())))])};s();var jn=e=>e==1/4?"\xBC":e==1/2?"\xBD":e==3/4?"\xBE":e.toString(),Js=(e,t)=>{let{trans:o,setupCtrl:r}=e;return[zn(e,t),r.timeMode()==="realTime"?a("div.time-choice",[a("label",{attrs:{for:"sf_time"}},o("minutesPerSide")),a("select#sf_time",{on:{change:n=>r.timeV(parseFloat(n.target.value))}},Pt.map((n,i)=>Z({key:i.toString(),name:jn(n)},r.timeV().toString())))]):null,r.timeMode()==="realTime"?a("div.increment-choice",[a("label",{attrs:{for:"sf_increment"}},o("incrementInSeconds")),a("select#sf_increment",{on:{change:n=>r.incrementV(parseInt(n.target.value))}},Array.from(Array(31).keys()).map(n=>Z({key:n.toString(),name:qe(n).toString()},r.incrementV().toString())))]):null,r.timeMode()==="correspondence"?a("div.days-choice",[a("label",{attrs:{for:"sf_days"}},o("daysPerTurn")),a("select#sf_days",{on:{change:n=>r.daysV(parseInt(n.target.value))}},Array.from(Array(7).keys()).map(n=>Z({key:(n+1).toString(),name:Ue(n+1).toString()},r.daysV().toString())))]):null]},zn=(e,t=!1)=>{let{trans:o,setupCtrl:r}=e;return e.me||t?a("div.label-select",[a("label",{attrs:{for:"sf_timeMode"}},o("timeControl")),a("select#sf_timeMode",{on:{change:n=>r.timeMode(n.target.value)}},Lt(o).map(n=>Z(n,r.timeMode())))]):null},To=(e,t,o,r)=>a("input.range",{class:r,attrs:{type:"range",min:e,max:t,value:o()},on:{input:n=>o(parseFloat(n.target.value))}}),xe=(e,t=!1)=>{let{trans:o,setupCtrl:r}=e;return a("div.time-mode-config.optional-config",lichess.blindMode?Js(e,t):[zn(e,t),r.timeMode()==="realTime"?a("div.time-choice.range",[`${o("minutesPerSide")}: `,a("span",jn(r.time())),To(0,38,r.timeV,{failure:!r.validTime()||!r.validAiTime()})]):null,r.timeMode()==="realTime"?a("div.increment-choice.range",[`${o("incrementInSeconds")}: `,a("span",r.increment()),To(0,30,r.incrementV,{failure:!r.validTime()})]):r.timeMode()==="correspondence"?a("div.correspondence",a("div.days-choice.range",[`${o("daysPerTurn")}: `,a("span",r.days()),To(1,7,r.daysV)])):null])};s();var Ft=e=>{if(!e.me)return null;let{trans:t,setupCtrl:o}=e;return a("div.mode-choice.buttons",a("group.radio",Mn(t).map(({key:r,name:n})=>{let i=r==="rated"&&o.ratedModeDisabled();return a("div",[a(`input#sf_mode_${r}.checked_${r===o.gameMode()}`,{attrs:{name:n,type:"radio",value:r,checked:r===o.gameMode(),disabled:i},on:{change:l=>o.gameMode(l.target.value)}}),a("label",{class:{disabled:i},attrs:{for:`sf_mode_${r}`}},n)])})))};s();var Gn=e=>{if(!e.me||lichess.blindMode||!e.data.ratingMap)return null;let{trans:t,setupCtrl:o}=e,r=e.setupCtrl.selectedPerf(),n=!!e.data.ratingMap[r].prov,i=n?".disabled":"",l=n?-500:o.ratingMin(),c=n?500:o.ratingMax();return a(`div.rating-range-config.optional-config${i}`,{attrs:n?{title:"Your rating is still provisional, play some rated games to use the rating range."}:void 0},[t("ratingRange"),a("div.rating-range",[a("input.range.rating-range__min",{attrs:{type:"range",min:"-500",max:"0",step:"50",value:l,disabled:n},on:{input:u=>{let d=parseInt(u.target.value);d===0&&o.ratingMax()===0&&o.ratingMax(50),o.ratingMin(d)}}}),a("span.rating-min","-"+Math.abs(l)),"/",a("span.rating-max","+"+c),a("input.range.rating-range__max",{attrs:{type:"range",min:"0",max:"500",step:"50",value:c,disabled:n},on:{input:u=>{let d=parseInt(u.target.value);d===0&&o.ratingMin()===0&&o.ratingMin(-50),o.ratingMax(d)}}})])])};s();var Ys=e=>[...e.setupCtrl.gameType==="hook"?[]:[a("label",{attrs:{for:"sf_color"}},e.trans("side")),a("select#sf_color",{on:{change:t=>e.setupCtrl.blindModeColor(t.target.value)}},ko(e.trans).map(t=>Z(t,e.setupCtrl.blindModeColor())))],a("button",{on:{click:()=>e.setupCtrl.submit(e.setupCtrl.blindModeColor())}},"Create the game")],ke=e=>{let{setupCtrl:t}=e,o=[];return t.valid()&&(o.push("random"),t.gameType!=="ai"&&t.gameMode()==="rated"&&kn.includes(t.variant())||o.push("white","black")),a("div.color-submits",lichess.blindMode?Ys(e):t.loading?de():ko(e.trans).map(({key:r,name:n})=>a(`button.button.button-metal.color-submits__button.${r}`,{attrs:{disabled:!o.includes(r),title:n,value:r},on:{click:()=>e.setupCtrl.submit(r)}},a("i"))))};s();var we=e=>{let{opts:t,data:o}=e;if(lichess.blindMode||!o.ratingMap)return null;let r=e.setupCtrl.selectedPerf(),n=me.find(({key:i})=>i===r)||wn.find(({key:i})=>i===r);if(n){let i={attrs:{"data-icon":n.icon}};return a("div.ratings",t.hideRatings?[a("i",i),n.name]:[...e.trans.vdom("perfRatingX",a("strong",i,o.ratingMap[r].rating+(o.ratingMap[r].prov?"?":""))),n.name])}};function So(e){let{trans:t}=e;return[a("h2",t("createAGame")),a("div.setup-content",[ye(e),xe(e),Ft(e),Gn(e),ke(e)]),we(e)]}s();s();function Co(e,t,o){let r=o?a("line.line.patron",{attrs:{title:"Lichess Patron"}}):void 0;return a("a",{class:{"user-link":!0,ulpt:!0},attrs:{href:"/@/"+e}},t&&t!="BOT"?[r,a("span.utitle",t),e]:[r,e])}s();var Rt=e=>{let{trans:t,setupCtrl:o}=e;if(o.variant()!=="fromPosition")return null;let r=o.fen();return a("div.fen.optional-config",[a("div.fen__form",[a("input#fen-input",{attrs:{placeholder:t("pasteTheFenStringHere"),value:r},on:{input:n=>{o.fen(n.target.value),o.validateFen()}},hook:{insert:o.validateFen},class:{failure:o.fenError}}),a("a.button.button-empty",{attrs:{"data-icon":zo,title:t("boardEditor"),href:"/editor"+(r?`/${r.replace(" ","_")}`:"")}})]),a("a.fen__board",{attrs:{href:"/editor"}},o.fenError||!o.lastValidFen?null:a("span.preview",a("div.position.mini-board.cg-wrap.is2d",{attrs:{"data-state":`${o.lastValidFen},white`},hook:{insert:n=>lichess.miniBoard.init(n.elm),update:n=>lichess.miniBoard.init(n.elm)}})))])};function Po(e){let{trans:t}=e;return[a("h2",t("playWithAFriend")),a("div.setup-content",[e.setupCtrl.friendUser?Co(e.setupCtrl.friendUser):null,ye(e),Rt(e),xe(e,!0),Ft(e),ke(e)]),we(e)]}s();s();var qn=e=>{let{trans:t,setupCtrl:o}=e;return lichess.blindMode?[a("label",{attrs:{for:"sf_level"}},t("strength")),a("select#sf_level",{on:{change:r=>o.aiLevel(parseInt(r.target.value))}},"12345678".split("").map(r=>Z({key:r,name:r},o.aiLevel().toString())))]:[a("br"),t("strength"),a("div.level.buttons",[a("div.config_level",a("group.radio",[1,2,3,4,5,6,7,8].map(r=>a("div",[a(`input#sf_level_${r}`,{attrs:{name:"level",type:"radio",value:r,checked:r===o.aiLevel()},on:{change:n=>o.aiLevel(parseInt(n.target.value))}}),a("label",{attrs:{for:`sf_level_${r}`}},r)])))),a("div.ai_info",a(`div.sf_level_${o.aiLevel()}`,t("aiNameLevelAiLevel","Fairy-Stockfish 14",o.aiLevel())))])]};function Lo(e){let{trans:t}=e;return[a("h2",t("playWithTheMachine")),a("div.setup-content",[ye(e),Rt(e),xe(e,!0),...qn(e),ke(e)]),we(e)]}var Qs={hook:So,friend:Po,ai:Lo};function Ao(e){let{setupCtrl:t}=e;if(!t.gameType)return null;let o=Qs[t.gameType];return On({class:"game-setup",onInsert:()=>lichess.loadCssPath("lobby.setup"),onClose:t.closeModal,content:o(e)})}function Vt(e){var u;let{data:t,trans:o,opts:r}=e,n=e.hasOngoingRealTimeGame(),i=r.playban||r.hasUnreadLichessMessage||((u=e.me)==null?void 0:u.isBot)||n,{members:l,rounds:c}=t.counters;return a("div.lobby__table",[a("div.bg-switch",{attrs:{title:"Dark mode"}},[a("div.bg-switch__track"),a("div.bg-switch__thumb")]),a("div.lobby__start",(lichess.blindMode?[a("h2","Play")]:[]).concat([["hook","createAGame",i],["friend","playWithAFriend",n],["ai","playWithTheMachine",n]].map(([d,g,h])=>a(`button.button.button-metal.config_${d}`,{class:{active:e.setupCtrl.gameType===d,disabled:h},attrs:{type:"button"},hook:h?{}:H(lichess.blindMode?"click":"mousedown",()=>e.setupCtrl.openModal(d),e.redraw)},o(g))))),Ao(e),Wt("div.lobby__counters",()=>a("div.lobby__counters",[lichess.blindMode?a("h2","Counters"):null,a("a",{attrs:lichess.blindMode?{}:{href:"/player"}},o.vdomPlural("nbPlayers",l,a("strong",{attrs:{"data-count":l},hook:J(d=>{e.spreadPlayersNumber=e.initNumberSpreader(d,10,l)})},Ke(l)))),a("a",lichess.blindMode?{}:{attrs:{href:"/games"}},o.vdomPlural("nbGamesInPlay",c,a("strong",{attrs:{"data-count":c},hook:J(d=>{e.spreadGamesNumber=e.initNumberSpreader(d,8,c)})},Ke(c))))]),[])])}var $t=Pe([Ae,Le,jt]);function _o(e){let t=new Xe(e,n);e.appElement.innerHTML="";let o=$t(e.appElement,Mo(t));e.tableElement.innerHTML="";let r=$t(e.tableElement,Vt(t));function n(){o=$t(o,Mo(t)),r=$t(r,Vt(t))}return t}window.Chessground=Ur;function Tf(e){e.appElement=document.querySelector(".lobby__app"),e.tableElement=document.querySelector(".lobby__table"),e.pools=[{id:"1+0",lim:1,inc:0,perf:"Bullet"},{id:"2+1",lim:2,inc:1,perf:"Bullet"},{id:"3+0",lim:3,inc:0,perf:"Blitz"},{id:"3+2",lim:3,inc:2,perf:"Blitz"},{id:"5+0",lim:5,inc:0,perf:"Blitz"},{id:"5+3",lim:5,inc:3,perf:"Blitz"},{id:"10+0",lim:10,inc:0,perf:"Rapid"},{id:"10+5",lim:10,inc:5,perf:"Rapid"},{id:"15+10",lim:15,inc:10,perf:"Rapid"},{id:"30+0",lim:30,inc:0,perf:"Classical"},{id:"30+20",lim:30,inc:20,perf:"Classical"}],e.trans=lichess.trans(e.i18n),lichess.socket=new lichess.StrongSocket("/lobby/socket/v5",!1,{receive:(o,r)=>t.socket.receive(o,r),events:{n(o,r){t.spreadPlayersNumber&&t.spreadPlayersNumber(r.d),setTimeout(()=>t.spreadGamesNumber&&t.spreadGamesNumber(r.r),lichess.socket.pingInterval()/2)},reload_timeline(){W("/timeline").then(o=>{$(".timeline").html(o),lichess.contentLoaded()})},featured(o){$(".lobby__tv").html(o.html),lichess.contentLoaded()},redirect(o){t.leavePool(),t.setRedirecting(),lichess.redirect(o)},fen(o){t.gameActivity(o.id)}}}),lichess.StrongSocket.firstConnect.then(()=>{let o=new URLSearchParams(location.search).get("hook_like");if(!o)return;let{ratingMin:r,ratingMax:n}=t.setupCtrl.makeSetupStore("hook")();W(Te(`/setup/hook/${lichess.sri}/like/${o}`,{deltaMin:r,deltaMax:n}),{method:"post"}),t.setTab("real_time"),t.redraw(),history.replaceState(null,"","/")}),e.socketSend=lichess.socket.send;let t=_o(e);e.data.me||ea()}function ea(){let e=window.matchMedia("(prefers-color-scheme: dark)").matches;document.body.getAttribute("data-theme")!=="system"||e||$(".bg-switch").addClass("active").on("click",()=>qo().then(o=>o.subs.background.set(document.body.dataset.theme==="dark"?"light":"dark")))}export{Tf as initModule};
