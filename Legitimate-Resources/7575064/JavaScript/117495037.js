var cPubgJNt = '{"campaigns":{},"events":{"157014829":{"type":"click","pageIds":["137701060"],"selector":".hero .cf__btn-rounded","name":"Click on .hero .cf__btn-rounded (Homepage)"},"157014869":{"type":"click","pageIds":["137701060"],"selector":"a:not([href^=\\"(http:|https:)?//\\"],[href^=\\"#\\"])","name":"On-page engagement (Homepage)"}},"pages":{"137701060":{"name":"Homepage","urls":[{"match":"regex","value":"^(https?:\\\\/\\\\/)?(www\\\\.)?coinflip\\\\.tech\\\\/?([?#].*?)?$"}]}},"audiences":{},"model":{},"id":"117495037","name":"CoinFlip","encrypt":false,"ictp":0.2,"ipcc":false,"plugins":[],"schemaVersion":"2","crossOrigin":{"enabled":true,"originWhitelist":["^https:\\\\/\\\\/.+\\\\.olliv\\\\.com","^https:\\\\/\\\\/.+\\\\.coinflip\\\\.tech"],"originBlacklist":[]},"classicAccess":false}';
var iOverride = {};
(function(){"use strict";try{if(typeof document!="undefined"){var e=document.createElement("style");e.appendChild(document.createTextNode("")),document.head.appendChild(e)}}catch(t){console.error("vite-plugin-css-injected-by-js",t)}})();
var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__pow=Math.pow,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__spreadValues=(e,t)=>{for(var i in t||(t={}))__hasOwnProp.call(t,i)&&__defNormalProp(e,i,t[i]);if(__getOwnPropSymbols)for(var i of __getOwnPropSymbols(t))__propIsEnum.call(t,i)&&__defNormalProp(e,i,t[i]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t)),__objRest=(e,t)=>{var i={};for(var s in e)__hasOwnProp.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&__getOwnPropSymbols)for(var s of __getOwnPropSymbols(e))t.indexOf(s)<0&&__propIsEnum.call(e,s)&&(i[s]=e[s]);return i},__publicField=(e,t,i)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,i),i),__async=(e,t,i)=>new Promise(((s,n)=>{var r=e=>{try{o(i.next(e))}catch(t){n(t)}},a=e=>{try{o(i.throw(e))}catch(t){n(t)}},o=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,a);o((i=i.apply(e,t)).next())}));!function(){"use strict";var e,t,i={},s={},n={};e=n,Object.defineProperty(e,"__esModule",{value:!0}),(t=e.LogLevel||(e.LogLevel={}))[t.OFF=5]="OFF",t[t.ERROR=4]="ERROR",t[t.WARN=3]="WARN",t[t.INFO=2]="INFO",t[t.DEBUG=1]="DEBUG",t[t.TRACE=0]="TRACE",Object.defineProperty(s,"__esModule",{value:!0});var r=n,a=function(){function e(e,t){this.prefix="",this.theConsole=e,this.minimumLogLevel=t}return e.prototype.getLevel=function(){return this.minimumLogLevel},e.prototype.error=function(e,t){this.minimumLogLevel<=r.LogLevel.ERROR&&this.theConsole.error("["+t+"] "+this.format(e))},e.prototype.warn=function(e,t){this.minimumLogLevel<=r.LogLevel.WARN&&this.theConsole.warn("["+t+"] "+this.format(e))},e.prototype.info=function(e,t){if(this.minimumLogLevel<=r.LogLevel.INFO){var i=void 0!==t?"["+t+"] ":"";this.theConsole.info(""+i+this.format(e))}},e.prototype.debug=function(e,t){if(this.minimumLogLevel<=r.LogLevel.DEBUG){var i=void 0!==t?"["+t+"] ":"";(this.theConsole.debug?this.theConsole.debug:this.theConsole.log)(""+i+this.format(e))}},e.prototype.group=function(e){this.minimumLogLevel<=r.LogLevel.DEBUG&&(this.prefix+="âŽ¢ ",this.theConsole.log("[1m"+this.format(e)+"[22m"))},e.prototype.groupEnd=function(){this.minimumLogLevel<=r.LogLevel.DEBUG&&(this.prefix=this.prefix.slice(0,-2))},e.prototype.time=function(e){this.minimumLogLevel<=r.LogLevel.DEBUG&&this.theConsole.time(this.format(e))},e.prototype.timeEnd=function(e){this.minimumLogLevel<=r.LogLevel.DEBUG&&this.theConsole.timeEnd(this.format(e))},e.prototype.format=function(e){return e.toString().replace(/^/gm,this.prefix)},e}();s.BasicConsoleLogger=a;var o={};Object.defineProperty(o,"__esModule",{value:!0});var c=n;o.NO_OP_LOGGER={getLevel:function(){return c.LogLevel.OFF},error:function(){},warn:function(){},info:function(){},debug:function(){},group:function(){},groupEnd:function(){},time:function(){},timeEnd:function(){}};var l={};Object.defineProperty(l,"__esModule",{value:!0});var d=n,u=function(){function e(e,t){this.theConsole=e,this.minimumLogLevel=t}return e.prototype.getLevel=function(){return this.minimumLogLevel},e.prototype.error=function(e,t){this.minimumLogLevel<=d.LogLevel.ERROR&&this.theConsole.error("["+t+"] "+e)},e.prototype.warn=function(e,t){this.minimumLogLevel<=d.LogLevel.WARN&&this.theConsole.warn("["+t+"] "+e)},e.prototype.info=function(e,t){if(this.minimumLogLevel<=d.LogLevel.INFO){var i=void 0!==t?"["+t+"] ":"";this.theConsole.info(""+i+e)}},e.prototype.debug=function(e,t){if(this.minimumLogLevel<=d.LogLevel.DEBUG){var i=void 0!==t?"["+t+"] ":"";(this.theConsole.debug?this.theConsole.debug:this.theConsole.log)(""+i+e)}},e.prototype.group=function(e){this.minimumLogLevel<=d.LogLevel.DEBUG&&this.theConsole.group(e)},e.prototype.groupEnd=function(){this.minimumLogLevel<=d.LogLevel.DEBUG&&this.theConsole.groupEnd()},e.prototype.time=function(e){this.minimumLogLevel<=d.LogLevel.DEBUG&&this.theConsole.time(e)},e.prototype.timeEnd=function(e){this.minimumLogLevel<=d.LogLevel.DEBUG&&this.theConsole.timeEnd(e)},e}();l.GroupConsoleLogger=u,Object.defineProperty(i,"__esModule",{value:!0});var h=s,g=i.BasicConsoleLogger=h.BasicConsoleLogger,p=n,m=i.LogLevel=p.LogLevel,v=o,b=i.NO_OP_LOGGER=v.NO_OP_LOGGER,f=l,E=i.GroupConsoleLogger=f.GroupConsoleLogger;const _=e=>"[object Array]"===Object.prototype.toString.call(e),S=e=>"boolean"==typeof e,y=e=>"number"==typeof e,I=e=>"[object Object]"===Object.prototype.toString.call(e),C=e=>"[object String]"===Object.prototype.toString.call(e),T=e=>C(e)&&e.length>0,A=e=>void 0===e,x=e=>/^[\da-f]{8}-[\da-f]{4}-4[\da-f]{3}-[89ab][\da-f]{3}-[\da-f]{12}$/.test(e),w=e=>{try{return T(e)&&/^[\u0020-\u007E]+$/.test(e)}catch(t){return!1}},k=CSS.escape,F=e=>{const t=String(e),{length:i}=t;let s,n=-1,r="";for(;++n<i;)s=t.codePointAt(n),r+=0!==s?s>=1&&s<=31||127===s?`\\${s.toString(16)} `:34!==s&&92!==s?t.charAt(n):`\\${t.charAt(n)}`:"ï¿½";return r},P={class_regexes:[/active/,/current/,/selected/,/animate/,/visible/],id_regexes:[/active/,/current/,/selected/,/^mkto_/]},D={TAG_NAME:1,ID:2,CLASS:3,ATTRIBUTE:4};function M(e){const t=[],i=e;let s,n=!1;for(;e.parentElement&&(s=N(e));)if(t.length&&L(U(t),e.parentElement)&&!L(s))e=e.parentElement,n=!1;else{if(t.push(s+(n?" >":"")),!L(U(t),e.parentElement)){const i=V(e)||"",s=Array.prototype.slice.call(e.parentElement.children).filter((e=>i===V(e))).indexOf(e);t.pop(),t.push("".concat(i,":nth-of-type(").concat(`${s+1}`,")").concat(n?" >":""))}const r=U(t);if(L(r)&&$(i,r))return r;n=!0,e=e.parentElement}return null}function N(e){if(e===document)return null;const t=e.getAttribute("data-intellimize-id");if(null!==t&&""!==t&&L(`[data-intellimize-id="${t}"]`))return`[data-intellimize-id="${t}"]`;let i=O(e);const s=i.find((e=>e.type===D.TAG_NAME)),n=i.find((e=>e.type===D.ID));if(!s)return null;if("body"===s.selector||"html"===s.selector)return s.selector;if(n&&L(n.selector))return n.selector;let r=R(i);const a=W(r).length;if(i.length<6)for(let o=z(i),c=1;c<o.length;c+=1){const e=R(o[c]);e.length<r.length&&W(e).length===a&&(r=e)}else{for(let e=0;e<i.length;e+=1){const t=W(i[e].selector);if(t.length===a)return i[e].selector;i[e].nodeListLength=t.length}i=G(i,"nodeListLength");for(let e=0;e<i.length&&(r=R(i.slice(0,e+1)),W(r).length!==a);e+=1);}return r}function O(e){const t=[],i=V(e);i&&t.push({selector:i,type:D.TAG_NAME});const s=function(e){let t=e.id;if(C(t)){t=t.trim();for(let e=0;e<P.id_regexes.length;e+=1)if(P.id_regexes[e].test(t))return null;if(t.length>0)return"#".concat(k(t))}return null}(e);return s&&t.push({selector:s,type:D.ID}),function(e){const t=[];return(e.getAttribute("class")||"").replace(/\{.*\}/,"").split(/\s/).filter(T).forEach((e=>{P.class_regexes.find((t=>e.match(t)))||t.push(".".concat(k(e)))})),t}(e).forEach((e=>{t.push({selector:e,type:D.CLASS})})),function(e){const t=[];return["name"].forEach((i=>{const s=e.getAttribute(i);s&&t.push("[".concat(k(i),'="').concat(F(s),'"]'))})),t}(e).forEach((e=>{t.push({selector:e,type:D.ATTRIBUTE})})),t}function R(e){return G(e,"type").map((e=>e.selector)).join("")}function U(e){return[...e].reverse().join(" ").trim()}function V(e){return A(e.tagName)?null:e.tagName.toLowerCase()}function L(e,t){return t?1===W(e,t).length:1===W(e).length}function $(e,t){const i=W(t);return 1===i.length&&e===i[0]||(console.debug("Generated selector doesnt match element: ".concat(t)),!1)}function z(e){return Array.prototype.reduce.call(e,((e,t)=>{const i=[t];return e.reduce(((e,t)=>(e.push(t.concat(i)),e)),e)}),[[]])}function W(e,t){try{return(t||document).querySelectorAll(e)}catch(i){return(t||document).querySelectorAll("div#intellimize-guaranteed-not-to-exist-to-return-empty-nodelist")}}function G(e,t){const i=(e,i)=>e[t]>i[t]?1:i[t]>e[t]?-1:0;return e.concat().sort(i)}var B=(e=>(e.ATTRIBUTE="ATTRIBUTE",e.CUSTOM_CODE="CUSTOM_CODE",e.INSERT_ELEMENT="INSERT_ELEMENT",e.MOVE_ELEMENT="MOVE_ELEMENT",e))(B||{}),j=(e=>(e.backgroundColor="backgroundColor",e.backgroundImage="backgroundImage",e.backgroundPosition="backgroundPosition",e.backgroundRepeat="backgroundRepeat",e.backgroundSize="backgroundSize",e.borderColor="borderColor",e.borderStyle="borderStyle",e.borderWidth="borderWidth",e.borderRadius="borderRadius",e.bottom="bottom",e.boxShadow="boxShadow",e.clear="clear",e.color="color",e.cursor="cursor",e.direction="direction",e.float="float",e.fontFamily="fontFamily",e.fontSize="fontSize",e.fontWeight="fontWeight",e.left="left",e.letterSpacing="letterSpacing",e.lineHeight="lineHeight",e.listStyleType="listStyleType",e.listStylePosition="listStylePosition",e.height="height",e.minHeight="minHeight",e.maxHeight="maxHeight",e.width="width",e.minWidth="minWidth",e.maxWidth="maxWidth",e.visibility="visibility",e.display="display",e.position="position",e.margin="margin",e.marginLeft="marginLeft",e.marginRight="marginRight",e.marginTop="marginTop",e.marginBottom="marginBottom",e.opacity="opacity",e.overflow="overflow",e.padding="padding",e.paddingLeft="paddingLeft",e.paddingRight="paddingRight",e.paddingTop="paddingTop",e.paddingBottom="paddingBottom",e.right="right",e.textAlign="textAlign",e.textShadow="textShadow",e.textTransform="textTransform",e.top="top",e.wordSpacing="wordSpacing",e.zIndex="zIndex",e))(j||{});const H="imize-move-id",K=new Set(["beforebegin","afterbegin","beforeend","afterend"]),Q=e=>K.has(e),q=e=>I(e)&&Q(e.insertPosition)&&w(e.selector)&&ve(e,["insertPosition","selector"]),Y=e=>{if(!le(e))return!1;const t=e;return"ATTRIBUTE"===t.type&&w(t.selector)&&me(t.attributes)},J=e=>Y(e)&&ve(e,["type","selector","attributes","id"]),X=new Set(["rich-text","html-block","video","image","heading"]),Z=e=>X.has(e),ee=new Set(["1","2","3","4","5","6"]),te=e=>ee.has(e),ie=e=>{if(!le(e))return!1;const t=e;return"INSERT_ELEMENT"===t.type&&Z(t.elementType)&&q(t.targetPosition)&&T(t.idAttribute)},se=e=>!!ie(e)&&("heading"!==e.elementType||te(e.size)),ne=["id","type","targetPosition","elementType","size","idAttribute"],re=e=>se(e)&&ve(e,ne),ae=e=>I(e)&&e.type===B.MOVE_ELEMENT&&x(e.moveId)&&w(e.selector)&&q(e.targetPosition),oe=["id","type","targetPosition","selector","moveId"],ce=e=>ae(e)&&ve(e,oe),le=e=>I(e)&&pe(e.type)&&(A(e.id)||T(e.id)),de=e=>!!I(e)&&Object.keys(e).every((t=>t in j&&"string"==typeof e[t])),ue=e=>{if(!le(e))return!1;const t=e,{code:i,css:s}=t;return"CUSTOM_CODE"===t.type&&(void 0!==i||void 0!==s)&&(A(i)||T(i))&&(A(s)||T(s))},he=e=>ue(e)&&ve(e,["type","id","code","css"]),ge=(()=>new Set([B.ATTRIBUTE,B.CUSTOM_CODE,B.INSERT_ELEMENT,B.MOVE_ELEMENT]))(),pe=e=>ge.has(e),me=e=>!("object"!=typeof e||!A(e.html)&&!C(e.html)||!A(e.style)&&!C(e.style)||!A(e.className)&&!C(e.className)||!A(e.src)&&!C(e.src)||!A(e.alt)&&!C(e.alt)||!A(e.srcset)&&!C(e.srcset)||!A(e.sizes)&&!C(e.sizes)||!A(e.href)&&!C(e.href)||!A(e.value)&&!C(e.value)||!A(e.placeholder)&&!C(e.placeholder)||!A(e.maxlength)&&!y(e.maxlength)||!A(e.required)&&!S(e.required)||!A(e.poster)&&!C(e.poster)||!A(e.loop)&&!S(e.loop)||!A(e.autoplay)&&!S(e.autoplay)||!A(e.muted)&&!S(e.muted)||!A(e.controls)&&!S(e.controls)||!A(e.css)&&!de(e.css))&&ve(e,["html","style","className","src","alt","srcset","sizes","href","css","value","placeholder","maxlength","required","poster","loop","autoplay","muted","controls"]),ve=(e,t)=>!!I(e)&&Object.keys(e).every((e=>t.includes(e)));let be=class extends Error{};function fe(e,t){if(null==e||"string"==typeof e&&0===e.length)throw new be(t);return e}class Ee extends Error{}function _e(e,t){if(fe(e),!e)throw new Ee(t)}class Se extends Error{}function ye(e,t){if(fe(e),!e)throw new Se(t)}let Ie=class extends Error{};var Ce=Object.defineProperty,Te=(e,t,i)=>t in e?Ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Ae=(e,t,i)=>(Te(e,"symbol"!=typeof t?t+"":t,i),i);let xe=class{static empty(){return Fe.INSTANCE}static of(e){return new we(fe(e))}static ofNullable(e){return null==e||"string"==typeof e&&0===e.length?Fe.INSTANCE:new we(e)}};class we extends xe{constructor(e){super(),Ae(this,"value"),this.value=e}isPresent(){return!0}ifPresent(e){return e(this.value),this}ifAbsent(e){return this}get(){return this.value}orElse(e){return this.value}orElseRun(e){return this.value}toArray(){return[this.value]}map(e){return xe.ofNullable(e(this.value))}flatMap(e){return e(this.value)}toString(){return`Optional[${this.value.toString()}]`}}const ke=class extends xe{isPresent(){return!1}ifPresent(e){return this}ifAbsent(e){return e(),this}get(){throw new Ie("No value present")}orElse(e){return e}orElseRun(e){return e()}toArray(){return[]}map(e){return xe.empty()}flatMap(e){return xe.empty()}toString(){return"Optional.empty"}};let Fe=ke;Ae(Fe,"INSTANCE",new ke);var Pe=Object.defineProperty,De=(e,t,i)=>t in e?Pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Me=(e,t,i)=>(De(e,"symbol"!=typeof t?t+"":t,i),i);function Ne(e){return e.replace(/['\\]/g,(e=>"\\"+e))}function Oe(e,t=!0){return`document.querySelectorAll('${Ne(e)}').length ${t?"> 0":"=== 1"}`}function Re(e){const t=document.querySelectorAll(e),i=null==t?void 0:t[0];return 1===t.length&&void 0!==i?xe.of(i):xe.empty()}class Ue{constructor(e,t,i,s){var n,r,a,o;Me(this,"allVariationsMap",{}),Me(this,"id"),Me(this,"name"),Me(this,"type"),Me(this,"state"),Me(this,"pages"),Me(this,"condition"),Me(this,"audiences"),Me(this,"realPreconditions"),Me(this,"preconditions"),Me(this,"dependsOnExperienceIds"),Me(this,"dependsOnExperiences",[]),Me(this,"realVariations"),Me(this,"campaign"),Me(this,"ignore"),Me(this,"inclusionStickyConfig"),Me(this,"variationStickyConfig"),Me(this,"boundingSelectors"),Me(this,"playbookId"),Me(this,"note"),this.id=e,this.name=t.name,this.type=null!=(n=t.type)?n:"cc",this.state=t.state,this.inclusionStickyConfig=i.buildExperienceIncludeStickyConfig(t.sinc),this.variationStickyConfig=i.buildVariationStickyConfig(t.svar),this.ignore=t.ignore,this.playbookId=t.playbookId,this.note=t.note;const c=[];t.pageIds.forEach((e=>{c.push(i.getPage(e))})),this.pages=c,this.pages.forEach((e=>{e.addExperience(this)})),this.condition=i.buildConditionFromVariationOrExperience(t),this.audiences=Ht.addExperienceToAudiences(this),this.dependsOnExperienceIds=null!=(r=t.dependsOnExperienceIds)?r:[],this.dependsOnExperiences=[];const l=[];for(const[d,u]of Object.entries(t.variations)){const e=i.buildVariation(d,u,this);l.push(e),this.allVariationsMap[d]=e}this.realVariations=l,this.boundingSelectors=null!=(a=t.boundingSelectors)?a:[],this.realPreconditions=null!=(o=t.preconditions)?o:[],this.preconditions=[...this.realPreconditions,...this.generatePreconditionsForBoundingSelectors()],this.campaign=s}inflateDependsOnExperiences(e){this.dependsOnExperienceIds.forEach((t=>{const i=e[t];void 0!==i&&this.dependsOnExperiences.push(i)}))}getId(){return this.id}getName(){return this.name}getType(){return this.type}isEnabled(){return"live"===this.state}getState(){return this.state}getPages(){return this.pages}getCondition(){return xe.ofNullable(this.condition)}getAudiences(){return this.audiences}getPreconditions(){return this.preconditions}getBoundingSelectors(){return this.boundingSelectors}getRealPreconditions(){return this.realPreconditions}getDependsOnExperiences(){return this.dependsOnExperiences}getRealVariations(){return this.realVariations}getVariation(e){return xe.ofNullable(this.allVariationsMap[e])}getCampaign(){return this.campaign}getInclusionStickyConfig(){return this.inclusionStickyConfig}getVariationStickyConfig(){return this.variationStickyConfig}getIgnore(){return this.ignore}getPlaybookId(){return xe.ofNullable(this.playbookId)}getNote(){return xe.ofNullable(this.note)}generatePreconditionsForBoundingSelectors(){const e=[];return this.boundingSelectors.forEach((t=>{e.push(Oe(t))})),e}}class Ve extends Ue{constructor(e,t,i,s){super(e,t,i,s),Me(this,"logger"),Me(this,"trafficAllocation"),this.logger=i.getLogger(),this.trafficAllocation=t.trafficAllocation}static filterExperiences(e){return e.filter((e=>"ab"===e.getType()))}selectVariation(e){let t;for(const[i,s]of Object.entries(this.trafficAllocation))if(e>=s.lowerEndpoint&&e<s.upperEndpoint){t=i;break}return void 0!==t?this.getVariation(t):(this.logger.error(`Could not determine A/B variation for ${e}`,1012,{experienceId:this.getId()}),xe.empty())}getTrafficAllocation(){const e={};for(const[t,i]of Object.entries(this.trafficAllocation))e[t]=__spreadValues({},i);return e}}class Le{constructor(){Me(this,"count",0)}accept(e){this.count++}result(){return this.count}}class $e{constructor(e){Me(this,"activityFieldFunction"),Me(this,"set",new Set),this.activityFieldFunction=e}accept(e){const t=this.activityFieldFunction(e);t.isPresent()&&this.set.add(t.get())}result(){return this.set.size}}class ze{constructor(e){Me(this,"activityFieldFunction"),Me(this,"sum",0),Me(this,"count",0),this.activityFieldFunction=e}accept(e){const t=this.activityFieldFunction(e);t.isPresent()&&(this.count++,this.sum+=t.get())}result(){return this.count>0?this.sum/this.count:0}}class We{constructor(e){Me(this,"activityFieldFunction"),Me(this,"sum",0),this.activityFieldFunction=e}accept(e){const t=this.activityFieldFunction(e);this.sum+=t.orElse(0)}result(){return this.sum}}class Ge{constructor(e,t){Me(this,"filters"),this.filters=e.filters.map((e=>t.buildActivityFilter(e)))}evaluate(e){return this.filters.every((t=>t.evaluate(e)))}}class Be{constructor(e,t){Me(this,"activityFieldFunction"),Me(this,"operation"),this.activityFieldFunction=e,this.operation=t}evaluate(e){return this.operation(this.activityFieldFunction(e))}}class je{constructor(e,t){Me(this,"filter"),this.filter=t.buildActivityFilter(e.filter)}evaluate(e){return!this.filter.evaluate(e)}}class He{constructor(e,t){Me(this,"filters"),this.filters=e.filters.map((e=>t.buildActivityFilter(e)))}evaluate(e){return this.filters.some((t=>t.evaluate(e)))}}class Ke{constructor({name:e,namespace:t}){Me(this,"name"),Me(this,"namespace"),this.name=e,this.namespace=t}getId(){return{name:this.name,namespace:this.namespace}}getName(){return this.name}getNamespace(){return this.namespace}getValue(e){return e.getAttributeValue(this)}}let Qe=class{constructor(e){Me(this,"code"),this.code=e.code}getCode(){return this.code}evaluate(e){return e.evalBoolean(this.code)}toJSON(){return{code:this.code,type:"code"}}};class qe{constructor(e,t,i){if(Me(this,"id"),Me(this,"name"),Me(this,"condition"),Me(this,"experiences",[]),Me(this,"variations",[]),this.id=e,this.name=t.name,void 0!==t.code&&void 0!==t.condition)this.condition=i.buildCondition({conditions:[{code:t.code,type:"code"},t.condition],type:"logic-and"});else if(void 0!==t.code)this.condition=i.buildCondition({code:t.code,type:"code"});else{if(void 0===t.condition)throw new be('Unable to build condition for audience. No "code" or "condition" property.');this.condition=i.buildCondition(t.condition)}}getId(){return this.id}getName(){return this.name}getCondition(){return this.condition}addExperience(e){this.experiences.push(e)}addVariation(e){this.variations.push(e)}getCode(){return this.condition instanceof Qe?xe.of(this.condition.getCode()):xe.empty()}getExperiences(){return[...this.experiences]}getVariations(){return[...this.variations]}isInclude(){return!0}}class Ye{constructor(e){Me(this,"type"),Me(this,"id"),this.type=e.type,this.id=e.id,_e(pe(e.type),"invalid variation change type: "+e.type)}getType(){return this.type}getId(){return xe.ofNullable(this.id)}}class Je extends Ye{constructor(e){super(e),Me(this,"selector"),Me(this,"attributes"),this.selector=e.selector;const t=__spreadValues({},e.attributes.css);this.attributes=__spreadProps(__spreadValues({},e.attributes),{css:t})}getSelector(){return this.selector}getSelectorElements(){return document.querySelectorAll(this.selector)}getAttributes(){return this.attributes}isReadyToApply(){return this.getSelectorElements().length>0}}class Xe extends Ye{constructor(e){super(e),Me(this,"code"),Me(this,"css"),_e(Boolean(e.code)||Boolean(e.css),'Either "code" or "css" must be specified'),this.code=e.code,this.css=e.css}getCode(){return xe.ofNullable(this.code)}getCss(){return xe.ofNullable(this.css)}isReadyToApply(){return!0}}class Ze extends Ye{constructor(e){super(e),Me(this,"elementType"),Me(this,"targetPosition"),Me(this,"idAttribute"),this.targetPosition=e.targetPosition,this.elementType=e.elementType,this.idAttribute=e.idAttribute}getElementType(){return this.elementType}getTargetPosition(){return this.targetPosition}getIdAttribute(){return this.idAttribute}getTargetElement(){return Re(this.targetPosition.selector)}isReadyToApply(){return this.getTargetElement().isPresent()}}class et extends Ze{constructor(e){super(e),Me(this,"size"),this.size=e.size}getSize(){return this.size}}class tt extends Ye{constructor(e){super(e),Me(this,"targetPosition"),Me(this,"selector"),Me(this,"moveId"),this.targetPosition=e.targetPosition,this.selector=e.selector,this.moveId=e.moveId}getTargetPosition(){return this.targetPosition}getSelector(){return this.selector}getMoveId(){return this.moveId}getSelectorElement(){return Re(this.selector)}getTargetElement(){return Re(this.targetPosition.selector)}isReadyToApply(){return this.getTargetElement().isPresent()&&this.getSelectorElement().isPresent()}}function it(e){if(J(e))return new Je(e);if(he(e))return new Xe(e);if(ce(e))return new tt(e);if(re(e)){if("heading"===e.elementType)return new et(e);return new Ze(e)}throw new be(`Invalid variation change type ${e.type}`)}class st{constructor(e,t,i,s){Me(this,"id"),Me(this,"name"),Me(this,"controlTrafficPercentage"),Me(this,"code"),Me(this,"css"),Me(this,"metrics"),Me(this,"experiences"),Me(this,"customer"),Me(this,"intervals"),Me(this,"intervalModifications"),Me(this,"important"),Me(this,"primaryMetrics"),this.id=e,this.customer=s,this.name=t.name,this.intervals=[],this.intervalModifications=[],void 0!==t.ictp&&(this.controlTrafficPercentage=t.ictp),void 0!==t.code&&(this.code=t.code),void 0!==t.css&&(this.css=t.css);const n=[];for(const[r,a]of Object.entries(t.experiences)){const e=i.buildExperience(r,a,this);n.push(e)}this.experiences=n,this.important=Boolean(t.important),void 0!==t.modifiedIntervals&&(this.intervals=t.modifiedIntervals),void 0!==t.intervalModifications&&(this.intervalModifications=t.intervalModifications),this.metrics=t.metrics.map((e=>i.buildMetric(e,this))),void 0!==t.primaryMetrics&&(this.primaryMetrics=t.primaryMetrics)}getId(){return this.id}getName(){return this.name}getControlTrafficPercentage(){return xe.ofNullable(this.controlTrafficPercentage)}getCode(){return xe.ofNullable(this.code)}getCss(){return xe.ofNullable(this.css)}getExperiences(){return this.experiences}getMetrics(){return this.metrics}getMetric(e){const t=this.metrics.filter((t=>t.getId()===e));return 0===t.length?xe.empty():xe.ofNullable(t[0])}getCustomer(){return this.customer}getExperience(e){const t=this.experiences.filter((t=>t.getId()===e));return 0===t.length?xe.empty():xe.ofNullable(t[0])}getIntervals(){return this.intervals}getIntervalModifications(){return this.intervalModifications}isImportant(){return this.important}getPrimaryMetrics(){const{primaryMetrics:e}=this;if(void 0===e)return xe.empty();const t="customer"===e.level?this.customer.getMetrics():this.metrics,i=0===e.metricIds.length?t:t.filter((t=>e.metricIds.includes(t.getId())));return xe.ofNullable(i)}getPrimaryMetricLevel(){var e;return xe.ofNullable(null==(e=this.primaryMetrics)?void 0:e.level)}}class nt extends Ue{constructor(e,t,i,s){super(e,t,i,s),Me(this,"controlVariation");const n=i.buildControlVariation(this);this.controlVariation=n,this.allVariationsMap[n.getId()]=n}static filterExperiences(e){return e.filter((e=>"cc"===e.getType()))}getControlVariation(){return this.controlVariation}}function rt(e){return"object"==typeof e&&e instanceof Error?e:new Error(e)}class at{constructor(e,t,i){Me(this,"logger"),Me(this,"id"),Me(this,"name"),Me(this,"type"),Me(this,"metrics",[]),this.logger=i.getLogger(),this.id=e,this.name=t.name,this.type=t.type,_e(void 0!==this.type,"invalid event type: "+t.type)}addMetric(e){this.metrics.push(e)}getId(){return this.id}getName(){return this.name}getType(){return this.type}getMetrics(){const e=[];return this.metrics.forEach((t=>{e.push(t)})),e}}class ot extends at{constructor(e,t,i){super(e,t,i),Me(this,"pages"),Me(this,"code"),Me(this,"selector");const s=[];t.pageIds.forEach((e=>{s.push(i.getPage(e))})),this.pages=s,this.pages.forEach((e=>{e.addEvent(this)})),void 0!==t.code&&(this.code=t.code),this.selector=t.selector}getPages(){return this.pages}getCode(){return xe.ofNullable(this.code)}getSelector(){return this.selector}executeCode(e){this.logger.debug("executeCode() if present");let t=!0;if(this.getCode().isPresent()){const s=this.getCode().get();try{this.logger.info(`Event ${this.id} code running`),t=e(s),this.logger.info(`Event ${this.id} code result => ${t}`)}catch(i){const e=rt(i);t=!1,e.message=`Event (${this.id}) code execution failed `+e.message,this.logger.error(e,1007)}}return t}}class ct{constructor(e){Me(this,"username"),Me(this,"role"),this.username=e.username,this.role=e.role}getUsername(){return this.username}getRole(){return this.role}}class lt{constructor(e,t,i,s,n){Me(this,"logger"),Me(this,"json"),Me(this,"filter"),Me(this,"newAggregator"),Me(this,"operation"),this.json=e,this.filter=t,this.newAggregator=i,this.logger=n,this.operation=s}evaluate(e){this.logger.group("ActivityCondition.evaluate()"),this.logger.debug(`activity condition config: ${JSON.stringify(this.json)}`);const t=e.getActivities();this.logger.debug(`activities: ${JSON.stringify(t)}`),this.logger.info(`activity count: ${t.length}`);const i=t.filter((e=>this.filter.evaluate(e)));this.logger.debug(`filtered activities: ${JSON.stringify(i)}`),this.logger.info(`filtered activities count: ${i.length}`);const s=this.newAggregator();i.forEach((e=>{s.accept(e)}));const n=s.result();this.logger.info(`aggregator result: ${n}`);const r=this.operation(xe.of(n));return this.logger.info(`condition result: ${r}`),this.logger.groupEnd(),r}toJSON(){return JSON.parse(JSON.stringify(this.json))}}class dt{constructor(e,t){Me(this,"conditions"),this.conditions=e.conditions.map((e=>t.buildCondition(e)))}getConditions(){return this.conditions}evaluate(e){return this.conditions.every((t=>t.evaluate(e)))}toJSON(){return{conditions:this.conditions.map((e=>e.toJSON())),type:"logic-and"}}}class ut{constructor(e){Me(this,"audience"),this.audience=e}getId(){return this.audience.getId()}getName(){return this.audience.getName()}getCondition(){return this.audience.getCondition()}addExperience(e){this.audience.addExperience(e)}addVariation(e){this.audience.addVariation(e)}getCode(){return this.audience.getCode()}getExperiences(){return this.audience.getExperiences()}getVariations(){return this.audience.getVariations()}isInclude(){return!1}}class ht{constructor(e,t,i){Me(this,"audience");const s=t.getAudience(e.audienceId);this.audience=!0===i?new ut(s):s}getAudience(){return this.audience}evaluate(e){return this.audience.getCondition().evaluate(e)}toJSON(){return{audienceId:this.audience.getId(),type:"audience"}}}class gt{constructor(e,t,i){Me(this,"json"),Me(this,"attributeDefinition"),Me(this,"operation"),this.json=e,this.attributeDefinition=t,this.operation=i}getAttributeDefinition(){return this.attributeDefinition}getComparisonOperation(){return this.operation}evaluate(e){return this.operation(this.attributeDefinition.getValue(e))}toJSON(){return JSON.parse(JSON.stringify(this.json))}}class pt{constructor(e,t){Me(this,"condition");const i="audience"===e.condition.type;this.condition=t.buildCondition(e.condition,i)}getCondition(){return this.condition}evaluate(e){return!this.condition.evaluate(e)}toJSON(){return{condition:this.condition.toJSON(),type:"logic-not"}}}class mt{constructor(e,t){Me(this,"conditions"),this.conditions=e.conditions.map((e=>t.buildCondition(e)))}getConditions(){return this.conditions}evaluate(e){return this.conditions.some((t=>t.evaluate(e)))}toJSON(){return{conditions:this.conditions.map((e=>e.toJSON())),type:"logic-or"}}}class vt{constructor(e){var t,i;Me(this,"enabled"),Me(this,"originWhitelist"),Me(this,"originBlacklist"),void 0===e?(this.enabled=!1,this.originWhitelist=[],this.originBlacklist=[]):(this.enabled=e.enabled||!1,this.originWhitelist=null!=(t=e.originWhitelist)?t:[],this.originBlacklist=null!=(i=e.originBlacklist)?i:[])}static isMatchingOrigin(e,t){return new RegExp(`^${e}$`).test(t)}isEnabled(){return this.enabled}getOriginWhitelist(){return this.originWhitelist}getOriginBlacklist(){return this.originBlacklist}isOriginAllowed(e){let t=!1;for(const i of this.originWhitelist)if(vt.isMatchingOrigin(i,e)){t=!0;break}if(t)for(const i of this.originBlacklist)if(vt.isMatchingOrigin(i,e)){t=!1;break}return t}}class bt extends at{constructor(e,t,i){super(e,t,i),Me(this,"apiName"),this.apiName=t.apiName}getApiName(){return this.apiName}}class ft extends at{constructor(e,t,i){super(e,t,i),Me(this,"customerEventName"),this.customerEventName=t.customerEventName}getCustomerEventName(){return this.customerEventName}}class Et{constructor(e,t){var i,s,n,r,a,o,c;Me(this,"data"),Me(this,"active"),Me(this,"encrypt"),Me(this,"schemaVersion"),Me(this,"id"),Me(this,"version"),Me(this,"name"),Me(this,"controlStickyConfig"),Me(this,"campaignControl"),Me(this,"controlTrafficPercentage"),Me(this,"collaborators"),Me(this,"excludeIps"),Me(this,"plugins"),Me(this,"metrics"),Me(this,"campaigns"),Me(this,"pages"),Me(this,"audiences"),Me(this,"experiences"),Me(this,"iEvents"),Me(this,"code"),Me(this,"css"),Me(this,"snippetDomain"),Me(this,"urlParamFilters"),Me(this,"customAttributeFilters"),Me(this,"googleUniversalAnalyticsIntegration"),Me(this,"googleAnalytics4Integration"),Me(this,"segmentAnalyticsIntegration"),Me(this,"mixpanelIntegration"),Me(this,"marketoIntegration"),Me(this,"salesforceIntegration"),Me(this,"shopifyIntegration"),Me(this,"sixsenseIntegration"),Me(this,"mfa"),Me(this,"changelogInternal"),Me(this,"changelogExternal"),Me(this,"crossOrigin"),Me(this,"vertical"),Me(this,"currentContract"),Me(this,"timeZone"),Me(this,"classicAccess"),this.data=e,this.active=e.active,this.encrypt=e.encrypt,this.schemaVersion=null!=(i=e.schemaVersion)?i:"1",this.id=e.id,this.version=e.__v,this.name=e.name,this.controlStickyConfig=t.buildControlStickyConfig(e.scon),this.campaignControl=e.ipcc,!this.campaignControl&&void 0!==e.ictp&&(this.controlTrafficPercentage=e.ictp),void 0!==e.code&&(this.code=e.code),void 0!==e.css&&(this.css=e.css),void 0!==e.snippetDomain&&(this.snippetDomain=e.snippetDomain);const l=[];void 0!==e.collaborators&&e.collaborators.forEach((e=>{l.push(t.buildCollaborator(e))})),this.collaborators=l,this.excludeIps=null!=(s=e.excludeIps)?s:[],this.plugins=null!=(n=e.plugins)?n:[],this.urlParamFilters=null!=(r=e.urlParamFilters)?r:[],this.customAttributeFilters=null!=(a=e.customAttributeFilters)?a:[],this.changelogInternal=null!=(o=e.changelogInternal)?o:[],this.changelogExternal=null!=(c=e.changelogExternal)?c:[],this.crossOrigin=t.buildCrossOrigin(e.crossOrigin);const d=[];for(const[v,b]of Object.entries(e.audiences)){const e=t.buildAudience(v,b);d.push(e)}this.audiences=d;const u=[];for(const[v,b]of Object.entries(e.pages)){const e=t.buildPage(v,b);u.push(e)}this.pages=u;const h=[];for(const[v,b]of Object.entries(e.events)){const e=t.buildEvent(v,b);h.push(e)}this.iEvents=h;let g=[];void 0!==e.metrics&&(g=e.metrics.map((e=>t.buildMetric(e,void 0,this)))),this.metrics=g;const p=[];for(const[v,b]of Object.entries(e.campaigns)){const e=t.buildCampaign(v,b,this);p.push(e)}this.campaigns=p;const m=new Map;this.campaigns.forEach((e=>{e.getExperiences().forEach((e=>{m.set(e.getId(),e)}))})),this.experiences=m,void 0!==e.iint&&(void 0!==e.iint.gua&&(this.googleUniversalAnalyticsIntegration=t.buildGoogleUniversalAnalyticsIntegration(e.iint.gua)),void 0!==e.iint.ga4&&(this.googleAnalytics4Integration=t.buildGoogleAnalytics4Integration(e.iint.ga4)),void 0!==e.iint.sg&&(this.segmentAnalyticsIntegration=t.buildSegmentIntegration(e.iint.sg)),void 0!==e.iint.mp&&(this.mixpanelIntegration=t.buildMixpanelIntegration(e.iint.mp)),void 0!==e.iint.marketo&&(this.marketoIntegration=t.buildMarketoIntegration(e.iint.marketo)),void 0!==e.iint.salesforce&&(this.salesforceIntegration=t.buildSalesforceIntegration(e.iint.salesforce)),void 0!==e.iint.shopify&&(this.shopifyIntegration=t.buildShopifyIntegration(e.iint.shopify)),void 0!==e.iint.sixsense&&(this.sixsenseIntegration=t.buildSixsenseIntegration(e.iint.sixsense))),this.mfa=Boolean(e.mfa),void 0!==e.vertical&&(this.vertical=e.vertical),void 0!==e.currentContract&&(this.currentContract=e.currentContract),void 0!==e.timeZone&&(this.timeZone=e.timeZone),void 0!==e.classicAccess&&(this.classicAccess=e.classicAccess)}getData(){return this.data}isActive(){return this.active}shouldEncrypt(){return this.encrypt}getSchemaVersion(){return this.schemaVersion}getId(){return this.id}getVersion(){return this.version}getName(){return this.name}getCollaborators(){return this.collaborators}getExcludeIps(){return this.excludeIps}getPlugins(){return this.plugins}getMetrics(){return this.metrics}getControlStickyConfig(){return this.controlStickyConfig}isCampaignControl(){return this.campaignControl}getControlTrafficPercentage(){return xe.ofNullable(this.controlTrafficPercentage)}getCode(){return xe.ofNullable(this.code)}getCss(){return xe.ofNullable(this.css)}getSnippetDomain(){return xe.ofNullable(this.snippetDomain)}getCampaigns(){return this.campaigns}getPages(){return this.pages}getAudiences(){return this.audiences}getEvents(){return this.iEvents}getCampaign(e){const t=this.campaigns.filter((t=>t.getId()===e));return 0===t.length?xe.empty():xe.ofNullable(t[0])}getExperience(e){return xe.ofNullable(this.experiences.get(e))}getPage(e){const t=this.pages.filter((t=>t.getId()===e));return 0===t.length?xe.empty():xe.ofNullable(t[0])}getEvent(e){const t=this.iEvents.filter((t=>t.getId()===e));return 0===t.length?xe.empty():xe.ofNullable(t[0])}getCustomEvent(e){const t=this.iEvents.filter((t=>t instanceof bt&&t.getApiName()===e));return 0===t.length?xe.empty():xe.ofNullable(t[0])}getShopifyEvent(e){const t=this.iEvents.filter((t=>t instanceof ft&&t.getCustomerEventName()===e));return 0===t.length?xe.empty():xe.ofNullable(t[0])}getAudience(e){const t=this.audiences.filter((t=>t.getId()===e));return 0===t.length?xe.empty():xe.ofNullable(t[0])}getIntegrationGoogleUniversalAnalytics(){return xe.ofNullable(this.googleUniversalAnalyticsIntegration)}getIntegrationGoogle4Analytics(){return xe.ofNullable(this.googleAnalytics4Integration)}getIntegrationSegmentAnalytics(){return xe.ofNullable(this.segmentAnalyticsIntegration)}getIntegrationMixpanel(){return xe.ofNullable(this.mixpanelIntegration)}getIntegrationMarketo(){return xe.ofNullable(this.marketoIntegration)}getIntegrationSalesforce(){return xe.ofNullable(this.salesforceIntegration)}getIntegrationShopify(){return xe.ofNullable(this.shopifyIntegration)}getIntegrationSixsense(){return xe.ofNullable(this.sixsenseIntegration)}getUrlParamFilters(){return this.urlParamFilters}getCustomAttributeFilters(){return this.customAttributeFilters}getChangelogInternal(){return this.changelogInternal}getChangelogExternal(){return this.changelogExternal}getCrossOrigin(){return this.crossOrigin}isMfa(){return this.mfa}getVertical(){return xe.ofNullable(this.vertical)}getCurrentContract(){return xe.ofNullable(this.currentContract)}getTimeZone(){return xe.ofNullable(this.timeZone)}hasClassicAccess(){return xe.ofNullable(this.classicAccess).orElse(!1)}}class _t{constructor(e){Me(this,"enabled"),Me(this,"autoConfig"),Me(this,"measurementIds"),this.enabled=e.enabled,this.autoConfig=e.autoConfig,this.measurementIds=e.measurementIds}isEnabled(){return this.enabled}isAutoConfig(){return this.autoConfig}getMeasurementIds(){return this.measurementIds}}class St{constructor(e){Me(this,"enabled"),Me(this,"autoConfig"),Me(this,"trackingIds"),Me(this,"dimensionName"),this.enabled=e.enabled,this.autoConfig=e.autoConfig,this.trackingIds=e.trackingIds,this.dimensionName=e.dimensionName}isEnabled(){return this.enabled}isAutoConfig(){return this.autoConfig}getTrackingIds(){return this.trackingIds}getDimensionName(){return xe.ofNullable(this.dimensionName)}}class yt{constructor(e){Me(this,"enabled"),Me(this,"munchkinId"),Me(this,"fieldsToIngest"),Me(this,"listsToIngest"),this.enabled=e.enabled,this.munchkinId=e.munchkinId,this.fieldsToIngest=e.fieldsToIngest,this.listsToIngest=e.listsToIngest}isEnabled(){return this.enabled}getMunchkinId(){return this.munchkinId}getFieldsToIngest(){return this.fieldsToIngest}getListsToIngest(){return this.listsToIngest}}class It{constructor(e,t,i,s){Me(this,"id"),Me(this,"name"),Me(this,"iEvents"),Me(this,"scope"),Me(this,"type"),Me(this,"countingMethod"),Me(this,"goal"),Me(this,"campaign"),Me(this,"customer"),_e(void 0===i||void 0===s),this.id=e.id,this.name=e.name,this.scope=e.scope,this.type=e.type,this.countingMethod=e.countingMethod,this.goal=e.isGoal;const n=[];e.eventIds.forEach((e=>{n.push(t.getEvent(e))})),this.iEvents=n,this.iEvents.forEach((e=>{e.addMetric(this)})),this.campaign=i,this.customer=s}getId(){return this.id}getName(){return this.name}getIEvents(){return this.iEvents}getScope(){return this.scope}getType(){return this.type}getCountingMethod(){return this.countingMethod}isGoal(){return this.goal}getCampaign(){return xe.ofNullable(this.campaign)}getCustomer(){return xe.ofNullable(this.customer)}}class Ct{constructor(e){Me(this,"enabled"),this.enabled=e.enabled}isEnabled(){return this.enabled}}function Tt(e){let t=()=>!1;switch(e.operator){case"includesAny":t=t=>t.some((t=>e.argument.includes(t)));break;case"excludesAll":t=t=>!t.some((t=>e.argument.includes(t)));break;default:throw new Error(`Unknown array enum operator: ${e.operator}`)}return e=>e.map((e=>t(e))).orElse(!1)}function At(e){let t=()=>!1;if("includesAny"!==e.operator)throw new Error(`Unknown array string operator: ${e.operator}`);return t=t=>t.some((t=>e.argument.includes(t))),e=>e.map((e=>t(e))).orElse(!1)}function xt(e){let t=()=>!1;switch(e.operator){case"eq":t=t=>t===e.argument;break;case"ne":t=t=>t!==e.argument;break;default:throw new Error(`Unknown enum operator: ${e.operator}`)}return e=>e.map((e=>t(e))).orElse(!1)}function wt(e){let t=()=>!1;switch(e.operator){case"isTrue":t=e=>e;break;case"isFalse":t=e=>!e;break;case"exists":t=()=>!0;break;default:throw new Error(`Unknown boolean operator: ${e.operator}`)}return e=>e.map((e=>t(e))).orElse(!1)}function kt(e){let t=()=>!1;switch(e.operator){case"==":t=t=>t===e.argument;break;case"!=":t=t=>t!==e.argument;break;case">":t=t=>t>e.argument;break;case"<":t=t=>t<e.argument;break;case">=":t=t=>t>=e.argument;break;case"<=":t=t=>t<=e.argument;break;case"exists":t=()=>!0;break;default:throw new Error(`Unknown number operator: ${e.operator}`)}return e=>e.map((e=>t(e))).orElse(!1)}function Ft(e){let t=()=>!1;switch(e.operator){case"eq":t=t=>t===e.argument;break;case"ne":t=t=>t!==e.argument;break;case"substr":t=t=>t.includes(e.argument);break;case"startsWith":t=t=>t.startsWith(e.argument);break;case"endsWith":t=t=>t.endsWith(e.argument);break;case"regex":t=t=>new RegExp(e.argument).test(t);break;case"exists":t=()=>!0;break;default:throw new Error(`Unknown string operator: ${e.operator}`)}return e=>e.map((e=>t(e))).orElse(!1)}function Pt(e){let t=()=>!1;switch(e.operator){case"withinPastDuration":t=t=>{const i=/^P(\d+)D$/.exec(e.argument);if(void 0===(null==i?void 0:i[1]))throw new Error(`Invalid unix time operator duration: ${e.argument}`);const s=24*Number(i[1])*60*60*1e3;return t>=Date.now()-s};break;case"inBetween":t=t=>{const[i,s]=e.argument;return t>=i&&t<s};break;case"exists":t=()=>!0;break;default:throw new Error(`Unknown unix time operator: ${e.operator}`)}return e=>e.map((e=>t(e))).orElse(!1)}class Dt{constructor(e,t,i){Me(this,"logger"),Me(this,"id"),Me(this,"name"),Me(this,"urls"),Me(this,"iEvents",[]),Me(this,"experiences",[]),Me(this,"code"),Me(this,"previewUrl"),Me(this,"timeBudget"),this.logger=i.getLogger(),this.id=e,this.name=t.name;const s=[];t.urls.forEach((e=>{s.push(i.buildUrl(e))})),this.urls=s,void 0!==t.code&&(this.code=t.code),void 0!==t.previewUrl&&(this.previewUrl=t.previewUrl),void 0!==t.timeBudget&&(this.timeBudget=t.timeBudget)}addEvent(e){this.iEvents.push(e)}addExperience(e){this.experiences.push(e)}getId(){return this.id}getName(){return this.name}getPreviewUrl(){return xe.ofNullable(this.previewUrl)}getCode(){return xe.ofNullable(this.code)}getExperiences(){const e=[];return this.experiences.forEach((t=>{e.push(t)})),e}getEvents(){const e=[];return this.iEvents.forEach((t=>{e.push(t)})),e}matches(e,t){this.logger.group("check page matches");const i=this.urls.some((t=>{this.logger.group("check url");const i=t.matches(e);return this.logger.groupEnd(),i}));this.logger.debug(i.toString());const s=this.executeCode(t);return this.logger.groupEnd(),i&&s}getTimeBudgetMs(){return xe.ofNullable(this.timeBudget)}getUrls(){return this.urls}executeCode(e){this.logger.debug("executeCode() if present");let t=!0;if(this.getCode().isPresent()){const s=this.getCode().get();try{this.logger.info(`Page ${this.id} code running`),t=e(s),this.logger.info(`Page ${this.id} code result => ${t}`)}catch(i){const e=rt(i);t=!1,e.message=`Page (${this.id}) code execution failed `+e.message,this.logger.error(e,1009)}}return t}}class Mt extends Ue{constructor(e,t,i,s){super(e,t,i,s),Me(this,"logger"),Me(this,"variationPriority"),this.logger=i.getLogger(),this.variationPriority=t.variationPriority}static filterExperiences(e){return e.filter((e=>"rbp"===e.getType()))}getPrioritizedVariations(){const e=[];if(void 0!==this.variationPriority)for(const t of this.variationPriority)this.getVariation(t).ifPresent((t=>{e.push(t)})).ifAbsent((()=>{this.logger.debug("Could not find prioritized variation for RBP",1013,{experienceId:this.getId(),variationId:t})}));return e}}class Nt{constructor(e){Me(this,"enabled"),Me(this,"objectsToIngest"),this.enabled=e.enabled,this.objectsToIngest=e.objectsToIngest}isEnabled(){return this.enabled}getObjectsToIngest(){return this.objectsToIngest}}class Ot{constructor(e){Me(this,"enabled"),Me(this,"eventName"),this.enabled=e.enabled,this.eventName=e.dim}isEnabled(){return this.enabled}getEventName(){return this.eventName}}class Rt{constructor(e){Me(this,"pixel"),this.pixel=e.pixel}isPixelEnabled(){return this.pixel}}class Ut{constructor(e){Me(this,"enabled"),this.enabled=e.enabled}isEnabled(){return this.enabled}}class Vt extends It{constructor(e,t,i,s){super(e,t,i,s),Me(this,"valueType"),this.valueType=e.valueType}getValueType(){return this.valueType}}class Lt extends Vt{constructor(e,t,i,s){super(e,t,i,s),Me(this,"value"),this.value=e.value}getValue(){return this.value}}class $t{constructor(e,t,i){this.sticky=e,this.relativeExpirationTimeSec=t,this.absoluteExpirationTimeSec=i}isSticky(){return this.sticky}getRelativeExpirationTimeSec(){return xe.ofNullable(this.relativeExpirationTimeSec)}getAbsoluteExpirationTimeSec(){return xe.ofNullable(this.absoluteExpirationTimeSec)}isExpired(e,t){return void 0!==this.absoluteExpirationTimeSec&&t<this.absoluteExpirationTimeSec||void 0!==this.relativeExpirationTimeSec&&t+this.relativeExpirationTimeSec<e}}const zt="118",Wt=["checkout_completed","checkout_started","collection_viewed","product_added_to_cart","product_viewed","search_submitted"];class Gt{constructor(e,t){Me(this,"logger"),Me(this,"value"),Me(this,"match"),this.logger=t.getLogger(),this.value=e.value,this.match=e.match,_e(void 0!==this.match,"invalid match type: "+e.match)}static simplifyUrl(e){let t=e;const i=t.indexOf("?");i>0&&(t=t.slice(0,Math.max(0,i)));const s=t.indexOf("#");s>0&&(t=t.slice(0,Math.max(0,s))),t.endsWith("/")&&(t=t.slice(0,Math.max(0,t.length-1)));const n=/^(?:https?:\/\/)?(?:www\.)?(.+)$/.exec(t);return void 0!==(null==n?void 0:n[1])&&(t=n[1]),t}getMatch(){return this.match}getValue(){return this.value}matches(e){let t=!1;switch(this.logger.debug("checking match: "+this.match+", value: "+this.value),this.match){case"simple":t=Gt.simplifyUrl(this.value)===Gt.simplifyUrl(e);break;case"regex":{const i=new RegExp(this.value);t=Boolean(i.test(e));break}case"exact":t=e===this.value;break;case"substring":t=e.includes(this.value);break;default:this.logger.error(`Unknown url match type: ${this.match}`,1010)}return this.logger.debug(t.toString()),t}}class Bt{constructor(e,t,i,s){Me(this,"id"),Me(this,"name"),Me(this,"state"),Me(this,"condition"),Me(this,"audiences"),Me(this,"preconditions"),Me(this,"code"),Me(this,"redirect"),Me(this,"css"),Me(this,"changes"),Me(this,"experience"),Me(this,"playbookTemplateId"),this.id=e,this.name=t.name,this.state=t.state,this.preconditions=t.preconditions,void 0!==t.code&&(this.code=t.code),void 0!==t.redirect&&(this.redirect=t.redirect),void 0!==t.css&&(this.css=t.css),this.condition=i.buildConditionFromVariationOrExperience(t),this.audiences=Ht.addVariationToAudiences(this);const n=[];void 0!==t.changes&&t.changes.forEach((e=>{const t=i.buildVariationChange(e);n.push(t)})),this.changes=n,this.experience=s,this.playbookTemplateId=t.playbookTemplateId}getId(){return this.id}getName(){return this.name}isEnabled(){return"live"===this.state}getState(){return this.state}getCode(){return xe.ofNullable(this.code)}getCss(){return xe.ofNullable(this.css)}getRedirect(){return xe.ofNullable(this.redirect)}getPreconditions(){return this.preconditions}getCondition(){return xe.ofNullable(this.condition)}getAudiences(){return this.audiences}getChanges(){return this.changes}isTypeChange(){return this.getChanges().length>0}isRedirect(){return this.getRedirect().isPresent()}getExperience(){return this.experience}getTrafficAllocation(){if(this.experience instanceof Ve){const e=this.experience.getTrafficAllocation()[this.id];if(void 0!==e)return xe.of(__spreadValues({},e))}return xe.empty()}getPlaybookTemplateId(){return xe.ofNullable(this.playbookTemplateId)}}class jt extends at{constructor(e,t,i){super(e,t,i),Me(this,"pages"),Me(this,"code");const s=[];for(const n of t.pageIds)s.push(i.getPage(n));this.pages=s,this.pages.forEach((e=>{e.addEvent(this)})),void 0!==t.code&&(this.code=t.code)}getPages(){return this.pages}getCode(){return xe.ofNullable(this.code)}executeCode(e){this.logger.debug("executeCode() if present");let t=!0;if(this.getCode().isPresent()){const s=this.getCode().get();try{this.logger.info(`Event ${this.id} code running`),t=e(s),this.logger.info(`Event ${this.id} code result => ${t}`)}catch(i){const e=rt(i);t=!1,e.message=`Event (${this.id}) code execution failed `+e.message,this.logger.error(e,1011)}}return t}}class Ht{constructor(e){Me(this,"logger"),Me(this,"experienceMap",{}),Me(this,"pageMap",{}),Me(this,"audienceMap",{}),Me(this,"eventMap",{}),this.logger=e}static buildStickyConfiguration(e,t){let i,s,n;return void 0!==e&&(void 0!==e.s&&(i=e.s),void 0!==e.r&&(s=e.r),void 0!==e.a&&(n=e.a)),void 0===i&&(i=t.s),void 0===s&&void 0!==t.r&&(s=t.r),void 0===n&&void 0!==t.a&&(n=t.a),new $t(i,s,n)}static addExperienceToAudiences(e){const t=[];return e.getCondition().ifPresent((i=>{if(i instanceof ht)t.push(Ht.addExperienceToAudience(e,i));else if(i instanceof dt||i instanceof mt)i.getConditions().forEach((i=>{if(i instanceof ht)t.push(Ht.addExperienceToAudience(e,i));else if(i instanceof pt){const s=i.getCondition();s instanceof ht&&(s.getAudience().addExperience(e),t.push(s.getAudience()))}}));else if(i instanceof pt){const s=i.getCondition();s instanceof ht&&(s.getAudience().addExperience(e),t.push(s.getAudience()))}})),t}static addVariationToAudiences(e){const t=[];return e.getCondition().ifPresent((i=>{if(i instanceof ht)t.push(Ht.addVariationToAudience(e,i));else if(i instanceof dt||i instanceof mt)i.getConditions().forEach((i=>{if(i instanceof ht)t.push(Ht.addVariationToAudience(e,i));else if(i instanceof pt){const s=i.getCondition();s instanceof ht&&(s.getAudience().addVariation(e),t.push(s.getAudience()))}}));else if(i instanceof pt){const s=i.getCondition();s instanceof ht&&(s.getAudience().addVariation(e),t.push(s.getAudience()))}})),t}static addExperienceToAudience(e,t){const i=t.getAudience();return t.getAudience().addExperience(e),i}static addVariationToAudience(e,t){const i=t.getAudience();return t.getAudience().addVariation(e),i}static audienceIdToConditionJson(e){let t=!1,i=e;e.startsWith("!")&&(t=!0,i=e.slice(1));const s={audienceId:i,type:"audience"};let n=s;return t&&(n={type:"logic-not",condition:s}),n}getLogger(){return this.logger}buildCustomer(e){const t=new Et(e,this);return t.getCampaigns().forEach((e=>{e.getExperiences().forEach((e=>{e.inflateDependsOnExperiences(this.experienceMap)}))})),t}buildCollaborator(e){return new ct(e)}buildCrossOrigin(e){return new vt(e)}buildPage(e,t){const i=this.pageMap[e];if(void 0!==i)return this.logger.warn(`Trying to build page twice ${e}`,1e3),i;const s=new Dt(e,t,this);return this.pageMap[e]=s,s}getPage(e){const t=this.pageMap[e];if(void 0===t)throw this.logger.error(`Could not find page in builder map ${e}`,1001),new be(`Could not find page in builder map ${e}`);return t}buildAudience(e,t){const i=this.audienceMap[e];if(void 0!==i)return this.logger.warn(`Trying to build audience twice ${e}`,1002),i;const s=new qe(e,t,this);return this.audienceMap[e]=s,s}buildConditionFromVariationOrExperience({audienceIds:e,condition:t}){const i=[];if(void 0!==e&&e.length>0&&e.forEach((e=>{i.push(Ht.audienceIdToConditionJson(e))})),void 0!==t&&("logic-and"===t.type?i.push(...t.conditions):i.push(t)),0===i.length)return;const[s]=i;return 1===i.length&&void 0!==s?this.buildCondition(s):this.buildCondition({conditions:i,type:"logic-and"})}buildCondition(e,t){switch(e.type){case"logic-not":return new pt(e,this);case"logic-and":return new dt(e,this);case"logic-or":return new mt(e,this);case"comparison-number":{let t;return t="exists"===e.operator?{operator:e.operator,argument:void 0}:{operator:e.operator,argument:e.value},new gt(e,new Ke(e.attrDefId),kt(t))}case"comparison-string":{let t;return t="exists"===e.operator?{operator:e.operator,argument:void 0}:{operator:e.operator,argument:e.value},new gt(e,new Ke(e.attrDefId),Ft(t))}case"comparison-enum":return new gt(e,new Ke(e.attrDefId),xt({operator:e.operator,argument:e.value}));case"comparison-boolean":return new gt(e,new Ke(e.attrDefId),wt({operator:e.operator,argument:void 0}));case"comparison-array-string":return new gt(e,new Ke(e.attrDefId),At({operator:e.operator,argument:e.value}));case"comparison-array-enum":return new gt(e,new Ke(e.attrDefId),Tt({operator:e.operator,argument:e.value}));case"audience":return new ht(e,this,t);case"code":return new Qe(e);case"activity":return new lt(e,this.buildActivityFilter(e.filter),(()=>this.buildAggregator(e.aggregation)),kt(e.operation),this.getLogger());default:throw new Error(`Unknown ConditionType: ${e.type}`)}}buildActivityFilter(e){switch(e.type){case"logic-not":return new je(e,this);case"logic-and":return new Ge(e,this);case"logic-or":return new He(e,this);case"comparison-number":return new Be(this.getActivityPathValue(e.fieldName,["number"]),kt(e.operation));case"comparison-string":return new Be(this.getActivityPathValue(e.fieldName,["string"]),Ft(e.operation));case"comparison-enum":return new Be(this.getActivityPathValue(e.fieldName,["string"]),xt(e.operation));case"comparison-array-enum":return new Be(this.getActivityPathValue(e.fieldName,["array-enum"]),Tt(e.operation));case"comparison-unix-time":return new Be(this.getActivityPathValue(e.fieldName,["number"]),Pt(e.operation));default:throw new Error(`Unknown activity filter type: ${e.type}`)}}buildAggregator(e){switch(e.type){case"count":return new Le;case"sum":return new We(this.getActivityPathValue(e.fieldName,["number"]));case"mean":return new ze(this.getActivityPathValue(e.fieldName,["number"]));case"countDistinct":return new $e(this.getActivityPathValue(e.fieldName,["string","number"]));default:throw new Error(`Unknown aggregator type: ${e.type}`)}}getAudience(e){const t=this.audienceMap[e];if(void 0===t)throw this.logger.error(`Could not find audience in builder map ${e}`,1003),new be(`Could not find audience in builder map ${e}`);return t}buildEvent(e,t){const i=this.eventMap[e];if(void 0!==i)return this.logger.warn(`Trying to build event twice ${e}`,1004),i;const s=this.buildTypedEvent(e,t);return this.eventMap[e]=s,s}buildTypedEvent(e,t){if("click"===t.type)return new ot(e,t,this);if("view"===t.type)return new jt(e,t,this);if("custom"===t.type)return new bt(e,t,this);if("shopify"===t.type)return new ft(e,t,this);throw new be(`Invalid event type ${t.type}`)}getEvent(e){const t=this.eventMap[e];if(void 0===t)throw this.logger.error(`Could not find event in builder map ${e}`,1005),new be(`Could not find event in builder map ${e}`);return t}buildCampaign(e,t,i){return new st(e,t,this,i)}buildExperience(e,t,i){const s=this.experienceMap[e];if(void 0!==s)return this.logger.warn(`Trying to build experience twice ${e}`,1006),s;const n=this.buildTypedExperience(e,t,i);return this.experienceMap[e]=n,n}buildTypedExperience(e,t,i){return"ab"===t.type?new Ve(e,t,this,i):"rbp"===t.type?new Mt(e,t,this,i):new nt(e,t,this,i)}buildMetric(e,t,i){return _e(Boolean(t)&&void 0===i||Boolean(i)&&void 0===t),"value"===e.type?"static"===e.valueType?new Lt(e,this,t,i):new Vt(e,this,t,i):new It(e,this,t,i)}buildUrl(e){return new Gt(e,this)}buildVariation(e,t,i){return new Bt(e,t,this,i)}buildControlVariation(e){const t={name:"Intellimize Control",state:"live",preconditions:[]};return this.buildVariation(zt,t,e)}buildControlStickyConfig(e){return Ht.buildStickyConfiguration(e,{s:!0})}buildExperienceIncludeStickyConfig(e){return Ht.buildStickyConfiguration(e,{s:!0})}buildVariationStickyConfig(e){return Ht.buildStickyConfiguration(e,{s:!0,r:302400})}buildGoogleUniversalAnalyticsIntegration(e){return new St(e)}buildGoogleAnalytics4Integration(e){return new _t(e)}buildSegmentIntegration(e){return new Ot(e)}buildMixpanelIntegration(e){return new Ct(e)}buildMarketoIntegration(e){return new yt(e)}buildSalesforceIntegration(e){return new Nt(e)}buildShopifyIntegration(e){return new Rt(e)}buildSixsenseIntegration(e){return new Ut(e)}buildVariationChange(e){return it(e)}getActivityPathValue(e,t){return i=>{let s=e,n=i;for(;void 0!==n&&void 0!==s;){const i=s.split(".");if(!(i.length>1&&void 0!==i[0])){const i=n[s];let r=typeof i;return _(i)&&i.every((e=>"string"==typeof e))&&(r="array-enum"),t.includes(r)?xe.ofNullable(i):(void 0!==i&&this.logger.warn(`Field "${e}" is not an allowed type (wanted ${t.join(", ")}; found ${r})`,1017),xe.empty())}n=n[i[0]],s=i.slice(1).join(".")}return xe.empty()}}}var Kt=function e(t){return Object.freeze(t),Object.getOwnPropertyNames(t).forEach((function(i){!t.hasOwnProperty(i)||null===t[i]||"object"!=typeof t[i]&&"function"!=typeof t[i]||Object.isFrozen(t[i])||e(t[i])})),t};const Qt=xe.ofNullable("v5.e89db1d0").orElse("NA"),qt=1e3,Yt=50,NO_PROGRESS_TOLERANCE_TIME_MS=48e4,Jt=1800,Xt=86400,Zt=3600,ei=500,ti=1e3,ii=63072e6,si="api.intellimize.co",ni="log.intellimize.co",ri="intellimize_api_",ai="intellimize_attributes_",oi="intellimize_integrations_",ci="intellimize_",li="intellimize_policy_",di="intellimize_server_context_",ui="intellimize_activity_",hi="intellimize_user_",gi="intellimize_opt_out_",pi="intellimize_shopify_",mi="_mkto_trk",vi=m.WARN,bi=m.OFF,fi=["utt","utm","uts","utcn","utcm"],Ei="mkt_tok";function _i(e){try{return Si(e)}catch(t){return"CAN_NOT_SERIALIZE"}}function Si(e,t,i){let s;if(void 0!==Array.prototype.toJSON&&"[3]"!==JSON.stringify([3])){const n=Array.prototype.toJSON;delete Array.prototype.toJSON,s=JSON.stringify(e,t,i),Array.prototype.toJSON=n}else s=JSON.stringify(e,t,i);return s}function yi(e){return JSON.parse(e)}function Ii(e){const t={type:e.type,target:Ti(e.target)};return e.addedNodes&&e.addedNodes.length>0&&(t.addedNodes=Array.prototype.map.call(e.addedNodes,Ti)),e.removedNodes&&e.removedNodes.length>0&&(t.removedNodes=Array.prototype.map.call(e.removedNodes,Ti)),e.attributeName&&(t.attributeName=e.attributeName),e.oldValue&&(t.oldValue=e.oldValue),Si(t)}function Ci(e){return Si(Ti(e))}function Ti(e){const t={nodeName:e.nodeName};return null!==e.textContent&&e.textContent.length<500&&(t.textContent=e.textContent),e instanceof Element&&(e.id&&(t.id=e.id),e.classList&&e.classList.length>0&&(t.classList=e.classList),e.attributes&&e.attributes.length>0&&(t.attributes=Ai(e.attributes))),t}function Ai(e){const t=e.length,i=[];for(let s=0;s<t;s+=1){const t=e.item(s);null!==t&&i.push({name:t.name,value:t.value})}return i}function xi(e,t){const i=e.getWindow().atob(t),s=ki(e,i);return decodeURIComponent(s)}function wi(e,t){return yi(xi(e,t))}function ki(e,t){const i=[...e.getWindow().atob("YmdKTnQ=")],s=[];for(let n=0;n<t.length;n++){const e=t.codePointAt(n)^i[n%i.length].codePointAt(0);s.push(String.fromCodePoint(e))}return s.join("")}function Fi(e){return e.getWindow().atob("Y1B1YmdKTnQ=")}function Pi(e){let t;if(void 0!==e)t=e;else{if("undefined"==typeof window)return b;t=window}const i=Oi(t);return i===m.OFF?b:"group"in t.console?new Di(t,i):new Mi(t,i)}class Di extends E{constructor(e,t){super(e.console,t),__publicField(this,"idebFilters"),this.idebFilters=Li(e)}debug(e,t,i,s){Ni(this.idebFilters,s)&&super.debug(e,t,i)}info(e,t,i,s){Ni(this.idebFilters,s)&&super.info(e,t,i)}warn(e,t,i,s){Ni(this.idebFilters,s)&&super.warn(e,t,i)}error(e,t,i,s){Ni(this.idebFilters,s)&&super.error(e,t,i)}group(e,t){Ni(this.idebFilters,t)&&super.group(e)}groupEnd(e){Ni(this.idebFilters,e)&&super.groupEnd()}time(e,t){Ni(this.idebFilters,t)&&super.time(e)}timeEnd(e,t){Ni(this.idebFilters,t)&&super.timeEnd(e)}}class Mi extends g{constructor(e,t){super(e.console,t),__publicField(this,"idebFilters"),this.idebFilters=Li(e)}debug(e,t,i,s){Ni(this.idebFilters,s)&&super.debug(e,t,i)}info(e,t,i,s){Ni(this.idebFilters,s)&&super.info(e,t,i)}warn(e,t,i,s){Ni(this.idebFilters,s)&&super.warn(e,t,i)}error(e,t,i,s){Ni(this.idebFilters,s)&&super.error(e,t,i)}group(e,t){Ni(this.idebFilters,t)&&super.group(e)}groupEnd(e){Ni(this.idebFilters,e)&&super.groupEnd()}time(e,t){Ni(this.idebFilters,t)&&super.time(e)}timeEnd(e,t){Ni(this.idebFilters,t)&&super.timeEnd(e)}}function Ni(e,t){const i=[],s=[];for(const n of e)n.startsWith("!")?s.push(n.slice(1)):i.push(n);return void 0===t&&0===i.length||(!0===(null==t?void 0:t.some((e=>i.includes(e))))||!0!==(null==t?void 0:t.some((e=>s.includes(e))))&&(!(i.length>0)||void 0!==t&&!t.every((e=>!i.includes(e)))))}function Oi(e){let t=Ri(e);return t.isPresent()?t.get():(t=Ui(e),t.isPresent()?t.get():(t=Vi(e),t.isPresent()?t.get():bi))}function Ri(e){if("location"in e&&"search"in e.location){const t=e.location.search.slice(1);if(void 0!==t&&t.length>0){const e=/(?:^|\?|&)ideb=([0-5])(?:$|&|#)/.exec(t);if(null!==e)return xe.of(Number.parseInt(e[1],10))}}return xe.empty()}function Ui(e){if("localStorage"in e&&"getItem"in e.localStorage){const t=e.localStorage.getItem("ideb");if(null!==t){const e=/^([0-5])$/.exec(t);if(null!==e)return xe.of(Number.parseInt(e[1],10))}}return xe.empty()}function Vi(e){const t=e.iOverride;return void 0!==t?xe.ofNullable(t.logLevel):xe.empty()}function Li(e){if("localStorage"in e&&"getItem"in e.localStorage){const i=e.localStorage.getItem("ideb_filters");if(null!==i){let s;try{if(s=i.split(","),!s.every((e=>/[A-Za-z\d-]+/.test(e))))throw new Error("ideb_filters contains at least one invalid entry");return e.console.debug("Found ideb filters:",s),s}catch(t){e.console.error(t)}}}return[]}class $i extends Error{constructor(e,t){super(`(${t}) ${e}`),this.name="JsonFetchError"}}function zi(){return __async(this,arguments,(function*(e,t,i={}){const s=Gi(e,t);return fetch(s,i).then((e=>{if(!e.ok)throw new $i(s,e.status);if(204!==e.status)return e.json()}))}))}function Wi(e,t){return __async(this,null,(function*(){return new Promise(((i,s)=>{const n=Gi(e,t),r=new XMLHttpRequest;r.open("GET",n,!1),r.addEventListener("load",(()=>{r.status>=200&&r.status<=299?i():s(new $i(n,r.status))})),r.addEventListener("error",(()=>{s(new $i(n,r.status))})),r.send()}))}))}function Gi(e,t){return`${"https://"}${e}${t}`}function Bi(e,t,i){null!=i&&e.push(t+"="+encodeURIComponent(i))}function ji(e,t,i){null!=i&&e.push(t+"="+encodeURIComponent(i.toString()))}function Hi(e,t,i){null!=i&&e.push(t+"="+encodeURIComponent(i.toString()))}function Ki(e,t,i){null!=i&&e.push(t+"="+encodeURIComponent(Si(i)))}function Qi(e){return new qi(e)}class qi{constructor(e){__publicField(this,"minimumLogLevel"),__publicField(this,"customer"),__publicField(this,"environment"),__publicField(this,"serverContext"),__publicField(this,"user"),this.minimumLogLevel=e}static get LOGGING_APP_STRING(){return"client"}static get PATH(){return"/clientlogger"}static encodeEntityIds(e,t){void 0!==t.audienceId&&Bi(e,"aid",t.audienceId),void 0!==t.campaignId&&Bi(e,"cmid",t.campaignId),void 0!==t.eventId&&Bi(e,"ei",t.eventId),void 0!==t.experienceId&&Bi(e,"eid",t.experienceId),void 0!==t.variationId&&Bi(e,"vid",t.variationId)}static encodeMessage(e,t){if("object"==typeof t&&t instanceof Error){const i=t;Bi(e,"m",i.message),Bi(e,"en",i.name),"stack"in i&&void 0!==i.stack&&Bi(e,"es",i.stack)}else Bi(e,"m",t)}configureCustomer(e){this.customer=e}configureEnvironment(e){this.environment=e}configureServerContext(e){this.serverContext=e}configureUser(e){this.user=e}getLevel(){return this.minimumLogLevel}error(e,t,i){if(this.minimumLogLevel<=m.ERROR){const s=[];Bi(s,"app",qi.LOGGING_APP_STRING),Hi(s,"mc",t),Bi(s,"ll","e"),void 0!==i&&qi.encodeEntityIds(s,i),this.send(s,e)}}warn(e,t,i){if(this.minimumLogLevel<=m.WARN){const s=[];Bi(s,"app",qi.LOGGING_APP_STRING),Hi(s,"mc",t),Bi(s,"ll","w"),void 0!==i&&qi.encodeEntityIds(s,i),this.send(s,e)}}info(e,t,i){if(this.minimumLogLevel<=m.INFO){const s=[];Bi(s,"app",qi.LOGGING_APP_STRING),void 0!==t&&Hi(s,"mc",t),Bi(s,"ll","i"),void 0!==i&&qi.encodeEntityIds(s,i),this.send(s,e)}}debug(e,t,i){if(this.minimumLogLevel<=m.DEBUG){const s=[];Bi(s,"app",qi.LOGGING_APP_STRING),void 0!==t&&Hi(s,"mc",t),Bi(s,"ll","d"),void 0!==i&&qi.encodeEntityIds(s,i),this.send(s,e)}}group(e){}groupEnd(){}time(e){}timeEnd(e){}commonQueryParams(e){void 0!==this.customer&&Bi(e,"cid",this.customer.getId()),void 0!==this.serverContext&&Bi(e,"rid",this.serverContext.requestId),void 0!==this.environment&&(Bi(e,"pvid",this.environment.getPageviewId()),this.environment.getHostingPageUrl().getUrl().ifPresent((t=>{Bi(e,"hpurl",t)})),Hi(e,"lut",this.environment.getNowUnixTimeMs()),Bi(e,"ltz",this.environment.getTimeZone())),void 0!==this.user&&Bi(e,"uid",this.user.getId()),Bi(e,"v",Qt)}send(e,t){this.commonQueryParams(e),qi.encodeMessage(e,t),zi(ni,qi.PATH+"?"+e.join("&"))}}class Yi{constructor(){__publicField(this,"consoleLogger"),__publicField(this,"serverLogger"),__publicField(this,"isLogging",!1),this.consoleLogger=Pi(),this.serverLogger=Qi(vi)}configureCustomer(e){this.serverLogger.configureCustomer(e)}configureEnvironment(e){this.serverLogger.configureEnvironment(e)}configureServerContext(e){this.serverLogger.configureServerContext(e)}configureUser(e){this.serverLogger.configureUser(e)}getLevel(){return this.consoleLogger.getLevel()}error(e,t,i,s){this.isLogging||(this.isLogging=!0,this.consoleLogger.error(e,t,i,s),this.serverLogger.error(e,t,i),this.isLogging=!1)}warn(e,t,i,s){this.isLogging||(this.isLogging=!0,this.consoleLogger.warn(e,t,i,s),this.serverLogger.warn(e,t,i),this.isLogging=!1)}info(e,t,i,s){this.isLogging||(this.isLogging=!0,this.consoleLogger.info(e,t,i,s),this.serverLogger.info(e,t,i),this.isLogging=!1)}debug(e,t,i,s){this.isLogging||(this.isLogging=!0,this.consoleLogger.debug(e,t,i,s),this.serverLogger.debug(e,t,i),this.isLogging=!1)}group(e,t){this.isLogging||(this.isLogging=!0,this.consoleLogger.group(e,t),this.isLogging=!1)}groupEnd(e){this.isLogging||(this.isLogging=!0,this.consoleLogger.groupEnd(e),this.isLogging=!1)}time(e,t){this.isLogging||(this.isLogging=!0,this.consoleLogger.time(e,t),this.isLogging=!1)}timeEnd(e,t){this.isLogging||(this.isLogging=!0,this.consoleLogger.timeEnd(e,t),this.isLogging=!1)}}const Ji=new Yi,Xi="Other";class Zi{constructor(e,t,i,s,n,r,a){__publicField(this,"environment"),__publicField(this,"serverContext"),__publicField(this,"attributeStorage"),__publicField(this,"override"),__publicField(this,"customerStorage"),__publicField(this,"integrationDataStorage"),__publicField(this,"user"),__publicField(this,"data"),this.environment=e,this.serverContext=t,this.attributeStorage=i,this.override=s,this.customerStorage=n,this.integrationDataStorage=r,this.user=a,this.reinitialize()}reinitialize(){this.data=this.withAttributeDataOverrides({location:this.initializeLocationData(),utmParams:this.initializeUtmParamData(),userAgent:this.initializeUserAgentData(),dayPart:this.environment.getDayPart(),weekPart:this.environment.getWeekPart(),trafficSource:this.initializeTrafficSourceData(),custom:this.initializeCustomData(),urlParam:this.initializeUrlParamData(),userVisitStatus:this.initializeUserVisitStatusData(),userBucket:this.initializeUserBucketData(),salesforce:this.initializeSalesforceData(),firmographic:this.initializeFirmographicData(),"6sense":this.initializeSixsenseData()}),Ji.debug(`[AttributeData] Initialized: ${Si(this.data)}`)}getLocationData(){return this.data.location}getUtmParamsData(){return this.data.utmParams}getUserAgentData(){return this.data.userAgent}getDayPartData(){return this.data.dayPart}getWeekPartData(){return this.data.weekPart}getTrafficSourceData(){return this.data.trafficSource}getCustomData(){return this.data.custom}getUrlParamData(){return this.data.urlParam}getUserVisitStatusData(){return this.data.userVisitStatus}getUserBucketData(){return this.data.userBucket}getSalesforceData(){return this.data.salesforce}getFirmographicData(){return this.data.firmographic}getSixsenseData(){return this.data["6sense"]}initializeCustomData(){return this.attributeStorage.getFlattenedCustomAttributes()}initializeUrlParamData(){const e=this.environment.getHostingPageUrl().getAllUrlParamsUnsafe();Ji.debug(`[AttributeData] All UrlParamsUnsafe: ${Si(e)}`);const t={};return Object.keys(e).forEach((i=>{const s=e[i];T(i)&&(t[i]=s)})),t}initializeUserVisitStatusData(){return this.customerStorage.getUserVisitStatus(this.user)}initializeUserBucketData(){return this.user.getUserBucket()}initializeLocationData(){var e,t,i,s;const n=null!=(e=this.serverContext.location)?e:{};return{country:null!=(t=n.country)?t:Xi,state:null!=(i=n.state)?i:Xi,city:null!=(s=n.city)?s:Xi,tz:this.environment.getTimeZone(),dma:n.dma,postal:n.postal}}initializeUserAgentData(){var e,t,i,s,n,r,a,o,c,l;const d=null!=(e=this.serverContext.userAgent)?e:{};let u,h,g;switch(d.deviceClass){case"Desktop":case"Set-top box":case"TV":case"Game Console":default:u="D";break;case"Mobile":case"Phone":case"Handheld Game Console":u="P";break;case"Tablet":case"eReader":u="T"}switch(d.agentName){case"Firefox":case"Gecko":case"Camino":case"SeaMonkey":h="Firefox";break;case"Chrome":case"Chrome Webview":case"Chromium":case"Epiphany":h="Chrome";break;case"Edge":case"Edge Webview":h="Edge";break;case"Safari":case"Mobile Safari":h="Safari";break;case"Internet Explorer":case"IE Mobile":case"Internet Explorer Webview":h="IE";break;default:h=Xi}switch(d.osName){case"Mac OS X":g="Macintosh";break;case"Windows Phone":g="WindowsPhone";break;case"Windows NT":case"Windows 9x":case"Windows CE":g="Windows";break;case"Android":g="Android";break;case"Linux":case"Fedora":g="Linux";break;case"iOS":g="iOS";break;default:g=Xi}return{deviceType:u,browser:h,os:g,deviceClass:null!=(t=d.deviceClass)?t:Xi,deviceName:null!=(i=d.deviceName)?i:Xi,deviceBrand:null!=(s=d.deviceBrand)?s:Xi,osClass:null!=(n=d.osClass)?n:Xi,osName:null!=(r=d.osName)?r:Xi,osVersion:null!=(a=d.osVersion)?a:Xi,agentClass:null!=(o=d.agentClass)?o:Xi,agentName:null!=(c=d.agentName)?c:Xi,agentVersionMajor:null!=(l=d.agentVersionMajor)?l:Xi}}initializeUtmParamData(){const e=this.attributeStorage.getInternalAttributes("user",fi);return{utmSource:e.uts,utmMedium:e.utm,utmCampaign:e.utcm,utmContent:e.utcn,utmTerm:e.utt}}initializeTrafficSourceData(){const{ts:e}=this.attributeStorage.getInternalAttributes("user",["ts"]);return null!=e?e:"OT"}initializeSalesforceData(){return this.integrationDataStorage.getData("salesforce").map((e=>{const t={};return void 0!==e&&Object.entries(e).forEach((([e,i])=>{Object.entries(i).forEach((([i,s])=>{t[`${e}.${i}`]=s}))})),t})).orElse({})}initializeFirmographicData(){return this.integrationDataStorage.getData("firmographic").map((e=>null!=e?e:{})).orElse({})}initializeSixsenseData(){return this.integrationDataStorage.getData("6sense").map((e=>null!=e?e:{})).orElse({})}withAttributeDataOverrides(e){const t=this.override.getAttributeDataOverrides();return this.overrideObject(e.location,t.location),this.overrideObject(e.utmParams,t.utmParams),this.overrideObject(e.userAgent,t.userAgent),void 0!==t.dayPart&&(e.dayPart=t.dayPart),void 0!==t.weekPart&&(e.weekPart=t.weekPart),void 0!==t.trafficSource&&(e.trafficSource=t.trafficSource),this.overrideObject(e.custom,t.custom),this.overrideObject(e.urlParam,t.urlParam),void 0!==t.userVisitStatus&&(e.userVisitStatus=t.userVisitStatus),void 0!==t.userBucket&&(e.userBucket=t.userBucket),e}overrideObject(e,t){Object.entries(t).forEach((([t,i])=>{void 0!==i&&(e[t]=i)}))}}function es(e){return"object"==typeof e&&e instanceof Error?e:new Error(e)}class ts{static evalBoolean(e){const t=ts.eval(e);if("boolean"==typeof t)return t;throw new TypeError("Expected boolean response, but got "+typeof t+": "+t)}static evalString(e){const t=ts.eval(e);if("string"==typeof t)return t;throw new TypeError("Expected string response, but got "+typeof t+": "+t)}static eval(e){return Ji.info(`eval code: ${e}`),(0,eval)('"use strict";\n'+ts.reformatJqueryCode(e))}static injectCss(e,t,i){Ji.info(`inject css: ${e}`);const s=`intellimize-${t}`,n=i.querySelectorAll(`head #${s}`),[r]=n;if(void 0===r){const t=i.createElement("style");t.id=s,t.className="iStyleBlock",t.append(e),i.head.append(t)}else r.innerHTML=e}static executeFunction(e,t){try{e.call(void 0)}catch(i){const e=es(i);e.message=`Caught exception in function callback: ${e.message}`,Ji.error(e,t)}}static reformatJqueryCode(e){return`var $ = (window.intellimize && window.intellimize.plugins && window.intellimize.plugins.jquery) ? window.intellimize.plugins.jquery : window.$;\n${e}`}}var is=(e=>(e[e.NOT_STARTED=0]="NOT_STARTED",e[e.TRY_LATER=1]="TRY_LATER",e[e.WAITING=2]="WAITING",e[e.SUCCEEDED=3]="SUCCEEDED",e[e.FAILED=4]="FAILED",e[e.CANCELED=5]="CANCELED",e))(is||{});const ss=new Set([0,1,2]),ns=class{constructor(){__publicField(this,"manager"),__publicField(this,"id"),__publicField(this,"doneFunctions",[]),__publicField(this,"currentStatus",0),this.id=++ns.lastId}static isDone(e){return!ss.has(e)}getId(){return this.id}setManager(e){this.manager=e}cancel(){this.currentStatus=5,this.cleanup()}cleanup(){}runWrapper(){Ji.group(this.toString()+".run()");const e=this.currentStatus;try{this.currentStatus=this.run()}catch(i){const e=es(i);e.message=`Task exception\n${e.message}`,Ji.error(e,179,this.getEntityIds()),this.currentStatus=4}const t=this.currentStatus;return!ns.isDone(e)&&ns.isDone(t)&&this.executeDoneFunctions(),Ji.groupEnd(),this.currentStatus}onDone(e){this.isDone()?ts.executeFunction(e,153):this.doneFunctions.push(e)}getStatus(){return this.currentStatus}isDone(){return!ss.has(this.currentStatus)}getNotDoneDependencies(){return[]}isBlocked(){if(2===this.currentStatus)return!0;return this.getNotDoneDependencies().filter((e=>e.isBlocked())).length>0}toString(){return`Task(${this.id})`}getEntityIds(){return{}}setStatusTryLater(){this.currentStatus=1}executeDoneFunctions(){for(let e=this.doneFunctions.shift();void 0!==e;e=this.doneFunctions.shift())ts.executeFunction(e,154)}};let rs=ns;__publicField(rs,"lastId",0);class as extends rs{constructor(e){super(),__publicField(this,"elementObserver"),this.elementObserver=e}toString(){return"ElementObserverTask()"}inTransaction(){return!1}isUnloading(){return!1}cleanup(){Ji.group("ElementObserverTask.cleanup()"),this.elementObserver.reset(),Ji.groupEnd()}run(){return Ji.debug("ElementObserverTask no-op done"),is.SUCCEEDED}}function os(e){return"[object Array]"===Object.prototype.toString.call(e)}function cs(e){return"[object Arguments]"===Object.prototype.toString.call(e)}function ls(e){return"[object Object]"===Object.prototype.toString.call(e)}function ds(e){return"[object Function]"===Object.prototype.toString.call(e)}function us(e,t){const i=[];for(const s of e)t.includes(s)||i.push(s);for(const s of t)e.includes(s)||i.push(s);return i}function hs(e){return e.replace(/([a-z\d])([A-Z])/g,"$1-$2").toLowerCase()}function gs(e,t){const i=e.indexOf(t);i>-1&&e.splice(i,1)}function ps(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>[t,e])))}const ms=class{constructor(e,t,i){__publicField(this,"change"),__publicField(this,"override"),__publicField(this,"changeAppliers"),_e(e.getType()===B.ATTRIBUTE),this.change=e,this.override=t,this.changeAppliers=i}static getIsValidAttribute(e,t){const i=e.tagName.toLowerCase();return ms.VALID_TAGS_BY_NON_STANDARD_ATTRIBUTE[t].includes(i)}apply(e){Ji.group("AttributeChangeApplier.apply()"),Ji.debug(`Applying change: ${Si(this.change)}`),this.changeAppliers.getElementObserver().ifPresent((t=>{Ji.debug("ElementObserver is enabled"),t.registerSelectorAndExecute(this.change.getSelector(),(t=>{this.applyChanges(t,e)}),{shouldReapply:e=>this.shouldReapply(e)})})).ifAbsent((()=>{Ji.debug("ElementObserver is not enabled"),Array.prototype.forEach.call(this.change.getSelectorElements(),(t=>{this.applyChanges(t,e)}))})),Ji.groupEnd()}undo(){Ji.debug(`[AttributeChangeApplier]: Undoing change: ${Si(this.change)}`),this.change.getId().ifPresent((e=>{const t=As.getImizeElements(e);Array.prototype.forEach.call(t,(t=>{if(t instanceof HTMLElement){const i=As.getChangeData(t,e);if(i.isPresent()){const e=i.get().value;Object.keys(this.change.getAttributes()).forEach((i=>{switch(i){case"html":void 0!==e.html&&(t.innerHTML=e.html);break;case"className":void 0!==e.className&&(t.className=e.className);break;case"alt":case"src":case"srcset":case"sizes":case"href":{const s=e[i];void 0===s?t.removeAttribute(i):t.setAttribute(i,s);break}case"css":case"style":void 0!==e.style&&(t.style.cssText=e.style);break;default:Ji.error(`[AttributeChangeApplier]: Cannot undo unknown attribute: ${i}`,121)}}))}else Ji.error(`[AttributeChangeApplier]: Expected change data, but there was none: ${Si(this.change)}`,122)}else Ji.error(new Error("[AttributeChangeApplier]: Found matching element that is not an HTMLElement"),123);As.removeImizeAttribute(t,e),As.removeChangeData(t,e)}))}))}cancel(){}applyChanges(e,t){let i=!1;Ji.group(`AttributeChangeApplier.applyChanges(${Si(this.change)})`),this.change.getId().ifPresent((t=>{As.setImizeAttribute(e,t)}));const s={};Object.keys(this.change.getAttributes()).forEach((n=>{switch(n){case"html":{const{html:t}=this.change.getAttributes();void 0!==t&&(s.html=e.innerHTML,e.innerHTML=t),Ji.debug("Applied html");break}case"css":case"style":break;case"className":{const{className:t}=this.change.getAttributes();void 0!==t&&(s.className=e.className,e.className=t),Ji.debug("Applied className");break}case"src":this.applyNonStandardAttribute(n,e,s),"img"===e.tagName.toLowerCase()&&this.override.hideImage().orElse(!0)&&(Ji.debug("attaching listener for img src loading"),i=!0,e.addEventListener("load",(()=>{Ji.debug("AttributeChangeApplier() image loaded! calling onReadyToRender()"),void 0!==t&&t()}),{once:!0}));break;case"alt":case"srcset":case"sizes":case"href":this.applyNonStandardAttribute(n,e,s);break;default:Ji.error(`[AttributeChangeApplier]: Cannot apply unknown attribute: ${n}`,120)}}));const n=this.createCssText(e);void 0!==n&&(s.style=e.style.cssText,e.style.cssText=n,Ji.debug("Applied css")),this.change.getId().ifPresent((t=>{As.setChangeData(e,t,{value:s,type:B.ATTRIBUTE})})),i||(Ji.debug("AttributeChangeApplier() not waiting; calling onReadyToRender()"),void 0!==t&&t()),Ji.debug("DOM modifications successfully applied for this change."),Ji.groupEnd()}applyNonStandardAttribute(e,t,i){const s=ms.getIsValidAttribute(t,e),n=this.change.getAttributes()[e];if(s&&void 0!==n){const s=t.getAttribute(e);null!==s&&(i[e]=s),t.setAttribute(e,n)}else Ji.error(`This ${t.tagName} does not support this attribute: ${e}`,131);Ji.debug(`Applied ${n}`)}createCssText(e){const{css:t,style:i}=this.change.getAttributes();if(A(t))return i;const s=null!=i?i:"";let n="";return Object.entries(t).forEach((([e,t])=>{if(!new RegExp(e+"\\s?:").test(s)){const i=t.includes("!important")?t:`${t} !important`;n+=`${hs(e)}:${i};`}})),A(i)?e.style.cssText+n:n+s}shouldReapply(e){for(const t in this.change.getAttributes())if(Object.prototype.hasOwnProperty.call(this.change.getAttributes(),t))switch(Ji.debug(`shouldReapply(): CHECKING "${t}"`),t){case"css":case"className":case"style":case"alt":Ji.debug(`shouldReapply(): SKIP (attribute "${t}" not checked)`);break;case"src":case"srcset":case"sizes":case"href":{const i=this.change.getAttributes()[t];if(void 0!==i){const s=e.getAttribute(t);if(""===i&&null===s){Ji.debug(`shouldReapply(): SKIP (value of "${t}" is null; configured value is empty string)`);break}if(i!==s)return Ji.debug(`shouldReapply(): YES (value of "${t}" changed from "${i}" to "${s}")`),!0;Ji.debug(`shouldReapply(): SKIP (value of "${t}" did not change)`);break}Ji.debug(`shouldReapply(): SKIP (configured value of "${t}" is undefined)`);break}case"html":{const i=this.change.getAttributes()[t],s=document.createElement("div");if(void 0!==i&&(s.innerHTML=i),e.innerText!==s.innerText)return Ji.debug(`shouldReapply(): YES (The visible text of the element has changed from "${s.innerText}" to "${e.innerText}")`),!0;Ji.debug(`shouldReapply(): SKIP (The visible text of the element has not changed; comparing configured "${s.innerText}" to current "${e.innerText}")`);break}default:Ji.error(`[AttributeChangeApplier]: shouldReapply() found unknown attribute: ${t}`,201)}return Ji.debug("shouldReapply(): NO (all attributes skipped)"),!1}};let vs=ms;function bs(){return _s("xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx")}function fs(){return _s("xxxx-yxxx-xxxxxxxxxxxx")}function Es(){return _s("xxxxxxxxxx")}function _s(e){let t=Date.now();return e.replace(/[xy]/g,(e=>{const i=Math.trunc((t+16*Math.random())%16);return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)}))}__publicField(vs,"VALID_TAGS_BY_NON_STANDARD_ATTRIBUTE",{alt:["img"],src:["img"],srcset:["img"],sizes:["img"],href:["a"]});class Ss{constructor(e,t,i){__publicField(this,"change"),__publicField(this,"changeAppliers"),__publicField(this,"localDocument"),_e(e.getType()===B.CUSTOM_CODE),this.change=e,this.changeAppliers=t,this.localDocument=i}apply(e){Ji.group("CustomCodeChangeApplier.apply()"),Ji.debug(`Applying change: ${Si(this.change)}`);try{this.change.getCss().ifPresent((e=>{this.injectCss(e)})),this.changeAppliers.detachObserver(),this.change.getCode().ifPresent((e=>{this.runCode(e)}))}finally{this.changeAppliers.attachObserver()}void 0!==e&&e(),Ji.groupEnd()}runCode(e){try{Ji.info("Running code for CUSTOM_CODE change"),ts.eval(e)}catch(t){const e=es(t);throw e.message="Code execution failed\n"+e.message,e}}injectCss(e){try{const t=this.change.getId().orElseRun(bs);Ji.info("Injecting css for CUSTOM_CODE change"),ts.injectCss(e,`variation-change-${t}`,this.localDocument)}catch(t){const e=es(t);throw e.message="Css injection failed\n"+e.message,e}}}class ys{constructor(e,t){__publicField(this,"change"),__publicField(this,"changeAppliers"),_e(e.getType()===B.INSERT_ELEMENT),this.change=e,this.changeAppliers=t}apply(e){Ji.group("InsertElementChangeApplier.apply()"),Ji.debug(`Applying change: ${Si(this.change)}`);const t=this.createInsertionElement();this.changeAppliers.getElementObserver().ifPresent((i=>{i.registerSelectorAndExecute(this.change.getTargetPosition().selector,(()=>{this.insertElement(t,e)}),{shouldReapply:this.shouldReapply.bind(this)})})).ifAbsent((()=>{this.insertElement(t,e)})),Ji.groupEnd()}undo(){Ji.group("InsertElementChangeApplier.undo()"),Ji.debug(`Undoing change: ${Si(this.change)}`),this.change.getId().ifPresent((e=>{const t=As.getImizeElements(e);1===t.length?t[0].remove():Ji.warn(`Unexpected error when undoing insertElementChange. Auto-generated attribute\n        selector expected 1 element match but found ${t.length}`,191)})),Ji.groupEnd()}cancel(){}insertElement(e,t){this.removeExistingElements(),this.change.getTargetElement().ifPresent((i=>{i.insertAdjacentElement(this.change.getTargetPosition().insertPosition,e),void 0!==t&&t()})).ifAbsent((()=>{throw new Error("Unexpected error: targetElement not found")})),this.change.getId().ifPresent((t=>{As.setChangeData(e,t,{value:this.change.getElementType(),type:B.INSERT_ELEMENT}),As.setImizeAttribute(e,t)}))}getInsertedElements(){return document.querySelectorAll(`#${this.change.getIdAttribute()}`)}removeExistingElements(){const e=this.getInsertedElements();Array.prototype.forEach.call(e,(e=>{e.remove()}))}createInsertionElement(){let e;if(this.change instanceof et)e=`h${this.change.getSize()}`;else switch(this.change.getElementType()){case"image":e="img";break;case"video":e="video";break;default:e="div"}const t=document.createElement(e);return t.id=this.change.getIdAttribute(),t}shouldReapply(){return 0===this.getInsertedElements().length}}const Is=class{constructor(e,t){__publicField(this,"change"),__publicField(this,"changeAppliers"),__publicField(this,"hasLoggedMutationWarning",!1),_e(e.getType()===B.MOVE_ELEMENT),this.change=e,this.changeAppliers=t}static createAndInsertPlaceholderElement(e){const t=document.createElement("imizeplaceholder");return t.style.display="none",t.hidden=!0,e.after(t),t}apply(e){Ji.group("MoveElementChangeApplier.apply()"),Ji.debug(`Applying change: ${Si(this.change)}`),this.changeAppliers.getElementObserver().ifPresent((e=>{const t=this.change.getSelector();e.registerSelectorAndExecute(t,(()=>{}),{shouldReapply:this.shouldReapply.bind(this)})})),this.moveElement(e),Ji.groupEnd()}undo(){Ji.group("MoveElementChangeApplier.undo()"),Ji.debug(`Undoing change: ${Si(this.change)}`),this.change.getId().ifPresent((e=>{const t=As.getImizeElements(e);if(1===t.length){const i=t[0];As.getChangeData(i,e).ifPresent((({value:e})=>{null!==e.parentElement&&e.parentElement.replaceChild(i,e)})).ifAbsent((()=>{Ji.warn(`Unexpected error when undoing moveElementChange. ChangeAppliers.getChangeData(${e}):\n          could not find data`,195)})),As.removeImizeAttribute(i,e),As.removeChangeData(i,e),i.removeAttribute(Is.MOVE_ELEMENT_DATA_ATTRIBUTE_NAME)}else Ji.warn(`Unexpected error when undoing moveElementChange. Auto-generated attribute\n        selector expected 1 element match but found ${t.length}`,196)})),Ji.groupEnd()}cancel(){}getMovedElement(){const e=document.querySelectorAll(`[${Is.MOVE_ELEMENT_DATA_ATTRIBUTE_NAME}="${this.change.getMoveId()}"]`);return 1===e.length?xe.ofNullable(e[0]):xe.empty()}shouldReapply(){return this.hasLoggedMutationWarning||(this.getMovedElement().ifPresent((()=>{Ji.warn("[MoveElementChangeApplier]: A mutation was observed for a move element change, however the moved element appears to still exists on the page",225)})).ifAbsent((()=>{Ji.warn("[MoveElementChangeApplier]: A mutation was observed for a move element change and the moved element could not be found on the page.",226)})),this.hasLoggedMutationWarning=!0),!1}moveElement(e){try{this.change.getSelectorElement().ifPresent((e=>{this.change.getTargetElement().ifPresent((t=>{if(e.contains(t))throw new Error("The target element cannot be a child of the selector element");this.change.getId().ifPresent((t=>{As.setImizeAttribute(e,t);const i=Is.createAndInsertPlaceholderElement(e);As.setChangeData(e,t,{value:i,type:B.MOVE_ELEMENT})})),t.insertAdjacentElement(this.change.getTargetPosition().insertPosition,e),e.setAttribute(Is.MOVE_ELEMENT_DATA_ATTRIBUTE_NAME,this.change.getMoveId())})).ifAbsent((()=>{throw new Error("Unexpected error: target element could not be found)")}))})).ifAbsent((()=>{throw new Error("Unexpected error: selector element could not be found)")}))}finally{void 0!==e&&e()}}};let Cs=Is;__publicField(Cs,"MOVE_ELEMENT_DATA_ATTRIBUTE_NAME",`data-${H}`);const Ts=class{constructor(e,t,i,s,n){__publicField(this,"taskManager"),__publicField(this,"environment"),__publicField(this,"isEditorMode"),__publicField(this,"override"),__publicField(this,"elementObserver"),this.taskManager=e,this.environment=t,this.isEditorMode=i,this.override=s,this.elementObserver=n,this.reinitialize(),this.initializeChangeApplierUtils(),this.initializeChangeAppliers()}static setChangeData(e,t,i){var s;const n=e;n.imizeChangeData=null!=(s=n.imizeChangeData)?s:{},I(n.imizeChangeData)?n.imizeChangeData[t]=i:Ji.error("Invalid imizeChangeData value: must be an object",118)}static getChangeData(e,t){return xe.ofNullable(Ts.getAllChangeData(e)[t])}static removeChangeData(e,t){delete Ts.getAllChangeData(e)[t],0===Object.keys(Ts.getAllChangeData(e)).length&&this.removeAllChangeData(e)}static hasChangeData(e){const t=e;return void 0!==t.imizeChangeData&&Object.keys(t.imizeChangeData).length>0}static getImizeElements(e){return document.querySelectorAll(`[${Ts.getImizeAttributeName(e)}]`)}static setImizeAttribute(e,t){e.setAttribute(Ts.getImizeAttributeName(t),t)}static removeImizeAttribute(e,t){e.removeAttribute(Ts.getImizeAttributeName(t))}static getAllChangeData(e){var t;const i=e;return I(i.imizeChangeData)||A(i.imizeChangeData)?null!=(t=i.imizeChangeData)?t:{}:(Ji.error("Invalid imizeChangeData value: must be undefined or an object",119),{})}static removeAllChangeData(e){delete e.imizeChangeData}reinitialize(){Ji.debug("ChangeAppliers.reinitialize()"),this.isEditorMode&&this.taskManager.addTask(new as(this.elementObserver))}createChangeApplier(e,t){switch(e.getType()){case B.ATTRIBUTE:return new vs(e,this.override,this);case B.INSERT_ELEMENT:return new ys(e,this);case B.MOVE_ELEMENT:return new Cs(e,this);case B.CUSTOM_CODE:return new Ss(e,this,t);default:throw new Error(`Unknown VariationChangeType: ${e.getType()}`)}}getElementObserver(){return this.shouldReapplyChanges()?xe.of(this.elementObserver):xe.empty()}attachObserver(){this.shouldReapplyChanges()&&this.elementObserver.attachObserver()}detachObserver(){this.shouldReapplyChanges()&&this.elementObserver.detachObserver()}shouldReapplyChanges(){return!this.isEditorMode}initializeChangeApplierUtils(){if(this.isEditorMode){const{intellimize:e}=this.environment.getWindow();void 0===e?Ji.error("window.intellimize is undefined: Cannot initialize ChangeApplier utils",217):e.changeApplierUtils={setChangeData:Ts.setChangeData,getChangeData:Ts.getChangeData,removeChangeData:Ts.removeChangeData,hasChangeData:Ts.hasChangeData,getChangeTypeData:Ts.getChangeTypeData}}}initializeChangeAppliers(){if(this.isEditorMode){const{intellimize:e}=this.environment.getWindow();void 0===e?Ji.error("window.intellimize is undefined: Cannot initialize ChangeAppliers",216):e.createChangeApplier=e=>this.createChangeApplier(e,this.environment.getWindow().document)}}};let As=Ts;__publicField(As,"IMIZE_ATTRIBUTE","data-imize"),__publicField(As,"getImizeAttributeName",(e=>`${Ts.IMIZE_ATTRIBUTE}-${e}`)),__publicField(As,"getChangeTypeData",((e,t)=>{const i={};for(const[s,n]of Object.entries(Ts.getAllChangeData(e)))n.type===t&&(i[s]=n.value);return i}));class xs{static getSource(e,t){const i=e.isPaidTraffic()||t.isPaidTraffic(),s=e.getUrl(),n=t.getUrl();let r=xs.getSourceByReferrer(e,t,i);return"OT"===r&&(r=xs.getSourceByUtmTags(e,t,i)),"OT"===r&&(r=t.getSourceFromAllParams(i)),"OT"===r&&(r=i?"OP":s.isPresent()?n.isPresent()&&xs.isRecirculation(s.get(),n.get())?"RC":"OT":"DN"),r}static isRecirculation(e,t){const i=/(https?):\/\/([^/]+)\/?.*$/.exec(e),s=/(https?):\/\/([^/]+)\/?.*$/.exec(t);return null!==i&&null!==s&&i[1]===s[1]&&i[2]===s[2]}static getSourceByReferrer(e,t,i){return e.isFromEmail()?"EM":e.isFromSocialNetwork()?i||t.isSocialPaid()?"CP":"CO":e.isFromSearchEngine()?i||t.isSearchTagged(e)||e.isSearchPaid()||t.isSearchPaid()?"SP":"SO":"OT"}static getSourceByUtmTags(e,t,i){return t.isSocialTagged()?i||t.isSocialPaid()?"CP":"CO":t.isSearchTagged(e)?i||t.isSearchPaid()?"SP":"SO":t.getUrl().isPresent()&&t.isEmailTagged()?"EM":"OT"}}class ws{constructor(){__publicField(this,"onVariationRecordedCallbackTuples",[])}static updateInternalAttributes(e,t){let i=!0;const s=e.getReferrerUrl(),n=e.getHostingPageUrl(),r={utcm:"utm_campaign",utcn:"utm_content",utm:"utm_medium",uts:"utm_source",utt:"utm_term"};if(xs.isRecirculation(s.getUrl().orElse(""),n.getUrl().orElse(""))&&(i=!1),i){const i=xs.getSource(s,n);t.setInternalAttributes("user",{ts:i}),t.deleteInternalAttributes("user",fi);const a={};fi.forEach((t=>{const i=r[t],s=e.getUrlParameter(i,(()=>!0));s.isPresent()&&(a[t]=s.get())})),Object.keys(a).length>0&&t.setInternalAttributes("user",a)}}static runCustomerCode(e,t,i){e.getCss().ifPresent((s=>{try{Ji.info(`Injecting customer ${e.getId()} css`),ts.injectCss(s,`customer-${e.getId()}`,i),t.setCustomer("css",!0)}catch(n){const i=es(n);i.message=`Customer (${e.getId()}) css injection failed\n`+i.message,Ji.error(i,26),t.setCustomer("css",!1)}})),e.getCode().ifPresent((i=>{try{Ji.info(`Running customer ${e.getId()} code`),ts.eval(i),t.setCustomer("code",!0)}catch(s){const i=es(s);i.message=`Customer (${e.getId()}) code execution failed\n`+i.message,Ji.error(i,13),t.setCustomer("code",!1)}}))}static iE(e){return!e.startsWith('{"')}getVariationRecordedCallbackTuples(){return this.onVariationRecordedCallbackTuples}addVariationRecordedCallbackTuple(e){this.onVariationRecordedCallbackTuples.push(e)}}class ks{constructor(e,t){__publicField(this,"attributeData"),__publicField(this,"activityStorage"),this.attributeData=e,this.activityStorage=t}evalBoolean(e){Ji.info(`ConditionEvaluationRuntime.evalBoolean(${e.slice(0,10)})`);const t=ts.evalBoolean(e);return Ji.info(`ConditionEvaluationRuntime.evalBoolean() => ${t}`),t}getAttributeValue(e){switch(e.getNamespace()){case"standard":switch(e.getName()){case"utm_source":return xe.ofNullable(this.attributeData.getUtmParamsData().utmSource);case"utm_medium":return xe.ofNullable(this.attributeData.getUtmParamsData().utmMedium);case"utm_campaign":return xe.ofNullable(this.attributeData.getUtmParamsData().utmCampaign);case"utm_content":return xe.ofNullable(this.attributeData.getUtmParamsData().utmContent);case"utm_term":return xe.ofNullable(this.attributeData.getUtmParamsData().utmTerm);case"country":return xe.ofNullable(this.attributeData.getLocationData().country);case"state":return xe.ofNullable(this.attributeData.getLocationData().state);case"timezone":return xe.ofNullable(this.attributeData.getLocationData().tz);case"device_type":return xe.ofNullable(this.attributeData.getUserAgentData().deviceType);case"day_part":return xe.ofNullable(this.attributeData.getDayPartData());case"week_part":return xe.ofNullable(this.attributeData.getWeekPartData());case"traffic_source":return xe.ofNullable(this.attributeData.getTrafficSourceData());case"user_visit_status":return xe.ofNullable(this.attributeData.getUserVisitStatusData());case"user_bucket":return xe.ofNullable(this.attributeData.getUserBucketData());default:return Ji.error(`Standard attribute name (${e.getName()}) not supported`,214),xe.empty()}case"url_param":return xe.ofNullable(this.attributeData.getUrlParamData()[e.getName()]);case"custom":return xe.ofNullable(this.attributeData.getCustomData()[e.getName()]);case"salesforce":return xe.ofNullable(this.attributeData.getSalesforceData()[e.getName()]);case"firmographic":return xe.ofNullable(this.attributeData.getFirmographicData()[e.getName()]);case"6sense":return xe.ofNullable(this.attributeData.getSixsenseData()[e.getName()]);default:return Ji.error(`Attribute namespace (${e.getNamespace()}) not supported`,215),xe.empty()}}getActivities(){return this.activityStorage.getAll()}}class Fs{constructor(e){__publicField(this,"optionalUrl"),__publicField(this,"urlParamsUnsafe"),this.optionalUrl=Fs.sanitizeUrl(e);const t=!0===(null==e?void 0:e.includes("?"))?e.slice(e.indexOf("?")):void 0;this.urlParamsUnsafe=Kt(Fs.parseQueryStringUnsafe(t))}static parseQueryStringUnsafe(e){const t={};return void 0!==e&&e.length>0&&e.slice(1).split("&").forEach((e=>{try{if(void 0!==e&&e.length>0){const i=e.split("=",2),s=decodeURIComponent(i[0]);if(!Object.prototype.hasOwnProperty.call(t,s)){let e="";void 0!==i[1]&&(e=decodeURIComponent(i[1].replace(/\+/g," "))),t[s]=e}}}catch(i){const e=es(i);Ji.warn(e,29)}})),t}static sanitizeUrl(e){try{if(void 0!==e)return xe.ofNullable(decodeURI(e))}catch(t){Ji.error(`Url could not be decoded: '${e}'`,44)}return xe.ofNullable(e)}getAllUrlParamsUnsafe(){return this.urlParamsUnsafe}getUrl(){return this.optionalUrl}}class Ps extends Fs{constructor(e){super(e),__publicField(this,"urlParamsEncoded"),__publicField(this,"utmMedium"),__publicField(this,"utmSource"),this.urlParamsEncoded=Kt(Ps.standardUrlParameterParser(e)),this.utmSource=this.urlParamsUnsafe.utm_source,this.utmMedium=this.urlParamsUnsafe.utm_medium}static standardUrlParameterParser(e){const t={};if(void 0===e)return t;const i=e.indexOf("#");let s=e.length-1;-1!==i&&(s=i-1);const n=e.indexOf("?"),r=n+1;return-1===n||r>=s||e.slice(r,s+1).split("&").filter((e=>void 0!==e&&e.length>0)).forEach((e=>{let i=e,s="";const n=e.indexOf("=");-1!==n&&(i=e.slice(0,Math.max(0,n)),s=e.slice(n+1)),void 0===t[i]?t[i]=[s]:t[i].push(s)})),t}get emailTagRegExp(){return/email|^send|hs_em|[\W_^]mail[\W_$]|sms|newsletter|^em[\W_$]|^attentive$/}get searchTagRegExp(){return/(search|bing|google|googlepla|sem|adwords)/i}get socialTagRegExp(){return/facebook|[\W_^]fb[\W_$]|youtube|[\W_^]ig[\W_$]|twitter|igstories|^tw$|twtr|profile|pinterest|instagram|socialmedia|quora|newsfeed|reddit|social|influencer|yelp|snapchat|linkedin|googleplus|g\+|gplus|google\+/i}get paidSocialRegExp(){return/influencer|ctc|ocpm|smm|socialp|cbo|bid|paidsocial/i}get organicSocialRegExp(){return/organic|socialo|stories|story|profile/i}get paidRegExp1(){return/(placement|attentive|taboola|gdn|criteo|googlepla|mrkt_adwords|outbrain|shareasale|klaviyo|inboxdollars|liveintent|adwords|ads|listrak|gsp|bluecore)/i}get paidRegExp2(){return/(cpc|affiliate|paid|smm|sem|ocpm|adroll|reengagement|remarketing|retargeting|cpa|paids|native|ppc|leads|display|[\W_^]ad[\W_$]|cpm|advertising|channel_partner|sponsored)/i}get searchIdRegExp(){return/([?&])(gclid|msclkid)=/i}get socialIdRegEx(){return/([?&])fbclid=/i}getAllUrlParamsEncoded(){return this.urlParamsEncoded}getSourceFromAllParams(e){let t=!1;for(const i of Object.keys(this.urlParamsUnsafe))if(Object.prototype.hasOwnProperty.call(this.urlParamsUnsafe,i)){const s=this.urlParamsUnsafe[i];if(t=t||this.isParamPaid(s),this.isParamSocialTagged(s))return e||t||this.isParamSocialPaid(s)?"CP":"CO";if(this.isParamSearchTagged(s))return e||t||this.isSearchPaid()?"SP":"SO";if(this.getUrl().isPresent()&&this.isParamEmailTagged(s))return"EM"}return t?"OP":"OT"}isSocialTagged(){return!(!this.optionalUrl.isPresent()||!this.socialIdRegEx.test(this.optionalUrl.get()))||(this.isParamSocialTagged(this.utmMedium)||this.isParamSocialTagged(this.utmSource))}isSocialPaid(){return this.isParamSocialPaid(this.utmMedium)||this.isParamSocialPaid(this.utmSource)}isSearchTagged(e){return!(!this.optionalUrl.isPresent()||!this.searchIdRegExp.test(this.optionalUrl.get()))||(!(!this.isParamSearchTagged(this.utmSource)&&!this.isParamSearchTagged(this.utmMedium))||e.getUrl().isPresent()&&e.isFromSearchEngine()&&(Boolean(this.utmMedium)||Boolean(this.utmSource)))}isSearchPaid(){return!(!this.optionalUrl.isPresent()||!this.searchIdRegExp.test(this.optionalUrl.get()))||(this.isParamSearchPaid(this.utmMedium)||this.isParamSearchPaid(this.utmSource))}isPaidTraffic(){return this.isParamPaid(this.utmSource)||this.isParamPaid(this.utmMedium)}isEmailTagged(){return this.isParamEmailTagged(this.utmSource)||this.isParamEmailTagged(this.utmMedium)}isParamPaid(e){return void 0!==e&&(this.paidRegExp1.test(e)||this.paidRegExp2.test(e))}isParamEmailTagged(e){return void 0!==e&&this.emailTagRegExp.test(e)}isParamSearchTagged(e){return void 0!==e&&this.searchTagRegExp.test(e)}isParamSearchPaid(e){return void 0!==e&&/googlep|adwords/.test(e)}isParamSocialPaid(e){return(void 0===e||!this.organicSocialRegExp.test(e))&&(void 0!==e&&this.paidSocialRegExp.test(e))}isParamSocialTagged(e){return void 0!==e&&this.socialTagRegExp.test(e)}}class Ds extends Fs{get emailDomainRegExp(){return/([/.])(webmail|live|mail|inbox|zimbra|email|em)\d{0,2}\.|google.android.gm/i}get socialDomainRegExp(){return/([/.])(t\.co|(plus\.google|facebook|twitter|linkedin|youtube|instagram|pinterest|quora|reddit|github|medium|producthunt|yelp|ycombinator|messenger)\.)/i}get paidDomainRegExp(){return/([/.])(taboola|aimtell|attentive|googlesyndication|shareasale|outbrain|shareasale-analytics|doubleclick)\./i}get invalidSearchRegExp(){return/([/.])((plus|mail|myactivity|chrome|classroom|accounts|news|docs|keep|sites)\.google|googlesyndication|google\.android\.(?!googlequicksearchbox))/i}get paidSearchRegExp(){return/([/.])(google|googleadservices)\..*?\/aclk\?/i}get validSearchRegExp(){return/([/.])(google|bing|baidu|duckduckgo|ask|search\.(yahoo|xfinity|aol|naver))\./i}isFromSearchEngine(){return this.optionalUrl.isPresent()&&!this.invalidSearchRegExp.test(this.optionalUrl.get())&&this.validSearchRegExp.test(this.optionalUrl.get())}isFromEmail(){return this.optionalUrl.isPresent()&&this.emailDomainRegExp.test(this.optionalUrl.get())}isFromSocialNetwork(){return this.optionalUrl.isPresent()&&this.socialDomainRegExp.test(this.optionalUrl.get())}isPaidTraffic(){return this.optionalUrl.isPresent()&&this.paidDomainRegExp.test(this.optionalUrl.get())}isSearchPaid(){return this.optionalUrl.isPresent()&&!this.invalidSearchRegExp.test(this.optionalUrl.get())&&this.paidSearchRegExp.test(this.optionalUrl.get())}}var Ms=(e=>(e[e.LN=0]="LN",e[e.EA=1]="EA",e[e.DT=2]="DT",e[e.EE=3]="EE",e[e.NT=4]="NT",e))(Ms||{}),Ns=(e=>(e[e.WD=0]="WD",e[e.WE=1]="WE",e))(Ns||{});class Os{constructor(e,t){__publicField(this,"localWindow"),__publicField(this,"timeZone"),__publicField(this,"origin"),__publicField(this,"hostName"),__publicField(this,"referrerOrigin"),__publicField(this,"date"),__publicField(this,"userAgent"),__publicField(this,"windowWidth"),__publicField(this,"windowHeight"),__publicField(this,"pageviewId"),__publicField(this,"visibilityChangeName"),__publicField(this,"isHidden"),__publicField(this,"navigationHostUrl"),__publicField(this,"navigationReferrerUrl"),this.timeZone=t,this.localWindow=e,this.visibilityChangeName="visibilitychange",this.isHidden=()=>!1,this.reinitialize()}reinitialize(){Ji.debug("Environment.reinitialize()"),"location"in this.localWindow&&(this.navigationHostUrl=new Ps(this.localWindow.location.href),"hostname"in this.localWindow.location&&(this.hostName=this.localWindow.location.hostname),"origin"in this.localWindow.location&&(this.origin=this.localWindow.location.origin)),"document"in this.localWindow&&(this.navigationReferrerUrl=new Ds(this.localWindow.document.referrer),this.navigationReferrerUrl.getUrl().ifPresent((e=>{if("URL"in this.localWindow)try{const{origin:t}=new URL(e);this.referrerOrigin=t}catch(t){const e=es(t);e.message="Could not construct URL to determine referrerOrigin\n"+e.message,Ji.warn(e,135)}else Ji.warn("URL object missing from window; cannot determine referrer origin",27)})).ifAbsent((()=>{Ji.debug("document.referrer missing; cannot determine referrer origin")})),void 0!==this.localWindow.document.hidden?(this.isHidden=()=>this.localWindow.document.hidden,this.visibilityChangeName="visibilitychange"):void 0!==this.localWindow.document.msHidden?(this.isHidden=()=>this.localWindow.document.msHidden,this.visibilityChangeName="msvisibilitychange"):void 0!==this.localWindow.document.webkitHidden&&(this.isHidden=()=>this.localWindow.document.webkitHidden,this.visibilityChangeName="webkitvisibilitychange")),"navigator"in this.localWindow&&"userAgent"in this.localWindow.navigator&&(this.userAgent=this.localWindow.navigator.userAgent),this.windowWidth=this.localWindow.innerWidth,this.windowHeight=this.localWindow.innerHeight,this.date=this.getNowDate(),this.pageviewId=bs()}getHostingPageUrl(){return this.navigationHostUrl}getUrlParameter(e,t){let i=xe.ofNullable(this.navigationHostUrl.getAllUrlParamsUnsafe()[e]);return i.isPresent()&&!t(i.get())&&(Ji.error(`Validator failed for ${e}`,28),i=xe.empty()),i}getAllUrlParamsEncoded(){return this.navigationHostUrl.getAllUrlParamsEncoded()}hasHostingPageUrlChanged(){let e;return"location"in this.localWindow&&"href"in this.localWindow.location&&(e=this.localWindow.location.href),this.navigationHostUrl.getUrl().map((t=>!e||e!==t)).orElse(Boolean(e))}getHostName(){return xe.ofNullable(this.hostName)}getOrigin(){return xe.ofNullable(this.origin)}getReferrerUrl(){return this.navigationReferrerUrl}getReferrerOrigin(){return xe.ofNullable(this.referrerOrigin)}getTimeZone(){return this.timeZone}getDayPart(){const e=this.getInitializeDate().getHours();let t;return t=e>=0&&e<7?0:e>=7&&e<10?1:e>=10&&e<17?2:e>=17&&e<20?3:4,Ms[t]}getWeekPart(){const e=this.getInitializeDate().getDay();return Ns[0===e||6===e?1:0]}getInitializeDate(){return new Date(this.date.getTime())}getInitializeUnixTime(){return Math.round(this.date.getTime()/qt)}getNowDate(){return new Date}getNowUnixTime(){return Math.round(this.getNowUnixTimeMs()/qt)}getNowUnixTimeMs(){return this.getNowDate().getTime()}getUserAgent(){return xe.ofNullable(this.userAgent)}getWidowWidth(){return xe.ofNullable(this.windowWidth)}getWidowHeight(){return xe.ofNullable(this.windowHeight)}getScreenOrientation(){return void 0!==this.windowHeight&&void 0!==this.windowWidth?this.windowWidth>this.windowHeight?xe.of("landscape"):xe.of("portrait"):xe.empty()}getPageviewId(){return this.pageviewId}writeCookie(e){Ji.debug("Environment.writeCookie("+e+")"),this.localWindow.document.cookie=e}readAllCookies(){return xe.ofNullable(this.localWindow.document.cookie)}writeLocalStorage(e,t){this.localWindow.localStorage.setItem(e,t)}readLocalStorage(e){return xe.ofNullable(this.localWindow.localStorage.getItem(e))}writeSessionStorage(e,t){this.localWindow.sessionStorage.setItem(e,t)}removeSessionStorage(e){this.localWindow.sessionStorage.removeItem(e)}readSessionStorage(e){return xe.ofNullable(this.localWindow.sessionStorage.getItem(e))}readLocalStorageMatching(e){const t={};return Object.keys(this.localWindow.localStorage).forEach((i=>{e.test(i)&&(t[i]=this.readLocalStorage(i).get())})),t}deleteLocalStorage(e){this.localWindow.localStorage.removeItem(e)}getWindow(){return this.localWindow}getNowVisibilityState(){return"document"in this.localWindow&&"visibilityState"in this.localWindow.document?xe.ofNullable(this.localWindow.document.visibilityState):xe.empty()}isNowDocumentHidden(){return"document"in this.localWindow?xe.ofNullable(this.isHidden()):xe.empty()}addListener(e,t){this.localWindow.addEventListener(e,t)}addListenerVisibilityChange(e){this.localWindow.document.addEventListener(this.visibilityChangeName,e,{once:!0,capture:!1})}addUnloadHandler(e){this.localWindow.addEventListener("beforeunload",e,!1)}redirect(e){this.localWindow.document.location.replace(e)}generateActionId(){return this.getNowUnixTime()+"-"+Es()}injectScript(e,t=!1){const i=this.localWindow.document.createElement("script");i.async=t,i.src=e;const s=this.localWindow.document.querySelectorAll("script")[0];s.parentNode.insertBefore(i,s)}}class Rs{constructor(e,t,i,s){__publicField(this,"iEvent"),__publicField(this,"actionId"),__publicField(this,"eventInstanceId"),__publicField(this,"eventValue"),__publicField(this,"nativeClickEvent"),this.iEvent=e,this.actionId=t,this.eventInstanceId=`${e.getId()}:${t}`,this.eventValue=i,this.nativeClickEvent=s}getEvent(){return this.iEvent}getEventId(){return this.iEvent.getId()}getActionId(){return this.actionId}getEventInstanceId(){return this.eventInstanceId}getEventValue(){return xe.ofNullable(this.eventValue)}getNativeMouseEvent(){return xe.ofNullable(this.nativeClickEvent)}toString(){return`ConversionEventContext(${this.getEventId()}, ${this.getEventInstanceId()})`}}class Us{constructor(e){__publicField(this,"timestamp"),this.timestamp=e.getNowUnixTime()}get id(){return"missing-policy"}getId(){return this.id}getTimestamp(){return this.timestamp}toJson(){return Si({id:this.id,timestamp:this.timestamp})}}class Vs{static sendPageview(e,t,i,s,n,r,a,o,c){return __async(this,null,(function*(){Ji.debug("BrowserEventLogger.sendPageview()");const l=Vs.buildPageviewEvent(e,t,i,s,n,r,a,o);return Vs.send(Vs.PATH+Vs.toQueryString(l),!0,c)}))}static sendContext(e,t,i,s,n){return __async(this,null,(function*(){Ji.debug("BrowserEventLogger.sendContext()");const r=Vs.buildContextEvent(e,t,i,s);return Vs.send(Vs.PATH,!0,n,{method:"POST",body:JSON.stringify(r)})}))}static sendConversion(e,t,i,s,n,r,a,o,c,l){return __async(this,null,(function*(){Ji.debug("BrowserEventLogger.sendConversion()");const d=Vs.buildConversionEvent(t,i,s,n,r,a,o,c,e);return Vs.send(Vs.PATH+Vs.toQueryString(d),!0,l)}))}static sendView(e,t,i,s,n,r,a,o,c,l){return __async(this,null,(function*(){Ji.debug("BrowserEventLogger.sendView()");const d=Vs.buildViewEvent(e,t,i,s,n,r,a,o,c);return Vs.send(Vs.PATH+Vs.toQueryString(d),!0,l)}))}static sendGoal(e,t,i,s,n,r,a,o,c,l,d,u){return __async(this,null,(function*(){Ji.debug("BrowserEventLogger.sendGoal()");const h=Vs.buildGoalEvent(e,t,i,s,n,r,a,o,c,l);return Vs.send(Vs.PATH+Vs.toQueryString(h),d,u)}))}static get PATH(){return"/logger"}static buildPageviewEvent(e,t,i,s,n,r,a,o){Ji.debug("BrowserEventLogger.buildPageviewEvent()");const c={eventType:"pv"};return Vs.buildCommonEvent(c,t,e,i,n,r,a,s),c.pageviewId=e.getPageviewId(),c.sessionId=s.updateAndGetSessionId(),c.policyId=o.getId(),c.policyTimestamp=o.getTimestamp(),s.getCustomerControlStatus(t).ifPresent((e=>{c.controlStatus=e})),c}static buildContextEvent(e,t,i,s){Ji.debug("BrowserEventLogger.buildContextEvent()");const n={eventType:"ctx",pageviewId:e.getPageviewId(),customerId:t.getId(),userId:i.getId()};return s.getAllData().ifPresent((e=>{n.integrationData=e})),n}static buildConversionEvent(e,t,i,s,n,r,a,o,c){Ji.debug("BrowserEventLogger.buildConversionEvent()");const l={eventType:"c"};return Vs.buildCommonEvent(l,t,e,i,n,r,a,s),this.populateConversionInfo(l,c),l.pageviewId=e.getPageviewId(),l.sessionId=s.updateAndGetSessionId(),l.policyId=o.getId(),l.policyTimestamp=o.getTimestamp(),s.getCustomerControlStatus(t).ifPresent((e=>{l.controlStatus=e})),l}static buildViewEvent(e,t,i,s,n,r,a,o,c){Ji.debug("BrowserEventLogger.buildViewEvent()");const l={eventType:"v"};Vs.buildBaseEvent(l,e,t,s,r,a,o,n);const d=e.getExperience(),u=d.getCampaign(),h=u.getCustomer();return i.isStickyVariation(e)?n.getVariationPredictionModelVersion(e).ifPresent((e=>{l.modelVersion=e})):l.modelVersion=i.getModelVersion(d.getId()),l.isPrediction=!i.isStickyVariation(e)&&e.getId()!==zt,l.isVariationSticky=i.isStickyVariation(e),l.isCampaignFirstTime=n.updateAndGetIsCampaignFirstTimeView(u,t.getInitializeUnixTime()),l.isVariationFirstTime=n.updateAndGetIsVariationFirstTimeView(e,t.getInitializeUnixTime()),l.pageviewId=t.getPageviewId(),l.sessionId=n.updateAndGetSessionId(),l.policyId=c.getId(),l.policyTimestamp=c.getTimestamp(),n.getCustomerControlStatus(h).ifPresent((e=>{l.controlStatus=e})),l}static buildGoalEvent(e,t,i,s,n,r,a,o,c,l){Ji.debug("BrowserEventLogger.buildGoalEvent()");const d={eventType:"ocg"};Vs.buildBaseEvent(d,e,t,s,r,a,o,n);const u=e.getExperience().getCampaign();return d.isCampaignFirstTime=n.updateAndGetIsCampaignFirstTimeGoal(u,i,t.getInitializeUnixTime()),d.isVariationFirstTime=n.updateAndGetIsVariationFirstTimeGoal(e,i,t.getInitializeUnixTime()),n.getVariationPredictionModelVersion(e).ifPresent((e=>{d.modelVersion=e})),d.metricId=i.getId(),d.isGoal=i.isGoal(),d.goalPageviewId=t.getPageviewId(),d.goalSessionId=n.updateAndGetSessionId(),this.populateConversionInfo(d,l),n.getVariationPredictionPageviewId(e).ifPresent((e=>{d.pageviewId=e})),n.getVariationPredictionSessionId(e).ifPresent((e=>{d.sessionId=e})),d.policyId=c.getId(),d.policyTimestamp=c.getTimestamp(),n.getCustomerControlStatus(u.getCustomer()).ifPresent((e=>{d.controlStatus=e})),d}static populateConversionInfo(e,t){e.actionId=t.getActionId(),t.getNativeMouseEvent().ifPresent((i=>{const s=M(i.target);s?e.clickTargetSelector=s:(e.clickTargetSelector="unknown",Ji.error(`Could not generate selector: ${_i(i.target)}`,136,{eventId:t.getEventId()})),Vs.getAnchorHref(i).ifPresent((t=>{e.clickTargetUrl=t}))})),e.eventId=t.getEventId(),e.eventInstanceId=t.getEventInstanceId(),t.getEventValue().ifPresent((t=>{e.eventValue=t}))}static getAnchorHref(e){var t,i;let s,n=e.target;for(;void 0!==n;){if(n instanceof HTMLAnchorElement){s=null!=(t=n.getAttribute("href"))?t:void 0;break}n=null!=(i=n.parentNode)?i:void 0}return xe.ofNullable(s)}static buildCommonEvent(e,t,i,s,n,r,a,o){e.userId=s.getId(),e.isFirstTimeUser=s.isNewVisitor(),e.userVisitStatus=o.getUserVisitStatus(s),e.userBucket=s.getUserBucket(),e.intellimizeClientIp=a.clientIp,e.customerId=t.getId(),i.getNowVisibilityState().ifPresent((t=>{e.visibilityState=t})),e.clientVersion=Qt,e.requestId=a.requestId,i.getReferrerUrl().getUrl().ifPresent((t=>{e.referrerUrl=t})),i.getHostingPageUrl().getUrl().ifPresent((t=>{e.hostingPageUrl=t})),e.intellimizeUserAgentDigest=a.userAgentDigest,e.time=i.getNowUnixTimeMs(),e.timeZone=i.getTimeZone(),i.getWidowWidth().ifPresent((t=>{e.windowWidth=t})),i.getWidowHeight().ifPresent((t=>{e.windowHeight=t})),i.getScreenOrientation().ifPresent((t=>{e.screenOrientation=t}));const c=n.getFlattenedInternalAttributes();Object.keys(c).length>0&&(e.internalAttributes=c);const l=n.getFlattenedCustomAttributes();Object.keys(l).length>0&&(e.customAttributes=l);const d=r.getPages().map((e=>e.getId()));d.length>0&&(e.pageIds=d);const u=r.getAudiences().map((e=>e.getId()));u.length>0&&(e.audienceIds=u)}static buildBaseEvent(e,t,i,s,n,r,a,o){const c=t.getExperience(),l=c.getCampaign(),d=l.getCustomer();Vs.buildCommonEvent(e,d,i,s,n,r,a,o),e.campaignId=l.getId(),e.experienceId=c.getId(),e.variationId=t.getId()}static toQueryString(e){const t=[];return Bi(t,"et",e.eventType),Bi(t,"o.cgd",e.campaignId),Bi(t,"o.eid",e.experienceId),Bi(t,"o.vid",e.variationId),ji(t,"icft",e.isCampaignFirstTime),ji(t,"ivft",e.isVariationFirstTime),Bi(t,"mv",e.modelVersion),ji(t,"isp",e.isPrediction),ji(t,"iss",e.isVariationSticky),Bi(t,"gid",e.metricId),ji(t,"ig",e.isGoal),Bi(t,"gpvid",e.goalPageviewId),Bi(t,"gsid",e.goalSessionId),Bi(t,"ai",e.actionId),Bi(t,"cts",e.clickTargetSelector),Bi(t,"cturl",e.clickTargetUrl),Bi(t,"ei",e.eventId),Bi(t,"eii",e.eventInstanceId),void 0!==e.eventValue&&("string"==typeof e.eventValue?Bi(t,"ev",e.eventValue):"number"==typeof e.eventValue&&Hi(t,"ev",e.eventValue)),Bi(t,"ieuid",e.userId),ji(t,"isftu",e.isFirstTimeUser),Bi(t,"uvs",e.userVisitStatus),Hi(t,"ub",e.userBucket),Bi(t,"icip",e.intellimizeClientIp),Bi(t,"o.pid",e.customerId),Bi(t,"vs",e.visibilityState),Bi(t,"cgv",e.clientVersion),Bi(t,"rid",e.requestId),Bi(t,"pvid",e.pageviewId),Bi(t,"sid",e.sessionId),Bi(t,"pid",e.policyId),Hi(t,"pts",e.policyTimestamp),Bi(t,"cs",e.controlStatus),Bi(t,"rurl",e.referrerUrl),Bi(t,"hpurl",e.hostingPageUrl),Bi(t,"iuad",e.intellimizeUserAgentDigest),Hi(t,"lut",e.time),Bi(t,"ltz",e.timeZone),Hi(t,"bww",e.windowWidth),Hi(t,"bwh",e.windowHeight),Bi(t,"so",e.screenOrientation),Ki(t,"ca",e.customAttributes),Ki(t,"ia",e.internalAttributes),Ki(t,"pids",e.pageIds),Ki(t,"aids",e.audienceIds),"?"+t.join("&")}static send(e,t,i,s){return __async(this,null,(function*(){const n=Date.now();Ji.debug(`BrowserEventLogger.send(async: ${t}) ${n}`),i.sendBrowserEvents().orElse(!0)?(t?yield zi(ni,e,s):yield Wi(ni,e),Ji.debug("BrowserEvent delivery success")):Ji.debug("BrowserEvent delivery skipped")}))}}class Ls extends rs{constructor(e,t,i,s,n,r,a,o,c){super(),__publicField(this,"conversionEventContext"),__publicField(this,"environment"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"policy"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"trackBrowserEvents",{}),__publicField(this,"hasSentGoals",!1),this.conversionEventContext=e,this.environment=t,this.customerStorage=i,this.attributeStorage=s,this.pageContext=n,this.serverContext=r,this.policy=a,this.user=o,this.override=c}toString(){return"GoalTask("+this.conversionEventContext.toString()+")"}getEntityIds(){return{eventId:this.conversionEventContext.getEventId()}}inTransaction(){return!0}isUnloading(){return!1}run(){this.hasSentGoals||this.sendGoalsOnce();if(Object.keys(this.trackBrowserEvents).map((e=>this.trackBrowserEvents[e])).some((e=>void 0===e||!rs.isDone(e))))return Ji.debug("Waiting for goal event delivery confirmation"),is.TRY_LATER;return Object.keys(this.trackBrowserEvents).map((e=>this.trackBrowserEvents[e])).every((e=>void 0!==e&&e===is.SUCCEEDED))?is.SUCCEEDED:is.FAILED}sendGoalsOnce(){Ji.debug("sendGoalsOnce()"),this.hasSentGoals=!0;const e="click"!==this.conversionEventContext.getEvent().getType();let t=0;this.conversionEventContext.getEvent().getMetrics().forEach((i=>{i.getCampaign().ifPresent((s=>{s.getExperiences().forEach((s=>{this.customerStorage.getVariation(s).ifPresent((n=>{const r=i.getId()+":"+n.getId();this.trackBrowserEvents[r]=is.TRY_LATER,Ji.info(`Sending goal ${i.getId()} event`),t++,Vs.sendGoal(n,this.environment,i,this.user,this.customerStorage,this.attributeStorage,this.pageContext,this.serverContext,this.policy,this.conversionEventContext,e,this.override).then((()=>{Ji.info(`Goal ${i.getId()} event delivery success`),this.trackBrowserEvents[r]=is.SUCCEEDED})).catch((e=>{const t=es(e);Ji.error(`Goal ${i.getId()} event delivery failed: ${t.message}`,78,{eventId:this.conversionEventContext.getEventId(),experienceId:s.getId(),variationId:n.getId()}),this.trackBrowserEvents[r]=is.FAILED}))}))}))}))})),Ji.debug(`Sent ${t} goal events`)}}class $s extends rs{constructor(e,t,i,s,n,r,a,o,c,l,d){super(),__publicField(this,"conversionEventContext"),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"policy"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"statusModel"),__publicField(this,"conversionSent",!1),__publicField(this,"conversionStatus",is.NOT_STARTED),__publicField(this,"goalTask"),this.conversionEventContext=e,this.environment=t,this.customer=i,this.customerStorage=s,this.attributeStorage=n,this.pageContext=r,this.serverContext=a,this.policy=o,this.user=c,this.override=l,this.statusModel=d}toString(){return`ConversionEventTask(${this.conversionEventContext.toString()})`}getEntityIds(){return{eventId:this.conversionEventContext.getEventId()}}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.scheduleGoalTaskOnce(),rs.isDone(this.conversionStatus)?!this.customer.hasClassicAccess()||void 0!==this.goalTask&&rs.isDone(this.goalTask.getStatus())?this.conversionStatus===is.SUCCEEDED?is.SUCCEEDED:is.FAILED:(Ji.debug("Waiting for goal task event confirmation"),is.TRY_LATER):(Ji.debug("Waiting for conversion event delivery confirmation"),is.TRY_LATER)}sendOnce(){if(!this.conversionSent){Ji.info(`Sending conversion event ${this.conversionEventContext.toString()}`);const e=this.conversionEventContext.getEvent(),t=e.getMetrics().map((t=>{const i=Es();return this.statusModel.setMetricEventData(t,e,i,is.WAITING),{metric:t,modelEventId:i}}));Vs.sendConversion(this.conversionEventContext,this.environment,this.customer,this.user,this.customerStorage,this.attributeStorage,this.pageContext,this.serverContext,this.policy,this.override).then((()=>{Ji.info(`Conversion event ${this.conversionEventContext.toString()} delivery success`),this.conversionStatus=is.SUCCEEDED,t.forEach((({metric:t,modelEventId:i})=>{this.statusModel.setMetricEventData(t,e,i,is.SUCCEEDED)}))})).catch((i=>{const s=es(i);Ji.warn(`Conversion event ${this.conversionEventContext.toString()} delivery failed: ${s.message}`,76,{eventId:this.conversionEventContext.getEventId()}),this.conversionStatus=is.FAILED,t.forEach((({metric:t,modelEventId:i})=>{this.statusModel.setMetricEventData(t,e,i,is.FAILED)}))})),this.conversionSent=!0}}scheduleGoalTaskOnce(){this.customer.hasClassicAccess()&&void 0===this.goalTask&&(this.goalTask=new Ls(this.conversionEventContext,this.environment,this.customerStorage,this.attributeStorage,this.pageContext,this.serverContext,this.policy,this.user,this.override),this.manager.addTask(this.goalTask))}}function zs(e){if("string"==typeof e){const t=e.search(/[.\-\d]/g);if(-1===t)return!1;const i=e.slice(Math.max(0,t));if(!/^-?\d*\.?\d{0,2}$/.test(i))return!1}else{if("number"!=typeof e)return!1;{const t=String(e);if(!/^-?\d*\.?\d{0,2}$/.test(t))return!1}}return!0}function Ws(e){return"string"==typeof e&&/^[\u0021-\u007E]{1,300}$/.test(e)}function Gs(e){return ls(e)&&("number"==typeof e.amount||"string"==typeof e.amount)&&"string"==typeof e.currencyCode}function Bs(e){return e.getIntegrationShopify().map((e=>e.isPixelEnabled())).orElse(!1)}function js(e,t,i,s,n,r,a,o,c,l,d,u,h){Ks(e).ifPresent((({eventActionId:g,eventValue:p})=>{t.getShopifyEvent(e.name).ifPresent((m=>{const v=new Rs(m,g,p,void 0);try{r.add(an.buildShopifyActivity(e,v,t,i,l,n,s))}catch(f){const e=es(f);e.message="Failed to build Shopify Activity\n"+e.message,Ji.error(e,234)}const b=new $s(v,i,t,s,n,a,o,c,l,d,u);h.addTask(b)})).ifAbsent((()=>{Ji.debug(`Shopify event not configured for customer: "${e.name}"`)}))}))}function Hs(e,t){let i;switch(e.name){case"collection_viewed":{const s=e;i=__spreadProps(__spreadValues({},t),{eventType:"s",customerEventName:"collection_viewed",data:Xs(s.data.collection)});break}case"product_viewed":{const s=e;i=__spreadProps(__spreadValues({},t),{eventType:"s",customerEventName:"product_viewed",data:Js(s.data.productVariant)});break}case"checkout_started":{const s=e;i=__spreadProps(__spreadValues({},t),{eventType:"s",customerEventName:"checkout_started",data:Zs(s.data.checkout)});break}case"checkout_completed":{const s=e;i=__spreadProps(__spreadValues({},t),{eventType:"s",customerEventName:"checkout_completed",data:Zs(s.data.checkout)});break}case"product_added_to_cart":{const s=e;i=__spreadProps(__spreadValues({},t),{eventType:"s",customerEventName:"product_added_to_cart",data:en(s.data.cartLine)});break}case"search_submitted":{const s=e;i=__spreadProps(__spreadValues({},t),{eventType:"s",customerEventName:"search_submitted",data:tn(s.data.searchResult)});break}default:throw new Error(`Unsupported customer event: ${e.name}`)}return Ji.debug(`Shopify activity (${e.name}): ${JSON.stringify(i.data)}`),i}function Ks(e){let t;if(!ls(e))return Ys("Not an object"),xe.empty();if(!T(e.name))return Ys(`Event name is not a valid event name: "${e.name}"`),xe.empty();if(!Qs(e.name))return xe.empty();if(!Ws(e.id))return Ys(`Event ID is not a valid action id: "${e.id}"`),xe.empty();if(!A(e.data)){if(!ls(e.data))return Ys(`Event data is defined, and is not an object: "${JSON.stringify(e.data)}"`),xe.empty();qs(e.name,e.data).ifPresent((e=>{t=e}))}return xe.of({eventActionId:e.id,eventValue:t})}function Qs(e){return Wt.includes(e)}function qs(e,t){let i;switch(e){case"checkout_started":case"checkout_completed":if(!ls(t.checkout))return Ys("Checkout data is not an object"),xe.empty();if(!Gs(t.checkout.subtotalPrice))return Ys(`Checkout data exists, but subtotal price is not valid: "${JSON.stringify(t.checkout.subtotalPrice)}"`),xe.empty();i=[t.checkout.subtotalPrice.amount,"checkout.subtotalPrice.amount"];break;case"product_added_to_cart":if(!ls(t.cartLine))return Ys("CartLine data is not an object"),xe.empty();if(!ls(t.cartLine.merchandise))return Ys("CartLine data exists, but does not include a product variant"),xe.empty();if(!Gs(t.cartLine.merchandise.price))return Ys(`CartLine ProductVariant data exists, but price is not valid: "${JSON.stringify(t.cartLine.merchandise.price)}"`),xe.empty();i=[t.cartLine.merchandise.price.amount,"cartLine.merchandise.price.amount"];break;case"product_viewed":if(!ls(t.productVariant))return Ys("ProductVariant data is not an object"),xe.empty();if(!Gs(t.productVariant.price))return Ys(`ProductVariant data exists, but price is not valid: "${JSON.stringify(t.productVariant.price)}"`),xe.empty();i=[t.productVariant.price.amount,"productVariant.price.amount"];break;default:return xe.empty()}const[s,n]=i;let r=s;return/^-?\d*\.?\d{3,}$/.test(String(s))&&(Ji.warn(`Found currency with > 2 decimal places: "${n}" = "${s}"`,235),r=Math.round(100*(Number(r)+Number.EPSILON))/100),zs(r)?xe.of(Number(r)):(Ys(`Event value is not valid: "${s}"`),xe.empty())}function Ys(e){Ji.error(`Invalid Shopify Pixel Event: ${e}`,233)}function Js(e){var t,i;return{productVariantPrice:e.price.amount,productVariantPriceCode:e.price.currencyCode,productVariantSku:null!=(t=e.sku)?t:void 0,productVariantId:e.id,productVariantTitle:e.title,productId:e.product.id,productTitle:e.product.title,productType:null!=(i=e.product.type)?i:void 0}}function Xs(e){return{collectionId:e.id}}function Zs(e){const t=[],i=[];return e.lineItems.forEach((({variant:e})=>{null!==e&&(t.push(e.id),i.push(e.product.id))})),{checkoutSubtotal:e.subtotalPrice.amount,checkoutSubtotalCode:e.subtotalPrice.currencyCode,productVariantIds:t,productIds:i}}function en(e){return __spreadValues({cartTotal:e.cost.totalAmount.amount,cartTotalCode:e.cost.totalAmount.currencyCode},Js(e.merchandise))}function tn(e){return{searchQuery:e.query}}function sn(){return{"data.productVariantPrice":"spvp","data.productVariantPriceCode":"spvpc","data.productVariantSku":"spvsku","data.productVariantId":"spvid","data.productVariantTitle":"spvt","data.productId":"spid","data.productTitle":"spt","data.productType":"spty","data.collectionId":"scid","data.checkoutSubtotal":"scost","data.checkoutSubtotalCode":"scostc","data.productVariantIds":"spvids","data.productIds":"spids","data.cartTotal":"scat","data.cartTotalCode":"scatc","data.searchQuery":"ssq"}}class nn{constructor(e){if(__publicField(this,"environment"),!nn.isEnabled(e))throw new Error("LocalStorage is not available");this.environment=e}static isEnabled(e){let t=!1;try{const i=e.getWindow();if("localStorage"in i){const e="_test_",s="_test_val_";i.localStorage.setItem(e,s);const n=i.localStorage.getItem(e);i.localStorage.removeItem(e),null!==n&&n===s&&(t=!0)}}catch(i){}return t}static getStorageKeys(e){return nn.getStorageKeyPrefixes().map((t=>`${t}${e.getId()}`))}static isQuotaExceededError(e){return e instanceof DOMException&&("QuotaExceededError"===e.name||"QUOTA_EXCEEDED_ERROR"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)}static getStorageKeyPrefixes(){return[ci,ai,li,ri,oi,hi,di,gi,ui]}write(e,t){nn.getStorageKeyPrefixes().some((t=>e.startsWith(t)))||Ji.error(`Writing an unknown key to LocalStorage: ${e}`,180),this.environment.writeLocalStorage(e,t)}read(e){return this.environment.readLocalStorage(e)}delete(e){this.environment.deleteLocalStorage(e)}}const rn=class{constructor(e,t,i){__publicField(this,"storageKey"),__publicField(this,"browserStorage"),__publicField(this,"environment"),this.storageKey=ui+e.getId(),this.browserStorage=t,this.environment=i}static buildPageviewActivity(e,t,i,s,n){return __spreadValues({eventType:"pv"},rn.setCommonActivityFields(e,t,i,s,n))}static buildViewActivity(e,t,i,s,n){const r=e.getExperience(),a=r.getCampaign(),o=a.getCustomer();return __spreadValues({eventType:"v",campaignId:a.getId(),experienceId:r.getId(),variationId:e.getId()},rn.setCommonActivityFields(o,t,i,s,n))}static buildConversionActivity(e,t,i,s,n,r){const a=__spreadValues({eventType:"c",actionId:e.getActionId(),eventId:e.getEventId(),eventInstanceId:e.getEventInstanceId()},rn.setCommonActivityFields(t,i,s,n,r));return e.getEventValue().ifPresent((e=>{a.eventValue=rn.transformEventValue(e)})),a}static buildShopifyActivity(e,t,i,s,n,r,a){return Hs(e,rn.buildConversionActivity(t,i,s,n,r,a))}static setCommonActivityFields(e,t,i,s,n){const r={userVisitStatus:n.getUserVisitStatus(i),userBucket:i.getUserBucket(),pageviewId:t.getPageviewId(),sessionId:n.updateAndGetSessionId(),time:t.getNowUnixTimeMs(),timeZone:t.getTimeZone()};n.getCustomerControlStatus(e).ifPresent((e=>{r.controlStatus=e})),t.getReferrerUrl().getUrl().ifPresent((e=>{r.referrerUrl=e})),t.getHostingPageUrl().getUrl().ifPresent((e=>{r.hostingPageUrl=e}));const a=s.getFlattenedInternalAttributes();Object.keys(a).length>0&&(r.trafficSource=a.ts,r.utmTerm=a.utt,r.utmMedium=a.utm,r.utmSource=a.uts,r.utmContent=a.utcn,r.utmCampaign=a.utcm);const o=s.getFlattenedCustomAttributes();return Object.keys(o).length>0&&(r.customAttributes=o),r}static transformEventValue(e){if("string"==typeof e)return Number.parseFloat(e)}add(e){const t=this.compressActivity(e),i=this.getAllCompressed();i.push(t),this.save(i)}getAll(){return this.getAllCompressed().map((e=>this.decompressActivity(e)))}backoffAndSave(e){e.shift(),this.save(e)}save(e){const t=Si(e);if(t.length>rn.CHARACTER_LIMIT&&e.length>0)this.backoffAndSave(e);else try{this.browserStorage.write(this.storageKey,t)}catch(i){if(!(nn.isQuotaExceededError(i)&&e.length>0))throw i;Ji.warn("localStorage quota exceeded. Removing old activity",220),this.backoffAndSave(e)}}getAllCompressed(){let e=[];try{e=this.browserStorage.read(this.storageKey).map((e=>{const t=yi(e);if(!Array.isArray(t))throw new TypeError("Expected an array");return t})).orElse([])}catch(i){e=[];const t=es(i);t.message="Could not read Activities from localStorage\n"+t.message,Ji.error(t,221)}const t=this.environment.getNowUnixTimeMs()-rn.TIME_LIMIT_MS;return e.filter((e=>e.t>=t))}compressActivity(e){const t={};for(const[i,s]of Object.entries(e))if("data"===i&&I(s))for(const[e,n]of Object.entries(s)){const i=`data.${e}`;void 0===rn.KEY_MAP[i]?(Ji.error(`Unknown key ${i} in Activity`,222),t[i]=n):t[rn.KEY_MAP[i]]=n}else void 0===rn.KEY_MAP[i]?(Ji.error(`Unknown key ${i} in Activity`,222),t[i]=s):t[rn.KEY_MAP[i]]=s;return t}decompressActivity(e){const t={};for(const[i,s]of Object.entries(e))if(void 0===rn.REVERSE_KEY_MAP[i])Ji.error(`Unknown key ${i} in CompressedActivity`,223),t[i]=s;else if(rn.REVERSE_KEY_MAP[i].startsWith("data.")){const e=rn.REVERSE_KEY_MAP[i].split(".");2===e.length&&(void 0===t.data&&(t.data={}),t.data[e[1]]=s)}else t[rn.REVERSE_KEY_MAP[i]]=s;return t}};let an=rn;__publicField(an,"TIME_LIMIT_MS",15552e6),__publicField(an,"CHARACTER_LIMIT",1048576),__publicField(an,"KEY_MAP",__spreadValues({eventType:"et",customerEventName:"en",campaignId:"cmid",experienceId:"eid",variationId:"vid",actionId:"acid",eventId:"evid",eventInstanceId:"eii",eventValue:"ev",userVisitStatus:"uvs",userBucket:"ub",pageviewId:"pvid",sessionId:"sid",controlStatus:"cs",referrerUrl:"rurl",hostingPageUrl:"hpurl",time:"t",timeZone:"tz",trafficSource:"ts",utmTerm:"utt",utmMedium:"utm",utmSource:"uts",utmContent:"utcn",utmCampaign:"utcm",customAttributes:"ca"},sn())),__publicField(an,"REVERSE_KEY_MAP",ps(rn.KEY_MAP));class on extends rs{constructor(e){super(),__publicField(this,"callbacks",[]),this.callbacks=e}toString(){return"ActivateTask()"}inTransaction(){return!1}isUnloading(){return!0}addCallback(e){this.callbacks.push(e)}run(){return this.manager.getClient().reRun(this.callbacks),is.SUCCEEDED}}class cn extends rs{constructor(e,t){super(),__publicField(this,"environment"),__publicField(this,"callbacks",[]),__publicField(this,"startTimeMs"),this.environment=e,this.callbacks=t,this.resetExpiration()}toString(){return"RequestActivateTask()"}inTransaction(){return!1}isUnloading(){return!1}resetExpiration(){Ji.debug("RequestActivateTask.resetExpiration()"),this.startTimeMs=this.environment.getNowUnixTimeMs()}addCallback(e){this.callbacks.push(e)}run(){if(!this.environment.hasHostingPageUrlChanged())return Ji.debug("URL has not changed yet"),this.hasExceededTimeBudget()?(Ji.info(`activate() timeout due to URL not changing after ${ei}ms`),is.SUCCEEDED):is.TRY_LATER;if(0===this.manager.findTasks((e=>e instanceof on&&!e.isDone())).length){const e=new on(this.callbacks);this.manager.addTask(e)}else Ji.debug("Not scheduling new ActivateTask since one is already running");return is.SUCCEEDED}hasExceededTimeBudget(){const e=this.environment.getNowUnixTimeMs(),t=e-this.startTimeMs,i=t>ei;return Ji.debug("hasExceededTimeBudget: "+e+" - "+this.startTimeMs+" ("+t+") > "+ei+"? => "+i),i}}class ln extends rs{constructor(e,t,i,s,n,r,a,o,c,l,d,u,h,g,p,m){super(),__publicField(this,"variation"),__publicField(this,"environment"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"policy"),__publicField(this,"user"),__publicField(this,"decisionContext"),__publicField(this,"startPageviewId"),__publicField(this,"override"),__publicField(this,"changeAppliers"),__publicField(this,"statusModel"),__publicField(this,"getVariationRecordedCallbackTuples"),__publicField(this,"hider"),this.environment=e,this.customerStorage=t,this.attributeStorage=i,this.activityStorage=s,this.pageContext=n,this.serverContext=r,this.decisionContext=a,this.policy=o,this.user=c,this.override=l,this.changeAppliers=d,this.statusModel=u,this.startPageviewId=h,this.hider=g,this.variation=p,this.getVariationRecordedCallbackTuples=m}toString(){return`ExecuteVariationTask(${this.variation.getId()})`}getEntityIds(){return{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}}inTransaction(){return this.isReadyToExecute()}isUnloading(){return!1}run(){let e=is.TRY_LATER;return this.isReadyToExecute()&&(e=this.executeVariation()),e}injectVariationCss(e){if(e.getCss().isPresent()){const i=e.getCss().get();try{Ji.info(`Variation ${e.getExperience().getId()}/${e.getId()} injecting css`),ts.injectCss(i,`variation-${e.getId()}`,this.environment.getWindow().document)}catch(t){const i=es(t);return i.message=`Variation (${e.getId()}) css injection failed\n${i.message}`,Ji.error(i,91,{variationId:e.getId(),experienceId:e.getExperience().getId()}),!1}}return!0}onReadyToRender(){this.hider.revealExperience(this.variation.getExperience())}isReadyToExecute(){const e=this.passDependencies(),t=this.passExperiencePreconditions(),i=this.passVariationPreconditions();return e&&t&&i}passDependencies(){const e=this.variation.getExperience();Ji.group("check experience dependsOnExperiences "+e.getId());const t=e.getDependsOnExperiences().every((e=>!this.decisionContext.isDecidingExperience(e)));return Ji.debug(t.toString()),Ji.groupEnd(),this.statusModel.setExperience(e,"dependsOnExperiences",t),t}passExperiencePreconditions(){const e=this.variation.getExperience();Ji.group("check experience preconditions "+e.getId());const t=e.getPreconditions().every((t=>{let i=!1;try{i=ts.evalBoolean(t),Ji.info(`Experience ${e.getId()} precondition => ${i}`)}catch(s){const t=es(s);i=!1,t.message=`Experience (${e.getId()}) precondition code execution failed\n${t.message}`,Ji.error(t,15,{experienceId:e.getId()})}return i}));return Ji.debug(t.toString()),Ji.groupEnd(),this.statusModel.setExperience(e,"preconditions",t),t}passVariationPreconditions(){const e=this.variation.getExperience();Ji.group("check variations preconditions "+this.variation.getId());const t=this.variation.getPreconditions().every((t=>{let i=!1;try{i=ts.evalBoolean(t),Ji.info(`Variation ${e.getId()}/${this.variation.getId()} precondition => ${i}`)}catch(s){const t=es(s);i=!1,t.message=`Variation (${this.variation.getId()}) precondition code execution failed\n${t.message}`,Ji.error(t,16,{experienceId:e.getId(),variationId:this.variation.getId()})}return i}));return Ji.debug(t.toString()),Ji.groupEnd(),this.statusModel.setVariation(this.variation,"preconditions",t),t}}class dn extends rs{constructor(e,t,i,s,n){super(),__publicField(this,"environment"),__publicField(this,"guaIntegration"),__publicField(this,"ga4Integration"),__publicField(this,"variation"),__publicField(this,"override"),__publicField(this,"states",{uaState:"notStarted",ga4State:"notStarted"}),__publicField(this,"uATrackingIdQueue",[]),__publicField(this,"ga4MeasurementIdQueue",[]),__publicField(this,"taskStartTime"),this.environment=e,this.guaIntegration=t,this.ga4Integration=i,this.variation=s,this.override=n,_e(!t.isPresent()||t.get().isEnabled()),_e(!i.isPresent()||i.get().isEnabled())}static get UA_TRACKING_ID_REGEX(){return/^UA-\d+(-\d+)?$/}static get GA4_MEASUREMENT_ID_REGEX(){return/^G-[\dA-Z]+$/}static get GA4_EVENT_NAME(){return"variation_viewed"}static get WAIT_FOR_GA_TIMEOUT_MS(){return 3e3}static get WAIT_FOR_PROPERTY_IDS_MS(){return 3e3}static isSent(e){return"sent"===e||dn.isCompleted(e)}static isCompleted(e){return dn.isSuccessful(e)||"failed"===e}static isSuccessful(e){return"delivered"===e||"skipped"===e}toString(){return"GoogleAnalyticsTask("+this.variation.getId()+")"}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.isAllCompleted()?this.isAllSuccessful()?is.SUCCEEDED:is.FAILED:(Ji.debug("Waiting for GA delivery confirmation"),is.TRY_LATER)}isAllSent(){return dn.isSent(this.states.uaState)&&dn.isSent(this.states.ga4State)}isAllCompleted(){return dn.isCompleted(this.states.uaState)&&dn.isCompleted(this.states.ga4State)}isAllSuccessful(){return dn.isSuccessful(this.states.uaState)&&dn.isSuccessful(this.states.ga4State)}setState(e,t){this.states[e]!==t&&(Ji.debug(`Transitioning ${e} from ${this.states[e]} to ${t}`),this.states[e]=this.isValidStateTransition(this.states[e],t)?t:"failed")}isValidStateTransition(e,t){switch(e){case"notStarted":if("polling"===t||"skipped"===t)return!0;break;case"polling":if("sent"===t||"failed"===t)return!0;break;case"sent":if("delivered"===t)return!0}return this.sendError(`Invalid state transition. Cannot transition from "${e}" to "${t}".`,189),!1}sendOnce(){if(!this.isAllSent()){void 0===this.taskStartTime&&(this.taskStartTime=this.environment.getNowDate(),Ji.debug(`GoogleAnalyticsTask start time: ${this.taskStartTime.getTime()}`));const e=this.environment.getNowDate().getTime()-this.taskStartTime.getTime();if(this.override.sendGoogleAnalytics().orElse(!0)){this.guaIntegration.ifPresent((()=>{Ji.debug("GoogleUniversalAnalytics - integration is enabled")})).ifAbsent((()=>{Ji.debug("Google Universal Analytics - integration is not enabled"),this.setState("uaState","skipped")})),this.ga4Integration.ifPresent((()=>{Ji.debug("GoogleAnalytics4 - integration is enabled")})).ifAbsent((()=>{Ji.debug("Google Analytics 4 - integration is not enabled"),this.setState("ga4State","skipped")}));this.waitForDataLayer(e).ifPresent((t=>{this.guaIntegration.ifPresent((i=>{if(i.isAutoConfig()){Ji.debug("GoogleUniversalAnalytics - AutoConfig is enabled");const s=this.waitForTrackingId(e);s.length>0&&this.sendToUaUsingGtagJsOnce(i,t,s)}else Ji.debug("GoogleUniversalAnalytics - AutoConfig is disabled"),this.sendToUaUsingGtagJsOnce(i,t)})),this.ga4Integration.ifPresent((i=>{if(i.isAutoConfig()){Ji.debug("GoogleAnalytics4 - AutoConfig is enabled");const s=this.waitForMeasurementId(e);s.length>0&&this.sendToGa4Once(i,t,s)}else Ji.debug("GoogleAnalytics4 - AutoConfig is disabled"),this.sendToGa4Once(i,t)}))}))}else Ji.debug("Google Analytics - Override behavior has prevented all events from being sent"),this.setState("uaState","skipped"),this.setState("ga4State","skipped")}}sendError(e,t){Ji.error(e,t,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()})}shimGtag(e){return function(){e.push(arguments)}}waitForDataLayer(e){const t=this.environment.getWindow();if(dn.isSent(this.states.uaState)||dn.isCompleted(this.states.uaState)||this.setState("uaState","polling"),dn.isSent(this.states.ga4State)||dn.isCompleted(this.states.ga4State)||this.setState("ga4State","polling"),void 0===t.dataLayer)Ji.debug(`window.dataLayer not defined after ${e} ms`);else{if(os(t.dataLayer))return xe.of(t.dataLayer);Ji.debug("window.dataLayer is not an array")}return e>=dn.WAIT_FOR_GA_TIMEOUT_MS&&(dn.isCompleted(this.states.uaState)||this.setState("uaState","failed"),dn.isCompleted(this.states.ga4State)||this.setState("ga4State","failed"),this.sendError(`window.dataLayer not present within ${dn.WAIT_FOR_GA_TIMEOUT_MS} ms`,185)),xe.empty()}waitForTrackingId(e){const t=this.getPropertyIdsAutomatically();return 0===t.gua.length?(Ji.debug(`Auto-configured Tracking ID not present after ${e} ms`),this.setState("uaState","polling"),e>=dn.WAIT_FOR_PROPERTY_IDS_MS&&(this.setState("uaState","failed"),this.sendError(`GoogleUniversalAnalytics - Auto-configured Tracking ID is not present within ${dn.WAIT_FOR_PROPERTY_IDS_MS} ms`,186)),[]):t.gua}waitForMeasurementId(e){const t=this.getPropertyIdsAutomatically();return 0===t.ga4.length?(Ji.debug(`Auto-configured Measurement ID not present after ${e} ms`),this.setState("ga4State","polling"),e>=dn.WAIT_FOR_PROPERTY_IDS_MS&&(this.setState("ga4State","failed"),this.sendError(`GoogleAnalytics4 - Auto-configured Measurement ID is not present within ${dn.WAIT_FOR_PROPERTY_IDS_MS} ms`,187)),[]):t.ga4}getPropertyIdsAutomatically(){var e;const t=[],i=[],s=e=>{this.isUaTrackingId(e)&&!t.includes(e)?(Ji.debug(`Found UA Tracking ID: ${e}`),t.push(e)):this.isGa4MeasurementId(e)&&!i.includes(e)&&(Ji.debug(`Found GA4 Measurement ID: ${e}`),i.push(e))},{gaData:n}=this.environment.getWindow();void 0!==n&&Object.keys(n).forEach((e=>{s(e)}));const r=this.environment.getWindow().google_tag_data;void 0!==(null==r?void 0:r.td)&&Object.keys(r.td).forEach((e=>{s(e)}));const a=this.environment.getWindow().google_tag_manager;void 0!==(null==(e=null==a?void 0:a.mb)?void 0:e.h)&&a.mb.h.forEach((({message:e})=>{cs(e)&&"config"===e[0]&&s(e[1])}));const{dataLayer:o}=this.environment.getWindow();return void 0!==o&&o.forEach((e=>{cs(e)&&"config"===e[0]&&s(e[1])})),{gua:t,ga4:i}}isUaTrackingId(e){return dn.UA_TRACKING_ID_REGEX.test(e)}isGa4MeasurementId(e){return dn.GA4_MEASUREMENT_ID_REGEX.test(e)}sendToUaUsingGtagJsOnce(e,t,i){if(!dn.isSent(this.states.uaState)){const s=this.shimGtag(t);e.getDimensionName().ifPresent((e=>{Ji.debug(`Found UA custom dimension: ${e}`),s("set",{[e]:"Intellimize"})}));const n=null!=i?i:e.getTrackingIds(),r={event_category:this.getUaEventCategory(),event_label:this.getUaEventLabel(),non_interaction:!0,send_to:n,event_callback:e=>{this.isUaTrackingId(e)&&(this.handleGaEventSuccess(`UA configuration (iint.gua) + gtag.js. Tracking ID: ${e}`),this.checkDelivered("uaState",e))}};Ji.debug(`Sending UA event using gtag.js: ${Si(r)}`),this.uATrackingIdQueue.push(...n),Ji.debug("Google Analytics UA payload sent"),this.setState("uaState","sent"),s("event",this.getUaEventAction(),r)}}sendToGa4Once(e,t,i){if(!dn.isSent(this.states.ga4State)){const s=this.shimGtag(t),n=null!=i?i:e.getMeasurementIds(),r={experienceId:this.variation.getExperience().getId(),experienceName:this.variation.getExperience().getName(),experienceType:this.variation.getExperience().getType(),variationId:this.variation.getId(),variationName:this.variation.getName(),ccStatus:this.variation.getId()===zt?"holdout":"optimized",send_to:n,event_callback:e=>{this.isGa4MeasurementId(e)&&(this.handleGaEventSuccess(`GA4 configuration (iint.ga4) + gtag.js. Measurement ID: ${e}`),this.checkDelivered("ga4State",e))}};Ji.debug(`Sending GA4 event using gtag.js: ${Si(r)}`),this.ga4MeasurementIdQueue.push(...n),Ji.debug("Google Analytics 4 payload sent"),this.setState("ga4State","sent"),s("event",dn.GA4_EVENT_NAME,r)}}getUaEventAction(){return`{${this.variation.getExperience().getName()}}:{${this.variation.getName()}}`}getUaEventCategory(){return`Intellimize - {${this.variation.getExperience().getCampaign().getName()}}`}getUaEventLabel(){return`PageURL: ${this.environment.getHostingPageUrl().getUrl().orElse("unknown")}`}handleGaEventSuccess(e){Ji.debug(`Google Analytics payload delivery complete - using ${e}`)}checkDelivered(e,t){const i="uaState"===e?this.uATrackingIdQueue:this.ga4MeasurementIdQueue;gs(i,t),0===i.length&&this.setState(e,"delivered")}}class un extends rs{constructor(e,t,i){super(),__publicField(this,"environment"),__publicField(this,"variation"),__publicField(this,"override"),__publicField(this,"sent",!1),__publicField(this,"delivered",!1),__publicField(this,"timedOut",!1),__publicField(this,"taskStartTime"),this.environment=e,this.variation=t,this.override=i}static get WAIT_FOR_MIXPANEL_TIMEOUT_MS(){return 3e3}toString(){return"MixpanelTask("+this.variation.getId()+")"}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.timedOut?is.FAILED:this.sent?this.delivered?is.SUCCEEDED:(Ji.debug("Waiting for Mixpanel delivery confirmation"),is.TRY_LATER):is.TRY_LATER}sendOnce(){if(!this.sent){void 0===this.taskStartTime&&(this.taskStartTime=this.environment.getNowDate(),Ji.debug(`MixpanelTask start time: ${this.taskStartTime.getTime()}`));if(this.environment.getNowDate().getTime()-this.taskStartTime.getTime()>=un.WAIT_FOR_MIXPANEL_TIMEOUT_MS)return Ji.error(`MixpanelTask - window.mixpanel.track not present within ${un.WAIT_FOR_MIXPANEL_TIMEOUT_MS} ms`,199),void(this.timedOut=!0);if(this.override.sendMixpanel().orElse(!0)){const e=this.environment.getWindow();if(void 0===e.mixpanel)return void Ji.debug("window.mixpanel not defined");if(void 0===e.mixpanel.track)return void Ji.debug("window.mixpanel.track not defined");const t="Intellimize Viewed",i={[`${this.variation.getExperience().getName()} (${this.variation.getExperience().getId()})`]:`${this.variation.getName()} (${this.variation.getId()})`};e.mixpanel.track(t,i,{send_immediately:!0},(()=>{Ji.debug("Mixpanel payload delivery complete"),this.delivered=!0})),Ji.debug("Mixpanel payload sent")}else this.delivered=!0,Ji.debug("Skipping Mixpanel");this.sent=!0}}}class hn extends rs{constructor(e,t,i,s){super(),__publicField(this,"environment"),__publicField(this,"segmentIntegration"),__publicField(this,"variation"),__publicField(this,"override"),__publicField(this,"sent",!1),__publicField(this,"delivered",!1),__publicField(this,"timedOut",!1),__publicField(this,"onTrack",!1),__publicField(this,"onReady",!1),__publicField(this,"trackCallback",!1),__publicField(this,"taskStartTime"),this.environment=e,this.segmentIntegration=t,this.variation=i,this.override=s}static get WAIT_FOR_SEGMENT_TIMEOUT_MS(){return 3e3}toString(){return"SegmentAnalyticsTask("+this.variation.getId()+")"}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.timedOut?is.FAILED:this.sent?this.delivered||this.onReady&&this.onTrack&&this.trackCallback?is.SUCCEEDED:(Ji.debug("Waiting for Segment delivery confirmation"),is.TRY_LATER):is.TRY_LATER}sendOnce(){if(!this.sent){void 0===this.taskStartTime&&(this.taskStartTime=this.environment.getNowDate(),Ji.debug(`SegmentAnalyticsTask start time: ${this.taskStartTime.getTime()}`));if(this.environment.getNowDate().getTime()-this.taskStartTime.getTime()>=hn.WAIT_FOR_SEGMENT_TIMEOUT_MS)return Ji.error(`SegmentAnalyticsTask - window.analytics.track not present within ${hn.WAIT_FOR_SEGMENT_TIMEOUT_MS} ms`,200),void(this.timedOut=!0);if(this.override.sendSegmentAnalytics().orElse(!0)){const e=this.environment.getWindow();if(void 0===e.analytics)return void Ji.debug("window.analytics not defined");if(void 0===e.analytics.track)return void Ji.debug("window.analytics.track not defined");const t=this.segmentIntegration.getEventName();e.analytics.on("track",((e,i)=>{e===t&&void 0!==i.variationId&&i.variationId===this.variation.getId()&&(Ji.debug("Segment on track event received"),this.onTrack=!0)}));const i={campaignId:this.variation.getExperience().getCampaign().getId(),campaignName:this.variation.getExperience().getCampaign().getName(),experimentId:this.variation.getExperience().getId(),experimentName:this.variation.getExperience().getName(),variationName:this.variation.getName(),variationId:this.variation.getId()};e.analytics.track(t,i,(()=>{Ji.debug("Segment track() callback called"),this.trackCallback=!0})),e.analytics.ready((()=>{Ji.debug("Segment ready() callback called"),this.onReady=!0}))}else this.delivered=!0;Ji.debug("Segment payload sent"),this.sent=!0}}}class gn extends rs{constructor(e,t,i,s,n,r,a,o,c,l){super(),__publicField(this,"variation"),__publicField(this,"environment"),__publicField(this,"decisionContext"),__publicField(this,"user"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"policy"),__publicField(this,"override"),__publicField(this,"sent",!1),__publicField(this,"deliveryStatus",is.NOT_STARTED),this.variation=e,this.environment=t,this.decisionContext=i,this.user=s,this.customerStorage=n,this.attributeStorage=r,this.pageContext=a,this.serverContext=o,this.policy=c,this.override=l}toString(){return"ViewEventTask("+this.variation.getId()+")"}getEntityIds(){return{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.deliveryStatus===is.SUCCEEDED?is.SUCCEEDED:this.deliveryStatus===is.FAILED?is.FAILED:(Ji.debug("Waiting for view event delivery confirmation"),is.TRY_LATER)}sendOnce(){this.sent||(Ji.info(`Variation ${this.variation.getExperience().getId()}/${this.variation.getId()} sending view event`),Vs.sendView(this.variation,this.environment,this.decisionContext,this.user,this.customerStorage,this.attributeStorage,this.pageContext,this.serverContext,this.policy,this.override).then((()=>{Ji.info(`Variation ${this.variation.getExperience().getId()}/${this.variation.getId()} view event delivery success`),this.deliveryStatus=is.SUCCEEDED})).catch((e=>{const t=es(e);Ji.warn(`Variation ${this.variation.getExperience().getId()}/${this.variation.getId()} view event delivery failed: ${t.message}`,93,{experienceId:this.variation.getExperience().getId(),variationId:this.variation.getId()}),this.deliveryStatus=is.FAILED})),this.sent=!0)}}class pn extends rs{constructor(e,t,i,s,n,r,a,o,c,l,d,u,h){super(),__publicField(this,"variation"),__publicField(this,"environment"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"policy"),__publicField(this,"user"),__publicField(this,"decisionContext"),__publicField(this,"startPageviewId"),__publicField(this,"override"),__publicField(this,"getVariationRecordedCallbackTuples"),__publicField(this,"haveUpdatedCustomerStorage",!1),__publicField(this,"haveUpdatedActivityStorage",!1),__publicField(this,"haveScheduledGoogleAnalytics",!1),__publicField(this,"googleAnalyticsTask"),__publicField(this,"haveScheduledSegmentAnalytics",!1),__publicField(this,"segmentAnalyticsTask"),__publicField(this,"haveScheduledMixpanel",!1),__publicField(this,"mixpanelTask"),__publicField(this,"viewEventTask"),__publicField(this,"haveRunSuccessCallbacks",!1),this.variation=e,this.environment=t,this.customerStorage=i,this.attributeStorage=s,this.activityStorage=n,this.pageContext=r,this.serverContext=a,this.policy=o,this.user=c,this.decisionContext=l,this.startPageviewId=d,this.override=u,this.getVariationRecordedCallbackTuples=h}toString(){return"RecordVariationTask("+this.variation.getId()+")"}getEntityIds(){return{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}}inTransaction(){return!1}isUnloading(){return!1}getNotDoneDependencies(){const e=[];return void 0===this.googleAnalyticsTask||this.googleAnalyticsTask.isDone()||e.push(this.googleAnalyticsTask),void 0===this.segmentAnalyticsTask||this.segmentAnalyticsTask.isDone()||e.push(this.segmentAnalyticsTask),void 0===this.mixpanelTask||this.mixpanelTask.isDone()||e.push(this.mixpanelTask),void 0===this.viewEventTask||this.viewEventTask.isDone()||e.push(this.viewEventTask),e}updateCustomerStorageOnce(){this.haveUpdatedCustomerStorage||(Ji.debug("RecordVariationTask.updateCustomerStorageOnce() "+this.variation.getId()),this.decisionContext.isStickyVariation(this.variation)?this.customerStorage.saveVariationStickySelection(this.variation,this.environment.getPageviewId()):this.customerStorage.saveVariationPredictionSelection(this.variation,this.decisionContext.getModelVersion(this.variation.getExperience().getId()),this.environment.getPageviewId()),this.haveUpdatedCustomerStorage=!0)}updateActivityStorageOnce(){if(!this.haveUpdatedActivityStorage){Ji.debug(`RecordVariationTask.haveUpdatedActivityStorage() ${this.variation.getId()}`);const e=an.buildViewActivity(this.variation,this.environment,this.user,this.attributeStorage,this.customerStorage);this.activityStorage.add(e),this.haveUpdatedActivityStorage=!0}}sendGoogleAnalyticsOnce(){if(!this.haveScheduledGoogleAnalytics){const e=this.variation.getExperience().getCampaign().getCustomer(),t=e.getIntegrationGoogleUniversalAnalytics(),i=e.getIntegrationGoogle4Analytics(),s=t.isPresent()&&t.get().isEnabled(),n=i.isPresent()&&i.get().isEnabled();(s||n)&&(this.googleAnalyticsTask=new dn(this.environment,s?t:xe.empty(),n?i:xe.empty(),this.variation,this.override),this.manager.addTask(this.googleAnalyticsTask)),this.haveScheduledGoogleAnalytics=!0}}sendSegmentAnalyticsOnce(){this.haveScheduledSegmentAnalytics||(this.variation.getExperience().getCampaign().getCustomer().getIntegrationSegmentAnalytics().ifPresent((e=>{e.isEnabled()&&(this.segmentAnalyticsTask=new hn(this.environment,e,this.variation,this.override),this.manager.addTask(this.segmentAnalyticsTask))})),this.haveScheduledSegmentAnalytics=!0)}sendMixpanelOnce(){this.haveScheduledMixpanel||(this.variation.getExperience().getCampaign().getCustomer().getIntegrationMixpanel().ifPresent((e=>{e.isEnabled()&&(this.mixpanelTask=new un(this.environment,this.variation,this.override),this.manager.addTask(this.mixpanelTask))})),this.haveScheduledMixpanel=!0)}sendViewEventOnce(){void 0===this.viewEventTask&&(this.viewEventTask=new gn(this.variation,this.environment,this.decisionContext,this.user,this.customerStorage,this.attributeStorage,this.pageContext,this.serverContext,this.policy,this.override),this.manager.addTask(this.viewEventTask))}checkDependency(e){switch(e.getStatus()){case is.NOT_STARTED:case is.TRY_LATER:case is.WAITING:return is.TRY_LATER;case is.FAILED:case is.CANCELED:return is.FAILED;case is.SUCCEEDED:return is.SUCCEEDED;default:return Ji.error(`Unrecognized status from dependency ${e.getStatus()}`,88,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}),is.FAILED}}getRecordViewStatus(){if(!this.haveUpdatedCustomerStorage)return Ji.debug("Waiting for CustomerStorage to be updated"),is.TRY_LATER;if(!this.haveScheduledGoogleAnalytics)return Ji.debug("Waiting for GoogleAnalytics to be scheduled"),is.TRY_LATER;if(void 0!==this.googleAnalyticsTask){const e=this.checkDependency(this.googleAnalyticsTask);if(e!==is.SUCCEEDED)return Ji.debug(`GoogleAnalytics returned ${is[e]}`),e}if(!this.haveScheduledSegmentAnalytics)return Ji.debug("Waiting for SegmentAnalytics to be scheduled"),is.TRY_LATER;if(void 0!==this.segmentAnalyticsTask){const e=this.checkDependency(this.segmentAnalyticsTask);if(e!==is.SUCCEEDED)return Ji.debug(`SegmentAnalytics returned ${is[e]}`),e}if(!this.haveScheduledMixpanel)return Ji.debug("Waiting for Mixpanel to be scheduled"),is.TRY_LATER;if(void 0!==this.mixpanelTask){const e=this.checkDependency(this.mixpanelTask);if(e!==is.SUCCEEDED)return Ji.debug(`Mixpanel returned ${is[e]}`),e}if(void 0===this.viewEventTask)return Ji.debug("Waiting for ViewEvent to be scheduled"),is.TRY_LATER;const e=this.checkDependency(this.viewEventTask);return e!==is.SUCCEEDED?(Ji.debug(`ViewEvent returned ${is[e]}`),e):is.SUCCEEDED}doSuccessCallbacksOnce(){this.haveRunSuccessCallbacks||(this.getVariationRecordedCallbackTuples().forEach((e=>{const t=e[0];try{t({experienceId:this.variation.getExperience().getId(),experienceName:this.variation.getExperience().getName(),experienceType:this.variation.getExperience().getType(),variationId:this.variation.getId(),variationName:this.variation.getName(),ccStatus:this.variation.getId()===zt?"holdout":"optimized"})}catch(i){const e=es(i);e.message=`Caught exception in onVariationRecorded success callback\n${e.message}`,Pn.consoleError(e.message,165)}})),this.haveRunSuccessCallbacks=!0)}}class mn extends rs{constructor(e){super(),__publicField(this,"environment"),__publicField(this,"startViewableTimeMs"),__publicField(this,"ignoreCallback",!1),__publicField(this,"activeEventListener",!1),this.environment=e}toString(){return"ViewabilityTask()"}inTransaction(){return!1}isUnloading(){return!1}cleanup(){this.ignoreCallback=!0}run(){const e=this.environment.getNowUnixTimeMs();if(!this.environment.isNowDocumentHidden().orElse(!0)){void 0===this.startViewableTimeMs&&(this.startViewableTimeMs=e);const t=e-this.startViewableTimeMs;return t>=ti?(Ji.debug(`page viewable for ${t}ms > threshold ${ti}ms`),is.SUCCEEDED):(Ji.debug(`page viewable for ${t}ms < threshold ${ti}ms`),is.TRY_LATER)}return this.startViewableTimeMs=void 0,this.activeEventListener||(Ji.debug("page not viewable, scheduling visibility change listener"),this.environment.addListenerVisibilityChange((()=>{this.ignoreCallback?Ji.debug("visibility change event - ignoring"):(Ji.debug("visibility change event - ask TM for polling"),this.setStatusTryLater(),this.manager.runNow())})),this.activeEventListener=!0),is.WAITING}}class vn extends pn{constructor(){super(...arguments),__publicField(this,"viewabilityTask")}toString(){return"RecordCodeVariationTask("+this.variation.getId()+")"}getNotDoneDependencies(){const e=super.getNotDoneDependencies();return void 0===this.viewabilityTask||this.viewabilityTask.isDone()||e.push(this.viewabilityTask),e}run(){if(this.startPageviewId!==this.environment.getPageviewId()&&Ji.error(`RecordCodeVariationTask executing, but pageviewId has changed from ${this.startPageviewId} to ${this.environment.getPageviewId()}`,85,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}),this.scheduleViewabilityOnce(),void 0===this.viewabilityTask||!this.viewabilityTask.isDone())return Ji.debug("RecordCodeVariationTask waiting for viewability"),is.TRY_LATER;const e=this.viewabilityTask.getStatus();return e===is.CANCELED?(Ji.info(`Variation ${this.variation.getExperience().getId()}/${this.variation.getId()} aborting record view event since viewability was canceled`),is.CANCELED):e===is.FAILED?(Ji.info(`Variation ${this.variation.getExperience().getId()}/${this.variation.getId()} aborting record view event since viewability failed`),is.CANCELED):e!==is.SUCCEEDED?(Ji.error(`Unknown viewability status ${e}`,86,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}),is.FAILED):(this.updateCustomerStorageOnce(),this.updateActivityStorageOnce(),this.sendGoogleAnalyticsOnce(),this.sendSegmentAnalyticsOnce(),this.sendMixpanelOnce(),this.sendViewEventOnce(),this.doSuccessCallbacksOnce(),this.getRecordViewStatus())}scheduleViewabilityOnce(){void 0===this.viewabilityTask&&(this.viewabilityTask=new mn(this.environment),this.manager.addTask(this.viewabilityTask))}}class bn extends ln{constructor(e,t,i,s,n,r,a,o,c,l,d,u,h,g,p,m){super(e,t,i,s,n,r,a,o,c,l,d,u,h,g,p,m),__publicField(this,"changesQueue",[]),__publicField(this,"applyPromises",[]),this.changesQueue=[...this.variation.getChanges()]}toString(){return`ExecuteChangeVariationTask(${this.variation.getId()})`}isReadyToExecute(){if(this.variation.getChanges().length===this.changesQueue.length){const e=this.passDependencies(),t=this.passExperiencePreconditions(),i=this.passVariationPreconditions();return e&&t&&i}return!0}executeVariation(){let e=!1;for(;this.changesQueue.length>0;){Ji.debug(`Changes left to apply: ${this.changesQueue.length}`);const i=this.changesQueue[0];let s,n=!1;try{s=this.changeAppliers.createChangeApplier(i,this.environment.getWindow().document)}catch(t){const s=es(t);s.message=`Failed to construct ChangeApplier: ${Si(i)}\n${s.message}`,Ji.error(s,124,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}),e=!0}if(!e&&i.isReadyToApply()&&this.applyPromises.push(new Promise((r=>{try{s.apply(r),n=!0}catch(t){const n=es(t);n.message=`Failed to apply change: ${Si(i)}\n${n.message}`,Ji.error(n,125,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}),e=!0,r()}}))),e)return Ji.debug("Change failed to apply; marking the task as FAILED."),this.statusModel.setVariation(this.variation,"failChange",!0),this.onReadyToRenderAllChanges(),is.FAILED;if(!n)return Ji.debug("Change did not apply; will try again next time."),is.TRY_LATER;this.changesQueue.shift(),Ji.debug("Change successfully applied; removing from change queue")}return this.onReadyToRenderAllChanges(),this.manager.addTask(new vn(this.variation,this.environment,this.customerStorage,this.attributeStorage,this.activityStorage,this.pageContext,this.serverContext,this.policy,this.user,this.decisionContext,this.startPageviewId,this.override,this.getVariationRecordedCallbackTuples)),this.statusModel.setVariation(this.variation,"apply",!0),is.SUCCEEDED}onReadyToRenderAllChanges(){Promise.all(this.applyPromises).then((()=>{Ji.debug(`SelectVariationsTask - all changes for variation are ready to render for variation ${this.variation.getId()}`),this.onReadyToRender()}))}}class fn extends ln{toString(){return`ExecuteCodeVariationTask(${this.variation.getId()})`}executeVariation(){if(!this.injectVariationCss(this.variation))return this.statusModel.setVariation(this.variation,"failCSS",!0),this.onReadyToRender(),is.FAILED;this.changeAppliers.detachObserver();const e=this.runVariationCode(this.variation);return this.changeAppliers.attachObserver(),e?(this.onReadyToRender(),this.manager.addTask(new vn(this.variation,this.environment,this.customerStorage,this.attributeStorage,this.activityStorage,this.pageContext,this.serverContext,this.policy,this.user,this.decisionContext,this.startPageviewId,this.override,this.getVariationRecordedCallbackTuples)),this.statusModel.setVariation(this.variation,"apply",!0),is.SUCCEEDED):(this.statusModel.setVariation(this.variation,"failCode",!0),this.onReadyToRender(),is.FAILED)}runVariationCode(e){if(e.getCode().isPresent()){const i=e.getCode().get();try{Ji.info(`Variation ${e.getExperience().getId()}/${e.getId()} running code`),ts.eval(i)}catch(t){const i=es(t);return i.message=`Variation (${e.getId()}) code execution failed\n${i.message}`,Ji.error(i,17,{variationId:e.getId(),experienceId:e.getExperience().getId()}),!1}}return!0}}class En extends rs{constructor(e,t){super(),__publicField(this,"targetUrl"),__publicField(this,"environment"),this.targetUrl=e,this.environment=t}toString(){return"RedirectTask("+this.targetUrl+")"}inTransaction(){return!1}isUnloading(){return!0}run(){return Ji.info("Executing redirect to "+this.targetUrl),this.environment.redirect(this.targetUrl),is.SUCCEEDED}}class _n extends pn{constructor(e,t,i,s,n,r,a,o,c,l,d,u,h,g,p){super(e,t,i,s,n,r,a,o,c,l,d,u,h),__publicField(this,"redirectUrl"),__publicField(this,"onReadyToRender"),__publicField(this,"startTimeMs"),__publicField(this,"redirectScheduled",!1),this.redirectUrl=g,this.onReadyToRender=p}static get REDIRECT_TIME_BUDGET_MS(){return 3e3}toString(){return"RecordRedirectVariationTask("+this.variation.getId()+")"}cleanup(){this.onReadyToRender()}run(){this.startTimeMs||(this.startTimeMs=this.environment.getNowUnixTimeMs());let e=this.runSteps();return!this.isDone()&&this.hasExceededTimeBudget()&&(this.scheduleRedirectOnce(),e=is.FAILED),this.doSuccessCallbacksOnce(),e}runSteps(){this.startPageviewId!==this.environment.getPageviewId()&&Ji.error(`RecordRedirectVariationTask executing, but pageviewId has changed from ${this.startPageviewId} to ${this.environment.getPageviewId()}`,87,{variationId:this.variation.getId(),experienceId:this.variation.getExperience().getId()}),this.updateCustomerStorageOnce(),this.updateActivityStorageOnce(),this.sendGoogleAnalyticsOnce(),this.sendSegmentAnalyticsOnce(),this.sendMixpanelOnce(),this.sendViewEventOnce();const e=this.getRecordViewStatus();return rs.isDone(e)?(this.scheduleRedirectOnce(),is.SUCCEEDED):e}scheduleRedirectOnce(){if(!this.redirectScheduled){const e=new En(this.redirectUrl,this.environment);this.manager.addTask(e),this.redirectScheduled=!0,this.environment.getWindow().setTimeout((()=>{this.onReadyToRender()}),this.getTimeRemainingMs()+qt)}}getTimeRemainingMs(){const e=this.environment.getNowUnixTimeMs()-this.startTimeMs,t=_n.REDIRECT_TIME_BUDGET_MS;return Ji.debug("getTimeRemainingMs elapsed: "+e+", budget: "+t),t-e}hasExceededTimeBudget(){return this.getTimeRemainingMs()<0}}class Sn extends ln{toString(){return`ExecuteRedirectVariationTask(${this.variation.getId()})`}executeVariation(){const e=this.runVariationRedirectCode(this.variation);if(void 0===e)return this.onReadyToRender(),is.FAILED;return this.injectVariationCss(this.variation)?(this.manager.addTask(new _n(this.variation,this.environment,this.customerStorage,this.attributeStorage,this.activityStorage,this.pageContext,this.serverContext,this.policy,this.user,this.decisionContext,this.startPageviewId,this.override,this.getVariationRecordedCallbackTuples,e,this.onReadyToRender)),this.statusModel.setVariation(this.variation,"apply",!0),is.SUCCEEDED):(this.onReadyToRender(),is.FAILED)}runVariationRedirectCode(e){let t;if(e.getRedirect().isPresent()){const s=e.getRedirect().get();try{Ji.info(`Variation ${e.getExperience().getId()}/${e.getId()} running redirect code`),t=ts.evalString(s),Ji.info(`Redirect URL is ${t}`)}catch(i){const s=es(i);s.message=`Variation (${e.getId()}) redirect code execution failed${s.message}`,Ji.error(s,18,{variationId:e.getId(),experienceId:e.getExperience().getId()}),t=void 0}}return t}}function yn(e,t,i,s,n,r,a,o,c,l,d,u,h,g,p,m){let v;return v=p.isTypeChange()?bn:p.isRedirect()?Sn:fn,new v(e,t,i,s,n,r,a,o,c,l,d,u,h,g,p,m)}class In extends rs{constructor(e,t,i,s,n,r,a,o,c,l,d,u,h,g,p){super(),__publicField(this,"environment"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"customerStorage"),__publicField(this,"decisionContext"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"statusModel"),__publicField(this,"changeAppliers"),__publicField(this,"hider"),__publicField(this,"getVariationRecordedCallbackTuples"),__publicField(this,"startPageviewId"),__publicField(this,"startTimeMs"),__publicField(this,"executeVariationTasks",{}),__publicField(this,"policy"),__publicField(this,"didHide",!1),this.environment=e,this.attributeStorage=t,this.activityStorage=i,this.customerStorage=s,this.decisionContext=n,this.pageContext=r,this.serverContext=a,this.user=o,this.override=c,this.statusModel=l,this.changeAppliers=d,this.hider=u,this.getVariationRecordedCallbackTuples=g,this.policy=p,this.startTimeMs=this.environment.getNowUnixTimeMs(),this.startPageviewId=e.getPageviewId(),this.override.requestAnimationFrame().orElse(h)&&this.environment.getWindow().requestAnimationFrame((()=>{this.handleRaf()}))}static get RAF_RUNTIME_MS(){return 3e4}toString(){return`ExecuteExperiencesTask(${this.startPageviewId})`}inTransaction(){return!1}isUnloading(){return!1}getStartPageviewId(){return this.startPageviewId}hideExperiencesOnce(){this.didHide||(this.hider.hideExperiences(this.decisionContext.getExperiences()),this.hider.revealDocument(),this.didHide=!0)}setPolicy(e){this.policy=e}run(){const{policy:e}=this;return void 0===e?(Ji.error("Cannot execute experiences without a policy",198),is.FAILED):(this.decisionContext.getExperiences().forEach((t=>{if(this.decisionContext.hasNext(t.getId())){const i=this.decisionContext.getFirst(t.getId());void 0===this.executeVariationTasks[t.getId()]&&(Ji.debug(`Queueing ExecuteVariationTask for ExperienceID: ${t.getId()}, Variation ID: ${i.getId()}`),this.executeVariationTasks[t.getId()]=yn(this.environment,this.customerStorage,this.attributeStorage,this.activityStorage,this.pageContext,this.serverContext,this.decisionContext,e,this.user,this.override,this.changeAppliers,this.statusModel,this.startPageviewId,this.hider,i,this.getVariationRecordedCallbackTuples),this.manager.addTask(this.executeVariationTasks[t.getId()]));const s=this.executeVariationTasks[t.getId()];s.getStatus()===is.FAILED||s.getStatus()===is.CANCELED?this.handleOnExperienceError(t):s.getStatus()===is.SUCCEEDED&&this.handleOnExperienceSuccess(t)}})),this.decisionContext.isEmpty()?is.SUCCEEDED:is.TRY_LATER)}handleOnExperienceSuccess(e){this.decisionContext.removeExperience(e.getId())}handleOnExperienceError(e){this.decisionContext.removeExperience(e.getId()),this.hider.revealExperience(e)}handleRaf(){this.manager&&this.manager.runNow(),this.environment.getNowUnixTimeMs()-this.startTimeMs<In.RAF_RUNTIME_MS&&!rs.isDone(this.getStatus())&&this.environment.getWindow().requestAnimationFrame((()=>{this.handleRaf()}))}}const Cn=class extends rs{constructor(e,t,i,s,n){super(),__publicField(this,"instanceNumber"),__publicField(this,"pageviewId"),__publicField(this,"customer"),__publicField(this,"environment"),__publicField(this,"customerStorage"),__publicField(this,"success"),__publicField(this,"startTimeMs"),this.instanceNumber=++Cn.instanceCount,this.environment=e,this.pageviewId=t,this.customerStorage=i,this.customer=s,this.success=n}static get DEPENDENCIES_TIME_BUDGET_MS(){return 3e3}toString(){return`SelectedVariationsCallbackTask(${this.pageviewId}, ${this.instanceNumber})`}inTransaction(){return!0}isUnloading(){return!1}getNotDoneDependencies(){const e=[],t=this.getRunningDependentRecordTasks();Array.prototype.push.apply(e,t);const i=this.getDependentExecuteExperiencesTask();return i.length>0&&!i[0].isDone()&&Array.prototype.push.apply(e,i),e}run(){this.startTimeMs||(this.startTimeMs=this.environment.getNowUnixTimeMs());const e=this.getRunningDependentRecordTasks();if(e.length>0)return Ji.debug("Waiting for "+e[0].toString()+", "+is[e[0].getStatus()]),is.TRY_LATER;const t=this.getDependentExecuteExperiencesTask();if(t.length>1)return Ji.error(`Found multiple ExecuteExperiencesTasks for pageviewId ${this.pageviewId}`,89),is.FAILED;if(0===t.length)return is.TRY_LATER;const i=t[0];return rs.isDone(i.getStatus())?(this.doCallback(),is.SUCCEEDED):this.hasExceededTimeBudget()?(Ji.debug(`Time budget of ${Cn.DEPENDENCIES_TIME_BUDGET_MS} ms exceeded while waiting for ExecuteVariationTasks to complete; triggering success callbacks now`),this.doCallback(),is.SUCCEEDED):(Ji.debug("Waiting for "+i.toString()+", "+is[i.getStatus()]),is.TRY_LATER)}getRunningDependentRecordTasks(){return this.manager.findTasks((e=>e instanceof pn&&!e.isDone()))}getDependentExecuteExperiencesTask(){return this.manager.findTasks((e=>e instanceof In&&this.pageviewId===e.getStartPageviewId()))}doCallback(){const e=this.customerStorage.getPageviewSelections(this.pageviewId),t=this.generateResponse(e);Ji.debug("Callback data: "+Si(t));try{this.success.call(void 0,t)}catch(i){const e=es(i);e.message=`Caught exception in customer callback: ${e.message}`,Ji.error(e,8)}}getTimeRemainingMs(){const e=this.environment.getNowUnixTimeMs()-this.startTimeMs,t=Cn.DEPENDENCIES_TIME_BUDGET_MS;return Ji.debug("getTimeRemainingMs elapsed: "+e+", budget: "+t),t-e}hasExceededTimeBudget(){return this.getTimeRemainingMs()<0}};let Tn=Cn;__publicField(Tn,"instanceCount",0);class An extends Tn{toString(){return"SelectedVariationIdsCallbackTask("+this.pageviewId+","+this.instanceNumber+")"}generateResponse(e){const t={};return e.forEach((e=>{t[e.experienceId]=e.variationId})),t}}class xn extends Tn{toString(){return"SelectedVariationNamesCallbackTask("+this.pageviewId+","+this.instanceNumber+")"}generateResponse(e){const t={};return e.forEach((e=>{e.campaignId in t||(t[e.campaignId]={});const i={};i.varId=e.variationId,this.customer.getCampaign(e.campaignId).ifPresent((s=>{t[e.campaignId].campaignName=s.getName(),s.getExperience(e.experienceId).ifPresent((t=>{i.expName=t.getName(),t.getVariation(e.variationId).ifPresent((e=>{i.varName=e.getName()}))}))})),t[e.campaignId][e.experienceId]=i})),t}}class wn extends rs{constructor(e,t,i,s,n){super(),__publicField(this,"sent",!1),__publicField(this,"deliveryStatus",is.NOT_STARTED),__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"customerUserDomain"),__publicField(this,"customerUserId"),__publicField(this,"attributeStorage"),this.customer=e,this.user=t,this.customerUserDomain=i,this.customerUserId=s,this.attributeStorage=n}static get ENDPOINT(){return"/user-alias"}toString(){return`UserAliasTask(customerUserDomain: ${this.customerUserDomain}, customerUserId: ${this.customerUserId})`}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.deliveryStatus===is.SUCCEEDED?is.SUCCEEDED:this.deliveryStatus===is.FAILED?is.FAILED:(Ji.debug("Waiting for user alias delivery confirmation"),is.TRY_LATER)}sendOnce(){this.sent||(Ji.info(`Sending request to set up user alias for ${this.customerUserDomain} (${this.customerUserId})`),zi(ni,wn.ENDPOINT,{method:"POST",body:Si({customerId:this.customer.getId(),userDomain1:"intellimize",userId1:this.user.getId(),userDomain2:this.customerUserDomain,userId2:this.customerUserId})}).then((()=>{this.saveToLocalStorage(),this.deliveryStatus=is.SUCCEEDED,Ji.info(`Successfully set up user alias for ${this.customerUserDomain} (${this.customerUserId})`)})).catch((e=>{const t=es(e);Ji.error(t,92),this.deliveryStatus=is.FAILED})),this.sent=!0)}saveToLocalStorage(){Ji.info(`Saving user alias to localStorage for ${this.customerUserDomain} (${this.customerUserId})`);const e=this.attributeStorage.getInternalAttributes("user",["userAlias"]);void 0===e.userAlias&&(e.userAlias={}),e.userAlias[this.customerUserDomain]=this.customerUserId,this.attributeStorage.setInternalAttributes("user",e)}}const kn=["marketo","salesforce","firmographic","6sense"],Fn=(e,t)=>`i${e}${t}`;class Pn{constructor(e,t,i,s,n,r,a,o,c,l,d,u,h,g,p,m){__publicField(this,"environment"),__publicField(this,"taskManager"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"integrationDataStorage"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"policy"),__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"statusModel"),__publicField(this,"callQueue"),__publicField(this,"readyCallbackQueue"),__publicField(this,"addVariationRecordedCallbackTuple"),__publicField(this,"initialized"),this.environment=e,this.taskManager=t,this.customerStorage=i,this.attributeStorage=s,this.activityStorage=n,this.integrationDataStorage=r,this.pageContext=a,this.serverContext=o,this.policy=null!=c?c:new Us(e),this.customer=l,this.user=d,this.override=u,this.statusModel=h,this.callQueue=g,this.readyCallbackQueue=p,this.addVariationRecordedCallbackTuple=m,this.initialized=!1}static validatePushCommand(e){return e&&"object"==typeof e&&e.constructor===Array?!(!e[0]||"string"!=typeof e[0])||(Pn.consoleError(`intellimize.push(): First parameter must be a string: ${Si(e)}`,114),!1):(Pn.consoleError(`intellimize.push(): Parameter must be an array: ${Si(e)}`,113),!1)}static validateReadyCallback(e){return!!ds(e)||(Pn.consoleError("intellimize.ready() was called with a non-function argument",115),!1)}static consoleError(e,t){console.error(e),Ji.error(e,t)}static validateAttributeScope(e){return"user"===e||"pageview"===e}static validateAttributes(e){return null!=e&&ls(e)}static filterAttributePairs(e){for(const t in e){if(!Object.prototype.hasOwnProperty.call(e,t))continue;if(!Pn.validateAttributeName(t)){Pn.consoleError(`intellimize.setAttributes() invalid attribute ${t}`,96),delete e[t];continue}const i=Pn.transformAttributeValue(e[t]);Pn.validateAttributeValue(i)?e[t]=i:(Pn.consoleError(`intellimize.setAttributes() invalid attribute ${t}: ${e[t]}`,97),delete e[t])}}static validateAttributeName(e){return/^[\u0020-\u003C\u003E-\u007E]{1,40}$/.test(e)}static transformAttributeValue(e){let t=e;return"boolean"==typeof t&&(t=t.toString()),"number"==typeof t&&(t=t.toString()),null===t&&(t=""),void 0===t&&(t=""),"string"==typeof t&&t.length>255&&(t=t.slice(0,255)),t}static validateAttributeValue(e){return void 0!==e&&"string"==typeof e&&e.length>=0&&e.length<256}static validateAttributeNames(e){if(void 0===e||!Array.isArray(e))return!1;for(const t of e)if(!Pn.validateAttributeName(t))return!1;return!0}static validateCustomEventApiName(e){return/^[\u0021-\u007E]{1,40}$/.test(e)}static validateCustomEventProperties(e){const t=new Set(["value","actionId"]);return!!Object.keys(e).every((e=>t.has(e)))&&(!(void 0!==e.value&&!zs(e.value))&&!(void 0!==e.actionId&&!Ws(e.actionId)))}static validateCustomerUserId(e){return/^[\u0021-\u007E]{1,300}$/.test(e)}static validateCustomerUserDomain(e){return"intellimize"!==e&&!e.startsWith("__")&&/^[\u0021-\u007E]{1,50}$/.test(e)}static doCallback(e){void 0!==e&&ts.executeFunction(e,5)}get isInitialized(){return this.initialized}setPolicy(e){this.policy=e}initialize(){const e=this,t=this.environment.getWindow(),{intellimize:i}=t;void 0!==i?(i.getSelectedVariationIds=(e,t)=>{"function"==typeof e?void 0===t||"function"==typeof t?this.getSelectedVariationIds(e,t):Pn.consoleError("intellimize.getSelectedVariationIds() second parameter must be an error function",103):Pn.consoleError("intellimize.getSelectedVariationIds() first parameter must be a success function",102)},i.getSelectedVariationNames=(e,t)=>{"function"==typeof e?void 0===t||"function"==typeof t?this.getSelectedVariationNames(e,t):Pn.consoleError("intellimize.getSelectedVariationNames() second parameter must be an error function",105):Pn.consoleError("intellimize.getSelectedVariationNames() First parameter must be a success function",104)},i.onVariationRecorded=function(t,i){e.onVariationRecorded(t.bind(this),void 0===i?void 0:i.bind(this))},i.setAttributes=(e,t)=>{this.setAttributes(e,t)},i.getAttributes=(e,t)=>this.getAttributes(e,t),i.getAllAttributes=e=>this.getAllAttributes(e),i.deleteAttributes=(e,t)=>{this.deleteAttributes(e,t)},i.deleteAllAttributes=e=>{this.deleteAllAttributes(e)},i.getIntegrationData=e=>this.getIntegrationData(e),i.sendEvent=(e,t,i)=>{this.sendEvent(e,t,i)},i.activate=e=>{this.activate(e)},i.setUserId=(e,t)=>{this.setCustomerUserId(e,t)},i.getActivities=()=>this.getActivities(),i.push=e=>{Pn.validatePushCommand(e)&&this.push(e)},i.ready=e=>{Pn.validateReadyCallback(e)&&this.ready(e)},this.callQueue.forEach((e=>{e&&"object"==typeof e&&e.constructor===Array?"push"!==e[0]?this.push(e):Pn.consoleError('intellimize.push() Refusing to process command "push", to prevent infinite recursion.',10):Pn.consoleError("intellimize.push() Parameter must be an array: "+Si(e),9)})),this.readyCallbackQueue.forEach(((e,t)=>{Ji.debug(`intellimize.ready() executing registered callback #${t+1}`),this.ready(e)})),this.initialized=!0):Ji.error("window.intellimize is undefined: Cannot initialize ExternalApi",218)}getSelectedVariationIds(e,t){Ji.debug("getSelectedVariationIds()"),Ji.warn("getSelectedVariationIds",160);const i=this.environment.getPageviewId(),s=new An(this.environment,i,this.customerStorage,this.customer,e);this.taskManager.addTask(s)}getSelectedVariationNames(e,t){Ji.debug("getSelectedVariationNames()"),Ji.warn("getSelectedVariationNames",161);const i=this.environment.getPageviewId(),s=new xn(this.environment,i,this.customerStorage,this.customer,e);this.taskManager.addTask(s)}onVariationRecorded(e,t){Ji.debug("onVariationRecorded()"),Ji.warn("onVariationRecorded",203),"function"==typeof e?void 0===t||"function"==typeof t?this.addVariationRecordedCallbackTuple([e,xe.ofNullable(t)]):Pn.consoleError("intellimize.onVariationRecorded() second parameter must be an error function",164):Pn.consoleError("intellimize.onVariationRecorded() first parameter must be a success function",163)}setAttributes(e,t){Ji.debug(`setAttributes(${e}, ${Si(t)})`),Pn.validateAttributeScope(e)?Pn.validateAttributes(t)?(Pn.filterAttributePairs(t),this.attributeStorage.setCustomAttributes(e,t)):Pn.consoleError("intellimize.setAttributes() invalid attributes parameter",110):Pn.consoleError("intellimize.setAttributes() invalid scope parameter",109)}getAttributes(e,t){return Ji.debug(`getAttributes(${e}, ${t})`),Pn.validateAttributeScope(e)?Pn.validateAttributeNames(t)?this.attributeStorage.getCustomAttributes(e,t):(Pn.consoleError("intellimize.getAttributes() invalid names parameter",100),{}):(Pn.consoleError("intellimize.getAttributes() invalid scope parameter",99),{})}getAllAttributes(e){return Ji.debug(`getAllAttributes(${e}`),Pn.validateAttributeScope(e)?this.attributeStorage.getCustomAttributes(e):(Pn.consoleError("intellimize.getAllAttributes() invalid scope parameter",98),{})}deleteAttributes(e,t){Ji.debug(`deleteAttributes(${e}, ${t})`),Pn.validateAttributeScope(e)?Pn.validateAttributeNames(t)?this.attributeStorage.deleteCustomAttributes(e,t):Pn.consoleError("intellimize.deleteAttributes() invalid names parameter",95):Pn.consoleError("intellimize.deleteAttributes() invalid scope parameter",94)}deleteAllAttributes(e){Ji.debug(`deleteAllAttributes(${e})`),Pn.validateAttributeScope(e)?this.attributeStorage.deleteCustomAttributes(e):Pn.consoleError("intellimize.deleteAllAttributes() invalid scope parameter",20)}getIntegrationData(e){return Ji.debug(`getIntegrationData(${e})`),"marketoLead"===e?this.integrationDataStorage.getData("marketo").flatMap((e=>xe.ofNullable(null==e?void 0:e.lead))).orElse({}):kn.includes(e)?this.integrationDataStorage.getData(e).flatMap((e=>xe.ofNullable(e))).orElse({}):(Pn.consoleError("intellimize.getData() invalid integration name parameter",101),{})}sendEvent(e,t,i){return Ji.debug(`sendEvent(${e}, ${Si(t)} )`),Pn.validateCustomEventApiName(e)?void 0===t||Pn.validateCustomEventProperties(t)?void this.customer.getCustomEvent(e).ifPresent((e=>{const s=void 0===t?void 0:t.value;let n=void 0===t?void 0:t.actionId;void 0===n&&(n=this.environment.generateActionId());const r=new Rs(e,n,s,void 0);this.activityStorage.add(an.buildConversionActivity(r,this.customer,this.environment,this.user,this.attributeStorage,this.customerStorage));const a=new $s(r,this.environment,this.customer,this.customerStorage,this.attributeStorage,this.pageContext,this.serverContext,this.policy,this.user,this.override,this.statusModel);void 0!==i&&a.onDone(i),this.taskManager.addTask(a)})).ifAbsent((()=>{Pn.consoleError(`intellimize.sendEvent() apiName not found "${e}"`,19),Pn.doCallback(i)})):(Pn.consoleError(`intellimize.sendEvent() invalid properties "${Si(t)}"`,108),void Pn.doCallback(i)):(Pn.consoleError(`intellimize.sendEvent() invalid apiName "${e}"`,107),void Pn.doCallback(i))}activate(e){Ji.debug("activate()");const t=this.taskManager.findTasks((e=>e instanceof on&&!e.isDone()));if(t.length>0){Ji.debug("Ignoring activate() since there is an outstanding ActivateTask");const i=t[0];return void(void 0!==e&&i.addCallback(e))}const i=this.taskManager.findTasks((e=>e instanceof cn&&!e.isDone()));if(i.length>0){Ji.debug("Extending activate() expiration time");const t=i[0];return void 0!==e&&t.addCallback(e),void t.resetExpiration()}const s=void 0===e?[]:[e],n=new cn(this.environment,s);this.taskManager.addTask(n)}setCustomerUserId(e,t){if(Ji.debug(`setCustomerUserId(${e}, ${t})`),!Pn.validateCustomerUserDomain(e))return void Pn.consoleError("intellimize.setCustomerUserId() invalid user domain",111);if(!Pn.validateCustomerUserId(t))return void Pn.consoleError("intellimize.setCustomerUserId() invalid user id",112);const i=new wn(this.customer,this.user,e,t,this.attributeStorage);this.taskManager.addTask(i)}getActivities(){return Ji.debug("getActivities()"),this.activityStorage.getAll()}push(e){Ji.debug("push("+e[0]+")");const t=this.environment.getWindow();try{if(void 0===t.intellimize)return void Ji.error("push() called, but window.intellimize undefined",30);const i=e.shift();if(void 0===t.intellimize[i])return void Pn.consoleError(`intellimize.${i}() is not a valid function`,106);t.intellimize[i].apply(void 0,e)}catch(i){const e=es(i);e.message="Error executing push() "+e.message,Ji.error(e,3)}}ready(e){Pn.doCallback(e)}}class Dn{constructor(e){__publicField(this,"environment"),__publicField(this,"callQueue"),__publicField(this,"readyCallbackQueue"),this.environment=e,this.callQueue=[],this.readyCallbackQueue=[]}static isValidObjectDefinition(e){if(ls(e)){const t=Object.keys(e);if(4===t.length){if(0===us(["p","r","push","ready"],t).length&&os(e.p)&&os(e.r)&&ds(e.push)&&ds(e.ready))return!0}}return!1}initialize(){const e=this.environment.getWindow();if(void 0!==e.intellimize)if(os(e.intellimize))this.setCallQueue(e.intellimize);else if(ls(e.intellimize))if(Dn.isValidObjectDefinition(e.intellimize)){const t=e.intellimize;this.setCallQueue(t.p),this.setReadyCallbackQueue(t.r)}else Pn.consoleError("[Intellimize Api]: window.intellimize is an object that does not match the expected definition",116);else Pn.consoleError("[Intellimize Api]: window.intellimize is not an object or an array",117);e.intellimize={ready:this.ready.bind(this),push:this.push.bind(this)}}extractCallQueue(){const{callQueue:e}=this;return this.callQueue=[],e}extractReadyCallbackQueue(){const{readyCallbackQueue:e}=this;return this.readyCallbackQueue=[],e}ready(e){Pn.validateReadyCallback(e)&&(Ji.debug("[Intellimize Api]: registering ready() callback"),this.readyCallbackQueue.push(e))}push(e){Pn.validatePushCommand(e)&&(Ji.debug("[Intellimize Api]: adding command to call queue"),this.callQueue.push([...e]))}setCallQueue(e){Ji.debug("[Intellimize Api]: storing window.intellimize callQueue"),this.callQueue=[],e.forEach((e=>{Pn.validatePushCommand(e)&&this.callQueue.push([...e])}))}setReadyCallbackQueue(e){Ji.debug("[Intellimize Api]: storing window.intellimize readyCallbackQueue"),this.readyCallbackQueue=[],e.forEach((e=>{Pn.validateReadyCallback(e)&&this.readyCallbackQueue.push(e)}))}}class Mn{constructor(e,t,i,s,n,r,a,o,c){__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"environment"),__publicField(this,"serverContext"),__publicField(this,"taskManager"),__publicField(this,"browserStorage"),__publicField(this,"customerStorage"),__publicField(this,"externalApi"),__publicField(this,"attributeData"),__publicField(this,"storageKey"),this.customer=e,this.user=t,this.environment=i,this.serverContext=s,this.taskManager=n,this.browserStorage=r,this.customerStorage=a,this.externalApi=o,this.attributeData=c,this.storageKey=ri+e.getId()}initialize(){if(!this.externalApi.isInitialized)throw new Error("ExternalApi needs to be initialized before calling InternalApi.initialize()");const e=this.environment.getWindow(),{intellimize:t}=e;void 0!==t?(t.plugins={},t.setLocalState=(e,t)=>{Ji.info(`intellimize.setLocalState(${e}, ${t})`),this.setLocalState(e,t)},t.getLocalState=e=>{const t=this.getLocalState(e);return Ji.info(`intellimize.getLocalState(${e}) => ${t}`),t},t.deleteLocalState=e=>{Ji.info(`intellimize.deleteLocalState(${e})`),this.deleteLocalState(e)},t.getSessionId=()=>(Ji.info("intellimize.getSessionId()"),this.getSessionId()),t.getUserId=()=>(Ji.info("intellimize.getUserId()"),this.getUserId()),t.getPageviewId=()=>(Ji.info("intellimize.getPageviewId()"),this.getPageviewId()),t.logErr=e=>{Ji.error(`Customer error: ${e}`,1)},t.log=(e,t,i)=>{const s=1e4;i&&(!/^\d{5}$/.test(`${i}`)||i<10001||i>10999)&&(Ji.error(`Called intellimize.log with an invalid message code. (Wanted: 10001 < code < 10999. Found: ${i})`,998),i=s);const n=null!=i?i:s;switch(t){case m.TRACE:case m.DEBUG:return void Ji.debug(e,n);case m.INFO:return void Ji.info(e,n);case m.WARN:return void Ji.warn(e,n);case m.ERROR:return void Ji.error(e,n);default:Ji.error(`Called intellimize.log with an invalid LogLevel (${t}). Treating as "debug".`,999),Ji.debug(e,n)}},t.hasStarted=()=>{const e=this.taskManager.hasStarted();return Ji.debug(`intellimize.hasStarted() => ${e}`),e},t.isDone=()=>{const e=this.taskManager.isDone();return Ji.debug(`intellimize.isDone() => ${e}`),e},t.onDone=e=>{Ji.debug("intellimize.onDone(callbackFunction)"),this.taskManager.onDone(e)},t.isRestarting=()=>{const e=this.taskManager.getClient().isRestarting();return Ji.debug(`intellimize.isRestarting() => ${e}`),e},Ji.getLevel()<=m.INFO&&(e[e.atob("aWNqc24=")]=this.customer.getData(),e[e.atob("aXBqc24=")]=()=>this.browserStorage.read(li+this.customer.getId()).map((e=>yi(xi(this.environment,e)))).orElse({})),this.reinitialize()):Ji.error("window.intellimize is undefined: Cannot initialize InternalApi",219)}reinitialize(){this.exposeAttributeData()}setLocalState(e,t){const i=this.readState();i[e]=t,this.writeState(i)}getLocalState(e){return this.readState()[e]}deleteLocalState(e){const t=this.readState();delete t[e],this.writeState(t)}getSessionId(){return this.customerStorage.updateAndGetSessionId()}getUserId(){return this.user.getId()}getPageviewId(){return this.environment.getPageviewId()}readState(){let e={};return this.browserStorage.read(this.storageKey).ifPresent((t=>{try{e=yi(t)}catch(i){const e=es(i);e.message="Could not parse internal api storage\n"+e.message,Ji.error(e,33)}})),e}writeState(e){const t=Si(e);this.browserStorage.write(this.storageKey,t)}exposeAttributeData(){const e=this.environment.getWindow(),t=this.attributeData.getLocationData();e.iiloc={country:t.country,region:t.state,city:t.city,dma:t.dma,postal:t.postal,tz:t.tz};const i=this.attributeData.getUserAgentData(),s=this.attributeData.getTrafficSourceData();e.icntxtlftrs={IP:this.serverContext.clientIp,D:i.deviceType,B:i.browser,OS:i.os,DC:i.deviceClass,DN:i.deviceName,DB:i.deviceBrand,OC:i.osClass,ON:i.osName,OV:i.osVersion,AC:i.agentClass,AN:i.agentName,AV:i.agentVersionMajor,TS:s};const n=this.attributeData.getUtmParamsData();e.iutmprms={uts:n.utmSource,utm:n.utmMedium,utcm:n.utmCampaign,utcn:n.utmContent,utt:n.utmTerm}}}const Nn="UTC";let On,Rn=!0;function Un(e){var t;if(void 0!==On)return On;if(Rn){if("undefined"===(null==(t=e.Intl)?void 0:t.DateTimeFormat))return void Vn();const i=e.Intl.DateTimeFormat();return void 0===i||void 0===i.resolvedOptions?void Vn():(On=e.Intl,On)}}function Vn(){Rn=!1,Ji.error("Intl.DateTimeFormat().resolvedOptions() is not supported by the browser",1014)}function Ln(e){const t=Un(e);let i="";return void 0!==t&&(i=t.DateTimeFormat().resolvedOptions().timeZone),void 0===i||""===i?Nn:i}const $n=e=>"0"===e||"1"===e;function zn(e){return t=>new RegExp("^"+e+"$").test(t)}const Wn=e=>"true"===e||"false"===e;class Gn{constructor(e,t=!1){if(__publicField(this,"experienceVariations",{}),__publicField(this,"_passExperienceAudience"),__publicField(this,"_passVariationAudience"),__publicField(this,"_isControl"),__publicField(this,"_saveCustomerStorage"),__publicField(this,"_sendBrowserEvents"),__publicField(this,"_sendGoogleAnalytics"),__publicField(this,"_sendSegmentAnalytics"),__publicField(this,"_sendMixpanel"),__publicField(this,"_showStatusModule"),__publicField(this,"_showBasesite"),__publicField(this,"_expires"),__publicField(this,"attributeData",{location:{},utmParams:{},userAgent:{},dayPart:void 0,weekPart:void 0,trafficSource:void 0,custom:{},urlParam:{},userVisitStatus:void 0,userBucket:void 0}),__publicField(this,"_hideImage"),__publicField(this,"_requestAnimationFrame"),__publicField(this,"_hideExperience"),t)return;const i=e.getWindow().iOverride;if(void 0!==i){if(void 0!==i.experienceVariations){const{experienceVariations:e}=i;Object.keys(e).forEach((t=>{var i;null==(i=e[t])||i.forEach((e=>{t in this.experienceVariations||(this.experienceVariations[t]={}),this.experienceVariations[t][e]=!0}))}))}this._passExperienceAudience=i.passExperienceAudience,this._passVariationAudience=i.passVariationAudience,this._isControl=i.isControl,this._saveCustomerStorage=i.saveCustomerStorage,this._sendBrowserEvents=i.sendBrowserEvents,this._sendGoogleAnalytics=i.sendGoogleAnalytics,this._sendSegmentAnalytics=i.sendSegmentAnalytics,this._sendMixpanel=i.sendMixpanel,this._showStatusModule=i.showStatusModule,this._expires=i.expires}e.readLocalStorage("intellimize_override").ifPresent((e=>{let t={};try{t=yi(e)}catch(i){const e=es(i);e.message="Could not parse override\n"+e.message,Ji.error(e,192)}void 0!==t.hideImage&&(this._hideImage=t.hideImage),void 0!==t.raf&&(this._requestAnimationFrame=t.raf),void 0!==t.hideExperience&&(this._hideExperience=t.hideExperience)})),e.getUrlParameter("iev",zn("[0-9;:]+")).ifPresent((e=>{this.experienceVariations={},e.split(";").forEach((t=>{const i=t.split(":");if(2===i.length){const e=i[0],t=i[1];e in this.experienceVariations||(this.experienceVariations[e]={}),this.experienceVariations[e][t]=!0}else Ji.error(`Override could not parse iev ${e}`,34)})),void 0!==i&&0!==Object.keys(i).length||(this._passExperienceAudience=!0,this._passVariationAudience=!0,this._saveCustomerStorage=!1,this._sendBrowserEvents=!1),this._isControl=!1,this._sendGoogleAnalytics=!1,this._sendSegmentAnalytics=!1,this._sendMixpanel=!1,this._showStatusModule=!0})),e.getUrlParameter("showBasesite",zn("1")).ifPresent((()=>{this._showBasesite=!0,this._showStatusModule=!0})),e.getUrlParameter("iea",$n).ifPresent((e=>{"1"===e&&(this._passExperienceAudience=void 0)})),e.getUrlParameter("iva",$n).ifPresent((e=>{"1"===e&&(this._passVariationAudience=void 0)})),e.getUrlParameter("is",$n).ifPresent((e=>{"1"===e?this._showStatusModule=!0:"0"===e&&(this._showStatusModule=!1)}));let s=!1;[["ictxt_city","city","([A-Z0-9]){1,40}"],["ictxt_region","state","([a-zA-Z0-9]){1,40}"],["ictxt_country","country","[A-Z]{2}"],["ictxt.city","city","([A-Z0-9]){1,40}"],["ictxt.region","state","([a-zA-Z0-9]){1,40}"],["ictxt.country","country","[A-Z]{2}"]].forEach((t=>{e.getUrlParameter(t[0],zn(t[2])).ifPresent((e=>{this.attributeData.location[t[1]]=e,s=!0}))}));[["ictxt_d","deviceType","[DPT]"]].forEach((t=>{e.getUrlParameter(t[0],zn(t[2])).ifPresent((e=>{this.attributeData.userAgent[t[1]]=e,s=!0}))})),e.getUrlParameter("ictxt_ts",zn("[A-Z]{2}")).ifPresent((e=>{this.attributeData.trafficSource=e,s=!0})),e.getUrlParameter("hideImage",Wn).ifPresent((e=>{"true"===e?this._hideImage=!0:"false"===e&&(this._hideImage=!1)})),e.getUrlParameter("raf",Wn).ifPresent((e=>{"true"===e?this._requestAnimationFrame=!0:"false"===e&&(this._requestAnimationFrame=!1)})),e.getUrlParameter("hideExperience",zn("(opacity|visibility|off)")).ifPresent((e=>{this._hideExperience=e})),s&&(this._isControl=!1,this._saveCustomerStorage=!1,this._sendBrowserEvents=!1,this._sendGoogleAnalytics=!1,this._sendSegmentAnalytics=!1,this._sendMixpanel=!1)}getExpirationMs(){return xe.ofNullable(this._expires)}setExpiration(e){this._expires=e}getOverrideJson(){const e={isControl:this._isControl,passExperienceAudience:this._passExperienceAudience,passVariationAudience:this._passVariationAudience,saveCustomerStorage:this._saveCustomerStorage,sendBrowserEvents:this._sendBrowserEvents,sendGoogleAnalytics:this._sendGoogleAnalytics,sendMixpanel:this._sendMixpanel,showStatusModule:this._showStatusModule},t={};return Object.keys(this.experienceVariations).forEach((e=>{t[e]=Object.keys(this.experienceVariations[e])})),t&&Object.keys(t).length>0&&(e.experienceVariations=t),Object.keys(e).forEach((t=>{void 0===e[t]&&delete e[t]})),e}isExperienceEnabled(e){return this.hasExperienceVariationsSet()?xe.of(this.isExperienceSet(e)):xe.empty()}passExperienceCondition(){return xe.ofNullable(this._passExperienceAudience)}isExperienceIncluded(e){return this.hasExperienceVariationsSet()?xe.of(this.isExperienceSet(e)):xe.empty()}hasExperienceIds(){if(this.hasExperienceVariationsSet()){const e=Object.keys(this.experienceVariations);return Ji.debug("hasExperienceIds => "+e+" (override)"),xe.of(e)}return xe.empty()}hasVariationIds(e){const t=e.getId();if(this.hasExperienceVariationsSet()&&t in this.experienceVariations){const e=Object.keys(this.experienceVariations[t]);return Ji.debug("hasVariationIds => "+e+" (override)"),xe.of(e)}return xe.empty()}isVariationEnabled(e){return this.hasExperienceVariationsSet()?xe.of(this.isVariationSet(e)):xe.empty()}passVariationCondition(){return xe.ofNullable(this._passVariationAudience)}isControl(){return xe.ofNullable(this._isControl)}saveCustomerStorage(){const e=xe.ofNullable(this._saveCustomerStorage);return e.ifPresent((e=>{Ji.debug(`save CustomerStorage => ${e} (override)`)})),e}sendBrowserEvents(){const e=xe.ofNullable(this._sendBrowserEvents);return e.ifPresent((e=>{Ji.debug(`send BrowserEvent => ${e} (override)`)})),e}sendGoogleAnalytics(){const e=xe.ofNullable(this._sendGoogleAnalytics);return e.ifPresent((e=>{Ji.debug(`send GoogleAnalytics => ${e} (override)`)})),e}sendSegmentAnalytics(){const e=xe.ofNullable(this._sendSegmentAnalytics);return e.ifPresent((e=>{Ji.debug(`send SegmentAnalytics => ${e} (override)`)})),e}sendMixpanel(){const e=xe.ofNullable(this._sendMixpanel);return e.ifPresent((e=>{Ji.debug(`send Mixpanel => ${e} (override)`)})),e}getAttributeDataOverrides(){return __spreadValues({},this.attributeData)}showStatusModule(){return xe.ofNullable(this._showStatusModule)}isExperienceSet(e){return!this._showBasesite&&e.getId()in this.experienceVariations}isVariationSet(e){var t;const i=e.getExperience().getId(),s=e.getId();return Boolean(null==(t=this.experienceVariations[i])?void 0:t[s])}showBasesite(){return xe.ofNullable(this._showBasesite)}hideImage(){return xe.ofNullable(this._hideImage)}hideExperience(){return xe.ofNullable(this._hideExperience)}requestAnimationFrame(){return xe.ofNullable(this._requestAnimationFrame)}hasExperienceVariationsSet(){return!0===this._showBasesite||Object.keys(this.experienceVariations).length>0}}class Bn{constructor(e,t,i){__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"conditionEvaluationRuntime"),__publicField(this,"pages",[]),__publicField(this,"audiences",[]),__publicField(this,"initialized",!1),this.environment=e,this.customer=t,this.conditionEvaluationRuntime=i}reinitialize(){let e=[];this.environment.getHostingPageUrl().getUrl().ifPresent((t=>{e=this.customer.getPages().filter((e=>{const i=e.matches(t,ts.evalBoolean);return Ji.debug(`check page: ${e.getName()} (${e.getId()}) => ${i}`),i}))})),this.pages=e,this.audiences=this.customer.getAudiences().filter((e=>{let t=!1;try{t=e.getCondition().evaluate(this.conditionEvaluationRuntime)}catch(i){const s=es(i);t=!1,s.message="Audience condition evaluation failed "+s.message,Ji.error(s,205,{audienceId:e.getId()})}return Ji.debug(`check audience: ${e.getName()} (${e.getId()}) => ${t}`),t})),this.initialized=!0}getPages(){return this.initialized||Ji.error("PageContext.getPages() called before initialization",151),this.pages}getAudiences(){return this.initialized||Ji.error("PageContext.getAudiences() called before initialization",152),this.audiences}}class jn{update(){}}class Hn{constructor(e,t,i,s){__publicField(this,"environment"),__publicField(this,"localStorage"),__publicField(this,"customer"),__publicField(this,"override"),__publicField(this,"overrideModule"),__publicField(this,"eventLogStorageKey"),__publicField(this,"expVarModel",{campaigns:{}}),__publicField(this,"eventModel",{count:0,campaigns:{}}),this.customer=t,this.environment=e,this.localStorage=s,this.override=i,this.eventLogStorageKey=`${t.getId()}_intellimize_event_log`,this.overrideModule=new jn(this.environment,i,this.customer,this.reinitializeGoalEvents.bind(this)),this.initializeGoalEvents()}reinitializeExperienceVariations(){this.expVarModel={campaigns:{}},this.overrideModule.update({experienceVariations:this.expVarModel})}reinitializeGoalEvents(){this.eventModel={count:0,campaigns:{}},this.writeEventModelToLocalStorage(),this.initializeGoalEvents(),this.overrideModule.update({goalEvents:this.eventModel})}initializeGoalEvents(){this.eventModel=this.readEventModelFromLocalStorage();const e=this.environment.getHostingPageUrl().getUrl().get();this.customer.getEvents().forEach((t=>{let i="custom"===t.getType();(t instanceof ot||t instanceof jt)&&(i=t.getPages().some((t=>t.matches(e,(()=>!0))))),i&&t.getMetrics().forEach((e=>{e.getCampaign().ifPresent((t=>{this.getCampaignEventData(t).metrics[e.getId()]=this.getMetricEventData(e)}))}))})),this.overrideModule.update({goalEvents:this.eventModel})}setCustomer(e,t){this.expVarModel[e]=t,this.overrideModule.update({experienceVariations:this.expVarModel})}setCampaign(e,t,i){this.getCampaignData(e)[t]=i,this.overrideModule.update({experienceVariations:this.expVarModel})}setExperience(e,t,i){this.getExperienceData(e)[t]=i,this.overrideModule.update({experienceVariations:this.expVarModel})}setVariation(e,t,i){this.getVariationData(e)[t]=i,this.overrideModule.update({experienceVariations:this.expVarModel})}setExperienceSortedVariations(e,t){this.getExperienceData(e).variationsSorted=t,this.overrideModule.update({experienceVariations:this.expVarModel})}setMetricEventData(e,t,i,s){if(!e.getCampaign().isPresent())return;this.eventModel=this.readEventModelFromLocalStorage();const n=this.getCampaignEventData(e.getCampaign().get()),r=this.getMetricEventData(e);void 0===r.events[i]?(r.events[i]={name:t.getName(),type:t.getType(),status:s,instanceId:i},this.eventModel.count+=1,n.count+=1,r.count+=1):(r.events[i].status=s,r.events[i].timestamp=s===is.SUCCEEDED?(new Date).toISOString():void 0,r.count=Object.keys(r.events).length),this.overrideModule.update({goalEvents:this.eventModel}),this.writeEventModelToLocalStorage()}getCampaignData(e){return void 0===this.expVarModel.campaigns[e.getId()]&&(this.expVarModel.campaigns[e.getId()]={campaign:e,experiences:{}}),this.expVarModel.campaigns[e.getId()]}getExperienceData(e){const t=this.getCampaignData(e.getCampaign());return void 0===t.experiences&&(t.experiences={}),void 0===t.experiences[e.getId()]&&(t.experiences[e.getId()]={experience:e,variations:{},variationsSorted:[]}),t.experiences[e.getId()]}getVariationData(e){const t=this.getExperienceData(e.getExperience());return void 0===t.variations&&(t.variations={}),void 0===t.variations[e.getId()]&&(t.variations[e.getId()]={variation:e}),t.variations[e.getId()]}getMetricEventData(e){if(!e.getCampaign().isPresent())throw new Ie("Metric not in campaign");const t=this.getCampaignEventData(e.getCampaign().get());return void 0===t.metrics[e.getId()]&&(t.metrics[e.getId()]=this.getInitialMetricEventData(e)),t.metrics[e.getId()]}getCampaignEventData(e){return void 0===this.eventModel.campaigns[e.getId()]&&(this.eventModel.campaigns[e.getId()]={name:e.getName(),count:0,metrics:{}}),this.eventModel.campaigns[e.getId()]}getMetricMeasurement(e){const t=e.getCountingMethod(),i=e.getScope();let s,n;return e instanceof Lt?(n=`$${(e.getValue()/100).toFixed(2)}`,s=`${t} static value per ${i}`):s=e instanceof Vt?`${t} dynamic value per ${i}`:`${t} conversion per ${i}`,{measurement:s,value:n}}getInitialMetricEventData(e){return __spreadValues({name:e.getName(),isGoal:e.isGoal(),events:{},count:0},this.getMetricMeasurement(e))}shouldUseLocalStorage(){let e=!1;return this.override.getExpirationMs().ifPresent((t=>{e=t>Date.now()})),e}deleteEventModelFromLocalStorage(){this.localStorage.delete(this.eventLogStorageKey)}writeEventModelToLocalStorage(){this.shouldUseLocalStorage()&&this.localStorage.write(this.eventLogStorageKey,Si(this.eventModel))}readEventModelFromLocalStorage(){let e=this.eventModel;return this.shouldUseLocalStorage()?this.localStorage.read(this.eventLogStorageKey).ifPresent((t=>{try{e=yi(t)}catch(i){}})):this.deleteEventModelFromLocalStorage(),e}}class Kn{reinitializeExperienceVariations(){}reinitializeGoalEvents(){}setCustomer(e,t){}setCampaign(e,t,i){}setExperience(e,t,i){}setVariation(e,t,i){}setExperienceSortedVariations(e,t){}setMetricEventData(e,t,i,s){}}class Qn{constructor(e,t,i,s){__publicField(this,"storageKey"),__publicField(this,"environment"),__publicField(this,"browserStorage"),__publicField(this,"user"),__publicField(this,"pageviewAttributes",{id:void 0,custom:{},internal:{}}),this.storageKey=ai+e.getId(),this.browserStorage=i,this.environment=t,this.user=s}setCustomAttributes(e,t){const i=this.getAttributeData(e);Object.keys(t).forEach((e=>{i.custom[e]=t[e]})),this.saveAttributeData(e,i)}setInternalAttributes(e,t){const i=this.getAttributeData(e);Object.keys(t).forEach((e=>{i.internal[e]=t[e]})),this.saveAttributeData(e,i)}getCustomAttributes(e,t){const i=this.getAttributeData(e),s={};return Object.keys(i.custom).forEach((e=>{(void 0===t||t.includes(e))&&(s[e]=i.custom[e])})),s}getInternalAttributes(e,t){const i=this.getAttributeData(e),s={};return Object.keys(i.internal).forEach((e=>{(void 0===t||t.includes(e))&&(s[e]="object"==typeof i.internal[e]?yi(Si(i.internal[e])):i.internal[e])})),s}getFlattenedCustomAttributes(){const e=this.getCustomAttributes("user"),t=this.getCustomAttributes("pageview");return Object.keys(t).forEach((i=>{e[i]=t[i]})),e}getFlattenedInternalAttributes(){const e=this.getInternalAttributes("user"),t=this.getInternalAttributes("pageview");return Object.keys(t).forEach((i=>{e[i]=t[i]})),e}deleteCustomAttributes(e,t){const i=this.getAttributeData(e);for(const s in i.custom)Object.prototype.hasOwnProperty.call(i.custom,s)&&(void 0===t||t.includes(s))&&delete i.custom[s];this.saveAttributeData(e,i)}deleteInternalAttributes(e,t){const i=this.getAttributeData(e);void 0===t?i.internal={}:t.forEach((e=>{delete i.internal[e]})),this.saveAttributeData(e,i)}getAttributeData(e){let t,i={id:void 0,custom:{},internal:{}};return"pageview"===e?(i=this.pageviewAttributes,t=this.environment.getPageviewId()):"user"===e?(i=this.readBrowserStorage(),t=this.user.getId()):Ji.error(`Tried to get attribute data for invalid scope ${e}`,49),t!==i.id&&(Ji.debug(`Mismatching IDs ("${t}" != "${i.id}"). Resetting AttributeData`),i.id=t,i.internal={},i.custom={}),i}saveAttributeData(e,t){"pageview"===e||("user"===e?this.saveBrowserStorage(t):Ji.error(`Tried to save attribute data for invalid scope ${e}`,50))}readBrowserStorage(){let e={id:void 0,custom:{},internal:{}};return this.browserStorage.read(this.storageKey).ifPresent((t=>{try{e=yi(t)}catch(i){const e=es(i);e.message=`Could not parse attribute storage\n${e.message}`,Ji.error(e,51)}})),e}saveBrowserStorage(e){const t=Si(e);this.browserStorage.write(this.storageKey,t)}}class qn{constructor(e){__publicField(this,"environment"),__publicField(this,"cookieDomain"),this.environment=e;const t=qn.getCommonDomain(e);t.isPresent()&&(this.cookieDomain=t.get())}static extractKey(e,t){const i=t+"=";let s=xe.empty();return e.readAllCookies().ifPresent((e=>{const t=e.split(";");for(let n of t){for(;n.startsWith(" ");)n=n.slice(1);n.startsWith(i)&&(s=xe.of(n.slice(i.length)))}})),s}static writeAttributes(e,t){const i=[t.name+"="+t.value];void 0!==t.path&&i.push("path="+t.path),void 0!==t.domain&&i.push("domain="+t.domain),void 0!==t.maxAge&&i.push("max-age="+t.maxAge),void 0!==t.expires&&i.push("expires="+t.expires.toUTCString()),void 0!==t.secure&&t.secure&&i.push("secure"),void 0!==t.samesite&&t.samesite&&i.push("samesite");const s=i.join("; ");e.writeCookie(s)}static getCommonDomain(e){let t;return e.getHostName().ifPresent((i=>{const s=i.split(".");if(s.length>1){const i="path=/",n="_intellimizeTest-"+Date.now();for(let r=2;r<=s.length;r+=1){const a="."+s.slice(s.length-r).join("."),o=[n+"="+n,i,"domain="+a];e.writeCookie(o.join("; "));const c=qn.extractKey(e,n);if(c.isPresent()&&c.get()===n){t=a;break}}if(void 0!==t){const s=[n+"="+n,"expires=Thu, 01 Jan 1970 00:00:01 GMT",i,"domain="+t];e.writeCookie(s.join("; "))}}})),xe.ofNullable(t)}write(e,t){Ji.debug("CookieStorage.write("+e+", "+t+")");const i=this.environment.getNowDate();i.setTime(i.getTime()+ii);const s={name:e,value:t,path:"/",domain:this.cookieDomain,expires:i};qn.writeAttributes(this.environment,s)}read(e){return Ji.debug("CookieStorage.read("+e+")"),qn.extractKey(this.environment,e)}delete(e){const t=e+"=";Ji.debug("CookieStorage.delete("+e+")"),this.environment.readAllCookies().ifPresent((i=>{const s=i.split(";");for(let n of s){for(;n.startsWith(" ");)n=n.slice(1);if(n.startsWith(t)){const t=this.environment.getNowDate();t.setTime(t.getTime()-1);const i={name:e,value:"",path:"/",domain:this.cookieDomain,expires:t};qn.writeAttributes(this.environment,i);break}}}))}}const Yn=["xo"],Jn={debug(e,t,i){Ji.debug(e,t,i,Yn)}};class Xn extends rs{constructor(e,t,i){super(),__publicField(this,"localStorage"),__publicField(this,"storageKey"),__publicField(this,"storageDatum"),this.localStorage=e,this.storageKey=t,this.storageDatum=i}toString(){return`StorageCleanupTask(${this.storageKey})`}inTransaction(){return!1}isUnloading(){return!1}getStorageKey(){return this.storageKey}setStorageDatum(e){this.storageDatum=void 0===e?void 0:__spreadValues({},e)}getNotDoneDependencies(){return this.manager.findTasks((e=>!(e instanceof Xn||e.isUnloading()||e.isDone())))}run(){return Jn.debug(`Running storage cleanup task for "${this.storageKey}".`),this.getNotDoneDependencies().length>0?(Jn.debug("Deferring storage cleanup; other tasks still running"),is.TRY_LATER):(void 0===this.storageDatum?(Jn.debug("Deleting data locally because the common origin is empty for this storageKey"),this.localStorage.delete(this.storageKey)):(Jn.debug(`Writing latest data from the common origin to the customer origin. ${Si(this.storageDatum,void 0,2)}`),this.localStorage.write(this.storageKey,Si(this.storageDatum))),is.SUCCEEDED)}}class Zn{constructor(e,t){__publicField(this,"localStorage"),__publicField(this,"taskManager"),this.localStorage=e,this.taskManager=t}run(){return __async(this,null,(function*(){return new Promise((e=>{this.taskManager.isDone()?(Jn.debug("[CleanupTaskManager]: no tasks to run"),e()):(Jn.debug("[CleanupTaskManager]: waiting for all tasks to complete"),this.taskManager.onDone((()=>{e()})))}))}))}queueCleanupTask(e,t){this.findNotDoneCleanupTask(e).ifPresent((i=>{Jn.debug(`Cleanup task already exists for ${e}; updating storageDatum`),i.setStorageDatum(t)})).ifAbsent((()=>{Jn.debug(`Creating cleanup task for ${e} with ${Si(t,void 0,2)}`),this.taskManager.addTask(new Xn(this.localStorage,e,t))}))}findNotDoneCleanupTask(e){const[t]=this.taskManager.findTasks((t=>t instanceof Xn&&t.getStorageKey()===e&&!t.isDone()));return xe.ofNullable(t)}}class er{constructor(e,t,i){__publicField(this,"localStorage"),__publicField(this,"requestId"),__publicField(this,"storageOrigin"),__publicField(this,"message"),__publicField(this,"iframe"),__publicField(this,"resolver"),__publicField(this,"isDone",!1),__publicField(this,"timeStart"),this.localStorage=e,this.requestId=bs(),this.storageOrigin=t,void 0!==i&&this.setMessage(i)}static get MESSAGE_EVENT_TIMEOUT_MS(){return 1e3}getRequestId(){return this.requestId}getStorageKey(){var e;return null==(e=this.message)?void 0:e.storageKey}setMessage(e){let t;this.getExpectedVersion(e.storageKey).ifPresent((e=>{t=e})),this.message=__spreadProps(__spreadValues({},e),{requestId:this.requestId,expectedVersion:t})}setIframe(e){this.iframe=e}send(){return __async(this,null,(function*(){if(void 0===this.iframe)throw new Error("Cannot call send() without setting the iframe");if(void 0===this.message)throw new Error("Cannot call send() without setting the message");const{iframe:e,message:t}=this;yield new Promise(((i,s)=>{var n;try{const r={resolve:i,reject:s};this.resolver=r,null===e.contentWindow?r.resolve():(Jn.debug(`send(): Sending message to storage domain (${this.storageOrigin}) ${Si(t,void 0,2)}`),this.timeStart=new Date,null==(n=e.contentWindow)||n.postMessage(t,this.storageOrigin),setTimeout((()=>{try{this.isDone||s(new Error(`Did not receive response within ${er.MESSAGE_EVENT_TIMEOUT_MS}ms`))}catch(e){const t=es(e);Ji.error(t,174)}}),er.MESSAGE_EVENT_TIMEOUT_MS))}catch(r){s(r)}}))}))}reply(e){if(void 0===this.resolver)throw new Error("Cannot reply to message request if the message has no resolver");if(void 0!==this.timeStart){const e=(new Date).getTime()-this.timeStart.getTime();this.timeStart=void 0,Jn.debug(`XO message round-trip time - ${e}ms`)}e.success?this.resolver.resolve():void 0===e.error?this.resolver.reject(new Error("Message request failed, but there is no error data (unexpected)")):this.resolver.reject(e),this.isDone=!0}getExpectedVersion(e){return this.localStorage.read(e).flatMap((e=>sr.validateStorageDatumString(e))).flatMap((e=>xe.ofNullable(e.version)))}}var tr=(e=>(e.UNEXPECTED="UNEXPECTED",e.LOCALSTORAGE_ACCESS="LOCALSTORAGE_ACCESS",e.INVALID_OP="INVALID_OP",e.INVALID_MESSAGE_FORMAT="INVALID_MESSAGE_FORMAT",e.INVALID_MESSAGE_META_FORMAT="INVALID_MESSAGE_META_FORMAT",e.INVALID_DATUM_FORMAT="INVALID_DATUM_FORMAT",e.UNEXPECTED_VERSION="UNEXPECTED_VERSION",e))(tr||{});function ir(e){return e}class sr{constructor(e,t,i,s){__publicField(this,"taskManager"),__publicField(this,"localStorage"),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"messageRequests"),__publicField(this,"storageKeys"),__publicField(this,"storageOrigin"),__publicField(this,"cleanupTaskManager"),__publicField(this,"isFeatureMissing"),__publicField(this,"iframeLoadPromise"),__publicField(this,"iframe"),this.localStorage=e,this.taskManager=i,this.environment=t,this.messageRequests={},this.customer=s,this.isFeatureMissing=!1;const n="intellimizeio.com";this.storageOrigin=`https://${s.getId()}.${n}`,this.storageKeys=nn.getStorageKeys(s),this.cleanupTaskManager=new Zn(this.localStorage,this.taskManager),this.loadIframe().catch((()=>{this.isFeatureMissing=!0}))}static validateStorageDatumString(e){let t;try{if(t=yi(e),"object"==typeof t&&null!==t&&("string"==typeof t.version||void 0===t.version)&&"string"==typeof t.data)return xe.of(t)}catch(i){Jn.debug(`validateStorageDatumString(): Not a StorageDatum (got ${Si(t)})`)}return xe.empty()}static getNormalizedStorageValue(e){return sr.validateStorageDatumString(e).map((e=>e.data)).orElse(e)}static get READY_MESSAGE_TIMEOUT_MS(){return 3e3}static get WAIT_FOR_DATA_MS(){return 500}static isMessageReply(e){return"object"==typeof e&&null!==e&&"reply"===e.type}get isCrossOriginEnabled(){return!this.isFeatureMissing&&this.customer.getCrossOrigin().isEnabled()}get shouldWaitForData(){if(this.environment.getReferrerUrl().getUrl().isPresent()&&this.environment.getHostingPageUrl().getUrl().isPresent()&&this.environment.getReferrerOrigin().isPresent()){const e=this.environment.getReferrerUrl().getUrl().get(),t=this.environment.getHostingPageUrl().getUrl().get(),i=this.environment.getReferrerOrigin().get();if(this.customer.getCrossOrigin().isOriginAllowed(i)){if(!xs.isRecirculation(e,t))return Jn.debug("shouldWaitForData(): Detected a switch to a different origin."),!0;let i=!1;for(const e of this.storageKeys)if(this.localStorage.read(e).isPresent()){i=!0;break}if(!i)return Ji.warn("shouldWaitForData(): Detected an origin with no data.",63),!0;Jn.debug("shouldWaitForData(): not waiting (user didn't cross origins, and there is existing data in LocalStorage)")}else Jn.debug(`shouldWaitForData(): not waiting (referrer origin not allowed - ${i})`)}else this.environment.getReferrerUrl().getUrl().isPresent()?this.environment.getReferrerOrigin().isPresent()?this.environment.getHostingPageUrl().getUrl().isPresent()||Ji.warn("shouldWaitForData(): not waiting (no hosting page URL - can't determine if user has crossed origins)",64):Jn.debug("shouldWaitForData(): not waiting (no referrer origin - can't determine if referrer origin is allowed)"):Jn.debug("shouldWaitForData(): not waiting (no referrer - can't determine if user has crossed origins");return!1}initialize(){return __async(this,null,(function*(){if(this.isCrossOriginEnabled){Jn.debug("Cross-Origin storage enabled by customer configuration. Persisting LocalStorage operations to the common origin.");const e=this.syncWithCommonOrigin().catch((e=>{const t=es(e);t.message=`Error syncing with common origin\n${t.message}`,Ji.error(t,130),this.isFeatureMissing=!0}));this.shouldWaitForData?(Jn.debug("initialize(): Blocking client execution until xd storage is ready (shouldWaitForData is true)"),yield this.waitForData(e)):Jn.debug("initialize(): Not waiting until xd storage is ready (shouldWaitForData is false)")}else Jn.debug("Cross-Origin storage disabled by customer configuration. Using LocalStorage only.");Jn.debug("crossOriginStorage.initialize() has finished")}))}read(e){const t=this.readFromLocalStorage(e);return this.readAsync(e).catch((()=>{this.isFeatureMissing=!0})),t.flatMap((e=>xe.ofNullable(e.data)))}write(e,t){this.writeAsync(e,t).catch((()=>{this.isFeatureMissing=!0}))}delete(e){this.deleteAsync(e).catch((()=>{this.isFeatureMissing=!0}))}loadIframe(){return __async(this,null,(function*(){if(void 0===this.iframeLoadPromise){const{document:e}=this.environment.getWindow();let t;this.iframe=e.createElement("iframe"),this.iframeLoadPromise=new Promise(((i,s)=>{let n=!1,r=!1;this.iframe.setAttribute("hidden",""),this.iframe.setAttribute("tabIndex","-1"),this.iframe.setAttribute("width","0"),this.iframe.setAttribute("height","0"),this.iframe.setAttribute("style","display:none");let a=`${this.storageOrigin}/storage.html`;Ji.getLevel()<m.OFF&&(a+=`?ideb=${Ji.getLevel()}`),this.iframe.setAttribute("src",a),this.iframe.setAttribute("referrerpolicy","strict-origin-when-cross-origin"),this.iframe.onerror=e=>{Jn.debug("XO iframe onerror callback triggered"),n||r||setTimeout((()=>{try{r=!0;const t=es(e);Ji.error(t,66),s()}catch(t){const e=es(t);Ji.error(e,170)}}),0)};const o=()=>{Jn.debug("XO iframe ready resolver triggered"),r||setTimeout((()=>{var e;try{if(Jn.debug("loadIframe(): iframe is ready"),n=!0,void 0===(null==(e=this.iframe.contentWindow)?void 0:e.postMessage))Ji.error("postMessage() API not supported",65),s(),this.iframe.remove();else{if(void 0!==t){const e=(new Date).getTime()-t.getTime();Jn.debug(`iframe load + ready message time - ${e}ms`)}i(void 0)}}catch(r){const e=es(r);Ji.error(e,171)}}),0)};this.environment.addListener("message",(e=>{this.handleResponse(e,o)})),t=new Date,e.querySelectorAll("head")[0].insertAdjacentElement("afterbegin",this.iframe),setTimeout((()=>{try{n||(r=!0,Ji.error(`iframe did not load & receive "ready" message within ${sr.READY_MESSAGE_TIMEOUT_MS} ms`,67),s())}catch(e){const t=es(e);Ji.error(t,172)}}),sr.READY_MESSAGE_TIMEOUT_MS)}))}return this.iframeLoadPromise}))}readFromLocalStorage(e){return this.localStorage.read(e).flatMap((e=>{try{return xe.of(yi(e))}catch(t){return Ji.error(`readFromLocalStorage(): Unable to parse as JSON (${e})`,68),xe.empty()}}))}writeToLocalStorage(e,t){this.localStorage.write(e,Si(t)),Jn.debug(`writeToLocalStorage(): Wrote "${e}" to LocalStorage (${Si(t,void 0,2)})`)}deleteFromLocalStorage(e){this.localStorage.delete(e),Jn.debug(`deleteFromLocalStorage(): Deleted "${e}" from LocalStorage`)}readAsync(e){return __async(this,null,(function*(){if(Jn.debug(`readAsync(): Called with storageKey: "${e}"`),this.isCrossOriginEnabled){const t=new er(this.localStorage,this.storageOrigin,{requestId:"",op:"read",storageKey:e});yield this.sendMessageRequest(t)}}))}writeAsync(e,t){return __async(this,null,(function*(){let i;if(Jn.debug(`writeAsync(): Called with storageKey: "${e}", data ${t}`),this.isCrossOriginEnabled){const s=new er(this.localStorage,this.storageOrigin);i={version:s.getRequestId(),data:t},s.setMessage({requestId:"",op:"write",storageKey:e,storageDatum:i}),this.writeToLocalStorage(e,i),yield this.sendMessageRequest(s)}else this.writeToLocalStorage(e,{data:t})}))}deleteAsync(e){return __async(this,null,(function*(){if(Jn.debug(`delete(): Called with storageKey: "${e}"`),this.isCrossOriginEnabled){const t=new er(this.localStorage,this.storageOrigin,{requestId:"",op:"delete",storageKey:e});this.deleteFromLocalStorage(e),yield this.sendMessageRequest(t)}else this.deleteFromLocalStorage(e)}))}syncWithCommonOrigin(){return __async(this,null,(function*(){const e=[];this.storageKeys.forEach((t=>{this.readFromLocalStorage(t).ifPresent((({data:i,version:s})=>{s?(Jn.debug(`syncWithCommonOrigin(): Existing storageDatum found with a version (storageKey: ${t}). Sending "read" message to the common origin.`),e.push(this.readAsync(t))):(Jn.debug(`syncWithCommonOrigin(): Existing storageDatum found without a version (storageKey: ${t}). Sending "write" message to the common origin.`),e.push(this.writeAsync(t,i)))})).ifAbsent((()=>{Jn.debug(`syncWithCommonOrigin(): No existing storageDatum found (storageKey: ${t}). Sending "read" message to the common origin.`),e.push(this.readAsync(t))}))})),yield Promise.all(e)}))}sendMessageRequest(e){return __async(this,null,(function*(){try{yield this.loadIframe()}catch(i){return void(this.isFeatureMissing=!0)}const t=e.getRequestId();e.setIframe(this.iframe),this.messageRequests[t]=e;try{yield e.send(),delete this.messageRequests[t]}catch(s){if(delete this.messageRequests[t],sr.isMessageReply(s))this.handleMessageReplyErrors(e,s);else{const e=es(s);e.message=`Could not send message request\n${e.message}`,Ji.error(e,129),this.isFeatureMissing=!0}}}))}handleResponse(e,t){const{data:i,origin:s}=e;if(s!==this.storageOrigin)return;if(Jn.debug(`handleResponse(): Received message event from storage domain (${this.storageOrigin})`),Jn.debug(i),"object"!=typeof i||null===i)return void Ji.error("handleResponse(): Refusing to handle message with invalid response format",69);if("ready"===i.type)return Jn.debug('handleResponse(): Received "ready" message'),void t();if("sync"===i.type)return void this.handleSyncResponse(ir(i));if("reply"!==i.type)return void Ji.error(`handleResponse(): Refusing to handle message with unknown type (${i.type})`,70);const{correlationId:n}=i,r=this.messageRequests[n];void 0!==r?r.reply(i):Ji.error("handleResponse(): Could not find matching message in memory",71)}handleSyncResponse({storageKey:e,storageDatum:t}){this.cleanupTaskManager.queueCleanupTask(e,t)}handleMessageReplyErrors(e,t){const{code:i,msg:s}=t.error;if(Jn.debug(s),i===tr.UNEXPECTED_VERSION)this.handleUnexpectedVersion(e,t);else{if(i!==tr.LOCALSTORAGE_ACCESS)throw new Error(s);Jn.debug("LocalStorage is not accessible on the common origin (i.e. browser security setting)")}}handleUnexpectedVersion(e,t){const i=e.getStorageKey(),{storageDatum:s}=t;if(void 0===s){const e=`handleUnexpectedVersion(): Common origin has no data for storageKey: "${i}"`;Jn.debug(e)}else{const e=`handleUnexpectedVersion(): Common origin for storageKey: "${i}"`;Jn.debug(`${e} ${Si(s,void 0,2)}`)}this.cleanupTaskManager.queueCleanupTask(i,s)}waitForData(e){return __async(this,null,(function*(){return new Promise(((t,i)=>__async(this,null,(function*(){let s=!1;const n=this.environment.getWindow().setTimeout((()=>__async(this,null,(function*(){s=!0;try{t()}catch(e){const t=es(e);Ji.error(t,173)}}))),sr.WAIT_FOR_DATA_MS),r=Date.now();try{const i=yield e,a=Date.now();Jn.debug(`waitForData(): iframe load + data sync time - ${a-r}ms`);const o=yield this.cleanupTaskManager.run(),c=Date.now();Jn.debug(`waitForData(): Cleanup task time - ${c-a}ms`),s?Ji.warn(`waitForData(): Synchronization did not complete within ${sr.WAIT_FOR_DATA_MS}ms. (Took ${c-r}ms)`,72):(Jn.debug(`waitForData(): Sync completed; finished in under ${sr.WAIT_FOR_DATA_MS}ms (Took ${c-r}ms)`),this.environment.getWindow().clearTimeout(n),t([i,o]))}catch(a){s||(this.environment.getWindow().clearTimeout(n),i(a))}}))))}))}}class nr{constructor(e,t,i,s){__publicField(this,"storageKey"),__publicField(this,"browserStorage"),__publicField(this,"environment"),__publicField(this,"override"),this.storageKey=ci+e.getId(),this.browserStorage=i,this.environment=t,this.override=s}static get VERSION(){return 2}static getPath(e,t){if(0===t.length)return e;const i=t[0];return i in e||(e[i]={}),t.splice(0,1),nr.getPath(e[i],t)}getCustomerControlStatus(e){if(!e.isCampaignControl()){const e=this.readState();if(!0===e.c)return xe.of("c");if(!1===e.c)return xe.of("i");this.override.saveCustomerStorage().orElse(!0)&&Ji.warn("Attempting to retrieve control value, but not set",52)}return xe.empty()}updateAndGetControl(e){Ji.debug("updateAndGetControl(campaign)");const t=e.getCustomer();return t.isCampaignControl()?this.setAndGetCampaignControl(e):this.setAndGetCustomerControl(t)}setAndGetCustomerControl(e){_e(!e.isCampaignControl());const t=this.readState(),i=t,s=e.getControlTrafficPercentage().get();return void 0!==t.cpg&&Object.keys(t.cpg).forEach((e=>{void 0!==t.cpg&&(delete t.cpg[e].c,delete t.cpg[e].ct)})),this.setAndGetControl(e,i,t,s)}updateAndGetExperienceInclusion(e){const t=this.environment.getInitializeUnixTime(),i=this.readState(),s=e.getId(),n=e.getCampaign().getId(),r=nr.getPath(i,["cpg",n,"exp",s]);if(e.getInclusionStickyConfig().isSticky()&&void 0!==r.i&&void 0!==r.it){const i=r.it;if(!e.getInclusionStickyConfig().isExpired(t,i)){const t=r.i;return Ji.info(`Experience ${e.getId()} sticky inclusion decision => ${t}`),t}}const a=Math.random()<1-e.getIgnore()/1e4;return r.i=a,r.it=t,this.writeState(i),Ji.info(`Experience ${e.getId()} new inclusion decision => ${a}`),a}getStickyVariation(e){Ji.group("getStickyVariation(experience:"+e.getId()+")");const t=this.environment.getInitializeUnixTime(),i=this.readState(),s=e.getId(),n=e.getCampaign().getId(),r=nr.getPath(i,["cpg",n,"exp",s]);if(e.getVariationStickyConfig().isSticky()&&void 0!==r.v&&void 0!==r.vt){const i=r.vt;if(!e.getVariationStickyConfig().isExpired(t,i))return Ji.debug("found sticky, non-expired variation: "+r.v),Ji.groupEnd(),e.getVariation(r.v)}return Ji.groupEnd(),xe.empty()}getVariation(e){Ji.group("getVariation(experience:"+e.getId()+")");const t=this.readState(),i=e.getId(),s=e.getCampaign().getId(),n=nr.getPath(t,["cpg",s,"exp",i]);return void 0!==n.v?(Ji.groupEnd(),e.getVariation(n.v)):(Ji.groupEnd(),xe.empty())}saveVariationStickySelection(e,t){const i=e.getExperience().getId(),s=e.getExperience().getCampaign().getId(),n=this.readState(),r=nr.getPath(n,["s"]),a=nr.getPath(n,["cpg",s,"exp",i]);e.getId()!==a.v&&Ji.error(`Updating variation page view id in local storage, but variation changed from ${a.v} to ${e.getId()}`,53,{campaignId:s,experienceId:i,variationId:e.getId()}),a.v=e.getId(),a.gpvid=t,a.gsid=r.id,this.writeState(n)}saveVariationPredictionSelection(e,t,i){const s=e.getExperience().getId(),n=e.getExperience().getCampaign().getId(),r=this.readState(),a=nr.getPath(r,["s"]),o=nr.getPath(r,["cpg",n,"exp",s]);o.v=e.getId(),o.vt=this.environment.getNowUnixTime(),o.mv=t,o.gpvid=i,o.gsid=a.id,this.writeState(r)}deleteExperiencePredictionSelection(e){const t=e.getId(),i=e.getCampaign().getId(),s=this.readState(),n=nr.getPath(s,["cpg",i,"exp",t]);delete n.v,delete n.vt,delete n.mv,delete n.gpvid,delete n.gsid,this.writeState(s)}updateAndGetIsCampaignFirstTimeView(e,t){return this.updateAndGetIsFirstTime([e.getId(),"v"],t)}updateAndGetIsCampaignFirstTimeGoal(e,t,i){return this.updateAndGetIsFirstTime([e.getId(),t.getId(),"g"],i)}updateAndGetIsVariationFirstTimeView(e,t){return this.updateAndGetIsFirstTime([e.getExperience().getCampaign().getId(),e.getExperience().getId(),e.getId(),"v"],t)}updateAndGetIsVariationFirstTimeGoal(e,t,i){return this.updateAndGetIsFirstTime([e.getExperience().getCampaign().getId(),t.getId(),e.getExperience().getId(),e.getId(),"g"],i)}getVariationPredictionModelVersion(e){const t=this.readState(),i=nr.getPath(t,["cpg",e.getExperience().getCampaign().getId(),"exp",e.getExperience().getId()]);return xe.ofNullable(i.mv)}getVariationPredictionPageviewId(e){const t=this.readState(),i=nr.getPath(t,["cpg",e.getExperience().getCampaign().getId(),"exp",e.getExperience().getId()]);return xe.ofNullable(i.gpvid)}getVariationPredictionSessionId(e){const t=this.readState(),i=nr.getPath(t,["cpg",e.getExperience().getCampaign().getId(),"exp",e.getExperience().getId()]);return xe.ofNullable(i.gsid)}getPageviewSelections(e){const t=[],i=this.readState();return void 0!==i.cpg&&Object.keys(i.cpg).forEach((s=>{if(void 0!==i.cpg){const n=i.cpg[s];"exp"in n&&Object.keys(n.exp).forEach((i=>{const r=n.exp[i];void 0!==r.v&&"gpvid"in r&&r.gpvid===e&&t.push({campaignId:s,experienceId:i,variationId:r.v})}))}})),t}getSessionId(){const e=this.readState(),t=nr.getPath(e,["s"]);return xe.ofNullable(t.id)}updateAndGetSessionId(){const e=this.environment.getNowUnixTime(),t=this.readState(),i=nr.getPath(t,["s"]);return void 0===i.st&&(i.st=e),(void 0===i.id||void 0===i.t||e-i.t>Jt||e-i.st>Xt)&&(Ji.debug("Starting a new session"),i.id=this.generateSessionId(),i.st=e),Ji.debug("Extending current session"),i.t=e,this.writeState(t),i.id}getUserVisitStatus(e){return this.isFirstSession(e)?"N":"R"}isFirstSession(e){const t=e.getFirstVisitTimeSec();this.updateAndGetSessionId();const i=this.readState(),s=nr.getPath(i,["s"]).st;return Ji.info(`user.getId(): ${e.getId()}`),Ji.info(`userCreationTimeSec: ${t}`),Ji.info(`currentSessionStartTimeSec: ${s}`),Math.abs(t-s)<Jt/2}setAndGetCampaignControl(e){const t=e.getCustomer();_e(t.isCampaignControl());const i=this.readState(),s=nr.getPath(i,["cpg",e.getId()]),n=e.getControlTrafficPercentage().get();return delete i.c,delete i.ct,this.setAndGetControl(t,s,i,n)}setAndGetControl(e,t,i,s){const n=this.environment.getInitializeUnixTime();if(e.getControlStickyConfig().isSticky()||Ji.error("Control is not sticky, but should be",54),e.getControlStickyConfig().isSticky()&&void 0!==t.c&&void 0!==t.ct){const i=t.ct;if(!e.getControlStickyConfig().isExpired(n,i))return Ji.debug("control: "+t.c+" (sticky decision)"),t.c;Ji.error(`Control sticky decision expired. now:${n}, last:${i}`,55)}void 0!==t.c&&Ji.error(`Making new control decision, but c is present: ${t.c}`,56),void 0!==t.ct&&Ji.error(`Making new control decision, but ct is present: ${t.ct}`,57);const r=Math.random()<s;return t.c=r,t.ct=n,this.writeState(i),Ji.debug("control: "+t.c),r}generateSessionId(){return this.environment.getNowUnixTime()+"-"+fs()}updateAndGetIsFirstTime(e,t){let i=!1;const s=this.readState(),n=nr.getPath(s,["uu"]),r=e.join(":");return r in n?n[r]===t&&(i=!0):(n[r]=t,this.writeState(s),i=!0),i}readState(){let e={};return this.browserStorage.read(this.storageKey).ifPresent((t=>{try{e=yi(t)}catch(i){const e=es(i);e.message=`Could not parse customer storage\n${e.message}`,Ji.error(e,58)}})),ye(!Object.prototype.hasOwnProperty.call(e,"vr")||e.vr===nr.VERSION),e}writeState(e){e.vr=nr.VERSION;const t=Si(e);this.override.saveCustomerStorage().orElse(!0)&&this.browserStorage.write(this.storageKey,t)}}class rr{constructor(e,t){__publicField(this,"storageKey"),__publicField(this,"browserStorage"),this.storageKey=`${oi}${e.getId()}`,this.browserStorage=t}setAllDataAndMetadata(e,t){const i={data:e,meta:t};this.browserStorage.write(this.storageKey,Si(i))}getData(e){return this.getAllData().flatMap((t=>xe.ofNullable(t[e])))}getAllData(){return this.getAllDataAndMetadata().flatMap((e=>xe.ofNullable(e.data)))}getMetadata(e){return this.getAllMetdata().flatMap((t=>xe.ofNullable(t[e])))}getAllMetdata(){return this.getAllDataAndMetadata().flatMap((e=>xe.ofNullable(e.meta)))}deleteAll(){this.browserStorage.delete(this.storageKey)}getAllDataAndMetadata(){let e;if(this.browserStorage.read(this.storageKey).ifPresent((t=>{try{e=yi(t)}catch(i){const e=es(i);e.message=`Could not parse integration data storage\n${e.message}`,Ji.error(e,59),this.deleteAll()}})),void 0!==e){const t=e;if(!ls(t)||void 0!==t.__marketoLead)return xe.empty()}return xe.ofNullable(e)}}class ar{constructor(){__publicField(this,"storage"),this.storage={}}write(e,t){this.storage[e]=t}read(e){return xe.ofNullable(this.storage[e])}delete(e){delete this.storage[e]}}class or{constructor(e,t){__publicField(this,"storageKey"),__publicField(this,"browserStorage"),this.storageKey=di+e.getId(),this.browserStorage=t}static fromJson(e){try{const t=yi(e);return xe.of(t)}catch(t){const e=es(t);e.message="Could not build server context from localStorage\n"+e.message,Ji.error(e,157)}return xe.empty()}set(e){this.browserStorage.write(this.storageKey,Si(e))}get(){return this.browserStorage.read(this.storageKey).flatMap((e=>or.fromJson(e)))}clear(){this.browserStorage.delete(this.storageKey)}}var cr={},lr={get exports(){return cr},set exports(e){cr=e}},dr={};!function(e){function t(e,t){var i,s,n,r,a,o,c,l;for(i=3&e.length,s=e.length-i,n=t,a=3432918353,o=461845907,l=0;l<s;)c=255&e.charCodeAt(l)|(255&e.charCodeAt(++l))<<8|(255&e.charCodeAt(++l))<<16|(255&e.charCodeAt(++l))<<24,++l,n=27492+(65535&(r=5*(65535&(n=(n^=c=(65535&(c=(c=(65535&c)*a+(((c>>>16)*a&65535)<<16)&4294967295)<<15|c>>>17))*o+(((c>>>16)*o&65535)<<16)&4294967295)<<13|n>>>19))+((5*(n>>>16)&65535)<<16)&4294967295))+((58964+(r>>>16)&65535)<<16);switch(c=0,i){case 3:c^=(255&e.charCodeAt(l+2))<<16;case 2:c^=(255&e.charCodeAt(l+1))<<8;case 1:n^=c=(65535&(c=(c=(65535&(c^=255&e.charCodeAt(l)))*a+(((c>>>16)*a&65535)<<16)&4294967295)<<15|c>>>17))*o+(((c>>>16)*o&65535)<<16)&4294967295}return n^=e.length,n=2246822507*(65535&(n^=n>>>16))+((2246822507*(n>>>16)&65535)<<16)&4294967295,n=3266489909*(65535&(n^=n>>>13))+((3266489909*(n>>>16)&65535)<<16)&4294967295,(n^=n>>>16)>>>0}e.exports=t}({get exports(){return dr},set exports(e){dr=e}});var ur={};!function(e){function t(e,t){for(var i,s=e.length,n=t^s,r=0;s>=4;)i=1540483477*(65535&(i=255&e.charCodeAt(r)|(255&e.charCodeAt(++r))<<8|(255&e.charCodeAt(++r))<<16|(255&e.charCodeAt(++r))<<24))+((1540483477*(i>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(i=1540483477*(65535&(i^=i>>>24))+((1540483477*(i>>>16)&65535)<<16)),s-=4,++r;switch(s){case 3:n^=(255&e.charCodeAt(r+2))<<16;case 2:n^=(255&e.charCodeAt(r+1))<<8;case 1:n=1540483477*(65535&(n^=255&e.charCodeAt(r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}e.exports=t}({get exports(){return ur},set exports(e){ur=e}});var hr=dr,gr=ur;lr.exports=hr;var pr=cr.murmur3=hr;function mr(e,t){return pr(e,t)}cr.murmur2=gr;const vr=__pow(2,32);function br(e,t){const i=(e>>>0)/vr;return Math.floor(i*t)}class fr{constructor(e,t,i){let s;__publicField(this,"browserStorage"),__publicField(this,"environment"),__publicField(this,"id"),__publicField(this,"storageKey"),this.browserStorage=e,this.environment=t,this.storageKey=`${hi}${i.getId()}`,this.browserStorage.read(this.storageKey).ifPresent((e=>{s=e,Ji.debug(`User: Found existing User ID: ${s}`)})),void 0===s&&(s=this.generateId(),Ji.debug(`User: No existing User ID; generated new ID: ${s}`),this.browserStorage.write(this.storageKey,s)),this.id=s}getId(){if(void 0===this.id)throw new Se("user id not defined");const e=this.browserStorage.read(this.storageKey);return e.isPresent()?e.get()!==this.id&&Ji.error(`User id in memory (${this.id}) not the same as user id in localStorage (${e.get()})`,62):Ji.error("User id is missing from localStorage",61),this.id}isNewVisitor(){const e=this.getFirstVisitTimeSec();return this.environment.getNowUnixTime()-e<Zt}isReturningVisitor(){return!this.isNewVisitor()}getFirstVisitTimeSec(){const e=this.getId().split(".",2);return Number(e[1])}getUserBucket(){const e=100,t=br(mr(this.getId(),1),e);return Math.floor(t+1)}generateId(){const e=this.environment.getNowUnixTime();return`${Es()}.${e}`}}class Er{constructor(e,t,i){__publicField(this,"environment"),__publicField(this,"storageKeyPrefix"),__publicField(this,"eventProcessor"),__publicField(this,"isObserving",!1),__publicField(this,"pollTimer"),this.environment=e,this.storageKeyPrefix=t,this.eventProcessor=i}static get POLLING_INTERVAL_MS(){return 1e3}start(){this.isObserving||(Ji.debug("StorageQueueConsumer starting to poll"),this.isObserving=!0,this.poll())}stop(){Ji.debug("StorageQueueConsumer stopping polling"),this.environment.getWindow().clearTimeout(this.pollTimer),this.isObserving=!1}handlePageUnload(){this.poll(),this.stop()}readSessionStorage(e){try{return this.environment.readSessionStorage(e)}catch(t){const i=es(t);throw i.message=`StorageQueueConsumer: Storage failed for getItem("${e}")\n${i.message}`,Ji.warn(i,227),i}}writeSessionStorage(e,t){try{this.environment.writeSessionStorage(e,t)}catch(i){const t=es(i);throw t.message=`StorageQueueConsumer: Storage failed for setItem("${e}")\n${t.message}`,Ji.warn(t,228),t}}removeSessionStorage(e){try{this.environment.removeSessionStorage(e)}catch(t){const i=es(t);throw i.message=`StorageQueueConsumer: Storage failed for removeItem("${e}")\n${i.message}`,Ji.warn(i,229),i}}poll(){const e=`${this.storageKeyPrefix}lastWrittenId`,t=`${this.storageKeyPrefix}lastReadId`;let i=xe.empty(),s=0;try{i=this.readSessionStorage(e).map((e=>Number.parseInt(e,10))),s=this.readSessionStorage(t).map((e=>Number.parseInt(e,10))).orElse(0)}catch(n){return void this.stop()}if(i.isPresent()&&s<i.get()){const e=s+1,i=`${this.storageKeyPrefix}event-${e}`;let a=xe.empty();try{a=this.readSessionStorage(i)}catch(n){return void this.stop()}try{this.writeSessionStorage(t,e.toString()),this.removeSessionStorage(i)}catch(n){return void this.stop()}if(a.isPresent()){let e;try{e=JSON.parse(a.get())}catch(r){const e=es(r);e.message=`StorageQueueConsumer: Event in queue is not valid JSON: "${a.get()}"`,Ji.error(e,230)}if(void 0!==e)try{Ji.debug(`StorageQueueConsumer processing event ${JSON.stringify(e)}`),this.eventProcessor(e)}catch(r){const e=es(r);e.message="StorageQueueConsumer: Could not process event\n"+e.message,Ji.error(e,231)}this.poll()}else Ji.error(new Error(`StorageQueueConsumer: event-${e} not found in session storage`),232),this.pollAfterDelay()}else this.pollAfterDelay()}pollAfterDelay(){this.environment.getWindow().clearTimeout(this.pollTimer),this.pollTimer=this.environment.getWindow().setTimeout((()=>{this.poll()}),Er.POLLING_INTERVAL_MS)}}class _r{constructor(e,t){__publicField(this,"client"),__publicField(this,"environment"),__publicField(this,"taskQueue",[]),__publicField(this,"completedTasks",[]),__publicField(this,"isRunning",!1),__publicField(this,"isStopping",!1),__publicField(this,"timeoutId"),__publicField(this,"queueChecksum"),__publicField(this,"doneCallbacks",[]),__publicField(this,"latestQueueChecksum"),__publicField(this,"latestQueueTimeMs"),this.client=e,this.environment=t}onDone(e){this.doneCallbacks.push(e)}isDone(){return 0===this.taskQueue.length}hasStarted(){return this.taskQueue.length>0||this.completedTasks.length>0}getClient(){return this.client}addTask(e){Ji.debug("TaskManager.addTask("+e.toString()+")"),this.isStopping?Ji.warn(`Rejecting addTask(${e.toString()}) request since TaskManager is stopping`,35,e.getEntityIds()):(e.setManager(this),this.handleNotDone(e),this.queueChecksum=void 0,this.runAfter(0))}runNow(){Ji.debug("TaskManager run now - synchronously"),this.eventLoop()}findTasks(e){return[...this.taskQueue,...this.completedTasks].filter((t=>e(t)))}stop(){Ji.debug("TaskManager.stop()"),this.isStopping=!0,this.runAfter(0)}eventLoop(){if(Ji.group("TaskManager.eventLoop()"),Ji.time("TaskManager.eventLoop()"),this.isRunning)return Ji.debug("TaskManager called again when already running. Back to work..."),void Ji.groupEnd();if(this.isRunning=!0,this.clearTimeout(),this.taskQueue.length>0&&void 0!==this.latestQueueChecksum&&void 0!==this.latestQueueTimeMs&&this.environment.getNowUnixTimeMs()-this.latestQueueTimeMs>NO_PROGRESS_TOLERANCE_TIME_MS&&!this.isQueueBlocked()){const e=this.extractVictim();void 0===e?Ji.error("Unable to extract latest task when trying to make progress",37):(Ji.error(`Unable to make progress. Canceling task ${e.toString()}. Queue: ${this.queueToString()}`,36,e.getEntityIds()),this.cancelTask(e))}if(this.isStopping?this.stopTasks():this.runTasks(),this.taskQueue.length>0){const e=this.computeChecksum();e!==this.latestQueueChecksum&&(this.latestQueueChecksum=e,this.latestQueueTimeMs=this.environment.getNowUnixTimeMs())}else this.latestQueueChecksum=void 0,this.latestQueueTimeMs=void 0;if(this.taskQueue.length>0)this.isQueueBlocked()?(Ji.debug("TaskManager queue is blocked on WAITING tasks. Sleeping."),this.clearTimeout(),this.latestQueueChecksum=void 0,this.latestQueueTimeMs=void 0):(Ji.debug("TaskManager schedule callback for later"),this.runAfter(Yt));else if(this.isStopping)Ji.debug("TaskManager schedule callback for now"),this.runAfter(0);else{for(Ji.group("TaskManager done"),this.clearTimeout(),this.latestQueueChecksum=void 0,this.latestQueueTimeMs=void 0;this.doneCallbacks.length>0;){const e=this.doneCallbacks.shift();void 0!==e&&(Ji.group("executing done callback"),ts.executeFunction(e,155),Ji.groupEnd())}Ji.groupEnd()}this.isRunning=!1,Ji.timeEnd("TaskManager.eventLoop()"),Ji.groupEnd()}extractVictim(){let e;for(let t=0;t<this.taskQueue.length;t++)this.taskQueue[t].isBlocked()||(void 0===e||this.taskQueue[t].getId()>this.taskQueue[e].getId())&&(e=t);if(void 0!==e)return this.taskQueue.splice(e,1)[0]}stopTasks(){Ji.group("TaskManager.stopTasks()");for(const e of this.completedTasks)e.cleanup();for(;this.taskQueue.length>0;){const e=this.taskQueue.shift();void 0!==e&&(Ji.error(`Stopping and had to cancel task ${e.toString()}`,38,e.getEntityIds()),this.cancelTask(e))}for(;this.completedTasks.length>0;)this.completedTasks.shift();Ji.debug("Cleanup of all Tasks complete. taskQueue and completedTasks are now empty"),Ji.groupEnd(),this.isStopping=!1}cancelTask(e){void 0!==e&&(Ji.debug("Canceling task "+e.toString()),e.cancel(),this.handleDone(e))}handleNotDone(e){this.taskQueue.push(e)}handleDone(e){this.completedTasks.push(e),this.queueChecksum=void 0}runTasks(){Ji.group("TaskManager.runTasks()"),this.queueChecksum=this.computeChecksum();let e=!0;for(;0!==this.taskQueue.length;){const t=this.getUnloadingTasks();if(!e&&0===t.length)break;Ji.debug(`task queue: ${this.queueToString()}`);const i=this.taskQueue.shift();if(void 0===i)continue;let s=!1,n=!1;t.length>0&&(i.isUnloading()&&e?s=!0:0===i.getNotDoneDependencies().length&&(n=!0));const r=this.computeChecksum();let a;s?(Ji.debug(`Skipping unloading task ${i.toString()}. TM in unloading state and still making progress`),a=is.TRY_LATER):i.getStatus()===is.WAITING?(Ji.debug(`Skipping waiting task ${i.toString()}`),a=is.WAITING):(Ji.debug(`TaskManager running ${i.toString()}`),Ji.time(`Task running ${i.toString()}`),a=i.runWrapper(),Ji.timeEnd(`Task running ${i.toString()}`),Ji.debug("TaskManager "+i.toString()+" returned "+is[a]));const o=this.computeChecksum();if(n&&r!==o&&(n=!1),n&&!i.isDone())i.inTransaction()&&Ji.warn(`Unloading ${t[0].toString()} and transaction task is not done. Canceling ${i.toString()}`,39,i.getEntityIds()),this.cancelTask(i);else switch(a){case is.TRY_LATER:this.handleNotDone(i);break;case is.FAILED:case is.SUCCEEDED:this.handleDone(i);break;case is.CANCELED:this.handleDone(i),Ji.debug("Task self-canceled "+i.toString());break;case is.WAITING:this.handleNotDone(i);break;default:this.handleDone(i),Ji.error(`Invalid task status ${a}`,40,i.getEntityIds())}const c=this.computeChecksum();if(c!==this.queueChecksum){if(this.isStopping)break;void 0===this.queueChecksum&&(this.queueChecksum=c)}else e=!1}Ji.debug("No more work to do now."),Ji.groupEnd()}getUnloadingTasks(){return this.taskQueue.filter((e=>e.isUnloading()))}clearTimeout(){void 0!==this.timeoutId&&(Ji.debug("TaskManager clearing timeoutId: "+this.timeoutId),this.environment.getWindow().clearTimeout(this.timeoutId),this.timeoutId=void 0)}runAfter(e){Ji.debug("TaskManager runAfter("+e+"ms)"),this.clearTimeout(),this.timeoutId=this.environment.getWindow().setTimeout((()=>{try{Ji.debug("TaskManager callback triggered"),this.eventLoop()}catch(e){const t=es(e);t.message=`TaskManager exception\n${t.message}`,Ji.error(t,41)}}),e),Ji.debug("TaskManager set new timer: "+this.timeoutId)}computeChecksum(){return this.taskQueue.map((e=>e.getId().toString())).join("-")}queueToString(){return this.taskQueue.map((e=>e.toString())).join(", ")}isQueueBlocked(){return this.taskQueue.every((e=>e.isBlocked()))}}class Sr extends rs{constructor(e,t,i,s,n){super(),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"integrationDataStorage"),__publicField(this,"override"),__publicField(this,"sent",!1),__publicField(this,"deliveryStatus",is.NOT_STARTED),this.environment=e,this.customer=t,this.user=i,this.integrationDataStorage=s,this.override=n}toString(){return`ContextEventTask(${this.environment.getPageviewId()})`}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.deliveryStatus===is.SUCCEEDED?is.SUCCEEDED:this.deliveryStatus===is.FAILED?is.FAILED:(Ji.debug("Waiting for context event delivery confirmation"),is.TRY_LATER)}sendOnce(){this.sent||(Ji.info("Sending context event"),Vs.sendContext(this.environment,this.customer,this.user,this.integrationDataStorage,this.override).then((()=>{Ji.info(`Context ${this.environment.getPageviewId()} event delivery success`),this.deliveryStatus=is.SUCCEEDED})).catch((e=>{const t=es(e);Ji.warn(`Context ${this.environment.getPageviewId()} event delivery failed: ${t.message}`,224),this.deliveryStatus=is.FAILED})),this.sent=!0)}}class yr extends rs{constructor(e,t,i,s,n,r,a,o,c,l,d){super(),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"policy"),__publicField(this,"registeredClickEvents",[]),__publicField(this,"statusModel"),__publicField(this,"pageviewId"),this.environment=e,this.customer=t,this.customerStorage=i,this.attributeStorage=s,this.activityStorage=n,this.user=r,this.override=a,this.pageContext=o,this.serverContext=c,this.policy=l,this.pageviewId=this.environment.getPageviewId(),this.statusModel=d}toString(){return"ConversionEventInstrumentationTask("+this.pageviewId+")"}inTransaction(){return!0}isUnloading(){return!1}cleanup(){Ji.group("ConversionEventInstrumentationTask.cleanup()"),this.registeredClickEvents.forEach((([e,t])=>{Ji.debug('removing handler: events="'+this.getEventName()+'", selector="'+e.getSelector()+'"');try{this.environment.getWindow().document.removeEventListener("click",t,!0)}catch(i){const t=es(i);t.message=`Failed to unregister click event\n${t.message}`,Ji.error(t,194,{eventId:e.getId()})}})),Ji.groupEnd()}run(){return this.instrumentEvents(),is.SUCCEEDED}getEventName(){return"click."+this.pageviewId}instrumentEvents(){Ji.group("instrumentEvents()");const e=this.environment.getPageviewId();this.customer.getEvents().forEach((t=>{(t instanceof ot||t instanceof jt)&&this.instrumentEvent(t,e)})),Ji.groupEnd()}instrumentEvent(e,t){Ji.group("instrumentEvent("+e.getName()+")");const i=this.environment.getHostingPageUrl().getUrl().orElse("unknown");Ji.debug(`check event URL match (at least one match), URL: ${i}`);const s=this.pageContext.getPages(),n=e.getPages().some((e=>s.some((t=>t.getId()===e.getId()))));if(Ji.debug("url match => "+n),n){switch(e.getType()){case"view":this.handleEvent(e,t);break;case"click":this.instrumentClickEvent(e);break;default:Ji.error(`Invalid event type ${e.getType()}`,77,{eventId:e.getId()})}Ji.groupEnd()}else Ji.groupEnd()}handleEvent(e,t,i){Ji.group(`handleEvent(${e.getName()}, ${t})`),Ji.debug("handleEvent run code");if(!e.executeCode(ts.evalBoolean))return void Ji.groupEnd();Ji.debug("handleEvent send conversion event");const s=new Rs(e,t,void 0,i);this.activityStorage.add(an.buildConversionActivity(s,this.customer,this.environment,this.user,this.attributeStorage,this.customerStorage));const n=new $s(s,this.environment,this.customer,this.customerStorage,this.attributeStorage,this.pageContext,this.serverContext,this.policy,this.user,this.override,this.statusModel);this.manager.addTask(n),Ji.groupEnd(),"click"===e.getType()&&this.manager.runNow()}instrumentClickEvent(e){Ji.group("instrumentClickEvent("+e.getName()+")"),Ji.info(`Instrument click event ${e.getId()}, selector ${e.getSelector()}`),Ji.debug('adding handler: events="'+this.getEventName()+'", selector="'+e.getSelector()+'"');const t=t=>{if(t.target instanceof HTMLElement&&t.target.closest(e.getSelector())instanceof Element)try{const i=this.environment.generateActionId();this.handleEvent(e,i,t)}catch(i){const t=es(i);t.message=`Failed to handle click event\n${t.message}`,Ji.error(t,167,{eventId:e.getId()})}};try{this.environment.getWindow().document.addEventListener("click",t,!0)}catch(i){const t=es(i);t.message=`Failed to register click event\n${t.message}`,Ji.error(t,193,{eventId:e.getId()})}this.registeredClickEvents.push([e,t]),Ji.groupEnd()}}function Ir(e){let t;return e.read(mi).ifPresent((e=>{const i=e.indexOf("token:");-1!==i&&(t=e.slice(Math.max(0,i+6)))})),xe.ofNullable(t)}function Cr(e){return e.getIntegrationMarketo().map((e=>e.isEnabled())).orElse(!1)}class Tr extends rs{constructor(e,t,i=[]){if(super(),__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"dependencies"),__publicField(this,"deliveryStatus",is.NOT_STARTED),__publicField(this,"sent",!1),!Cr(e))throw new Error("Marketo integration must be enabled for the customer to use the MarketoIdAssociatorTask");this.customer=e,this.user=t,this.dependencies=i}static get ENDPOINT(){return"/marketo-id-associator"}toString(){return`MarketoIdAssociatorTask(user: ${this.user.getId()})`}inTransaction(){return!0}isUnloading(){return!1}getNotDoneDependencies(){const e=[];return this.dependencies.forEach((t=>{t.isDone()||e.push(t)})),e}run(){return this.getNotDoneDependencies().length>0?is.TRY_LATER:(this.sendOnce(),this.deliveryStatus===is.SUCCEEDED?is.SUCCEEDED:this.deliveryStatus===is.FAILED?is.FAILED:(Ji.debug("Waiting for marketo id association response confirmation"),is.TRY_LATER))}sendOnce(){if(!this.sent){const e=this.customer.getId(),t=this.user.getId();Ji.info(`Sending marketo id association request. Customer: ${e} User: ${t}`);const i={customerId:this.customer.getId(),intellimizeUserId:this.user.getId()};zi(ni,Tr.ENDPOINT,{method:"POST",body:Si(i)}).then((()=>{Ji.info("Successfully sent marketo id association request"),this.deliveryStatus=is.SUCCEEDED})).catch((e=>{const t=es(e);Ji.error(t,82),this.deliveryStatus=is.FAILED})),this.sent=!0}}}const Ar=class extends rs{constructor(e,t,i,s,n){if(super(),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"attributeStorage"),__publicField(this,"cookieStorage"),__publicField(this,"startTimeMs"),!Cr(t))throw new Error("Marketo integration must be enabled for the customer to use the MarketoCookieTask");this.environment=e,this.customer=t,this.user=i,this.attributeStorage=s,this.cookieStorage=n,this.startTimeMs=this.environment.getNowUnixTimeMs()}toString(){return"MarketoCookieTask()"}inTransaction(){return!1}isUnloading(){return!1}run(){const e=this.environment.getNowUnixTimeMs(),t=Ir(this.cookieStorage);if(t.isPresent()){Ji.debug("marketo cookie present; setting up user alias task to associate w/ intellimize user");const e=new wn(this.customer,this.user,"__marketoCookie",t.get(),this.attributeStorage);if(this.manager.addTask(e),this.environment.getUrlParameter(Ei,T).isPresent()){const t=new Tr(this.customer,this.user,[e]);this.manager.addTask(t)}return is.SUCCEEDED}return e-this.startTimeMs>=Ar.WAIT_FOR_MKTO_COOKIE_MS?(Ji.warn(`marketo cookie not present on the page within ${Ar.WAIT_FOR_MKTO_COOKIE_MS}ms`,81),is.SUCCEEDED):(Ji.debug("marketo cookie not present; Will try again later."),is.TRY_LATER)}};let xr=Ar;__publicField(xr,"WAIT_FOR_MKTO_COOKIE_MS",5e3);const wr=class extends rs{constructor(e,t,i){if(super(),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"startTimeMs"),!Cr(t))throw new Error("Marketo integration must be enabled for the customer to use the MarketoFormsTask");this.environment=e,this.customer=t,this.user=i,this.startTimeMs=this.environment.getNowUnixTimeMs()}toString(){return"MarketoFormsTask()"}inTransaction(){return!1}isUnloading(){return!1}run(){const e=this.environment.getNowUnixTimeMs(),t=this.environment.getWindow();if(void 0!==t.MktoForms2)return Ji.debug("marketo forms library ready"),this.attachFormHandlers(t.MktoForms2),is.SUCCEEDED;return e-this.startTimeMs>=wr.WAIT_FOR_MKTOFORMS2_MS?(Ji.debug(`marketo forms library not present on the page within ${wr.WAIT_FOR_MKTOFORMS2_MS}ms`),is.SUCCEEDED):(Ji.debug("marketo forms library not present; Will try again later."),is.TRY_LATER)}attachFormHandlers(e){e.whenReady((e=>{Ji.debug(`attaching success handler to marketo (Form ID: ${Si(e)})`),e.onSuccess((()=>{Ji.debug(`success handler fired for marketo form; triggering lead association request (Form ID: ${Si(e)})`);const t=new Tr(this.customer,this.user);this.manager.addTask(t)}))}))}};let kr=wr;__publicField(kr,"WAIT_FOR_MKTOFORMS2_MS",5e3);class Fr extends rs{toString(){return"PageUnloadingTask()"}inTransaction(){return!1}isUnloading(){return!0}run(){return Ji.debug("page unload no-op done"),is.SUCCEEDED}}class Pr extends rs{constructor(e,t,i,s,n,r,a,o,c){super(),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"user"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"policy"),__publicField(this,"override"),__publicField(this,"sent",!1),__publicField(this,"deliveryStatus",is.NOT_STARTED),this.environment=e,this.customer=t,this.user=i,this.customerStorage=s,this.attributeStorage=n,this.pageContext=r,this.serverContext=a,this.policy=o,this.override=c}toString(){return`PageviewEventTask(${this.environment.getPageviewId()})`}inTransaction(){return!0}isUnloading(){return!1}run(){return this.sendOnce(),this.deliveryStatus===is.SUCCEEDED?is.SUCCEEDED:this.deliveryStatus===is.FAILED?is.FAILED:(Ji.debug("Waiting for pageview event delivery confirmation"),is.TRY_LATER)}sendOnce(){this.sent||(Ji.info("Sending pageview event"),Vs.sendPageview(this.environment,this.customer,this.user,this.customerStorage,this.attributeStorage,this.pageContext,this.serverContext,this.policy,this.override).then((()=>{Ji.info(`Pageview ${this.environment.getPageviewId()} event delivery success`),this.deliveryStatus=is.SUCCEEDED})).catch((e=>{const t=es(e);Ji.warn(`Pageview ${this.environment.getPageviewId()} event delivery failed: ${t.message}`,83),this.deliveryStatus=is.FAILED})),this.sent=!0)}}var Dr=(e=>(e[e.TS=0]="TS",e[e.TZ=1]="TZ",e[e.DP=2]="DP",e[e.WP=3]="WP",e[e.US=4]="US",e[e.UM=5]="UM",e[e.UCM=6]="UCM",e[e.UT=7]="UT",e[e.UCN=8]="UCN",e[e.UPN=9]="UPN",e[e.UPNV=10]="UPNV",e[e.CAN=11]="CAN",e[e.CANV=12]="CANV",e[e.PID=13]="PID",e[e.IFTU=14]="IFTU",e[e.AID=15]="AID",e))(Dr||{});const Mr="=",Nr="-";class Or{static buildBrowserContext(e,t,i,s,n){const r=t.getInternalAttributes("user"),a=[];n.getExperiences().forEach((e=>{if("cc"!==e.getType()){const t=n.getVariationIds(e.getId());1===t.length?a.push(t[0]):Ji.error("Non-cc experience does not have exactly one variation selected",181,{experienceId:e.getId()})}}));const o={isFirstTimeUser:i.isNewVisitor(),timestamp:e.getNowUnixTime(),customAttributes:t.getFlattenedCustomAttributes(),pageIds:s.getPages().map((e=>e.getId())),audienceIds:s.getAudiences().map((e=>e.getId())),selectedVariationIds:a};return void 0!==r.ts&&(o.trafficSource=r.ts),o.timeZone=e.getTimeZone(),void 0!==r.uts&&(o.utmSource=r.uts),void 0!==r.utm&&(o.utmMedium=r.utm),void 0!==r.utcm&&(o.utmCampaign=r.utcm),void 0!==r.utt&&(o.utmTerm=r.utt),void 0!==r.utcn&&(o.utmContent=r.utcn),e.getHostingPageUrl().getUrl().ifPresent((e=>{o.hostingPageUrl=e})),o}static buildFeatures(e,t,i,s){const n={},r=t.getInternalAttributes("user");return Or.addFeature(n,0,Or.getFeatureFromAttribute(r.ts)),Or.addFeature(n,4,Or.getFeatureFromAttribute(r.uts)),Or.addFeature(n,5,Or.getFeatureFromAttribute(r.utm)),Or.addFeature(n,6,Or.getFeatureFromAttribute(r.utcm)),Or.addFeature(n,7,Or.getFeatureFromAttribute(r.utt)),Or.addFeature(n,8,Or.getFeatureFromAttribute(r.utcn)),Or.addFeature(n,9,Or.getUrlParameterName(e)),Or.addFeature(n,10,Or.getUrlParameterNameValue(e)),Or.addFeature(n,1,Or.getTimeZoneValue(e)),Or.addFeature(n,2,Or.getDayPartValue(e)),Or.addFeature(n,3,Or.getWeekPartValue(e)),Or.addFeature(n,11,Or.getCustomAttributeName(t)),Or.addFeature(n,12,Or.getCustomAttributeNameValue(t)),Or.addFeature(n,13,Or.getPageId(s)),Or.addFeature(n,14,Or.getIsFirstTimeUser(i)),Or.addFeature(n,15,Or.getAudienceId(s)),n}static getFeatureFromAttribute(e){return xe.ofNullable(e).toArray()}static getTimeZoneValue(e){return[e.getTimeZone()]}static getDayPartValue(e){return[e.getDayPart()]}static getWeekPartValue(e){return[e.getWeekPart()]}static getUrlParameterName(e){return Object.keys(e.getAllUrlParamsEncoded()).filter((e=>""!==e))}static getUrlParameterNameValue(e){const t=e.getAllUrlParamsEncoded(),i=[];return Object.keys(t).forEach((e=>{t[e].forEach((t=>{i.push(e+Nr+t)}))})),i}static getCustomAttributeName(e){const t=e.getFlattenedCustomAttributes();return Object.keys(t)}static getCustomAttributeNameValue(e){const t=e.getFlattenedCustomAttributes();return Object.keys(t).map((e=>e+Nr+t[e]))}static getPageId(e){return e.getPages().map((e=>e.getId()))}static getIsFirstTimeUser(e){return[e.isNewVisitor().toString()]}static getAudienceId(e){return e.getAudiences().map((e=>e.getId()))}static buildUnaryFeature(e,t){return Dr[e]+Mr+t}static addFeature(e,t,i){i.forEach((i=>{e[Or.buildUnaryFeature(t,i)]=!0}))}}class Rr{constructor(e){__publicField(this,"id"),__publicField(this,"timestamp"),__publicField(this,"experiences",{}),this.id=fe(e.id),this.timestamp=fe(e.timestamp),fe(e.experiences),Object.keys(e.experiences).forEach((t=>{this.experiences[t]={modelVersion:fe(e.experiences[t].modelVersion),variationId:fe(e.experiences[t].variationId)}}))}static buildControlPolicy(e){return new Ur(e)}getId(){return this.id}getTimestamp(){return this.timestamp}getExperienceModelVersion(e){return void 0===this.experiences[e]?(Ji.info(`PolicyV5 could not find experience ${e}`),"NA"):this.experiences[e].modelVersion}getExperienceVariationId(e){return void 0===this.experiences[e]?(Ji.info(`PolicyV5 could not find experience ${e}`),"NA"):this.experiences[e].variationId}toJson(){return Si({id:this.id,timestamp:this.timestamp,experiences:this.experiences})}}class Ur extends Rr{constructor(e){super({id:"control-policy",timestamp:e.getNowUnixTime(),experiences:{}})}getExperienceModelVersion(e){return"control-experience"}getExperienceVariationId(e){return zt}}class Vr{constructor(){__publicField(this,"variationLists",{}),__publicField(this,"experiences",{}),__publicField(this,"pages",{}),__publicField(this,"stickyVariations",{}),__publicField(this,"modelVersions",{})}unshift(e){const t=e.getExperience(),i=t.getId();void 0===this.variationLists[i]&&(this.variationLists[i]=[]),this.variationLists[i].unshift(e),this.experiences[i]=t}isEmpty(){return!Object.keys(this.variationLists).some((e=>this.variationLists[e].length>0))}setPage(e,t){this.pages[e]=t}getPage(e){return this.pages[e]}getExperience(e){return this.experiences[e]}getExperiences(){return Object.keys(this.variationLists).map((e=>this.experiences[e]))}setModelVersion(e,t){this.modelVersions[e]=t}getModelVersion(e){return this.modelVersions[e]}sortVariations(e,t){var i;null==(i=this.variationLists[e])||i.sort(t)}prioritizeStickyVariation(e,t){if(Ji.group("prioritizeVariation(experience:"+e+", variation:"+t+")"),e in this.variationLists){let i=-1;this.variationLists[e].forEach(((e,s)=>{e.getId()===t&&(i=s)})),Ji.debug("found variation index? => "+i),-1!==i&&(this.variationLists[e]=[this.variationLists[e][i]],e in this.stickyVariations||(this.stickyVariations[e]={}),this.stickyVariations[e][t]=!0)}Ji.groupEnd()}getVariationIds(e){var t,i;return null!=(i=null==(t=this.variationLists[e])?void 0:t.map((e=>e.getId())))?i:[]}hasNext(e){const t=this.variationLists[e];return void 0!==t&&t.length>0}shift(e){var t;if(!(e in this.variationLists))throw new Ie("No value present");const i=null==(t=this.variationLists[e])?void 0:t.shift();if(this.removeIfEmpty(e),void 0!==i)return i;throw new Ie("No value present")}getFirst(e){var t;const i=this.variationLists[e];if(void 0===i)throw new Ie("No experience present");if(0===i.length)throw new Ie("No variations present");const s=null==(t=this.variationLists[e])?void 0:t[0];if(void 0!==s)return s;throw new Ie("No value present")}removeVariation(e,t){t.getId();const i=this.variationLists[e];if(void 0!==i){let s=-1;i.forEach(((e,i)=>{e.getId()===t.getId()&&(s=i)})),-1!==s&&(i.splice(s,1),this.removeIfEmpty(e))}}removeExperience(e){e in this.experiences&&delete this.experiences[e],e in this.variationLists&&delete this.variationLists[e]}isDecidingExperience(e){return e.getId()in this.experiences}isStickyVariation(e){var t;const i=e.getId(),s=e.getExperience().getId();return Boolean(null==(t=this.stickyVariations[s])?void 0:t[i])}toString(){let e="{\n";return Object.keys(this.variationLists).forEach((t=>{e+="  "+t+": ",e+="["+this.variationLists[t].map((e=>e.getId())).join(", ")+"]",e+="\n"})),e+="}\n",e}removeIfEmpty(e){const t=this.variationLists[e];void 0!==t&&0===t.length&&this.removeExperience(e)}}class Lr extends rs{constructor(e,t,i,s,n,r,a,o,c,l,d,u,h,g){super(),__publicField(this,"environment"),__publicField(this,"customer"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"activityStorage"),__publicField(this,"user"),__publicField(this,"override"),__publicField(this,"pageContext"),__publicField(this,"serverContext"),__publicField(this,"statusModel"),__publicField(this,"changeAppliers"),__publicField(this,"runtime"),__publicField(this,"hider"),__publicField(this,"decisionContext"),__publicField(this,"getVariationRecordedCallbackTuples"),__publicField(this,"getEligibleCc",!1),__publicField(this,"selectAb",!1),__publicField(this,"selectRbp",!1),__publicField(this,"haveRunCampaignCode",{}),this.environment=e,this.customer=t,this.customerStorage=i,this.attributeStorage=s,this.activityStorage=n,this.user=r,this.override=a,this.pageContext=o,this.serverContext=c,this.statusModel=l,this.changeAppliers=d,this.runtime=u,this.hider=h,this.getVariationRecordedCallbackTuples=g,this.decisionContext=new Vr}toString(){return"SelectVariationsTask()"}inTransaction(){return!1}isUnloading(){return!1}selectAbExperienceVariationsOnce(){this.selectAb||(Ji.time("selectAbExperienceVariationsOnce"),Ji.group("selectAbExperienceVariationsOnce()"),this.customer.getCampaigns().forEach((e=>{Ve.filterExperiences(e.getExperiences()).filter((e=>this.isExperienceEligible(e))).forEach((t=>{let i;if(this.runCampaignCodeOnce(e),this.override.hasVariationIds(t).isPresent()){const e=this.override.hasVariationIds(t).get();i=t.getVariation(e[0])}else{const e=1e3,s=br(mr(t.getId()+this.user.getId(),1),e);i=t.selectVariation(s)}i.ifPresent((e=>{this.isVariationEligible(e)?(this.decisionContext.unshift(e),this.decisionContext.setModelVersion(t.getId(),"ab")):Ji.error("Selected A/B variation is not eligible",182,{experienceId:t.getId(),variationId:e.getId()})})).ifAbsent((()=>{Ji.error("Failed to select variation for A/B experience",183,{experienceId:t.getId()})}))}))})),Ji.groupEnd(),Ji.timeEnd("selectAbExperienceVariationsOnce"),this.selectAb=!0)}selectRbpExperienceVariationsOnce(){this.selectRbp||(Ji.time("selectRbpExperienceVariationsOnce"),Ji.group("selectRbpExperienceVariationsOnce()"),this.customer.getCampaigns().forEach((e=>{Mt.filterExperiences(e.getExperiences()).filter((e=>this.isExperienceEligible(e))).forEach((t=>{this.runCampaignCodeOnce(e);for(const e of t.getPrioritizedVariations())if(this.isVariationEligible(e)){this.decisionContext.unshift(e),this.decisionContext.setModelVersion(t.getId(),"rbp");break}void 0===this.decisionContext.getExperience(t.getId())&&Ji.info("Failed to select variation for RBP",184,{experienceId:t.getId()})}))})),Ji.groupEnd(),Ji.timeEnd("selectRbpExperienceVariationsOnce"),this.selectRbp=!0)}getCcEligibleVariationsOnce(){this.getEligibleCc||(Ji.time("getCcEligibleVariationsOnce"),Ji.group("getCcEligibleVariationsOnce()"),this.customer.getCampaigns().forEach((e=>{nt.filterExperiences(e.getExperiences()).filter((e=>this.isExperienceEligible(e))).forEach((t=>{this.runCampaignCodeOnce(e);const i=this.override.isControl().orElseRun((()=>this.customerStorage.updateAndGetControl(e)));if(this.statusModel.setCampaign(e,"control",i),i){const e=t.getControlVariation();this.decisionContext.unshift(e)}else t.getRealVariations().forEach((e=>{this.isVariationEligible(e)&&this.decisionContext.unshift(e)}))}))})),Ji.groupEnd(),Ji.timeEnd("getCcEligibleVariationsOnce"),this.getEligibleCc=!0)}isExperienceEligible(e){Ji.group("isExperienceEligible(experience:"+e.getId()+")"),Ji.debug(`Experience URL match (at least one match), URL: ${this.environment.getHostingPageUrl().getUrl().get()}`);const t=this.pageContext.getPages(),i=e.getPages().filter((e=>t.some((t=>t.getId()===e.getId()))));if(Ji.debug("url match => "+(i.length>0)),this.statusModel.setExperience(e,"urlMatch",i.length>0),0===i.length)return Ji.groupEnd(),!1;i.length>0&&Ji.info(`Experience ${e.getId()} URL check, URL:${this.environment.getHostingPageUrl().getUrl().get()} Page:${i[0].getName()} => true`),this.decisionContext.setPage(e.getId(),i[0]),Ji.debug("check experience enabled");let s=" (override)";const n=this.override.isExperienceEnabled(e).orElseRun((()=>(s="",e.isEnabled())));if(Ji.info(`Experience ${e.getId()} enabled => ${n}${s}`),this.statusModel.setExperience(e,"enabled",n),!n)return this.customerStorage.deleteExperiencePredictionSelection(e),Ji.groupEnd(),!1;Ji.debug("check experience condition");let r=" (override)";const a=this.override.passExperienceCondition().orElseRun((()=>(r="",Ji.debug("evaluating experience condition"),e.getCondition().map((t=>{let i=!1;try{i=t.evaluate(this.runtime)}catch(s){const t=es(s);i=!1,t.message="Experience condition evaluation failed "+t.message,Ji.error(t,206,{experienceId:e.getId()})}return i})).orElse(!0))));if(Ji.info(`Experience ${e.getId()} condition passed => ${a}${r}`),this.statusModel.setExperience(e,"passCondition",a),!a)return Ji.groupEnd(),this.customerStorage.deleteExperiencePredictionSelection(e),!1;Ji.debug("check experience inclusion");let o=" (override)";const c=this.override.isExperienceIncluded(e).orElseRun((()=>(o="",this.customerStorage.updateAndGetExperienceInclusion(e))));return Ji.info(`Experience ${e.getId()} inclusion => ${c}${o}`),this.statusModel.setExperience(e,"inclusion",c),c?(Ji.debug("isExperienceEligible => true"),Ji.groupEnd(),!0):(Ji.groupEnd(),this.customerStorage.deleteExperiencePredictionSelection(e),!1)}isVariationEligible(e){Ji.group("isVariationEligible(variation:"+e.getId()+")"),Ji.debug("check variation enabled");let t=" (override)";const i=this.override.isVariationEnabled(e).orElseRun((()=>(t="",e.isEnabled())));if(Ji.info(`Variation ${e.getExperience().getId()}/${e.getId()} enabled => ${i}${t}`),this.statusModel.setVariation(e,"enabled",i),!i)return Ji.groupEnd(),!1;Ji.debug("check variation condition");let s=" (override)";const n=this.override.passVariationCondition().orElseRun((()=>(s="",e.getCondition().map((t=>{let i=!1;try{i=t.evaluate(this.runtime)}catch(s){const t=es(s);i=!1,t.message="Variation condition evaluation failed "+t.message,Ji.error(t,207,{experienceId:e.getExperience().getId(),variationId:e.getId()})}return i})).orElse(!0))));return Ji.info(`Variation ${e.getExperience().getId()}/${e.getId()} condition passed => ${n}${s}`),this.statusModel.setVariation(e,"passCondition",n),n?(Ji.debug("isVariationEligible => true"),Ji.groupEnd(),!0):(Ji.groupEnd(),!1)}runCampaignCodeOnce(e){const t=e.getId();this.haveRunCampaignCode[t]||(this.haveRunCampaignCode[t]=!0,e.getCss().ifPresent((i=>{try{Ji.info(`Injecting campaign ${e.getId()} css`),ts.injectCss(i,`campaign-${t}`,this.environment.getWindow().document),this.statusModel.setCampaign(e,"css",!0)}catch(s){const t=es(s);t.message=`Campaign (${e.getId()}) css injection failed\n${t.message}`,Ji.error(t,90,{campaignId:e.getId()}),this.statusModel.setCampaign(e,"css",!1)}})),e.getCode().ifPresent((t=>{try{Ji.info(`Running campaign ${e.getId()} code`),ts.eval(t),this.statusModel.setCampaign(e,"code",!0)}catch(i){const t=es(i);t.message=`Campaign (${e.getId()}) code execution failed\n${t.message}`,Ji.error(t,14,{campaignId:e.getId()}),this.statusModel.setCampaign(e,"code",!1)}})))}}class $r extends Lr{constructor(){super(...arguments),__publicField(this,"policyCallbackFunctions",[]),__publicField(this,"executeExperiencesTask"),__publicField(this,"policy"),__publicField(this,"sent",!1),__publicField(this,"apiStatus",is.WAITING)}static get PREDICTION_ENDPOINT(){return"/prediction"}toString(){return"SelectVariationsTaskV5()"}onPolicyReady(e){void 0===this.policy?this.policyCallbackFunctions.push(e):e(this.policy)}run(){return this.selectAbExperienceVariationsOnce(),this.selectRbpExperienceVariationsOnce(),this.getCcEligibleVariationsOnce(),Ji.debug("decisionContext: "+this.decisionContext),void 0===this.executeExperiencesTask&&(this.executeExperiencesTask=new In(this.environment,this.attributeStorage,this.activityStorage,this.customerStorage,this.decisionContext,this.pageContext,this.serverContext,this.user,this.override,this.statusModel,this.changeAppliers,this.hider,!0,this.getVariationRecordedCallbackTuples)),this.executeExperiencesTask.hideExperiencesOnce(),this.sendOnce(),this.apiStatus===is.FAILED?is.FAILED:this.apiStatus===is.SUCCEEDED?is.SUCCEEDED:is.TRY_LATER}buildRequest(){const e=this.user.getId(),t=this.customerStorage.updateAndGetSessionId(),i=this.override.isControl().orElseRun((()=>this.customerStorage.setAndGetCustomerControl(this.customer))),s={};nt.filterExperiences(this.decisionContext.getExperiences()).forEach((e=>{const t=e.getId(),i=this.customerStorage.getStickyVariation(e).map((e=>e.getId())).orElse("NEVER_MATCH");s[t]=this.decisionContext.getVariationIds(t).map((e=>({variationId:e,isSticky:i===e})))}));const n=Or.buildBrowserContext(this.environment,this.attributeStorage,this.user,this.pageContext,this.decisionContext);return{userId:e,sessionId:t,isControl:i,candidates:s,context:n}}sendOnce(){this.sent||(Ji.debug("SelectVariationsTaskV5.sendOnce()"),zi(si,`${$r.PREDICTION_ENDPOINT}/${this.customer.getId()}`,{method:"POST",body:Si(this.buildRequest())}).then((e=>{Ji.debug("SelectVariationsTaskV5.sendOnce() => got reply");const t=this.override.isControl().orElseRun((()=>this.customerStorage.setAndGetCustomerControl(this.customer)));this.policy=t?Rr.buildControlPolicy(this.environment):new Rr(e.policy),this.prioritizeCcVariations(this.policy),this.apiStatus=is.SUCCEEDED,this.executePolicyReadyFunctions(this.policy),this.executeExperiencesTask.setPolicy(this.policy),this.manager.addTask(this.executeExperiencesTask),this.manager.runNow()})).catch((e=>{const t=es(e);t.message="Caught exception in prediction call: "+t.message,Ji.error(t,148),this.apiStatus=is.FAILED})),this.sent=!0)}prioritizeCcVariations(e){Ji.debug("SelectVariationsTaskV5.prioritizeCcVariations()"),nt.filterExperiences(this.decisionContext.getExperiences()).forEach((t=>{const i=t.getId(),s=e.getExperienceVariationId(i);let n;for(;this.decisionContext.hasNext(i);){const e=this.decisionContext.shift(i);e.getId()===s&&(n=e)}void 0===n?Ji.error("Prediction API did not select an eligible variation",149):(this.decisionContext.unshift(n),this.customerStorage.getStickyVariation(this.decisionContext.getExperience(i)).ifPresent((e=>{Ji.info(`Variation ${i}/${e.getId()} selection was sticky`),this.decisionContext.prioritizeStickyVariation(i,e.getId())})),this.decisionContext.setModelVersion(i,e.getExperienceModelVersion(i))),this.statusModel.setExperienceSortedVariations(this.decisionContext.getExperience(i),this.decisionContext.getVariationIds(i))})),Ji.debug(`decisionContext: ${this.decisionContext}`)}executePolicyReadyFunctions(e){Ji.debug("SelectVariationsTaskV5.executePolicyReadyFunctions()");for(let t=this.policyCallbackFunctions.shift();void 0!==t;t=this.policyCallbackFunctions.shift())t(e)}}const zr=Fn("sf","lh"),Wr=Fn("sf","ch");function Gr(e){return e.getIntegrationSalesforce().map((e=>e.isEnabled())).orElse(!1)}function Br(e){const t=e.getUrlParameter(zr,T),i=e.getUrlParameter(Wr,T);if(t.isPresent()||i.isPresent()){const e={};return t.ifPresent((t=>{e.leadIdHash=t})),i.ifPresent((t=>{e.contactIdHash=t})),xe.of(e)}return xe.empty()}class jr extends rs{constructor(e,t,i){super(),__publicField(this,"customer"),__publicField(this,"integrationDataStorage"),__publicField(this,"user"),__publicField(this,"apiStatus",is.NOT_STARTED),__publicField(this,"sent",!1),this.customer=e,this.user=t,this.integrationDataStorage=i}static get ENDPOINT(){return"/context-v2"}toString(){return"ServerContextTask()"}inTransaction(){return!1}isUnloading(){return!1}run(){return this.sendOnce(),this.apiStatus===is.SUCCEEDED?is.SUCCEEDED:this.apiStatus===is.FAILED?is.FAILED:(Ji.debug("Waiting for server response"),is.TRY_LATER)}buildRequestBody(){return this.getCommonRequestBody()}handleResponse(e,t){this.integrationDataStorage.setAllDataAndMetadata(t.integrationData,{})}sendOnce(){if(!this.sent){const e=this.buildRequestBody();zi(si,`${jr.ENDPOINT}/${this.customer.getId()}`,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(e)}).then((t=>{this.handleResponse(e,t),this.apiStatus=is.SUCCEEDED,Ji.info("Successfully retrieved ServerContext"),this.manager.runNow()})).catch((e=>{const t=es(e);t.message=`Caught exception in server context task: ${t.message}`,Ji.error(t,156),this.apiStatus=is.FAILED}))}this.sent=!0}getCommonRequestBody(){return{clientVersion:Qt,userId:this.user.getId()}}}class Hr extends jr{constructor(e,t,i,s,n,r){super(t,i,s),__publicField(this,"environment"),__publicField(this,"serverContextStorage"),__publicField(this,"isNewSession"),this.environment=e,this.serverContextStorage=n,this.isNewSession=r}static shouldWaitForServerContext(e,t,i,s,n){let r=!1;Gr(e)&&Br(t).ifPresent((e=>{const t=i.getMetadata("salesforce").orElse({});void 0!==(null==e?void 0:e.leadIdHash)&&(null==t?void 0:t.leadIdHash)!==e.leadIdHash&&(r=!0),void 0!==(null==e?void 0:e.contactIdHash)&&(null==t?void 0:t.contactIdHash)!==e.contactIdHash&&(r=!0)}));const a=s.get(),o=!a.flatMap((e=>xe.ofNullable(e.domain))).isPresent(),c=!a.map((e=>Object.keys(null==e?void 0:e.location).length>0&&Object.keys(null==e?void 0:e.userAgent).length>0)).orElse(!1);return r||o||c||n}buildRequestBody(){const e=super.buildRequestBody();if(this.serverContextStorage.get().ifPresent((({domain:t,clientIp:i})=>{void 0===t||this.isNewSession||(e.domain=t),void 0!==i&&(e.clientIp=i)})),Gr(this.customer)){const t=this.integrationDataStorage.getMetadata("salesforce").orElse({}),i=Br(this.environment),s=null==t?void 0:t.leadIdHash,n=i.map((e=>null==e?void 0:e.leadIdHash)).orElse(void 0),r=null!=n?n:s,a=null==t?void 0:t.contactIdHash,o=i.map((e=>null==e?void 0:e.contactIdHash)).orElse(void 0),c=null!=o?o:a;if(void 0!==r||void 0!==c){const t={};void 0!==r&&(t.leadIdHash=r),void 0!==c&&(t.contactIdHash=c),e.salesforce=t}}return e}handleResponse(e,t){const i=t,{integrationData:s}=i,n=__objRest(i,["integrationData"]),r={};void 0!==e.salesforce&&(r.salesforce=e.salesforce);this.serverContextStorage.get().map((e=>e.domain)).orElse(void 0)===n.domain&&(this.integrationDataStorage.getData("firmographic").ifPresent((e=>{s.firmographic=e})).ifAbsent((()=>{delete s.firmographic})),this.integrationDataStorage.getData("6sense").ifPresent((e=>{s["6sense"]=e})).ifAbsent((()=>{delete s["6sense"]}))),this.integrationDataStorage.setAllDataAndMetadata(s,r),this.serverContextStorage.set(n)}}const Kr=class{constructor(e,t,i){__publicField(this,"localWindow"),__publicField(this,"override"),__publicField(this,"defaultExperienceHideType"),__publicField(this,"experiences",{}),this.localWindow=e,this.override=t,this.defaultExperienceHideType=i}static revealAll(e){Kr._revealDocument(e),Kr._revealAllExperienceRegions(e)}static get HTML_CLASS_NAME(){return"anti-flicker"}static get EXPERIENCE_TIMEOUT_MS(){return 3e3}static get EXPERIENCE_HTML_ATTRIBUTE_NAME(){return`${Kr.ELEMENT_DATA_ATTRIBUTE_NAME_PREFIX}rendering`}static get EXPERIENCE_ELEMENT_ATTRIBUTE_NAME_PREFIX(){return`${Kr.ELEMENT_DATA_ATTRIBUTE_NAME_PREFIX}exp-`}static _revealDocument(e){Ji.debug(`Hider.revealDocument() - before:${e.documentElement.className}`),e.documentElement.className=e.documentElement.className.replace(new RegExp(` ?${Kr.HTML_CLASS_NAME}`,"g"),""),Ji.debug(`Hider.revealDocument() - after:${e.documentElement.className}`)}static _revealAllExperienceRegions(e){Ji.info(`Removing ${Kr.EXPERIENCE_HTML_ATTRIBUTE_NAME} attribute`),e.documentElement.removeAttribute(Kr.EXPERIENCE_HTML_ATTRIBUTE_NAME)}revealDocument(){Kr._revealDocument(this.localWindow.document)}startTimedExperienceHider(){Ji.debug("Hider.startTimedExperienceHider()"),this.localWindow.document.documentElement.setAttribute(Kr.EXPERIENCE_HTML_ATTRIBUTE_NAME,"true"),this.localWindow.setTimeout((()=>{Kr._revealAllExperienceRegions(this.localWindow.document),Object.keys(this.experiences).forEach((e=>{this.experiences[e].revealed||Ji.warn("Experience was not revealed before timeout",209,{experienceId:e})}))}),Kr.EXPERIENCE_TIMEOUT_MS)}hideExperiences(e){const t=e.map((e=>e.getId())).join(", ");Ji.debug(`Hider.hideExperiences(${t})`);const i=[];for(const n of e){this.experiences[n.getId()]={selectors:[],revealed:!1};for(const e of this.getExperienceSelectors(n))this.experiences[n.getId()].selectors.push(e),i.push(`html[${Kr.EXPERIENCE_HTML_ATTRIBUTE_NAME}] ${e}:not([${Kr.EXPERIENCE_ELEMENT_ATTRIBUTE_NAME_PREFIX}${n.getId()}])`)}let s;switch(this.override.hideExperience().orElse(this.defaultExperienceHideType)){case"opacity":s="opacity: 0";break;case"visibility":s="visibility: hidden"}if(s){Ji.debug(`Hider.hideExperiences() - hiding experiences with ${s}`);const e=`${i.join(", ")} { ${s} !important; }`;ts.injectCss(e,"hider",this.localWindow.document)}}revealExperience(e){const t=e.getId();Ji.debug(`Hider.revealExperience(${t})`),void 0===this.experiences[t]&&(Ji.warn("Revealing experience that was never hidden",208,{experienceId:t}),this.experiences[t]={selectors:[],revealed:!1});const i=this.experiences[t],{selectors:s}=i;if(s.length>0){const t=this.localWindow.document.querySelectorAll(s.join(", "));Array.prototype.forEach.call(t,(t=>{t.setAttribute(`${Kr.EXPERIENCE_ELEMENT_ATTRIBUTE_NAME_PREFIX}${e.getId()}`,"true")}))}i.revealed=!0}getExperienceSelectors(e){let t=!1;const i={},s=e.getBoundingSelectors();return e.getRealVariations().forEach((e=>{e.isTypeChange()?e.getChanges().forEach((e=>{e.getType()===B.ATTRIBUTE||e.getType()===B.MOVE_ELEMENT?i[e.getSelector()]=!0:e.getType()===B.CUSTOM_CODE&&(t=!0)})):e.isRedirect()?i.body=!0:t=!0})),t&&s.forEach((e=>{i[e]=!0})),Object.keys(i)}};let Qr=Kr;__publicField(Qr,"ELEMENT_DATA_ATTRIBUTE_NAME_PREFIX","data-intellimize-");const qr=["mutations"],Yr={debug(e,t,i){Ji.debug(e,t,i,qr)},group(e){Ji.group(e,qr)},groupEnd(){Ji.groupEnd(qr)},time(e){Ji.time(e,qr)},timeEnd(e){Ji.timeEnd(e,qr)}},Jr=2,Xr=1,Zr=Xr,ea=class{constructor(){__publicField(this,"mutationObserver"),__publicField(this,"mutationHandlers",{}),__publicField(this,"currentUrl"),this.mutationObserver=new MutationObserver((e=>{if(Object.keys(this.mutationHandlers).length>0){if(Yr.group("MutationObserver.observe() - window.location.href: "+window.location.href),this.currentUrl||(this.currentUrl=window.location.href),this.currentUrl!==window.location.href)return Yr.debug("MutationObserver skip processing since URL changed"),void Yr.groupEnd();ea.containsValidMutations(e)?(Yr.debug("mutationList contains at least one valid mutation; processing store"),this.processStore()):Yr.debug("mutationList contains no valid mutations; skipping store processing"),Yr.groupEnd()}})),this.reset()}static get CALLBACK_MAX_COUNT(){return 25}static get MISSING_ELEMENT_MAX_COUNT(){return 5}static get CALLBACK_THROTTLE_MS(){return 50}static selectorExists(e){try{return Boolean(document.querySelector(e))}catch(t){return!1}}static isProcessed(e,t){var i,s,n,r;switch(Zr){case Xr:return"string"==typeof(null==(i=e.imizeObserverProcessed)?void 0:i[t])||!0===(null==(s=e.imizeObserverProcessed)?void 0:s[t])?(Yr.debug('isProcessed (OPT_CHECK_BOOL): imizeObserverProcessed is "true"'),!0):(Yr.debug('isProcessed (OPT_CHECK_BOOL): imizeObserverProcessed is NOT "true"'),!1);case Jr:return"string"==typeof(null==(n=e.imizeObserverProcessed)?void 0:n[t])||!0===(null==(r=e.imizeObserverProcessed)?void 0:r[t])?e.imizeObserverProcessed[t]===e.outerHTML?(Yr.debug("isProcessed (OPT_COMPARE_HTML): imizeObserverProcessed outerHTML matches"),!0):(Yr.debug("isProcessed (OPT_COMPARE_HTML): imizeObserverProcessed outerHTML DOES NOT match"),Yr.debug(`outerHTML: ${e.outerHTML}`),Yr.debug(`imizeObserverProcessed: ${e.imizeObserverProcessed[t]}`),e.imizeObserverProcessed[t]=!1,!1):(Yr.debug("isProcessed (OPT_COMPARE_HTML): imizeObserverProcessed does not exist on the element"),!1);default:return Yr.debug("isProcessed (OPT_ALWAYS_CALLBACK): skipping check"),!1}}static setIsProcessed(e,t){switch(void 0===e.imizeObserverProcessed&&(e.imizeObserverProcessed={}),Zr){case Xr:e.imizeObserverProcessed[t]=!0;break;case Jr:e.imizeObserverProcessed[t]=e.outerHTML}}static isValidNodeNameMutation(e){var t;if(ea.INVALID_NODE_NAMES.includes(e.target.nodeName))return Yr.debug(`Invalid mutation - Node is one of ${Si(ea.INVALID_NODE_NAMES)}`),!1;if(!0===(null==(t=e.attributeName)?void 0:t.startsWith(Qr.ELEMENT_DATA_ATTRIBUTE_NAME_PREFIX)))return!1;if("childList"===e.type){if(Array.prototype.every.call([...Array.prototype.slice.call(e.addedNodes),...Array.prototype.slice.call(e.removedNodes)],(e=>ea.INVALID_NODE_NAMES.includes(e.nodeName))))return Yr.debug("Invalid mutation - All nodes in child list contain one of "+Si(ea.INVALID_NODE_NAMES)),!1}return!0}static isUnchangedAttributeMutation(e){const{target:t,type:i,attributeName:s,oldValue:n}=e;if(t instanceof HTMLElement&&"attributes"===i&&s){const e=t.attributes.getNamedItem(s);if(null!==e&&e.value===n)return Yr.debug(`Invalid mutation - value for attribute "${s}" hasn't changed (value: "${n}")`),!0}return!1}static isStatusModuleNode(e){const t="intellimize____status-module-root";return e instanceof HTMLElement&&(e.id===t?(Yr.debug("Invalid mutation - Node is part of the status module"),!0):null!==e.parentNode&&ea.isStatusModuleNode(e.parentNode))}static containsValidMutations(e){Yr.group("containsValidMutations()");const t=e.every((e=>(Yr.debug(`Mutation: ${Ii(e)}`),!(ea.isValidNodeNameMutation(e)&&!ea.isUnchangedAttributeMutation(e)&&!ea.isStatusModuleNode(e.target))||(Yr.debug("Found valid mutation"),!1))));return Yr.groupEnd(),!t}reset(){Yr.debug("Resetting ElementObserver state"),this.mutationHandlers={},this.currentUrl=void 0,this.detachObserver()}registerSelectorAndExecute(e,t,i={}){if(!ea.selectorExists(e))throw new Error(`Selector "${e}" does not exist in the DOM`);const s=bs();return this.mutationHandlers[s]={selector:e,callback:t,options:i,startTime:new Date,mutationCnt:0,missingElementCnt:0},Yr.group(`registerSelectorAndExecute(${s})`),Yr.debug("Manually calling handleObservation()"),this.detachObserver(),this.handleObservation(s,!1),this.attachObserver(),Yr.groupEnd(),()=>{this.cancelObservation(s)}}attachObserver(){Yr.debug("Attaching observer to document"),this.mutationObserver.observe(document.documentElement,ea.observerOpts)}detachObserver(){Yr.debug("Detaching observer from document"),this.mutationObserver.disconnect()}processStore(){Yr.group("ElementObserver.processStore()"),Yr.debug(`mutationHandlers: ${Si(this.mutationHandlers)}`),this.detachObserver(),Object.keys(this.mutationHandlers).forEach((e=>{this.handleObservation(e,!0)})),this.attachObserver(),Yr.groupEnd()}handleObservation(e,t){const i=this.mutationHandlers[e];if(Yr.group(`handleObservation(${e})`),t&&i.options.observationTimeMs&&Date.now()-i.startTime.getTime()>i.options.observationTimeMs)return 0===i.mutationCnt?void 0!==i.options.onTimeout&&(Ji.error(`MutationHandler timed out for ${i.selector}. observationTimeMs (${i.options.observationTimeMs}) has passed.`,140),i.options.onTimeout()):Ji.warn(`Observation cancelled for ${i.selector}. observationTimeMs (${i.options.observationTimeMs}) has passed.`,141),this.cancelObservation(e),void Yr.groupEnd();if(i.mutationCnt>=ea.CALLBACK_MAX_COUNT)return Yr.debug(`Reached CALLBACK_MAX_COUNT (${ea.CALLBACK_MAX_COUNT})`),this.cancelObservation(e),void Yr.groupEnd();if(void 0!==i.lastCallbackTime){const e=Date.now()-i.lastCallbackTime.getTime();if(e<ea.CALLBACK_THROTTLE_MS)return Yr.debug(`Throttling callback (${ea.CALLBACK_THROTTLE_MS}ms). Only (${e})ms have elapsed`),void Yr.groupEnd()}const s=document.querySelectorAll(i.selector);if(Yr.debug(`Found ${s.length} matching elements`),s.length>0){const n=t=>!ea.isProcessed(t,e)||void 0!==i.options.shouldReapply&&i.options.shouldReapply(t);Array.prototype.forEach.call(s,(s=>{if(Yr.debug(`Processing element: ${Ci(s)}`),!t||n(s)){Yr.debug("isProcessed: false");let n="Triggering callback for element";t&&(i.mutationCnt+=1,i.lastCallbackTime=new Date,n+=` (mutationCnt: ${i.mutationCnt})`),Yr.debug(n),i.callback(s),ea.setIsProcessed(s,e),i.options.once&&this.cancelObservation(e)}else Yr.debug("isProcessed: true (skipping)")}))}else Ji.warn(`Could not find any matching elements for ${i.selector}`,139),i.missingElementCnt+=1,i.missingElementCnt>=ea.MISSING_ELEMENT_MAX_COUNT&&(Yr.debug(`Reached MISSING_ELEMENT_MAX_COUNT (${ea.MISSING_ELEMENT_MAX_COUNT})`),this.cancelObservation(e));Yr.groupEnd()}cancelObservation(e){delete this.mutationHandlers[e]}};let ta=ea;__publicField(ta,"INVALID_NODE_NAMES",["HTML","SCRIPT","LINK","STYLE","HEAD","BODY","IFRAME","TITLE","META"]),__publicField(ta,"observerOpts",{subtree:!0,childList:!0,attributes:!0,characterData:!0,attributeOldValue:!0,characterDataOldValue:!0});class ia extends ws{constructor(){super(...arguments),__publicField(this,"hasRun",!1),__publicField(this,"isRestartingStatus",!1),__publicField(this,"isEditorMode",!1),__publicField(this,"taskManager"),__publicField(this,"environment"),__publicField(this,"override"),__publicField(this,"customer"),__publicField(this,"conditionEvaluationRuntime"),__publicField(this,"pageContext"),__publicField(this,"customerStorage"),__publicField(this,"attributeStorage"),__publicField(this,"integrationDataStorage"),__publicField(this,"serverContextStorage"),__publicField(this,"intellimizeApi"),__publicField(this,"user"),__publicField(this,"browserStorage"),__publicField(this,"cookieStorage"),__publicField(this,"localStorage"),__publicField(this,"statusModel"),__publicField(this,"changeAppliers"),__publicField(this,"attributeData"),__publicField(this,"activityStorage"),__publicField(this,"internalApi"),__publicField(this,"hider"),__publicField(this,"shopifyConsumer")}run(){return __async(this,null,(function*(){if(Ji.info("Starting client"),Ji.time("Client run time"),this.hasRun)return void Ji.error("Tried to run client again",143);Ji.time("new Environment");const e=Ln(window);this.environment=new Os(window,e),Ji.configureEnvironment(this.environment),Ji.timeEnd("new Environment"),this.isEditorMode=this.environment.getUrlParameter("imize_editor",zn("true")).isPresent();const t=this.isEditorMode?"editor mode (imize_editor=true)":"production mode (imize_editor!=true)";Ji.info(`Client running in ${t}`);if(void 0!==this.environment.getWindow().ipgvidtfr)return void Ji.error("Intellimize duplicate code detected on page.",144);this.environment.getWindow().ipgvidtfr=this.environment.getPageviewId();if(this.environment.getUrlParameter("intellimize_no_run",zn("true")).isPresent()&&!this.isEditorMode)return Ji.info("Client not running since intellimize_no_run=true"),this.environment.getWindow().inrsgew=!0,void Qr.revealAll(this.environment.getWindow().document);this.override=new Gn(this.environment,this.isEditorMode),this.hider=new Qr(this.environment.getWindow(),this.override,"visibility"),this.hider.startTimedExperienceHider(),this.localStorage=new nn(this.environment);const i=this.environment.getWindow()[Fi(this.environment)];if(void 0===i)return Ji.error("Missing customer JSON. Aborting.",145),void Qr.revealAll(this.environment.getWindow().document);let s;if(Ji.time("load json"),ws.iE(i))try{s=wi(this.environment,i)}catch(u){const e=es(u);return e.message="Could not decrypt CustomerJson\n"+e.message,Ji.error(e,213),void Qr.revealAll(this.environment.getWindow().document)}else try{s=yi(i)}catch(u){const e=es(u);return e.message="Could not parse CustomerJson\n"+e.message,Ji.error(e,210),void Qr.revealAll(this.environment.getWindow().document)}const n=Kt(s);Ji.timeEnd("load json"),Ji.time("Build customer object time");const r=new Ht(Ji);this.customer=r.buildCustomer(n),Ji.timeEnd("Build customer object time"),Ji.configureCustomer(this.customer),this.intellimizeApi=new Dn(this.environment),this.intellimizeApi.initialize(),this.taskManager=new _r(this,this.environment);const a=new ta;if(this.changeAppliers=new As(this.taskManager,this.environment,this.isEditorMode,this.override,a),this.isEditorMode)this.hider.revealDocument();else{const e=`${gi}${this.customer.getId()}`;let t="true"===this.localStorage.read(e).orElse("false");if(t||this.environment.getUrlParameter("intellimize_opt_out",zn("true")).ifPresent((()=>{t=this.environment.getWindow().confirm("Are you sure you want to opt out of Intellimize for this domain?"),t&&(this.localStorage.write(e,"true"),this.environment.getWindow().alert("You have successfully opted out of Intellimize for this domain."))})),t)return Ji.debug("User opt-out; cleanup and exit early"),nn.getStorageKeys(this.customer).forEach((t=>{t!==e&&this.localStorage.delete(t)})),this.hider.revealDocument(),void(this.environment.getWindow().inrsgew=!0)}if(Ji.time("Setup storage"),Ji.time("new CookieStorage"),this.cookieStorage=new qn(this.environment),Ji.timeEnd("new CookieStorage"),Ji.time("initialize browserStorage"),this.isEditorMode)this.browserStorage=new ar;else{const e=new sr(this.localStorage,this.environment,this.taskManager,this.customer);yield e.initialize(),this.browserStorage=e}Ji.timeEnd("initialize browserStorage"),this.user=new fr(this.browserStorage,this.environment,this.customer),Ji.configureUser(this.user),this.statusModel=this.override.showStatusModule().orElse(!1)?new Hn(this.environment,this.customer,this.override,this.browserStorage):new Kn,this.customerStorage=new nr(this.customer,this.environment,this.browserStorage,this.override);const o=this.customerStorage.getSessionId(),c=this.customerStorage.updateAndGetSessionId(),l=!o.map((e=>e===c)).orElse(!1);this.customer.isCampaignControl()||this.customerStorage.setAndGetCustomerControl(this.customer),this.attributeStorage=new Qn(this.customer,this.environment,this.browserStorage,this.user),this.activityStorage=new an(this.customer,this.browserStorage,this.environment),Ji.time("updateInternalAttributes"),ws.updateInternalAttributes(this.environment,this.attributeStorage),Ji.timeEnd("updateInternalAttributes"),this.integrationDataStorage=new rr(this.customer,this.browserStorage),this.serverContextStorage=new or(this.customer,this.browserStorage),Ji.timeEnd("Setup storage"),this.environment.addUnloadHandler((()=>{this.handlePageUnload()}));const d=new Hr(this.environment,this.customer,this.user,this.integrationDataStorage,this.serverContextStorage,l);Hr.shouldWaitForServerContext(this.customer,this.environment,this.integrationDataStorage,this.serverContextStorage,l)?d.onDone((()=>{this.postServerContextWork()})):this.postServerContextWork(),this.taskManager.addTask(d),this.hasRun=!0,Ji.timeEnd("Client run time"),this.taskManager.runNow()}))}reRun(e){Ji.info("Client.reRun()"),this.isRestartingStatus=!0,this.handlePageUnload(),this.environment.getWindow().setTimeout((()=>{this.taskManager.stop(),this.taskManager.onDone((()=>{this.statusModel.reinitializeExperienceVariations(),this.environment.reinitialize(),this.changeAppliers.reinitialize(),this.customerStorage.updateAndGetSessionId(),ws.updateInternalAttributes(this.environment,this.attributeStorage),this.attributeData.reinitialize(),this.internalApi.reinitialize(),e.forEach((e=>{ts.executeFunction(e,150)})),this.activityStorage.add(an.buildPageviewActivity(this.customer,this.environment,this.user,this.attributeStorage,this.customerStorage)),this.pageContext.reinitialize(),ws.runCustomerCode(this.customer,this.statusModel,this.environment.getWindow().document),this.scheduleTasks(),this.isRestartingStatus=!1}))}),0)}isRestarting(){return Ji.debug(`Client.isRestarting() => ${this.isRestartingStatus}`),this.isRestartingStatus}postServerContextWork(){Ji.time("postServerContextWork");const e=this.serverContextStorage.get();if(!e.isPresent())return void Ji.error("Expected ServerContext is missing",146);const t=e.get();Ji.debug(`postServerContextWork() serverContext: ${Si(t)}`),Ji.configureServerContext(t),this.attributeData=new Zi(this.environment,t,this.attributeStorage,this.override,this.customerStorage,this.integrationDataStorage,this.user),this.conditionEvaluationRuntime=new ks(this.attributeData,this.activityStorage),this.pageContext=new Bn(this.environment,this.customer,this.conditionEvaluationRuntime);const i=new Pn(this.environment,this.taskManager,this.customerStorage,this.attributeStorage,this.activityStorage,this.integrationDataStorage,this.pageContext,t,void 0,this.customer,this.user,this.override,this.statusModel,this.intellimizeApi.extractCallQueue(),this.intellimizeApi.extractReadyCallbackQueue(),(e=>{this.addVariationRecordedCallbackTuple(e)}));i.initialize(),this.internalApi=new Mn(this.customer,this.user,this.environment,t,this.taskManager,this.browserStorage,this.customerStorage,i,this.attributeData),this.internalApi.initialize(),this.activityStorage.add(an.buildPageviewActivity(this.customer,this.environment,this.user,this.attributeStorage,this.customerStorage)),ws.runCustomerCode(this.customer,this.statusModel,this.environment.getWindow().document),this.pageContext.reinitialize(),this.scheduleTasks(i),this.isEditorMode&&this.environment.injectScript("https://intellimizeditor.com/common.js"),Ji.timeEnd("postServerContextWork")}scheduleTasks(e){const t=this.serverContextStorage.get();if(!t.isPresent())return void Ji.error("Expected ServerContext is missing",147);const i=t.get();if(Ji.debug(`scheduleTasks() serverContext: ${Si(i)}`),!this.isEditorMode){const t=new $r(this.environment,this.customer,this.customerStorage,this.attributeStorage,this.activityStorage,this.user,this.override,this.pageContext,i,this.statusModel,this.changeAppliers,this.conditionEvaluationRuntime,this.hider,this.getVariationRecordedCallbackTuples.bind(this));if(t.onPolicyReady((t=>{void 0!==e&&e.setPolicy(t),Ji.debug(`scheduleTasks() onPolicyReady() serverContext: ${Si(i)}`);const s=new yr(this.environment,this.customer,this.customerStorage,this.attributeStorage,this.activityStorage,this.user,this.override,this.pageContext,i,t,this.statusModel),n=new Pr(this.environment,this.customer,this.user,this.customerStorage,this.attributeStorage,this.pageContext,i,t,this.override),r=new Sr(this.environment,this.customer,this.user,this.integrationDataStorage,this.override);this.taskManager.addTask(n),this.taskManager.addTask(r),this.taskManager.addTask(s),Bs(this.customer)&&(Ji.debug("Shopify Pixel enabled for customer"),this.shopifyConsumer=new Er(this.environment,`${pi}${this.customer.getId()}_`,(e=>{js(e,this.customer,this.environment,this.customerStorage,this.attributeStorage,this.activityStorage,this.pageContext,i,t,this.user,this.override,this.statusModel,this.taskManager)})),this.shopifyConsumer.start())})),this.taskManager.addTask(t),Cr(this.customer)){const e=new xr(this.environment,this.customer,this.user,this.attributeStorage,this.cookieStorage),t=new kr(this.environment,this.customer,this.user);this.taskManager.addTask(e),this.taskManager.addTask(t)}}}handlePageUnload(){var e;Ji.debug("(Prepare for Shutdown): handlePageUnload() giving the client one more chance to run tasks..."),null==(e=this.shopifyConsumer)||e.handlePageUnload();this.taskManager.findTasks((e=>!e.isDone())).length>0&&(this.taskManager.addTask(new Fr),this.taskManager.runNow())}}function sa(e,t){return i=>{Ji.time("frameTick");const s=null!=t?t:i;i-s<e&&window.requestAnimationFrame(sa(e,s)),Ji.timeEnd("frameTick")}}function na(){new MutationObserver((e=>{Yr.time(`mutations: ${e.length}`),e.forEach((e=>{Yr.debug(`Doc mutation: ${Ii(e)}`)})),Yr.timeEnd(`mutations: ${e.length}`)})).observe(document.documentElement,{subtree:!0,childList:!0,attributes:!0,characterData:!0,attributeOldValue:!0,characterDataOldValue:!0})}(()=>{__async(this,null,(function*(){try{Ji.time("client startup time"),Ji.getLevel()<=m.DEBUG&&(window.requestAnimationFrame(sa(2e3)),na());const e=new ia;yield e.run(),Ji.timeEnd("client startup time")}catch(e){Qr.revealAll(document);const t=es(e);Ji.error(t,142)}}))})()}();

