fourSq.views.Map=function(a,b){};
fourSq.views.Map=fourSq.ui.View.extend({initialize:function(){this.pins={};this.mapLoaded=!1;this.initialZoom=16;this.motionListeners=[];this.userAccThreshold=2E3;this.userAcc=1E5;this.userLoc=fourSq.api.models.companion.geo.LatLngUtil.toLeaflet(fourSq.api.models.companion.user.UserUtil.latLng());this.mapElement=$("#map");this.expandControl=$("#expand");this.fetchingLocation=$("#fetchingLocation");this.fetchingVenues=$("#fetchingVenues");this.notice=$("#mapNotice");this.setCurrentTime();this.createMap();
this.initLocation()},initLocation:function(){if(navigator.geolocation&&navigator.geolocation.watchPosition){var a=window.setTimeout(fourSq.bind(this.initSearch,this),400);navigator.geolocation.getCurrentPosition(fourSq.bind(function(b){window.clearTimeout(a);this.userAcc=b.coords.accuracy;fourSq.debug.info("Got updated location");fourSq.debug.info(b);this.userAcc<this.userAccThreshold?this.userLoc=new L.LatLng(b.coords.latitude,b.coords.longitude):(fourSq.debug.info("Location not accurate enough: "+
this.userAcc+" meters"),this.showNotice("Sorry, we couldn't get your location accurately."));this.initSearch()},this),fourSq.bind(function(b){window.clearTimeout(a);this.initSearch()},this),{maximumAge:6E5})}else this.initSearch()},setCurrentTime:function(){var a=new Date,b=12<a.getHours()?a.getHours()-12:a.getHours(),c=10>a.getMinutes()?"0"+a.getMinutes():a.getMinutes(),a=12>a.getHours()?"am":"pm";0==b&&(b=12);b=b+":"+c+a;$("#nearbyRex #timestamp").text(b)},createMap:function(){this.currentLocationPoint=
fourSq.api.models.companion.geo.LatLngUtil.toLeaflet(fourSq.api.models.companion.user.UserUtil.latLng());this.map=fourSq.map.MapGenerator.generate("map",{scrollWheelZoom:!1});this.map.on("load",fourSq.bind(function(){this.mapLoaded=!0},this));this.map.setView(this.currentLocationPoint,this.initialZoom)},addMotionListeners:function(){this.motionListeners=[this.map.on("click",fourSq.bind(this.hideTooltips,this)),this.map.on("dragend",fourSq.bind(this.mapDragEnd,this)),this.map.on("zoomend",fourSq.bind(this.load,
this))]},clearMotionListeners:function(){_(this.motionListeners).each(function(a){_.isFunction(a.cancel)&&a.cancel()})},mapDragEnd:function(){this.browseFence=this.calculateBrowseFence();if(!this.browseFence.contains(this.searchPoint)){var a=this.map.getCenter();fourSq.debug.info("requerying");this.searchPoint=a;this.load()}},calculateBrowseFence:function(){var a=this.map.getCenter(),b=this.map.getBounds(),c=b.getNorthEast(),b=b.getSouthWest(),d=new L.LatLng(c.lat,b.lng),b=fourSq.map.MapUtil.distanceBetween(d,
b)/2,c=fourSq.map.MapUtil.distanceBetween(c,d)/2,d=fourSq.map.MapUtil.computeOffset(a,.5*b,0),d=fourSq.map.MapUtil.computeOffset(d,.5*c,90),a=fourSq.map.MapUtil.computeOffset(a,.5*b,180),a=fourSq.map.MapUtil.computeOffset(a,.5*c,-90);return new L.LatLngBounds(a,d)},showFence:function(){var a=this.browseFence,b=a.getNorthEast(),a=a.getSouthWest(),c=new L.LatLng(b.lat,a.lng),d=new L.LatLng(a.lat,b.lng),b=new L.Polygon([c,b,d,a]);this.map.addLayer(b,{color:"red"})},initSearch:function(){this.clearMotionListeners();
this.searchPoint=this.userLoc;this.showCurrentLocation()},showCurrentLocation:function(){if(fourSq.isUndefinedOrNull(this.currentLocationMarker)){new L.Point(11,18);var a=L.Icon.extend({options:{iconUrl:"https://ss0.4sqi.net/img/centerpoint-139fa4e52a9ccf65cb108a3b402e3bf1.png",iconSize:new L.Point(22,22),iconAnchor:new L.Point(4,14),shadowUrl:null}});this.userAcc<=this.userAccThreshold&&(this.currentLocationMarker=new L.Marker(this.userLoc,{icon:new a,zIndexOffset:4999}));this.userAcc<=this.userAccThreshold/
2&&fourSq.config.user.USER_PROFILE&&(this.currentLocationPin=this.renderPin(this.userLoc.lat,this.userLoc.lng,helpers.user.imageHref({photo:fourSq.config.user.USER_PROFILE.photo,size:32}),"#","You're here!",6,!0,this.pinImage(null)))}else this.currentLocationMarker.position=this.userLoc,this.currentLocationPin.updatePosition(this.userLoc);this.map.panTo(this.userLoc);this.fetchingLocation.hide()},renderPin:function(a,b,c,d,e,f,g,h){return new fourSq.views.HomepagePin({map:this.map,mapView:this,lat:a,
lng:b,img:c,url:d,message:e,zIndex:f,square:g,pinImage:h})},showNotice:function(a){this.notice.text(a);this.notice.show();setTimeout(fourSq.bind(function(){this.notice.hide()},this),4E3)},mapRadius:function(){return 500},pinImage:function(a){switch(a){case "trendingVenueReason":return"https://ss0.4sqi.net/img/pin-yellow-transparent-2b4c1d16a7309a89faaee13b1151b9b8.png";case "specialReason":return"https://ss1.4sqi.net/img/pin-orange-transparent-bad20d0bf67b74bbfeb826a1174627bd.png";case "combinationOfListsReason":return"https://ss1.4sqi.net/img/pin-green-transparent-1f0b88962835594a28fb54b006e24930.png";
default:return"https://ss1.4sqi.net/img/pin-blue-transparent-1b136e62c0796ad9247f790a9ef7623b.png"}},hideTooltips:function(a){_.each(this.pins,function(b,c){a&&b==a||!b.tooltipIsShown()||b.hideTooltip()})}});